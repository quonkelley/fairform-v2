# Story 13.16: Disclaimer System

## Status
Draft (low priority)

## Story
**As a** FairForm legal compliance officer,
**I want** a comprehensive disclaimer system that clearly communicates legal boundaries and limitations,
**so that** users understand FairForm provides educational guidance (not legal advice) and we maintain compliance with legal practice regulations.

## Acceptance Criteria

1. Legal disclaimer is displayed at chat initiation (first message)
2. Disclaimer appears in contextual situations (sensitive topics, legal advice requests)
3. Disclaimer is visible in UI settings/info panel
4. Disclaimer text is configurable and version-controlled
5. User acknowledgment is tracked (optional opt-in for "I understand")
6. Disclaimer content meets legal compliance requirements
7. System logs disclaimer presentations for audit trail
8. Unit tests cover disclaimer injection and tracking

## Tasks / Subtasks

- [ ] Task 1: Create disclaimer content and configuration (AC: 4, 6)
  - [ ] Draft legal disclaimer text
  - [ ] Create disclaimer configuration file
  - [ ] Support multiple disclaimer types (general, sensitive, demo)
  - [ ] Add version tracking for disclaimers
  - [ ] Get legal team approval on text

- [ ] Task 2: Implement disclaimer service (AC: 1, 2, 7)
  - [ ] Create `lib/ai/disclaimer.ts`
  - [ ] Implement disclaimer injection logic
  - [ ] Add contextual disclaimer triggers
  - [ ] Log disclaimer presentations
  - [ ] Support different disclaimer types

- [ ] Task 3: Add disclaimer to chat initialization (AC: 1)
  - [ ] Inject disclaimer as system message on first chat
  - [ ] Display disclaimer in UI before user input
  - [ ] Handle disclaimer dismissal
  - [ ] Store dismissal in session
  - [ ] Add visual styling for disclaimers

- [ ] Task 4: Implement contextual disclaimers (AC: 2)
  - [ ] Detect sensitive topic keywords
  - [ ] Inject disclaimer when legal advice requested
  - [ ] Add disclaimer for high-risk topics
  - [ ] Support inline disclaimer injection
  - [ ] Avoid duplicate disclaimers

- [ ] Task 5: Create disclaimer UI components (AC: 3)
  - [ ] Add disclaimer info panel in chat widget
  - [ ] Create disclaimer modal component
  - [ ] Add "What is FairForm?" info button
  - [ ] Display disclaimer in settings
  - [ ] Style disclaimer for accessibility

- [ ] Task 6: Implement acknowledgment tracking (AC: 5, 7)
  - [ ] Add optional "I understand" checkbox
  - [ ] Track acknowledgment in session
  - [ ] Store acknowledgment events
  - [ ] Support per-session acknowledgment
  - [ ] Add acknowledgment to audit logs

- [ ] Task 7: Add audit logging (AC: 7)
  - [ ] Log disclaimer presentations
  - [ ] Log user acknowledgments
  - [ ] Track disclaimer version shown
  - [ ] Store in Firestore for compliance
  - [ ] Support compliance reporting

- [ ] Task 8: Create comprehensive tests (AC: 8)
  - [ ] Test disclaimer injection on first message
  - [ ] Test contextual disclaimer triggers
  - [ ] Test acknowledgment tracking
  - [ ] Test UI components
  - [ ] Test audit logging

## Dev Notes

### Architecture Context
[Source: docs/epic-13-unified-architecture-specification.md, Section 4]
[Source: docs/prd/epic-13-ai-copilot.md, Section 6]

Disclaimers are **legally required** to protect FairForm from unauthorized legal practice claims. The system must clearly communicate that FairForm provides **educational guidance, not legal advice**, while maintaining a helpful, non-intimidating tone.

**Key Design Decisions:**
- Disclaimer shown at chat start (non-dismissible)
- Contextual disclaimers for sensitive topics
- Version-controlled disclaimer text
- Audit logging for compliance
- Optional user acknowledgment

### Disclaimer Content

**Legal Disclaimer Text:**
```typescript
// lib/ai/disclaimerContent.ts

export const DISCLAIMERS = {
  general: {
    version: '1.0',
    content: `**Important Notice:**

FairForm is an educational platform that helps you understand and navigate legal processes. We provide general information and guidance, but **we are not your lawyer and this is not legal advice**.

For specific legal advice tailored to your situation, please consult with a licensed attorney in your jurisdiction.

By using FairForm, you understand:
- The information provided is educational, not legal advice
- FairForm does not create an attorney-client relationship
- You should verify all information with official sources
- You are responsible for your legal decisions`,
    shortVersion: 'FairForm provides educational guidance, not legal advice. For specific legal advice, consult a licensed attorney.'
  },

  sensitive: {
    version: '1.0',
    content: `**Legal Advice Limitation:**

You've asked about a matter that may require specific legal advice. While I can provide general educational information, **I cannot give legal advice or tell you what to do in your specific situation**.

I strongly recommend consulting with a licensed attorney who can:
- Review your specific circumstances
- Provide advice tailored to your situation
- Represent you in legal proceedings if needed

Would you like me to provide general educational information about this topic instead?`,
    shortVersion: 'This topic requires specific legal advice. Please consult a licensed attorney.'
  },

  crisis: {
    version: '1.0',
    content: `**Crisis Support:**

If you're experiencing an emergency or crisis situation:
- **Emergency:** Call 911
- **Domestic Violence:** National Hotline 1-800-799-7233
- **Suicide Prevention:** 988 Lifeline
- **Legal Aid:** Visit www.lawhelp.org to find free legal services

I'm here to help with legal process information, but please reach out to crisis professionals for immediate support.`,
    shortVersion: 'If this is an emergency, please call 911 or contact appropriate crisis services.'
  },

  demo: {
    version: '1.0',
    content: `**Demo Mode:**

You're using FairForm in demo mode with sample data. This demonstration:
- Uses example cases and information
- Does not store your real case data
- Shows how FairForm helps navigate legal processes
- Is for evaluation purposes only

Ready to create a real account? Sign up to get started with your actual case.`,
    shortVersion: 'Demo mode - using sample data for demonstration purposes.'
  }
};

export type DisclaimerType = keyof typeof DISCLAIMERS;
```

### Disclaimer Service Implementation

**Core Service:**
```typescript
// lib/ai/disclaimer.ts

import { DISCLAIMERS, DisclaimerType } from './disclaimerContent';
import { getAdminFirestore } from '@/lib/firebase-admin';

export interface DisclaimerEvent {
  id: string;
  timestamp: number;
  userId: string;
  sessionId: string;
  disclaimerType: DisclaimerType;
  version: string;
  acknowledged?: boolean;
  context?: string;
}

export class DisclaimerService {
  private db = getAdminFirestore();

  /**
   * Get disclaimer content by type
   */
  getDisclaimer(type: DisclaimerType, shortVersion: boolean = false): string {
    const disclaimer = DISCLAIMERS[type];
    return shortVersion ? disclaimer.shortVersion : disclaimer.content;
  }

  /**
   * Check if disclaimer should be shown for session
   */
  async shouldShowDisclaimer(
    sessionId: string,
    disclaimerType: DisclaimerType
  ): Promise<boolean> {
    // Check if disclaimer already shown in this session
    const eventsSnapshot = await this.db
      .collection('disclaimerEvents')
      .where('sessionId', '==', sessionId)
      .where('disclaimerType', '==', disclaimerType)
      .limit(1)
      .get();

    return eventsSnapshot.empty;
  }

  /**
   * Create disclaimer message for chat
   */
  createDisclaimerMessage(type: DisclaimerType, shortVersion: boolean = false): {
    author: 'system';
    content: string;
    meta: { disclaimer: true; disclaimerType: DisclaimerType };
  } {
    return {
      author: 'system',
      content: this.getDisclaimer(type, shortVersion),
      meta: {
        disclaimer: true,
        disclaimerType: type
      }
    };
  }

  /**
   * Detect if message content requires contextual disclaimer
   */
  detectDisclaimerTriggers(messageContent: string): DisclaimerType | null {
    const content = messageContent.toLowerCase();

    // Crisis keywords
    const crisisKeywords = [
      'kill myself',
      'suicide',
      'end my life',
      'hurt myself',
      'want to die',
      'domestic violence',
      'being abused',
      'emergency'
    ];

    if (crisisKeywords.some(keyword => content.includes(keyword))) {
      return 'crisis';
    }

    // Legal advice request keywords
    const legalAdviceKeywords = [
      'should i',
      'what should i do',
      'tell me what to do',
      'is this legal',
      'will i win',
      'do i have a case',
      'sue them',
      'take them to court'
    ];

    if (legalAdviceKeywords.some(keyword => content.includes(keyword))) {
      return 'sensitive';
    }

    return null;
  }

  /**
   * Log disclaimer presentation
   */
  async logDisclaimerEvent(event: Omit<DisclaimerEvent, 'id' | 'timestamp'>): Promise<void> {
    const disclaimerEvent: DisclaimerEvent = {
      id: `disclaimer_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
      timestamp: Date.now(),
      ...event
    };

    await this.db
      .collection('disclaimerEvents')
      .doc(disclaimerEvent.id)
      .set(disclaimerEvent);

    console.log('[DISCLAIMER]', {
      id: disclaimerEvent.id,
      type: disclaimerEvent.disclaimerType,
      sessionId: disclaimerEvent.sessionId,
      acknowledged: disclaimerEvent.acknowledged
    });
  }

  /**
   * Record user acknowledgment
   */
  async recordAcknowledgment(
    userId: string,
    sessionId: string,
    disclaimerType: DisclaimerType
  ): Promise<void> {
    await this.logDisclaimerEvent({
      userId,
      sessionId,
      disclaimerType,
      version: DISCLAIMERS[disclaimerType].version,
      acknowledged: true
    });
  }

  /**
   * Get disclaimer history for user
   */
  async getDisclaimerHistory(userId: string): Promise<DisclaimerEvent[]> {
    const snapshot = await this.db
      .collection('disclaimerEvents')
      .where('userId', '==', userId)
      .orderBy('timestamp', 'desc')
      .limit(50)
      .get();

    return snapshot.docs.map(doc => doc.data() as DisclaimerEvent);
  }
}
```

### Integration with Chat API

**Updated Chat Endpoint:**
```typescript
// app/api/ai/copilot/chat/route.ts

import { DisclaimerService } from '@/lib/ai/disclaimer';

export async function POST(request: Request) {
  const { sessionId, message, caseId, demo } = await request.json();
  const auth = await requireAuth(request);
  const disclaimerService = new DisclaimerService();

  // Get or create session
  let session = sessionId
    ? await aiSessionsRepo.getSession(sessionId)
    : await aiSessionsRepo.createSession({
        userId: auth.uid,
        caseId,
        demo
      });

  // Check if this is first message (show general disclaimer)
  const messageCount = await aiSessionsRepo.getMessageCount(session.id);

  if (messageCount === 0) {
    // Inject initial disclaimer
    const disclaimerType = demo ? 'demo' : 'general';
    const disclaimerMessage = disclaimerService.createDisclaimerMessage(disclaimerType);

    await aiSessionsRepo.appendMessage(session.id, disclaimerMessage);

    // Log disclaimer event
    await disclaimerService.logDisclaimerEvent({
      userId: auth.uid,
      sessionId: session.id,
      disclaimerType,
      version: DISCLAIMERS[disclaimerType].version
    });
  }

  // Store user message
  await aiSessionsRepo.appendMessage(session.id, {
    author: 'user',
    content: message
  });

  // Check for contextual disclaimer triggers
  const contextualTrigger = disclaimerService.detectDisclaimerTriggers(message);

  if (contextualTrigger) {
    const shouldShow = await disclaimerService.shouldShowDisclaimer(
      session.id,
      contextualTrigger
    );

    if (shouldShow) {
      // Inject contextual disclaimer before AI response
      const contextualDisclaimer = disclaimerService.createDisclaimerMessage(
        contextualTrigger,
        false
      );

      await aiSessionsRepo.appendMessage(session.id, contextualDisclaimer);

      // Log disclaimer event
      await disclaimerService.logDisclaimerEvent({
        userId: auth.uid,
        sessionId: session.id,
        disclaimerType: contextualTrigger,
        version: DISCLAIMERS[contextualTrigger].version,
        context: message.substring(0, 100)
      });
    }
  }

  // Continue with AI response generation...
  const context = await buildPromptContext(auth.uid, caseId, session.id);
  const aiResponse = await callOpenAI(context, message);

  // Store AI response
  const assistantMessage = await aiSessionsRepo.appendMessage(session.id, {
    author: 'assistant',
    content: aiResponse
  });

  return NextResponse.json({
    sessionId: session.id,
    messageId: assistantMessage.id,
    reply: aiResponse
  });
}
```

### UI Components

**Disclaimer Modal Component:**
```typescript
// components/ai/disclaimer-modal.tsx

import { useState } from 'react';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Checkbox } from '@/components/ui/checkbox';
import { DISCLAIMERS, DisclaimerType } from '@/lib/ai/disclaimerContent';

interface DisclaimerModalProps {
  type: DisclaimerType;
  isOpen: boolean;
  onClose: () => void;
  onAcknowledge?: () => void;
  requireAcknowledgment?: boolean;
}

export function DisclaimerModal({
  type,
  isOpen,
  onClose,
  onAcknowledge,
  requireAcknowledgment = false
}: DisclaimerModalProps) {
  const [acknowledged, setAcknowledged] = useState(false);
  const disclaimer = DISCLAIMERS[type];

  const handleContinue = () => {
    if (onAcknowledge && acknowledged) {
      onAcknowledge();
    }
    onClose();
  };

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>
            {type === 'general' && 'Important Notice'}
            {type === 'sensitive' && 'Legal Advice Limitation'}
            {type === 'crisis' && 'Crisis Support Information'}
            {type === 'demo' && 'Demo Mode'}
          </DialogTitle>
        </DialogHeader>

        <div className="prose prose-sm max-w-none py-4">
          <div className="whitespace-pre-wrap">{disclaimer.content}</div>
        </div>

        {requireAcknowledgment && (
          <div className="flex items-center space-x-2 py-2">
            <Checkbox
              id="acknowledge"
              checked={acknowledged}
              onCheckedChange={(checked) => setAcknowledged(checked === true)}
            />
            <label
              htmlFor="acknowledge"
              className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"
            >
              I understand and agree to these terms
            </label>
          </div>
        )}

        <DialogFooter>
          {requireAcknowledgment ? (
            <Button
              onClick={handleContinue}
              disabled={!acknowledged}
            >
              Continue
            </Button>
          ) : (
            <Button onClick={onClose}>
              Close
            </Button>
          )}
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

**Disclaimer Info Button:**
```typescript
// components/ai/disclaimer-info-button.tsx

import { Info } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { DisclaimerModal } from './disclaimer-modal';
import { useState } from 'react';

export function DisclaimerInfoButton() {
  const [showDisclaimer, setShowDisclaimer] = useState(false);

  return (
    <>
      <Button
        variant="ghost"
        size="sm"
        onClick={() => setShowDisclaimer(true)}
        className="text-muted-foreground"
        aria-label="View legal disclaimer"
      >
        <Info className="h-4 w-4 mr-1" />
        Legal Info
      </Button>

      <DisclaimerModal
        type="general"
        isOpen={showDisclaimer}
        onClose={() => setShowDisclaimer(false)}
      />
    </>
  );
}
```

**System Message Display:**
```typescript
// components/ai/chat-message.tsx

import { AlertCircle } from 'lucide-react';
import { Alert, AlertDescription } from '@/components/ui/alert';

interface ChatMessageProps {
  message: AIMessage;
}

export function ChatMessage({ message }: ChatMessageProps) {
  // Display system messages (disclaimers) differently
  if (message.author === 'system' && message.meta?.disclaimer) {
    return (
      <Alert className="my-4 border-amber-500 bg-amber-50">
        <AlertCircle className="h-4 w-4 text-amber-600" />
        <AlertDescription className="text-sm whitespace-pre-wrap">
          {message.content}
        </AlertDescription>
      </Alert>
    );
  }

  // Regular message display
  return (
    <div className={`message message-${message.author}`}>
      {message.content}
    </div>
  );
}
```

### Testing

**Test Location:** `lib/ai/disclaimer.test.ts`

**Test Suite:**
```typescript
describe('DisclaimerService', () => {
  let service: DisclaimerService;

  beforeEach(() => {
    service = new DisclaimerService();
  });

  it('detects crisis keywords', () => {
    const trigger = service.detectDisclaimerTriggers('I want to kill myself');
    expect(trigger).toBe('crisis');
  });

  it('detects legal advice requests', () => {
    const trigger = service.detectDisclaimerTriggers('What should I do in this situation?');
    expect(trigger).toBe('sensitive');
  });

  it('returns null for normal questions', () => {
    const trigger = service.detectDisclaimerTriggers('How do I file a small claims case?');
    expect(trigger).toBeNull();
  });

  it('creates disclaimer message with correct structure', () => {
    const message = service.createDisclaimerMessage('general');

    expect(message.author).toBe('system');
    expect(message.content).toContain('not legal advice');
    expect(message.meta.disclaimer).toBe(true);
    expect(message.meta.disclaimerType).toBe('general');
  });

  it('logs disclaimer events', async () => {
    await service.logDisclaimerEvent({
      userId: 'user-123',
      sessionId: 'session-abc',
      disclaimerType: 'general',
      version: '1.0'
    });

    // Verify event was logged (mock Firestore in real tests)
    // expect(mockFirestore.collection).toHaveBeenCalledWith('disclaimerEvents');
  });
});
```

### Source Tree
```
lib/ai/
├── disclaimer.ts          # NEW: Disclaimer service
├── disclaimerContent.ts   # NEW: Disclaimer text content
└── types.ts               # MODIFIED: Add disclaimer types

components/ai/
├── disclaimer-modal.tsx       # NEW: Disclaimer modal
├── disclaimer-info-button.tsx # NEW: Info button
└── chat-message.tsx           # MODIFIED: Display system messages

app/api/ai/copilot/
└── chat/route.ts          # MODIFIED: Inject disclaimers

tests/
└── lib/ai/
    └── disclaimer.test.ts # NEW: Disclaimer tests
```

### Configuration

**Disclaimer Versions:**
```typescript
// Track disclaimer version changes
export const DISCLAIMER_VERSION_HISTORY = [
  {
    version: '1.0',
    date: '2025-01-13',
    changes: 'Initial disclaimer text',
    approvedBy: 'Legal Team'
  }
];
```

### Performance Considerations
- Minimal latency impact (text injection only)
- Cache disclaimer text in memory
- Efficient Firestore queries for acknowledgment checks
- Batch log writes when possible

### Dependencies
- Existing chat API and message repository
- UI components (Dialog, Alert, Button)
- Firebase Admin SDK for logging

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent*

### Debug Log References
_To be populated by dev agent*

### Completion Notes List
_To be populated by dev agent*

### File List
_To be populated by dev agent*

## QA Results
_To be populated by QA agent*
