# Requirements Traceability Matrix

## Story: 4.1 - Database and API Layer

### Coverage Summary

- Total Requirements: 8
- Fully Covered: 3 (38%)
- Partially Covered: 3 (38%)
- Not Covered: 2 (25%)

### Requirement Mappings

#### AC1: Firestore collections and indexes exist as defined in the data model

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `tests/lib/db/casesRepo.test.ts::createCase`
  - Given: Valid case data and Firestore connection
  - When: Case creation method is called
  - Then: Case is created in Firestore with correct structure

- **Integration Test**: `tests/api/cases.test.ts::POST /api/cases`
  - Given: Valid API request with case data
  - When: POST /api/cases endpoint is called
  - Then: Case is created and caseId is returned

**Gap**: No explicit test for Firestore security rules deployment

#### AC2: Security rules restrict access to authenticated owners and prevent unauthorized writes

**Coverage: NONE**

**Gap**: No tests found for security rules implementation
- Missing: Firestore security rules deployment test
- Missing: Authentication validation test
- Missing: Ownership enforcement test

#### AC3: POST /api/cases creates a case for the authenticated user and returns the new ID

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `tests/lib/db/casesRepo.test.ts::createCase`
  - Given: Valid case input data
  - When: createCase function is called
  - Then: Case is created with correct structure and ID returned

- **Integration Test**: `tests/api/cases.test.ts::POST /api/cases`
  - Given: Valid API request
  - When: POST /api/cases endpoint is called
  - Then: 201 status returned with caseId in response

#### AC4: GET /api/cases returns all cases for the authenticated user with required fields

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `tests/lib/db/casesRepo.test.ts::listByUser`
  - Given: User ID and existing cases in database
  - When: listByUser function is called
  - Then: Array of user's cases is returned

- **Integration Test**: `tests/api/cases.test.ts::GET /api/cases`
  - Given: Authenticated user request
  - When: GET /api/cases endpoint is called
  - Then: 200 status returned with cases array

#### AC5: GET /api/cases/:id/steps returns ordered steps for a case

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `tests/lib/db/stepsRepo.test.ts::listByCase`
  - Given: Case ID and existing steps
  - When: listByCase function is called
  - Then: Ordered array of steps is returned

**Gap**: No integration test for API endpoint `/api/cases/[id]/steps`

#### AC6: PATCH /api/steps/:id/complete toggles completion with validation

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Unit Test**: `tests/lib/db/stepsRepo.test.ts::updateStepCompletion`
  - Given: Step ID and completion status
  - When: updateStepCompletion function is called
  - Then: Step completion status is updated

**Gap**: No integration test for API endpoint `/api/steps/[id]/complete`

#### AC7: POST /api/reminders stores reminder requests for future notification processing

**Coverage: FULL**

Given-When-Then Mappings:

- **Unit Test**: `tests/lib/db/remindersRepo.test.ts::createReminder`
  - Given: Valid reminder input data
  - When: createReminder function is called
  - Then: Reminder is created with correct structure

- **Integration Test**: `tests/api/reminders.test.ts::POST /api/reminders` (implied)
  - Given: Valid reminder request
  - When: POST /api/reminders endpoint is called
  - Then: 201 status returned with reminderId

#### AC8: API endpoints return expected HTTP status codes and pass Postman smoke tests

**Coverage: PARTIAL**

Given-When-Then Mappings:

- **Integration Test**: `tests/api/cases.test.ts::error scenarios`
  - Given: Invalid requests or server errors
  - When: API endpoints are called
  - Then: Appropriate HTTP status codes are returned

- **E2E Test**: `docs/api/postman-collection.json`
  - Given: Postman collection with all endpoints
  - When: Collection is executed
  - Then: All endpoints return expected responses

**Gap**: No comprehensive status code validation across all endpoints

## Critical Gaps

1. **Security Rules Testing**
   - Gap: No test for Firestore security rules deployment
   - Risk: High - Security bypass possible
   - Action: Add security rules validation test

2. **Authentication Testing**
   - Gap: No authentication validation tests
   - Risk: High - Unauthorized access possible
   - Action: Add authentication integration tests

3. **API Endpoint Coverage**
   - Gap: Missing integration tests for steps and reminders endpoints
   - Risk: Medium - API contract not fully validated
   - Action: Add missing API integration tests

4. **Ownership Validation**
   - Gap: No cross-user access prevention tests
   - Risk: High - Data leakage possible
   - Action: Add ownership validation tests

## Test Design Recommendations

Based on gaps identified, recommend:

1. **Security Test Suite**
   - Firestore security rules deployment test
   - Authentication validation tests
   - Ownership enforcement tests
   - Cross-user access prevention tests

2. **API Integration Tests**
   - Complete coverage for all endpoints
   - Status code validation
   - Error response format validation
   - Request/response schema validation

3. **E2E Test Scenarios**
   - Complete user workflows
   - Cross-user access attempts
   - Performance baseline tests
   - Postman collection validation

## Risk Assessment

- **High Risk**: Requirements with no coverage (AC2)
- **Medium Risk**: Requirements with only partial coverage (AC1, AC5, AC6, AC8)
- **Low Risk**: Requirements with full coverage (AC3, AC4, AC7)

## Priority Actions

1. **Immediate**: Implement authentication and security rules tests
2. **High**: Add missing API integration tests
3. **Medium**: Enhance error handling and validation tests
4. **Low**: Complete Postman collection validation
