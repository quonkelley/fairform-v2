# Story 13.30: Document Upload & OCR Extraction ðŸ”¥

## Status
ðŸ“‹ Planned

## Story
**As a** user with a court notice or legal document,
**I want** to upload a photo or PDF and have the information automatically extracted,
**so that** I don't have to manually type all the details.

## Acceptance Criteria

1. Users can upload images (PNG, JPG) and PDFs
2. File upload UI is intuitive and accessible
3. GPT-4 Vision extracts case number, hearing date, jurisdiction, case type
4. Extracted information is displayed with confidence indicators
5. Users can verify and edit extracted information
6. System handles extraction failures gracefully
7. Works on mobile devices (camera capture)
8. File size limits enforced (max 10MB)
9. Progress indicator shows during extraction
10. Security: files are not stored permanently, only processed

## Tasks / Subtasks

- [ ] Task 1: Add file upload UI (AC: 1, 2, 7, 8)
  - [ ] Add file input button to ChatPanel
  - [ ] Support camera capture on mobile
  - [ ] Validate file type and size
  - [ ] Show preview of uploaded file
  - [ ] Add drag-and-drop support (desktop)

- [ ] Task 2: Create OCR extraction service (AC: 3, 6, 9)
  - [ ] Create `lib/ai/documentExtraction.ts`
  - [ ] Implement GPT-4 Vision API integration
  - [ ] Convert file to base64 for API
  - [ ] Parse structured response
  - [ ] Handle API errors

- [ ] Task 3: Display extracted information (AC: 4, 5)
  - [ ] Create ExtractionResultCard component
  - [ ] Show extracted fields with confidence scores
  - [ ] Add inline editing for each field
  - [ ] Confirm or reject extraction results

- [ ] Task 4: Security and privacy (AC: 10)
  - [ ] Process files in-memory only
  - [ ] Don't store uploaded files
  - [ ] Redact PII in logs
  - [ ] Add security headers

- [ ] Task 5: Testing (AC: All)
  - [ ] Test with various document types
  - [ ] Test with poor quality images
  - [ ] Test with non-English documents
  - [ ] Test error scenarios

## Dev Notes

### GPT-4 Vision Integration

```typescript
// lib/ai/documentExtraction.ts
export async function extractFromDocument(
  fileBase64: string,
  mimeType: string
): Promise<ExtractionResult> {
  const response = await openai.chat.completions.create({
    model: "gpt-4o",
    messages: [{
      role: "user",
      content: [
        {
          type: "text",
          text: "Extract the following information from this legal notice: case number, hearing date, court name, case type (eviction, small claims, etc.), and jurisdiction. Return as JSON."
        },
        {
          type: "image_url",
          image_url: {
            url: `data:${mimeType};base64,${fileBase64}`
          }
        }
      ]
    }],
    response_format: { type: "json_object" }
  });

  return JSON.parse(response.choices[0].message.content);
}
```

### File Upload Component

```typescript
export function DocumentUpload({ onExtract }: { onExtract: (data: any) => void }) {
  const handleFileSelect = async (file: File) => {
    // Validate
    if (file.size > 10 * 1024 * 1024) {
      toast.error('File too large (max 10MB)');
      return;
    }

    // Convert to base64
    const base64 = await fileToBase64(file);

    // Extract
    const result = await extractFromDocument(base64, file.type);

    onExtract(result);
  };

  return (
    <div>
      <input
        type="file"
        accept="image/*,application/pdf"
        onChange={(e) => handleFileSelect(e.target.files[0])}
      />
      {/* Or camera capture on mobile */}
      <input
        type="file"
        accept="image/*"
        capture="environment"
      />
    </div>
  );
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Product Team |

