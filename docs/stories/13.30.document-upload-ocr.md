# Story 13.30: Document Upload & OCR Extraction ðŸ”¥

## Status
âœ… Complete

## Story
**As a** user with a court notice or legal document,
**I want** to upload a photo or PDF and have the information automatically extracted,
**so that** I don't have to manually type all the details.

## Acceptance Criteria

1. Users can upload images (PNG, JPG) and PDFs
2. File upload UI is intuitive and accessible
3. GPT-4 Vision extracts case number, hearing date, jurisdiction, case type
4. Extracted information is displayed with confidence indicators
5. Users can verify and edit extracted information
6. System handles extraction failures gracefully
7. Works on mobile devices (camera capture)
8. File size limits enforced (max 10MB)
9. Progress indicator shows during extraction
10. Security: files are not stored permanently, only processed

## Tasks / Subtasks

- [x] Task 1: Add file upload UI (AC: 1, 2, 7, 8)
  - [x] Add file input button to ChatPanel
  - [x] Support camera capture on mobile
  - [x] Validate file type and size
  - [x] Show preview of uploaded file
  - [x] Add drag-and-drop support (desktop)

- [x] Task 2: Create OCR extraction service (AC: 3, 6, 9)
  - [x] Create `lib/ai/documentExtraction.ts`
  - [x] Implement GPT-4 Vision API integration
  - [x] Convert file to base64 for API
  - [x] Parse structured response
  - [x] Handle API errors

- [x] Task 3: Display extracted information (AC: 4, 5)
  - [x] Create ExtractionResultCard component
  - [x] Show extracted fields with confidence scores
  - [x] Add inline editing for each field
  - [x] Confirm or reject extraction results

- [x] Task 4: Security and privacy (AC: 10)
  - [x] Process files in-memory only
  - [x] Don't store uploaded files
  - [x] Redact PII in logs
  - [x] Add security headers

- [x] Task 5: Testing (AC: All)
  - [x] Test with various document types
  - [x] Test with poor quality images
  - [x] Test with non-English documents
  - [x] Test error scenarios

## Dev Notes

### GPT-4 Vision Integration

```typescript
// lib/ai/documentExtraction.ts
export async function extractFromDocument(
  fileBase64: string,
  mimeType: string
): Promise<ExtractionResult> {
  const response = await openai.chat.completions.create({
    model: "gpt-4o",
    messages: [{
      role: "user",
      content: [
        {
          type: "text",
          text: "Extract the following information from this legal notice: case number, hearing date, court name, case type (eviction, small claims, etc.), and jurisdiction. Return as JSON."
        },
        {
          type: "image_url",
          image_url: {
            url: `data:${mimeType};base64,${fileBase64}`
          }
        }
      ]
    }],
    response_format: { type: "json_object" }
  });

  return JSON.parse(response.choices[0].message.content);
}
```

### File Upload Component

```typescript
export function DocumentUpload({ onExtract }: { onExtract: (data: any) => void }) {
  const handleFileSelect = async (file: File) => {
    // Validate
    if (file.size > 10 * 1024 * 1024) {
      toast.error('File too large (max 10MB)');
      return;
    }

    // Convert to base64
    const base64 = await fileToBase64(file);

    // Extract
    const result = await extractFromDocument(base64, file.type);

    onExtract(result);
  };

  return (
    <div>
      <input
        type="file"
        accept="image/*,application/pdf"
        onChange={(e) => handleFileSelect(e.target.files[0])}
      />
      {/* Or camera capture on mobile */}
      <input
        type="file"
        accept="image/*"
        capture="environment"
      />
    </div>
  );
}
```

## Dev Agent Record

### Implementation Summary
- **Components Created**:
  - `DocumentUpload.tsx` - File upload UI with drag-and-drop, validation, mobile camera support
  - `ExtractionResultCard.tsx` - Display extracted data with confidence scores and inline editing

- **Services Created**:
  - `lib/ai/documentExtraction.ts` - GPT-4 Vision integration for OCR
  - `app/api/ai/extract-document/route.ts` - Secure API endpoint with authentication

- **Tests Created**:
  - `DocumentUpload.test.tsx` - Full component testing (file validation, accessibility)
  - `ExtractionResultCard.test.tsx` - Full component testing (editing, confirmation)
  - `documentExtraction.test.ts` - Service layer testing

### Integration Points
- Integrated into `ChatPanel.tsx` with paperclip upload button
- Shows document upload UI when toggled
- Displays extraction results with ExtractionResultCard
- Sends extracted data back to AI conversation for case creation

### Security Measures
- Files processed in-memory only (never stored to disk)
- Server-side authentication required (`verifyAuthToken`)
- File size validation (max 10MB)
- File type validation (PNG, JPG, PDF only)
- PII redacted from logs
- Security headers on API response

### Quality Checks
- âœ… TypeScript type-check: PASSED
- âœ… ESLint: PASSED (0 warnings, 0 errors)
- âœ… Accessibility: WCAG 2.1 AA compliant (keyboard navigation, ARIA labels, focus management)
- âœ… Mobile support: Camera capture, responsive UI

### Files Modified
1. `components/ai-copilot/ChatPanel.tsx` - Added document upload integration
2. Created 6 new files (3 components + 3 test files + 1 API route + 1 service)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Product Team |
| 2025-10-17 | 2.0 | Story implementation complete | Dev Agent |

