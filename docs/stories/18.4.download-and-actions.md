# Story 18.4: Download & Basic Actions

## Status
In Review

## Story
**As a** user,
**I want** to download my completed form as a PDF and see it linked to my case,
**so that** I can print it and file it with the court.

## Acceptance Criteria

1. After form completion, user sees success card with download button
2. Clicking download triggers PDF generation and browser download
3. Completed form is uploaded to Firebase Storage under user's path
4. Form metadata is saved to Firestore (linked to case)
5. Form appears in case dashboard under "Documents" section
6. Success message shows confetti animation (celebration)
7. API route handles PDF generation and storage securely
8. User can view list of completed forms for their case

## Tasks / Subtasks

- [x] Task 1: Create form completion success card (AC: 1, 6)
  - [x] Create `components/forms/FormSuccessCard.tsx`
  - [x] Show success message: "Your Appearance Form is ready!"
  - [x] Display form summary (case number, hearing date)
  - [x] Show primary action: Download PDF button
  - [x] Add confetti animation on mount (use `canvas-confetti` or CSS)
  - [x] Include "View in Dashboard" link

- [x] Task 2: Create generate & download API route (AC: 2, 3, 7)
  - [x] Create `app/api/forms/generate/route.ts`
  - [x] POST endpoint accepting `{ formId, caseId, fields }`
  - [x] Validate user authentication (must own case)
  - [x] Validate form data with Zod schema
  - [x] Load template from Storage (Story 18.1)
  - [x] Generate PDF using pdfGenerator (Story 18.2)
  - [x] Upload completed PDF to Firebase Storage
  - [x] Return download URL
  - [x] Handle errors with proper status codes

- [x] Task 3: Create download handler (AC: 2)
  - [x] Add `downloadPDF()` function in FormSuccessCard
  - [x] Call generate API route
  - [x] Show loading spinner during generation
  - [x] Trigger browser download using blob URL
  - [x] Set filename: `{formType}_{caseNumber}_{date}.pdf`
  - [x] Show error toast if generation fails

- [x] Task 4: Save form metadata to Firestore (AC: 4)
  - [x] Create `completedForms` collection
  - [x] Schema: `{ formId, userId, caseId, storagePath, downloadUrl, status, fields, createdAt }`
  - [x] Create `lib/db/formsRepo.ts`
  - [x] Function: `saveCompletedForm(metadata: CompletedForm): Promise<Result<string>>`
  - [x] Called by generate API after PDF upload
  - [x] Index on `caseId` for efficient queries

- [x] Task 5: Display forms in case dashboard (AC: 5, 8)
  - [x] Update `app/dashboard/page.tsx` or case detail page
  - [x] Add "Documents" section below steps or in sidebar
  - [x] Query completed forms: `formsRepo.getFormsByCase(caseId)`
  - [x] Show form cards with: type, created date, download link
  - [x] Empty state: "No forms completed yet"

- [x] Task 6: Integrate with FormSession completion (AC: 1)
  - [x] Update FormSession `onComplete` handler
  - [skipped] Call generate API with collected form data (intentionally skipped)
  - [x] Show loading state: "Generating your form..."
  - [x] On success, show FormSuccessCard
  - [x] On error, show error message with retry option

- [x] Task 7: Add form listing component (AC: 8)
  - [x] Create `components/forms/CompletedFormsList.tsx`
  - [x] Display forms as cards with metadata
  - [x] Each card shows: form title, date, download icon
  - [x] Click card â†’ download PDF
  - [x] Use existing UI patterns from dashboard

- [ ] Task 8: Create unit tests (AC: all)
  - [ ] Test generate API validates auth and input
  - [ ] Test PDF generation success and error paths
  - [x] Test metadata saved to Firestore
  - [x] Test formsRepo CRUD operations
  - [x] Test FormSuccessCard renders correctly
  - [x] Test download triggers browser download

## Dev Notes

### Architecture Context
This story completes the form filler flow by giving users the final output - a downloadable PDF. It also persists form data so users can access it later.

**MVP Focus:**
- Simple download (no email, no sharing)
- Store in Firebase Storage (user-specific path)
- Basic metadata in Firestore (no versioning, no editing)
- Show in dashboard (no separate forms page)

### Generate & Download Flow
```
1. User completes last form field
2. FormSession calls onComplete(fieldValues)
3. Call POST /api/forms/generate with form data
4. API validates auth and data
5. API generates PDF using pdfGenerator
6. API uploads PDF to Firebase Storage
7. API saves metadata to Firestore
8. API returns { success: true, downloadUrl, formId }
9. Show FormSuccessCard with download button
10. User clicks Download
11. Browser downloads PDF file
12. Confetti animation plays
```

### Generate API Route
```typescript
// app/api/forms/generate/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { getServerSession } from '@/lib/auth/server-auth';
import { generatePDF } from '@/lib/forms/pdfGenerator';
import { uploadFile } from '@/lib/db/storageRepo';
import { saveCompletedForm } from '@/lib/db/formsRepo';
import { loadFormTemplate } from '@/lib/forms/formLoader';

const generateFormSchema = z.object({
  formId: z.string(),
  caseId: z.string(),
  fields: z.record(z.any())
});

export async function POST(request: NextRequest) {
  try {
    // 1. Validate auth
    const session = await getServerSession();
    if (!session?.userId) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    // 2. Parse and validate input
    const body = await request.json();
    const { formId, caseId, fields } = generateFormSchema.parse(body);

    // 3. Verify user owns case (TODO: add casesRepo.getCase check)

    // 4. Load template
    const template = await loadFormTemplate(formId);
    const templateUrl = `/demo/forms/${formId}-template.pdf`; // Or from Storage

    // 5. Generate PDF
    const pdfResult = await generatePDF(templateUrl, fields);
    if (!pdfResult.success) {
      return NextResponse.json({ error: 'PDF generation failed' }, { status: 500 });
    }

    // 6. Upload to Storage
    const storagePath = `forms/completed/${session.userId}/${caseId}/${formId}_${Date.now()}.pdf`;
    const uploadResult = await uploadFile(storagePath, pdfResult.data);
    if (!uploadResult.success) {
      return NextResponse.json({ error: 'Upload failed' }, { status: 500 });
    }

    // 7. Save metadata to Firestore
    const metadata = {
      formId,
      userId: session.userId,
      caseId,
      storagePath,
      downloadUrl: uploadResult.data,
      status: 'completed' as const,
      fields,
      createdAt: Date.now()
    };
    const saveResult = await saveCompletedForm(metadata);
    if (!saveResult.success) {
      return NextResponse.json({ error: 'Failed to save metadata' }, { status: 500 });
    }

    // 8. Return success
    return NextResponse.json({
      success: true,
      downloadUrl: uploadResult.data,
      formRecordId: saveResult.data
    });

  } catch (error) {
    console.error('Generate form error:', error);
    return NextResponse.json({ error: 'Internal error' }, { status: 500 });
  }
}
```

### FormSuccessCard Component
```typescript
interface FormSuccessCardProps {
  formId: string;
  formTitle: string;
  downloadUrl: string;
  caseId: string;
}

export function FormSuccessCard({ formId, formTitle, downloadUrl, caseId }: FormSuccessCardProps) {
  const [downloading, setDownloading] = useState(false);

  useEffect(() => {
    // Trigger confetti animation
    confetti({
      particleCount: 100,
      spread: 70,
      origin: { y: 0.6 }
    });
  }, []);

  const handleDownload = async () => {
    setDownloading(true);
    try {
      const response = await fetch(downloadUrl);
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${formId}_${Date.now()}.pdf`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Download failed:', error);
      // Show error toast
    } finally {
      setDownloading(false);
    }
  };

  return (
    <div className="bg-white rounded-lg shadow-lg p-6 text-center">
      <div className="text-4xl mb-4">ðŸŽ‰</div>
      <h2 className="text-2xl font-bold mb-2">Your {formTitle} is Ready!</h2>
      <p className="text-gray-600 mb-6">
        Your form has been completed and is ready to download.
      </p>

      <button
        onClick={handleDownload}
        disabled={downloading}
        className="btn-primary mb-4"
      >
        {downloading ? 'Downloading...' : 'Download PDF'}
      </button>

      <div className="text-sm text-gray-500">
        <a href={`/dashboard?caseId=${caseId}`} className="text-blue-600 hover:underline">
          View in Dashboard
        </a>
      </div>
    </div>
  );
}
```

### Forms Repository
```typescript
// lib/db/formsRepo.ts
import { getAdminFirestore } from '@/lib/firebase-admin';
import { Result } from '@/lib/types';

export class FormsRepositoryError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'FormsRepositoryError';
  }
}

export interface CompletedForm {
  id?: string;
  formId: string;
  userId: string;
  caseId: string;
  storagePath: string;
  downloadUrl: string;
  status: 'completed' | 'draft';
  fields: Record<string, any>;
  createdAt: number;
}

const FORMS_COLLECTION = 'completedForms';

export async function saveCompletedForm(form: CompletedForm): Promise<Result<string>> {
  try {
    const db = getAdminFirestore();
    const docRef = await db.collection(FORMS_COLLECTION).add(form);
    return { success: true, data: docRef.id };
  } catch (error) {
    console.error('Failed to save completed form:', error);
    return { success: false, error: 'Failed to save form' };
  }
}

export async function getFormsByCase(caseId: string): Promise<Result<CompletedForm[]>> {
  try {
    const db = getAdminFirestore();
    const snapshot = await db
      .collection(FORMS_COLLECTION)
      .where('caseId', '==', caseId)
      .orderBy('createdAt', 'desc')
      .get();

    const forms = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    } as CompletedForm));

    return { success: true, data: forms };
  } catch (error) {
    console.error('Failed to get forms by case:', error);
    return { success: false, error: 'Failed to retrieve forms' };
  }
}

export async function getForm(formRecordId: string): Promise<Result<CompletedForm>> {
  try {
    const db = getAdminFirestore();
    const doc = await db.collection(FORMS_COLLECTION).doc(formRecordId).get();

    if (!doc.exists) {
      return { success: false, error: 'Form not found' };
    }

    return { success: true, data: { id: doc.id, ...doc.data() } as CompletedForm };
  } catch (error) {
    console.error('Failed to get form:', error);
    return { success: false, error: 'Failed to retrieve form' };
  }
}
```

### Display in Dashboard
```typescript
// In case dashboard page
import { CompletedFormsList } from '@/components/forms/CompletedFormsList';

export default async function CaseDashboard({ params }) {
  const caseData = await getCaseData(params.caseId);
  const formsResult = await formsRepo.getFormsByCase(params.caseId);
  const forms = formsResult.success ? formsResult.data : [];

  return (
    <div>
      {/* Existing case content */}

      <section className="mt-8">
        <h2 className="text-xl font-bold mb-4">Documents</h2>
        <CompletedFormsList forms={forms} />
      </section>
    </div>
  );
}
```

### Confetti Animation
Use `canvas-confetti` library:
```bash
npm install canvas-confetti
npm install -D @types/canvas-confetti
```

Or simple CSS alternative (no library):
```css
@keyframes confetti-fall {
  to { transform: translateY(100vh) rotate(360deg); }
}

.confetti-piece {
  position: fixed;
  width: 10px;
  height: 10px;
  background: #ffd700;
  animation: confetti-fall 2s linear;
}
```

### Source Tree
```
app/api/forms/
â””â”€â”€ generate/
    â””â”€â”€ route.ts                # NEW: Generate & upload API

components/forms/
â”œâ”€â”€ FormSuccessCard.tsx         # NEW: Success UI with download
â””â”€â”€ CompletedFormsList.tsx      # NEW: List of completed forms

lib/db/
â””â”€â”€ formsRepo.ts                # NEW: Firestore operations for forms

app/dashboard/
â””â”€â”€ page.tsx                    # MODIFY: Add Documents section
```

### Testing Strategy
- Mock Firebase Storage upload
- Mock Firestore write
- Test generate API with valid/invalid input
- Test auth check rejects unauthorized requests
- Test download triggers blob download
- Test forms appear in dashboard

### Dependencies
- pdfGenerator from Story 18.2
- storageRepo from Story 18.1
- formLoader from Story 18.2
- Existing auth utilities
- canvas-confetti (or CSS animation)

### Implementation Notes
- Download should work on mobile (test iOS Safari)
- Filename format: `appearance_49D01-2410_2025-10-16.pdf`
- Show loading spinner during generation (can take 2-3 seconds)
- Error messages should be user-friendly, not technical
- Store full form data in Firestore for audit/re-generation

### Out of Scope (Defer)
- Email PDF to user â†’ Post-MVP
- Share link with others â†’ Post-MVP
- Edit completed form â†’ Post-MVP
- Delete completed form â†’ Post-MVP
- Print directly (browser print) â†’ Can use download + print
- Form versioning â†’ Post-MVP

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | PM |

## Dev Agent Record

### Agent Model Used
GPT-5 Codex

### Debug Log References
- `npm test -- tests/forms/FormSuccessCard.test.tsx tests/db/formsRepo.test.ts`

### Completion Notes List
- Implemented server route for form generation, Firestore persistence, and storage upload with filename normalization.
- Added FormSuccessCard workflow with confetti, download handler, and dashboard documents listing via CompletedFormsList.
- Generation is triggered on download click; outstanding automated coverage still needed for API validation and PDF engine paths.

### File List
- app/api/forms/generate/route.ts
- app/api/cases/[id]/forms/route.ts
- app/cases/[id]/page.tsx
- components/ai-copilot/ChatPanel.tsx
- components/ai-copilot/FormSession.tsx
- components/forms/CompletedFormsList.tsx
- components/forms/FormSuccessCard.tsx
- lib/db/formsRepo.ts
- lib/db/storageRepo.ts
- lib/db/types.ts
- lib/forms/completedForm.ts
- lib/hooks/useCompletedForms.ts
- lib/hooks/useFormSession.ts
- tests/db/formsRepo.test.ts
- tests/forms/FormSuccessCard.test.tsx
- docs/stories/18.4.download-and-actions.md

## QA Results

### Test Results
_To be filled by QA_

### Acceptance Criteria Validation
_To be filled by QA_

### Next Steps
After completing Story 18.4, proceed to Story 18.5 (Demo Mode Integration).
