# Story 13.20: Accessibility & E2E Testing

## Status
Draft

## Story
**As a** FairForm QA engineer,
**I want** comprehensive accessibility and end-to-end testing for the AI Copilot,
**so that** we ensure WCAG 2.1 AA compliance, validate user flows work correctly, and provide an inclusive experience for all users.

## Acceptance Criteria

1. AI Copilot components meet WCAG 2.1 AA standards
2. All interactive elements are keyboard accessible
3. Screen reader compatibility is verified (NVDA, JAWS, VoiceOver)
4. Focus management works correctly in chat interface
5. E2E tests cover critical user flows (chat, context switching, errors)
6. Accessibility tests run in CI/CD pipeline
7. ARIA labels and semantic HTML are properly implemented
8. Color contrast meets WCAG AA requirements (4.5:1 for text)

## Tasks / Subtasks

- [ ] Task 1: Set up accessibility testing tools (AC: 6)
  - [ ] Install axe-core and jest-axe
  - [ ] Install Playwright for E2E tests
  - [ ] Configure accessibility linting (eslint-plugin-jsx-a11y)
  - [ ] Set up screen reader testing environment
  - [ ] Configure CI/CD integration

- [ ] Task 2: Create accessibility component tests (AC: 1, 7)
  - [ ] Test chat widget for accessibility
  - [ ] Test chat panel for accessibility
  - [ ] Test message components for accessibility
  - [ ] Test modal/dialog accessibility
  - [ ] Test form inputs and buttons

- [ ] Task 3: Implement keyboard navigation tests (AC: 2, 4)
  - [ ] Test tab order and focus flow
  - [ ] Test escape key to close modals
  - [ ] Test enter key to send messages
  - [ ] Test arrow keys for message navigation
  - [ ] Test focus trapping in modals

- [ ] Task 4: Create screen reader tests (AC: 3)
  - [ ] Test chat widget announcement
  - [ ] Test message announcement
  - [ ] Test error message announcement
  - [ ] Test loading state announcement
  - [ ] Test ARIA live regions

- [ ] Task 5: Create E2E user flow tests (AC: 5)
  - [ ] Test complete chat conversation flow
  - [ ] Test chat with case context switching
  - [ ] Test error handling and recovery
  - [ ] Test demo mode activation
  - [ ] Test session persistence

- [ ] Task 6: Verify color contrast (AC: 8)
  - [ ] Audit all text color combinations
  - [ ] Test in light and dark modes
  - [ ] Verify link colors meet standards
  - [ ] Test disabled state colors
  - [ ] Test error and warning colors

- [ ] Task 7: Test focus indicators (AC: 2)
  - [ ] Verify visible focus rings on all interactive elements
  - [ ] Test focus indicator color contrast (3:1 minimum)
  - [ ] Test focus indicators in different states
  - [ ] Verify focus indicators not hidden by CSS
  - [ ] Test custom focus styling

- [ ] Task 8: Create comprehensive test suite (AC: 6)
  - [ ] Integrate tests into CI/CD
  - [ ] Set up automated accessibility scanning
  - [ ] Configure test reporting
  - [ ] Add accessibility checklist to PR template
  - [ ] Document testing procedures

## Dev Notes

### Architecture Context
[Source: CLAUDE.md, Section "Development Standards > Accessibility"]

FairForm requires **WCAG 2.1 AA compliance** for all features. The AI Copilot introduces complex interactive patterns (chat, streaming, modals) that require careful accessibility consideration.

**Key Requirements:**
- WCAG 2.1 AA compliance
- Keyboard accessibility for all interactions
- Screen reader support
- Visible focus indicators
- 4.5:1 color contrast for text

### Accessibility Testing Setup

**Dependencies:**
```json
{
  "devDependencies": {
    "@axe-core/playwright": "^4.8.0",
    "@playwright/test": "^1.40.0",
    "@testing-library/jest-dom": "^6.1.5",
    "@testing-library/react": "^14.1.2",
    "axe-core": "^4.8.3",
    "jest-axe": "^8.0.0",
    "eslint-plugin-jsx-a11y": "^6.8.0"
  }
}
```

**ESLint Configuration:**
```json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:jsx-a11y/recommended"
  ],
  "plugins": ["jsx-a11y"],
  "rules": {
    "jsx-a11y/no-autofocus": "warn",
    "jsx-a11y/no-onchange": "off"
  }
}
```

### Accessibility Component Tests

**Chat Widget Accessibility Test:**
```typescript
// tests/accessibility/chat-widget.a11y.test.tsx

import { render } from '@testing-library/react';
import { axe, toHaveNoViolations } from 'jest-axe';
import { AICopilotWidget } from '@/components/ai/chat-widget';

expect.extend(toHaveNoViolations);

describe('AICopilotWidget Accessibility', () => {
  it('should have no accessibility violations', async () => {
    const { container } = render(<AICopilotWidget />);
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });

  it('has proper ARIA labels', () => {
    const { getByRole } = render(<AICopilotWidget />);

    expect(getByRole('button', { name: /open ai copilot/i })).toBeInTheDocument();
  });

  it('is keyboard accessible', () => {
    const { getByRole } = render(<AICopilotWidget />);
    const button = getByRole('button');

    button.focus();
    expect(button).toHaveFocus();
  });

  it('has visible focus indicator', () => {
    const { getByRole } = render(<AICopilotWidget />);
    const button = getByRole('button');

    button.focus();

    // Check for focus ring (implementation-specific)
    const styles = window.getComputedStyle(button);
    expect(styles.outline).not.toBe('none');
  });
});
```

**Chat Panel Accessibility Test:**
```typescript
// tests/accessibility/chat-panel.a11y.test.tsx

import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { axe } from 'jest-axe';
import { ChatPanel } from '@/components/ai/chat-panel';

describe('ChatPanel Accessibility', () => {
  const mockMessages = [
    { id: '1', author: 'user', content: 'Hello', createdAt: Date.now() },
    { id: '2', author: 'assistant', content: 'Hi there!', createdAt: Date.now() }
  ];

  it('should have no accessibility violations', async () => {
    const { container } = render(
      <ChatPanel messages={mockMessages} onSendMessage={() => {}} />
    );
    const results = await axe(container);
    expect(results).toHaveNoViolations();
  });

  it('has semantic HTML structure', () => {
    render(<ChatPanel messages={mockMessages} onSendMessage={() => {}} />);

    // Chat should use proper landmark
    expect(screen.getByRole('region', { name: /chat/i })).toBeInTheDocument();

    // Input should be labeled
    expect(screen.getByLabelText(/message/i)).toBeInTheDocument();

    // Send button should be labeled
    expect(screen.getByRole('button', { name: /send/i })).toBeInTheDocument();
  });

  it('announces new messages to screen readers', () => {
    const { rerender } = render(
      <ChatPanel messages={mockMessages} onSendMessage={() => {}} />
    );

    const newMessages = [
      ...mockMessages,
      { id: '3', author: 'assistant', content: 'New response', createdAt: Date.now() }
    ];

    rerender(<ChatPanel messages={newMessages} onSendMessage={() => {}} />);

    // Check for ARIA live region
    const liveRegion = screen.getByRole('status');
    expect(liveRegion).toHaveTextContent('New response');
  });

  it('supports keyboard navigation', async () => {
    const user = userEvent.setup();
    const onSendMessage = jest.fn();

    render(<ChatPanel messages={mockMessages} onSendMessage={onSendMessage} />);

    const input = screen.getByLabelText(/message/i);

    // Tab to input
    await user.tab();
    expect(input).toHaveFocus();

    // Type message
    await user.type(input, 'Test message');

    // Submit with Enter
    await user.keyboard('{Enter}');

    expect(onSendMessage).toHaveBeenCalledWith('Test message');
  });

  it('traps focus in modal when open', async () => {
    const user = userEvent.setup();

    render(<ChatPanel messages={mockMessages} onSendMessage={() => {}} isOpen />);

    // First focusable element
    const closeButton = screen.getByRole('button', { name: /close/i });
    const sendButton = screen.getByRole('button', { name: /send/i });

    closeButton.focus();
    expect(closeButton).toHaveFocus();

    // Tab forward through all focusable elements
    await user.tab();
    // ... eventually circles back to close button

    // Shift+Tab should go backwards
    await user.keyboard('{Shift>}{Tab}{/Shift}');
    expect(sendButton).toHaveFocus();
  });
});
```

### Keyboard Navigation Tests

**Keyboard Interaction Test:**
```typescript
// tests/accessibility/keyboard-navigation.test.tsx

import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { AICopilotChat } from '@/components/ai/copilot-chat';

describe('Keyboard Navigation', () => {
  it('supports complete keyboard workflow', async () => {
    const user = userEvent.setup();

    render(<AICopilotChat />);

    // Open chat widget with Enter
    const openButton = screen.getByRole('button', { name: /open/i });
    openButton.focus();
    await user.keyboard('{Enter}');

    // Focus should move to chat input
    const input = screen.getByLabelText(/message/i);
    expect(input).toHaveFocus();

    // Type message
    await user.type(input, 'Test message');

    // Send with Enter
    await user.keyboard('{Enter}');

    // Close with Escape
    await user.keyboard('{Escape}');

    // Focus returns to open button
    expect(openButton).toHaveFocus();
  });

  it('maintains logical tab order', async () => {
    const user = userEvent.setup();

    render(<AICopilotChat isOpen />);

    const elements = [
      screen.getByRole('button', { name: /close/i }),
      screen.getByLabelText(/message/i),
      screen.getByRole('button', { name: /send/i }),
      screen.getByRole('button', { name: /info/i })
    ];

    // Tab through all elements in order
    for (const element of elements) {
      await user.tab();
      expect(element).toHaveFocus();
    }
  });

  it('supports arrow key navigation in message history', async () => {
    const user = userEvent.setup();

    const messages = [
      { id: '1', author: 'user', content: 'Message 1' },
      { id: '2', author: 'assistant', content: 'Message 2' },
      { id: '3', author: 'user', content: 'Message 3' }
    ];

    render(<AICopilotChat messages={messages} />);

    const messageList = screen.getByRole('log');
    messageList.focus();

    // Arrow down to navigate messages
    await user.keyboard('{ArrowDown}');
    // First message should be highlighted/focused

    await user.keyboard('{ArrowDown}');
    // Second message should be highlighted/focused
  });
});
```

### Screen Reader Tests

**ARIA Live Region Test:**
```typescript
// tests/accessibility/screen-reader.test.tsx

import { render, screen, waitFor } from '@testing-library/react';
import { ChatPanel } from '@/components/ai/chat-panel';

describe('Screen Reader Support', () => {
  it('announces new messages via ARIA live region', async () => {
    const { rerender } = render(
      <ChatPanel messages={[]} onSendMessage={() => {}} />
    );

    // Add new message
    const newMessages = [{
      id: '1',
      author: 'assistant',
      content: 'Hello, how can I help you today?',
      createdAt: Date.now()
    }];

    rerender(<ChatPanel messages={newMessages} onSendMessage={() => {}} />);

    // Check for ARIA live region with polite announcement
    const liveRegion = await screen.findByRole('status');
    expect(liveRegion).toHaveAttribute('aria-live', 'polite');
    expect(liveRegion).toHaveAttribute('aria-atomic', 'true');
    expect(liveRegion).toHaveTextContent('Hello, how can I help you today?');
  });

  it('announces loading state', async () => {
    render(<ChatPanel messages={[]} onSendMessage={() => {}} isLoading />);

    const loadingStatus = screen.getByRole('status');
    expect(loadingStatus).toHaveTextContent(/loading/i);
  });

  it('announces error messages', async () => {
    render(
      <ChatPanel
        messages={[]}
        onSendMessage={() => {}}
        error="Failed to send message"
      />
    );

    const errorAlert = screen.getByRole('alert');
    expect(errorAlert).toHaveTextContent('Failed to send message');
  });

  it('labels chat widget button descriptively', () => {
    render(<AICopilotWidget unreadCount={3} />);

    const button = screen.getByRole('button');
    expect(button).toHaveAccessibleName('Open AI Copilot chat, 3 unread messages');
  });
});
```

### E2E Tests with Playwright

**Chat Flow E2E Test:**
```typescript
// tests/e2e/chat-flow.spec.ts

import { test, expect } from '@playwright/test';
import { injectAxe, checkA11y } from '@axe-core/playwright';

test.describe('AI Copilot E2E', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('http://localhost:3000?demo=true');
    await injectAxe(page);
  });

  test('complete chat conversation flow', async ({ page }) => {
    // Open chat widget
    await page.click('button[aria-label*="Open AI Copilot"]');

    // Wait for panel to open
    await expect(page.locator('[role="region"][aria-label*="chat"]')).toBeVisible();

    // Type message
    await page.fill('textarea[aria-label*="message"]', 'What is a small claims case?');

    // Send message
    await page.click('button[aria-label="Send message"]');

    // Wait for response
    await expect(page.locator('text=A small claims case')).toBeVisible({ timeout: 10000 });

    // Verify accessibility
    await checkA11y(page);
  });

  test('handles errors gracefully', async ({ page }) => {
    // Open chat
    await page.click('button[aria-label*="Open AI Copilot"]');

    // Mock API error
    await page.route('**/api/ai/copilot/chat', (route) => {
      route.fulfill({
        status: 500,
        body: JSON.stringify({ error: 'Service unavailable' })
      });
    });

    // Send message
    await page.fill('textarea[aria-label*="message"]', 'Test');
    await page.click('button[aria-label="Send message"]');

    // Verify error is announced
    await expect(page.locator('[role="alert"]')).toBeVisible();
    await expect(page.locator('[role="alert"]')).toContainText('Service unavailable');

    // Verify accessibility of error state
    await checkA11y(page);
  });

  test('keyboard navigation works throughout flow', async ({ page }) => {
    // Tab to open button
    await page.keyboard.press('Tab');
    await expect(page.locator('button[aria-label*="Open AI Copilot"]')).toBeFocused();

    // Open with Enter
    await page.keyboard.press('Enter');

    // Focus should move to input
    await expect(page.locator('textarea[aria-label*="message"]')).toBeFocused();

    // Type and send with keyboard
    await page.keyboard.type('Hello');
    await page.keyboard.press('Enter');

    // Close with Escape
    await page.keyboard.press('Escape');

    // Focus returns to trigger button
    await expect(page.locator('button[aria-label*="Open AI Copilot"]')).toBeFocused();
  });

  test('screen reader announces messages correctly', async ({ page }) => {
    await page.click('button[aria-label*="Open AI Copilot"]');

    // Send message
    await page.fill('textarea[aria-label*="message"]', 'Test');
    await page.click('button[aria-label="Send message"]');

    // Wait for response
    await page.waitForSelector('[role="status"]');

    // Verify ARIA live region exists and contains response
    const liveRegion = page.locator('[role="status"][aria-live="polite"]');
    await expect(liveRegion).toBeVisible();

    // Verify it contains assistant response
    await expect(liveRegion).not.toBeEmpty();
  });

  test('meets WCAG AA color contrast', async ({ page }) => {
    await page.click('button[aria-label*="Open AI Copilot"]');

    // Check accessibility including color contrast
    await checkA11y(page, null, {
      rules: {
        'color-contrast': { enabled: true }
      }
    });
  });
});
```

**Context Switching E2E Test:**
```typescript
// tests/e2e/context-switching.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Context Switching', () => {
  test('maintains conversation when switching cases', async ({ page }) => {
    await page.goto('http://localhost:3000/cases/case-1?demo=true');

    // Open chat and send message
    await page.click('button[aria-label*="Open AI Copilot"]');
    await page.fill('textarea[aria-label*="message"]', 'What is my next step?');
    await page.click('button[aria-label="Send message"]');

    // Wait for response
    await page.waitForSelector('text=next step', { timeout: 10000 });

    // Navigate to different case
    await page.goto('http://localhost:3000/cases/case-2?demo=true');

    // Chat should show new context
    await page.click('button[aria-label*="Open AI Copilot"]');

    // Verify new conversation or context indicator
    await expect(page.locator('[role="region"][aria-label*="chat"]')).toBeVisible();
  });
});
```

### CI/CD Integration

**GitHub Actions Workflow:**
```yaml
# .github/workflows/accessibility-tests.yml

name: Accessibility & E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  accessibility-tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility linting
        run: npm run lint:a11y

      - name: Run accessibility unit tests
        run: npm run test:a11y

      - name: Build application
        run: npm run build

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-results
          path: playwright-report/

      - name: Comment PR with accessibility results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const results = fs.readFileSync('accessibility-results.json', 'utf8');
            const data = JSON.parse(results);

            const comment = `## Accessibility Test Results

            - Total Tests: ${data.totalTests}
            - Passed: ${data.passed}
            - Failed: ${data.failed}
            - WCAG Violations: ${data.violations}

            ${data.failed === 0 ? '✅ All accessibility tests passed!' : '❌ Some tests failed - review results'}`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
```

### Accessibility Checklist

**Component Accessibility Checklist:**
```markdown
## AI Copilot Accessibility Checklist

### Keyboard Accessibility
- [ ] All interactive elements reachable via keyboard
- [ ] Logical tab order maintained
- [ ] Enter/Space activate buttons
- [ ] Escape closes modals/panels
- [ ] No keyboard traps

### Screen Reader Support
- [ ] All images have alt text
- [ ] Form inputs have labels
- [ ] Buttons have descriptive text
- [ ] ARIA labels for icon-only buttons
- [ ] ARIA live regions for dynamic content
- [ ] Status messages announced
- [ ] Error messages announced

### Visual Design
- [ ] Text contrast ≥ 4.5:1 (WCAG AA)
- [ ] Large text contrast ≥ 3:1
- [ ] Focus indicators visible (3:1 contrast)
- [ ] Color not sole indicator of meaning
- [ ] Text resizable to 200% without loss of content

### Semantic HTML
- [ ] Proper heading hierarchy
- [ ] Landmarks used appropriately
- [ ] Lists marked up as lists
- [ ] Buttons vs links used correctly

### Testing
- [ ] Tested with keyboard only
- [ ] Tested with screen reader
- [ ] Automated accessibility scan passed
- [ ] Color contrast verified
- [ ] E2E tests include accessibility checks
```

### Source Tree
```
tests/
├── accessibility/
│   ├── chat-widget.a11y.test.tsx
│   ├── chat-panel.a11y.test.tsx
│   ├── keyboard-navigation.test.tsx
│   └── screen-reader.test.tsx
├── e2e/
│   ├── chat-flow.spec.ts
│   ├── context-switching.spec.ts
│   └── error-handling.spec.ts
└── accessibility-checklist.md

.github/workflows/
└── accessibility-tests.yml

playwright.config.ts         # NEW: Playwright configuration
```

### package.json Scripts

```json
{
  "scripts": {
    "test:a11y": "jest --testMatch='**/*.a11y.test.tsx'",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "lint:a11y": "eslint --ext .tsx --plugin jsx-a11y components/",
    "test:all": "npm run test:a11y && npm run test:e2e"
  }
}
```

### Dependencies
- jest-axe for accessibility testing
- Playwright for E2E tests
- @axe-core/playwright for accessibility in E2E
- eslint-plugin-jsx-a11y for linting
- @testing-library/react for component tests

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent*

### Debug Log References
_To be populated by dev agent*

### Completion Notes List
_To be populated by dev agent*

### File List
_To be populated by dev agent*

## QA Results
_To be populated by QA agent*
