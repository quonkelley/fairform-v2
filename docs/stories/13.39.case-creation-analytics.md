# Story 13.39: Case Creation Analytics & Metrics

## Status
ðŸ“‹ Planned

## Story
**As a** product manager,
**I want** to track case creation funnel metrics,
**so that** I can identify drop-off points and improve conversion rates.

## Acceptance Criteria

1. Tracks case creation funnel: started â†’ info gathering â†’ confirmation â†’ completed
2. Records drop-off stage for abandoned conversations
3. Tracks time-to-complete for successful case creations
4. Counts messages exchanged during case creation
5. Tracks which case types convert best
6. Dashboard showing conversion rate by case type
7. Identifies most common drop-off stage
8. Tracks suggestion chip usage and effectiveness
9. Privacy-conscious (no PII logged)
10. Real-time dashboard updates

## Tasks / Subtasks

- [ ] Task 1: Define analytics events (AC: 1, 2, 3, 4)
  - [ ] Create event schema
  - [ ] Define funnel stages
  - [ ] Add event tracking calls

- [ ] Task 2: Implement event tracking (AC: All)
  - [ ] Track "case_creation_started"
  - [ ] Track "case_creation_stage_change"
  - [ ] Track "case_creation_completed"
  - [ ] Track "case_creation_abandoned"
  - [ ] Track "suggestion_chip_used"

- [ ] Task 3: Analytics dashboard (AC: 6, 7, 10)
  - [ ] Create admin dashboard page
  - [ ] Show funnel visualization
  - [ ] Show conversion rate by case type
  - [ ] Show average time-to-complete
  - [ ] Show drop-off analysis

- [ ] Task 4: Privacy compliance (AC: 9)
  - [ ] Strip PII from events
  - [ ] Anonymize user IDs
  - [ ] Follow GDPR/CCPA guidelines

- [ ] Task 5: Testing (AC: All)
  - [ ] Test event tracking
  - [ ] Verify dashboard accuracy
  - [ ] Load test with high volume

## Dev Notes

### Analytics Events Schema

```typescript
// Event: case_creation_started
{
  event: 'case_creation_started',
  timestamp: Date,
  userId: string, // Hashed
  sessionId: string,
  source: 'copilot' | 'intake_form'
}

// Event: case_creation_stage_change
{
  event: 'case_creation_stage_change',
  timestamp: Date,
  sessionId: string,
  fromStage: ConversationStage,
  toStage: ConversationStage,
  messageCount: number,
  secondsElapsed: number
}

// Event: case_creation_completed
{
  event: 'case_creation_completed',
  timestamp: Date,
  sessionId: string,
  caseType: string,
  totalMessages: number,
  totalSeconds: number,
  suggestionsUsed: number
}

// Event: case_creation_abandoned
{
  event: 'case_creation_abandoned',
  timestamp: Date,
  sessionId: string,
  lastStage: ConversationStage,
  messagesExchanged: number,
  reasonInferred?: string
}

// Event: suggestion_chip_used
{
  event: 'suggestion_chip_used',
  timestamp: Date,
  sessionId: string,
  chipText: string,
  stage: ConversationStage
}
```

### Tracking Implementation

```typescript
// lib/analytics/caseCreationTracking.ts
import { analytics } from '@/lib/firebase';
import { logEvent } from 'firebase/analytics';

export function trackCaseCreationStarted(userId: string, sessionId: string) {
  logEvent(analytics, 'case_creation_started', {
    user_id: hashUserId(userId), // Hash for privacy
    session_id: sessionId,
    source: 'copilot'
  });
}

export function trackStageChange(
  sessionId: string,
  fromStage: ConversationStage,
  toStage: ConversationStage,
  messageCount: number,
  secondsElapsed: number
) {
  logEvent(analytics, 'case_creation_stage_change', {
    session_id: sessionId,
    from_stage: fromStage,
    to_stage: toStage,
    message_count: messageCount,
    seconds_elapsed: secondsElapsed
  });
}

export function trackCaseCreationCompleted(
  sessionId: string,
  caseType: string,
  totalMessages: number,
  totalSeconds: number,
  suggestionsUsed: number
) {
  logEvent(analytics, 'case_creation_completed', {
    session_id: sessionId,
    case_type: caseType,
    total_messages: totalMessages,
    total_seconds: totalSeconds,
    suggestions_used: suggestionsUsed
  });
}
```

### Dashboard Queries

```typescript
// Calculate conversion rate
const started = await getEventCount('case_creation_started', dateRange);
const completed = await getEventCount('case_creation_completed', dateRange);
const conversionRate = (completed / started) * 100;

// Find most common drop-off stage
const abandonedEvents = await getEvents('case_creation_abandoned', dateRange);
const dropOffStages = countBy(abandonedEvents, 'lastStage');
```

### Dashboard UI

```typescript
export function CaseCreationDashboard() {
  return (
    <div className="dashboard">
      <h1>Case Creation Funnel</h1>

      {/* Funnel visualization */}
      <FunnelChart
        stages={[
          { name: 'Started', count: 1000 },
          { name: 'Gathering Info', count: 750 },
          { name: 'Confirmation', count: 500 },
          { name: 'Completed', count: 450 }
        ]}
      />

      {/* Conversion rate by case type */}
      <CaseTypeConversion
        data={[
          { caseType: 'eviction', started: 500, completed: 350, rate: 70 },
          { caseType: 'small_claims', started: 300, completed: 180, rate: 60 }
        ]}
      />

      {/* Average metrics */}
      <MetricsGrid>
        <Metric label="Avg Time to Complete" value="4.2 min" />
        <Metric label="Avg Messages" value="8.5" />
        <Metric label="Conversion Rate" value="45%" />
      </MetricsGrid>

      {/* Drop-off analysis */}
      <DropOffAnalysis
        stages={[
          { stage: 'GREET', abandonedCount: 100 },
          { stage: 'GATHER_MIN', abandonedCount: 250 },
          { stage: 'CONFIRM_CREATE', abandonedCount: 50 }
        ]}
      />
    </div>
  );
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Product Team |

