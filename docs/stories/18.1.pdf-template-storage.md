# Story 18.1: PDF Template Storage & Basic Upload

## Status
Planned

## Story
**As a** FairForm developer,
**I want** basic Firebase Storage setup to store PDF templates and completed forms,
**so that** the form filler can load templates and save generated PDFs.

## Acceptance Criteria

1. Firebase Storage is configured and accessible via client SDK
2. Storage structure defined: `forms/templates/` and `forms/completed/{userId}/{caseId}/`
3. Basic storage repository (`storageRepo.ts`) with upload and download URL methods
4. Demo mode uses `/public/demo/forms/` directory (no Firebase calls)
5. Marion County Appearance form template stored in demo folder
6. Simple storage security rules allow authenticated user access
7. Unit tests for storageRepo with mocked Firebase Storage

## Tasks / Subtasks

- [ ] Task 1: Set up Firebase Storage client (AC: 1)
  - [ ] Update `lib/firebase.ts` to initialize Firebase Storage
  - [ ] Export `getFirebaseStorage()` function
  - [ ] Test connection in browser console

- [ ] Task 2: Create basic storage repository (AC: 3)
  - [ ] Create `lib/db/storageRepo.ts`
  - [ ] Add `StorageRepositoryError` class
  - [ ] Implement `uploadFile(path: string, file: File): Promise<Result<string>>`
  - [ ] Implement `getDownloadUrl(path: string): Promise<Result<string>>`
  - [ ] Implement `deleteFile(path: string): Promise<Result<void>>`
  - [ ] Use existing `Result` pattern from other repos

- [ ] Task 3: Add demo mode storage (AC: 4, 5)
  - [ ] Create `public/demo/forms/` directory
  - [ ] Add blank Marion County Appearance PDF template
  - [ ] Create `lib/demo/demoStorageAdapter.ts`
  - [ ] Implement in-memory Map for demo uploads
  - [ ] Return `/demo/forms/` paths for demo templates

- [ ] Task 4: Define storage structure (AC: 2)
  - [ ] Document storage paths in `docs/architecture/storage-structure.md`
  - [ ] Create path builder utility functions
  - [ ] `getTemplatePath(jurisdiction: string, formType: string): string`
  - [ ] `getCompletedFormPath(userId: string, caseId: string, formId: string): string`

- [ ] Task 5: Create storage security rules (AC: 6)
  - [ ] Create `storage.rules` file
  - [ ] Allow read access to `forms/templates/` for all authenticated users
  - [ ] Allow read/write to `forms/completed/{userId}/` only for that user
  - [ ] Deploy rules: `firebase deploy --only storage`

- [ ] Task 6: Create unit tests (AC: 7)
  - [ ] Test uploadFile success and error cases
  - [ ] Test getDownloadUrl with valid and invalid paths
  - [ ] Test deleteFile
  - [ ] Mock Firebase Storage SDK
  - [ ] Test demo mode adapter returns correct paths

## Dev Notes

### Architecture Context
This is the foundation for Epic 18 (Smart Form Filler). We're starting minimal - just enough storage infrastructure to upload templates and save completed PDFs.

**Keep It Simple:**
- No complex metadata tracking yet (defer to later stories)
- No file validation beyond basic type check (defer to Epic 14 security)
- No storage quotas or usage tracking (nice-to-have)
- Demo mode uses static files in `/public` (fast, no API calls)

### Storage Structure (MVP)
```
Firebase Storage:
forms/
├── templates/
│   └── marion/
│       └── appearance-template.pdf
└── completed/
    └── {userId}/
        └── {caseId}/
            └── {formId}_{timestamp}.pdf

Local Demo:
public/demo/forms/
└── marion-appearance-template.pdf
```

### Repository Pattern
Follow existing pattern from `casesRepo.ts`:
- Export functions (not class)
- Use `Result<T>` pattern for return types
- Custom error class for specific errors
- Try/catch around Firebase calls
- Clear error messages

### Firebase Storage Setup
Add to `lib/firebase.ts`:
```typescript
import { getStorage, type FirebaseStorage } from 'firebase/storage';

let storageInstance: FirebaseStorage | null = null;

export function getFirebaseStorage(): FirebaseStorage {
  if (storageInstance) return storageInstance;
  storageInstance = getStorage(firebaseApp);
  return storageInstance;
}
```

### Demo Mode Strategy
Check for demo mode early:
```typescript
export async function uploadFile(path: string, file: File, demo = false): Promise<Result<string>> {
  if (demo) {
    return demoStorageAdapter.uploadFile(path, file);
  }
  // Real Firebase upload
}
```

### Path Builders
```typescript
export function getTemplatePath(jurisdiction: string, formType: string): string {
  return `forms/templates/${jurisdiction}/${formType}-template.pdf`;
}

export function getCompletedFormPath(userId: string, caseId: string, formId: string): string {
  const timestamp = Date.now();
  return `forms/completed/${userId}/${caseId}/${formId}_${timestamp}.pdf`;
}
```

### Storage Security Rules (Basic)
```
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /forms/templates/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if false; // Admin only (manual upload)
    }

    match /forms/completed/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
```

### Source Tree
```
lib/
├── firebase.ts                    # MODIFY: Add getFirebaseStorage()
├── db/
│   └── storageRepo.ts            # NEW: Storage operations
└── demo/
    └── demoStorageAdapter.ts     # NEW: Demo mode storage

public/demo/forms/
└── marion-appearance-template.pdf # NEW: Demo template

storage.rules                      # NEW: Security rules
```

### Testing
Use Vitest with mocked Firebase Storage:
```typescript
vi.mock('firebase/storage', () => ({
  getStorage: vi.fn(),
  ref: vi.fn(),
  uploadBytes: vi.fn(),
  getDownloadURL: vi.fn(),
  deleteObject: vi.fn()
}));
```

### Dependencies
- `firebase` package (already installed)
- Blank Marion County Appearance PDF (get from county website or create simple template)
- Firebase project with Storage enabled (already done: `fairform-demo.firebasestorage.app`)

### Implementation Notes
- File size limit: 10MB for forms (client-side check only for MVP)
- Accepted file types: `application/pdf` only for templates
- Demo mode adapter uses in-memory Map, cleared on page reload
- No progress indicators in this story (add in UI story)

### Out of Scope (Defer)
- File validation (magic numbers, virus scan) → Epic 14
- Storage quotas and usage tracking → Post-MVP
- Thumbnail generation → Not needed
- CDN optimization → Not needed for demo
- Bulk operations → Not needed yet

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | PM |

## Dev Agent Record

### Agent Model Used
_To be filled by implementing agent_

### Debug Log References
_To be filled by implementing agent_

### Completion Notes List
_To be filled by implementing agent_

### File List
_To be filled by implementing agent_

## QA Results

### Test Results
_To be filled by QA_

### Acceptance Criteria Validation
_To be filled by QA_

### Next Steps
After completing Story 18.1, proceed to Story 18.2 (PDF Generation with pdf-lib).
