# Story 13.6: Chat Panel Component

## Status
Draft

## Story
**As a** FairForm user,
**I want** a chat panel that opens from the widget and provides a full conversational interface,
**so that** I can have extended conversations with the AI Copilot.

## Acceptance Criteria

1. Chat panel opens as modal/overlay when widget is clicked
2. Panel displays conversation history with proper message formatting
3. Panel includes input field for typing new messages
4. Panel shows typing indicators when AI is responding
5. Panel supports message sending via Enter key or send button
6. Panel displays message timestamps and author identification
7. Panel handles SSE streaming for real-time message updates
8. Panel is accessible via keyboard navigation and screen readers

## Tasks / Subtasks

- [ ] Task 1: Create chat panel component structure (AC: 1)
  - [ ] Create `components/ai-copilot/ChatPanel.tsx`
  - [ ] Implement modal/overlay with backdrop
  - [ ] Add panel header with title and close button
  - [ ] Position panel appropriately (bottom-right, full-height on mobile)
  - [ ] Handle panel open/close state and animations

- [ ] Task 2: Implement message display area (AC: 2, 6)
  - [ ] Create scrollable message container
  - [ ] Display messages with proper formatting (user vs assistant)
  - [ ] Show message timestamps in readable format
  - [ ] Add message author identification (user/assistant)
  - [ ] Implement auto-scroll to bottom on new messages

- [ ] Task 3: Create message input interface (AC: 3, 5)
  - [ ] Add text input field with placeholder text
  - [ ] Implement Enter key submission (Shift+Enter for new line)
  - [ ] Add send button with icon
  - [ ] Handle input validation and character limits
  - [ ] Clear input after successful message send

- [ ] Task 4: Implement typing indicators (AC: 4)
  - [ ] Show "AI is typing..." indicator during responses
  - [ ] Add animated dots for typing animation
  - [ ] Hide indicator when response completes
  - [ ] Handle connection status in typing indicator

- [ ] Task 5: Integrate SSE streaming (AC: 7)
  - [ ] Connect to chat API with EventSource
  - [ ] Handle meta, delta, and done events
  - [ ] Stream message content in real-time
  - [ ] Update UI with streaming content
  - [ ] Handle stream errors and reconnection

- [ ] Task 6: Add accessibility features (AC: 8)
  - [ ] Add ARIA labels and roles
  - [ ] Implement keyboard navigation (Tab, Escape)
  - [ ] Add screen reader announcements for new messages
  - [ ] Ensure proper focus management
  - [ ] Add high contrast mode support

- [ ] Task 7: Implement responsive design (AC: 1)
  - [ ] Mobile: Full-screen panel
  - [ ] Tablet: Side panel with backdrop
  - [ ] Desktop: Floating panel in corner
  - [ ] Handle orientation changes
  - [ ] Adjust message layout for different screens

- [ ] Task 8: Add message formatting and styling (AC: 2)
  - [ ] Style user messages (right-aligned, blue background)
  - [ ] Style assistant messages (left-aligned, gray background)
  - [ ] Add message bubbles with proper spacing
  - [ ] Handle long messages with word wrapping
  - [ ] Add message status indicators (sending, sent, failed)

## Dev Notes

### Architecture Context
[Source: docs/epic-13-unified-architecture-specification.md]

The chat panel provides the main conversational interface for AI Copilot interactions. It handles **real-time messaging**, **SSE streaming**, and **responsive design** while maintaining accessibility standards.

**Key Design Decisions:**
- Modal overlay for desktop, full-screen for mobile
- SSE streaming for real-time responses
- Auto-scrolling message history
- Keyboard-first interaction design
- Accessible message formatting

### Component Structure

**ChatPanel.tsx:**
```typescript
interface ChatPanelProps {
  isOpen: boolean;
  onClose: () => void;
  sessionId?: string;
  caseId?: string;
  className?: string;
}

interface Message {
  id: string;
  author: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: number;
  status?: 'sending' | 'sent' | 'failed';
}

export function ChatPanel({
  isOpen,
  onClose,
  sessionId,
  caseId
}: ChatPanelProps) {
  // Component implementation
}
```

### Panel Layout

**Desktop Layout:**
```typescript
const panelClasses = `
  fixed bottom-24 right-6 z-50
  w-96 h-[600px]
  bg-white rounded-lg shadow-xl
  border border-gray-200
  flex flex-col
  md:w-[400px] md:h-[700px]
`;

const headerClasses = `
  flex items-center justify-between
  p-4 border-b border-gray-200
  bg-gray-50 rounded-t-lg
`;

const messagesClasses = `
  flex-1 overflow-y-auto
  p-4 space-y-4
`;

const inputClasses = `
  p-4 border-t border-gray-200
  bg-white rounded-b-lg
`;
```

**Mobile Layout:**
```typescript
const mobilePanelClasses = `
  fixed inset-0 z-50
  bg-white
  flex flex-col
  sm:bottom-24 sm:right-6 sm:w-96 sm:h-[600px] sm:rounded-lg
`;
```

### Message Formatting

**Message Bubble Styles:**
```typescript
const getUserMessageClasses = (status?: string) => `
  ml-auto max-w-[80%]
  bg-blue-600 text-white
  px-4 py-2 rounded-lg
  ${status === 'sending' ? 'opacity-70' : ''}
  ${status === 'failed' ? 'bg-red-500' : ''}
`;

const getAssistantMessageClasses = () => `
  mr-auto max-w-[80%]
  bg-gray-100 text-gray-900
  px-4 py-2 rounded-lg
  border border-gray-200
`;
```

**Message Component:**
```typescript
function MessageBubble({ message }: { message: Message }) {
  const isUser = message.author === 'user';
  const timeString = new Date(message.timestamp).toLocaleTimeString([], {
    hour: '2-digit',
    minute: '2-digit'
  });
  
  return (
    <div className={`flex ${isUser ? 'justify-end' : 'justify-start'}`}>
      <div className={`${isUser ? getUserMessageClasses(message.status) : getAssistantMessageClasses()}`}>
        <p className="text-sm whitespace-pre-wrap">{message.content}</p>
        <p className={`text-xs mt-1 ${isUser ? 'text-blue-100' : 'text-gray-500'}`}>
          {timeString}
        </p>
      </div>
    </div>
  );
}
```

### SSE Streaming Implementation

**EventSource Setup:**
```typescript
function useChatStream(sessionId: string) {
  const [isStreaming, setIsStreaming] = useState(false);
  const [currentMessage, setCurrentMessage] = useState('');
  
  const sendMessage = useCallback(async (content: string) => {
    setIsStreaming(true);
    setCurrentMessage('');
    
    try {
      const response = await fetch('/api/ai/copilot/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream'
        },
        body: JSON.stringify({
          message: content,
          sessionId: sessionId || undefined
        })
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const reader = response.body?.getReader();
      const decoder = new TextDecoder();
      
      while (true) {
        const { done, value } = await reader!.read();
        if (done) break;
        
        const chunk = decoder.decode(value);
        const lines = chunk.split('\n');
        
        for (const line of lines) {
          if (line.startsWith('event: ')) {
            const eventType = line.slice(7);
            // Handle meta, delta, done events
          } else if (line.startsWith('data: ')) {
            const data = JSON.parse(line.slice(6));
            // Process event data
          }
        }
      }
    } catch (error) {
      console.error('Stream error:', error);
    } finally {
      setIsStreaming(false);
    }
  }, [sessionId]);
  
  return { sendMessage, isStreaming, currentMessage };
}
```

### Typing Indicator

**Animated Typing Dots:**
```typescript
function TypingIndicator() {
  return (
    <div className="flex items-center space-x-1 p-3">
      <div className="flex space-x-1">
        {[0, 1, 2].map((i) => (
          <motion.div
            key={i}
            className="w-2 h-2 bg-gray-400 rounded-full"
            animate={{
              scale: [1, 1.2, 1],
              opacity: [0.5, 1, 0.5]
            }}
            transition={{
              duration: 1.5,
              repeat: Infinity,
              delay: i * 0.2
            }}
          />
        ))}
      </div>
      <span className="text-sm text-gray-500 ml-2">AI is typing...</span>
    </div>
  );
}
```

### Input Component

**Message Input with Validation:**
```typescript
function MessageInput({ onSend }: { onSend: (message: string) => void }) {
  const [input, setInput] = useState('');
  const [isSending, setIsSending] = useState(false);
  
  const handleSubmit = async (e: FormEvent) => {
    e.preventDefault();
    
    if (!input.trim() || isSending) return;
    
    const message = input.trim();
    setInput('');
    setIsSending(true);
    
    try {
      await onSend(message);
    } finally {
      setIsSending(false);
    }
  };
  
  const handleKeyDown = (e: KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e);
    }
  };
  
  return (
    <form onSubmit={handleSubmit} className="flex items-end space-x-2">
      <div className="flex-1">
        <textarea
          value={input}
          onChange={(e) => setInput(e.target.value)}
          onKeyDown={handleKeyDown}
          placeholder="Type your message... (Shift+Enter for new line)"
          className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          rows={1}
          maxLength={2000}
          disabled={isSending}
        />
      </div>
      <button
        type="submit"
        disabled={!input.trim() || isSending}
        className="p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <Send className="w-5 h-5" />
      </button>
    </form>
  );
}
```

### Accessibility Implementation

**ARIA Labels and Roles:**
```typescript
<div
  role="dialog"
  aria-modal="true"
  aria-labelledby="chat-panel-title"
  className={panelClasses}
>
  <div className={headerClasses}>
    <h2 id="chat-panel-title" className="text-lg font-semibold">
      AI Copilot
    </h2>
    <button
      onClick={onClose}
      aria-label="Close chat panel"
      className="p-2 hover:bg-gray-200 rounded-lg"
    >
      <X className="w-5 h-5" />
    </button>
  </div>
  
  <div
    role="log"
    aria-live="polite"
    aria-label="Chat messages"
    className={messagesClasses}
  >
    {/* Messages */}
  </div>
  
  <div className={inputClasses}>
    <MessageInput onSend={sendMessage} />
  </div>
</div>
```

### Source Tree
```
components/
└── ai-copilot/
    ├── ChatWidget.tsx      # EXISTING: From Story 13.5
    ├── ChatPanel.tsx       # NEW: Chat panel component
    ├── MessageBubble.tsx   # NEW: Individual message component
    ├── TypingIndicator.tsx # NEW: Typing animation
    ├── MessageInput.tsx    # NEW: Input component
    └── index.ts            # MODIFIED: Export all components

lib/
└── hooks/
    └── useChatStream.ts    # NEW: SSE streaming hook
```

### Responsive Breakpoints

**Tailwind Responsive Classes:**
```typescript
const getPanelClasses = () => `
  fixed z-50
  inset-0
  sm:bottom-24 sm:right-6 sm:inset-auto
  sm:w-96 sm:h-[600px]
  md:w-[400px] md:h-[700px]
  bg-white rounded-lg shadow-xl
  border border-gray-200
  flex flex-col
`;
```

### Integration with Chat Widget

**Parent Component Usage:**
```typescript
function AICopilotContainer() {
  const [isChatOpen, setIsChatOpen] = useState(false);
  const { sessionId, unreadCount } = useAICopilot();
  
  return (
    <>
      <ChatWidget
        isOpen={isChatOpen}
        onToggle={() => setIsChatOpen(!isChatOpen)}
        unreadCount={unreadCount}
      />
      
      <AnimatePresence>
        {isChatOpen && (
          <ChatPanel
            isOpen={isChatOpen}
            onClose={() => setIsChatOpen(false)}
            sessionId={sessionId}
          />
        )}
      </AnimatePresence>
    </>
  );
}
```

### Testing

**Test Location:** `components/ai-copilot/ChatPanel.test.tsx`

**Test Coverage:**
- Panel rendering and positioning
- Message display and formatting
- Input handling and validation
- SSE streaming integration
- Keyboard accessibility
- Responsive behavior
- Close functionality

**Example Test:**
```typescript
describe('ChatPanel', () => {
  it('renders chat panel when open', () => {
    render(<ChatPanel isOpen={true} onClose={jest.fn()} />);
    
    expect(screen.getByRole('dialog')).toBeInTheDocument();
    expect(screen.getByText('AI Copilot')).toBeInTheDocument();
  });
  
  it('sends message on Enter key', async () => {
    const onSend = jest.fn();
    render(<ChatPanel isOpen={true} onClose={jest.fn()} />);
    
    const input = screen.getByPlaceholderText('Type your message...');
    fireEvent.change(input, { target: { value: 'Hello AI' } });
    fireEvent.keyDown(input, { key: 'Enter' });
    
    await waitFor(() => {
      expect(onSend).toHaveBeenCalledWith('Hello AI');
    });
  });
  
  it('closes panel when Escape key is pressed', () => {
    const onClose = jest.fn();
    render(<ChatPanel isOpen={true} onClose={onClose} />);
    
    fireEvent.keyDown(document, { key: 'Escape' });
    
    expect(onClose).toHaveBeenCalled();
  });
});
```

### Performance Considerations
- Virtual scrolling for large message histories
- Debounced auto-scroll to bottom
- Memoized message components
- Lazy loading of heavy animations

### Dependencies
- framer-motion (existing)
- lucide-react (existing)
- React Query (for state management)
- EventSource API (browser native)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
