# Story 13.31: Structured Information Extraction (GPT Functions)

## Status
ðŸ“‹ Planned

## Story
**As a** system extracting case information from user messages,
**I want** to use OpenAI function calling for structured extraction,
**so that** extraction accuracy improves from ~70% to ~90%+.

## Acceptance Criteria

1. Replaces current regex patterns in `conversationStages.ts`
2. Extracts case type with 90%+ accuracy
3. Handles jurisdiction variations (city, county, state names/abbreviations)
4. Extracts dates in various formats (MM/DD/YYYY, "January 15", "next Friday")
5. Returns confidence scores for each extracted field (0.0-1.0)
6. Falls back gracefully if extraction fails
7. Processing time < 2 seconds per message
8. Works with conversational, informal language

## Tasks / Subtasks

- [ ] Task 1: Define OpenAI function schema (AC: 2, 3, 4)
  - [ ] Create extraction function definition
  - [ ] Define parameters for all case fields
  - [ ] Add enum constraints for case types
  - [ ] Add format specifications for dates

- [ ] Task 2: Implement extraction service (AC: 1, 5, 7)
  - [ ] Create `lib/ai/structuredExtraction.ts`
  - [ ] Call OpenAI with function definition
  - [ ] Parse function call response
  - [ ] Return confidence scores
  - [ ] Handle API errors

- [ ] Task 3: Replace regex patterns (AC: 1)
  - [ ] Update `extractCaseInfo()` in conversationStages.ts
  - [ ] Maintain backward compatibility
  - [ ] Add feature flag for rollout

- [ ] Task 4: Testing and validation (AC: All)
  - [ ] Test with 100+ real messages
  - [ ] Measure accuracy improvements
  - [ ] Test edge cases
  - [ ] Performance benchmarks

## Dev Notes

### OpenAI Function Definition

```typescript
const extractionFunction = {
  name: "extract_case_info",
  description: "Extract legal case information from user message",
  parameters: {
    type: "object",
    properties: {
      caseType: {
        type: "string",
        enum: [
          "eviction",
          "small_claims",
          "family_law",
          "debt",
          "employment",
          "housing",
          "consumer",
          "contract",
          "discrimination",
          "other"
        ],
        description: "Type of legal case"
      },
      jurisdiction: {
        type: "string",
        description: "City, county, or state where case is filed"
      },
      caseNumber: {
        type: "string",
        description: "Court case number if mentioned"
      },
      hearingDate: {
        type: "string",
        description: "Court hearing date in ISO format if mentioned"
      },
      confidence: {
        type: "object",
        properties: {
          caseType: { type: "number", minimum: 0, maximum: 1 },
          jurisdiction: { type: "number", minimum: 0, maximum: 1 },
          caseNumber: { type: "number", minimum: 0, maximum: 1 },
          hearingDate: { type: "number", minimum: 0, maximum: 1 }
        }
      }
    }
  }
};
```

### Implementation

```typescript
// lib/ai/structuredExtraction.ts
export async function extractCaseInfoAI(message: string): Promise<ExtractionResult> {
  const response = await openai.chat.completions.create({
    model: "gpt-4o-mini",
    messages: [{
      role: "user",
      content: message
    }],
    functions: [extractionFunction],
    function_call: { name: "extract_case_info" }
  });

  const functionCall = response.choices[0].message.function_call;
  if (!functionCall) {
    return { info: {}, confidence: {} };
  }

  const extracted = JSON.parse(functionCall.arguments);
  
  return {
    info: {
      caseType: extracted.caseType,
      jurisdiction: extracted.jurisdiction,
      caseNumber: extracted.caseNumber,
      hearingDate: extracted.hearingDate
    },
    confidence: extracted.confidence || {}
  };
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Product Team |

