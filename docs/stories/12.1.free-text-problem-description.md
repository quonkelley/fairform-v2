# Story 12.1: Free-Text Problem Description

## Status
Draft

## Story
**As a** self-represented litigant using FairForm,
**I want** to describe my legal problem in plain language using a text input,
**so that** I can easily explain my situation without navigating complex legal forms.

## Acceptance Criteria

1. `/intake` page exists and is accessible only when user has AI participation enabled (Story 11.3).
2. Page displays clear disclaimer: "AI features provide educational guidance only, not legal advice."
3. Page shows large textarea (minimum 250px height) for problem description.
4. Textarea has helpful placeholder text: "Describe your legal issue in your own words..."
5. Submit button is disabled until text meets minimum length (20 characters).
6. Character counter shows current length and minimum required (e.g., "15 / 20 characters minimum").
7. Submit button shows loading spinner during API call.
8. Form is keyboard accessible with proper Tab order and focus management.
9. Page meets WCAG 2.1 AA accessibility standards (zero jest-axe violations).

## Tasks / Subtasks

- [ ] Task 1: Create intake page route with access control (AC: 1)
  - [ ] Create `app/intake/page.tsx` as authenticated server component
  - [ ] Use `requireAuth` for authentication check
  - [ ] Use `checkAIAccess` helper from Story 11.3 to verify AI participation
  - [ ] If access denied, redirect to `/settings?message=enable_ai`
  - [ ] If access granted, render IntakePage client component

- [ ] Task 2: Create IntakePage client component (AC: 2, 3, 4, 5, 6)
  - [ ] Create `components/intake/IntakePage.tsx`
  - [ ] Use shadcn/ui Card for main container
  - [ ] Add page title with BETA badge: "AI-Assisted Intake (Experimental Beta)"
  - [ ] Add disclaimer Alert component (warning variant)
  - [ ] Disclaimer text: "AI features provide educational guidance only, not legal advice."
  - [ ] Add link to compliance docs: "Learn More" → `/docs/06_Compliance.md`
  - [ ] Create large Textarea component (min-height: 250px)
  - [ ] Placeholder: "Describe your legal issue in your own words. For example: 'My landlord won't fix the broken heater...' or 'I was injured at work and...' Be as specific as you can about what happened and when."
  - [ ] Add character counter below textarea
  - [ ] Format: "{current} / 20 characters minimum" (muted when < 20, primary when ≥ 20)

- [ ] Task 3: Implement form state management (AC: 5, 6, 7)
  - [ ] Use React useState for textarea value
  - [ ] Track character count in real-time
  - [ ] Calculate `isValid` (text.length >= 20)
  - [ ] Submit button disabled when !isValid
  - [ ] Track `isSubmitting` state for loading spinner
  - [ ] Disable textarea and button during submission
  - [ ] Clear textarea after successful submission (for future use)

- [ ] Task 4: Create submission handler (AC: 7)
  - [ ] Create placeholder handler `handleSubmit`
  - [ ] Set `isSubmitting = true`
  - [ ] Log text to console (for Story 12.1 only - will integrate API in 12.2)
  - [ ] Simulate 1s delay with setTimeout
  - [ ] Set `isSubmitting = false`
  - [ ] Show success toast: "Analyzing your situation..."
  - [ ] Store text in component state for Story 12.3
  - [ ] Note: Full API integration happens in Story 12.2

- [ ] Task 5: Add helpful UI elements (AC: 3, 4, 6)
  - [ ] Add "Tips for best results" expandable section (Accordion component)
  - [ ] Tips content:
    - "Include when the issue started"
    - "Mention any important dates or deadlines"
    - "Describe what you've tried so far"
    - "Include names of people or organizations involved"
  - [ ] Add privacy reassurance text (muted, small):
    - "Your information is private and secure. We'll help you understand your situation step by step."
  - [ ] Add estimated time indicator: "This will take about 2-3 minutes"

- [ ] Task 6: Implement accessibility features (AC: 8, 9)
  - [ ] Page title (H1): "Describe Your Legal Issue"
  - [ ] Textarea has proper label: "Problem Description"
  - [ ] Associate helper text with textarea using aria-describedby
  - [ ] Submit button has descriptive aria-label: "Submit description for AI analysis"
  - [ ] Disclaimer has role="alert" for immediate screen reader announcement
  - [ ] Loading state announced with aria-live="polite"
  - [ ] Focus management: Focus textarea on page load
  - [ ] Keyboard: Tab order is logical (disclaimer link → textarea → tips → submit)

- [ ] Task 7: Add responsive design (AC: 9)
  - [ ] Mobile (< 768px):
    - Single column layout
    - Full-width textarea
    - Stack submit button below textarea
    - Minimum 16px font size to prevent zoom on iOS
  - [ ] Desktop (≥ 768px):
    - Max-width 800px container, centered
    - Textarea fills available width
    - Submit button aligned right
  - [ ] Test at 360px, 768px, 1024px breakpoints

- [ ] Task 8: Create comprehensive tests (AC: All)
  - [ ] Route protection tests:
    - Redirects unauthenticated users
    - Redirects users without AI participation
    - Allows users with AI participation enabled
  - [ ] Component tests:
    - Renders disclaimer and textarea
    - Character counter updates correctly
    - Submit button disabled when text < 20 chars
    - Submit button enabled when text ≥ 20 chars
    - Loading spinner shows during submission
    - Form fields disabled during submission
    - Tips accordion expands/collapses
  - [ ] Accessibility tests:
    - Zero jest-axe violations
    - Proper ARIA labels and roles
    - Focus management works correctly
    - Screen reader announcements tested
  - [ ] Responsive tests:
    - Layout adapts at breakpoints
    - Touch targets ≥ 44x44px on mobile
    - Font sizes prevent zoom

## Dev Notes

### **Previous Story Insights**
- Story 11.3: AI participation toggle and checkAIAccess helper implemented
- Toast notifications (Sonner) configured
- shadcn/ui components installed (Card, Alert, Textarea, Button, Badge, Accordion)
- Authentication and route protection patterns established

### **AI Spike Infrastructure** (Already Complete)
- ✅ `/api/ai/intake/route.ts` - API endpoint with moderation and GPT-4o-mini
- ✅ `lib/ai/schemas.ts` - Request/Response schemas
- ✅ `lib/ai/prompts/intake.ts` - System prompt
- ✅ `lib/ai/moderate.ts` - Content moderation
- ✅ `lib/ai/logs.ts` - Anonymized logging

### **Page Structure**
```
┌─────────────────────────────────────┐
│ 🧠 AI-Assisted Intake    [BETA]     │ ← H1 + Badge
├─────────────────────────────────────┤
│ ⚠️  AI features provide educational  │ ← Alert (warning)
│ guidance only, not legal advice.    │
│ Learn More →                        │
├─────────────────────────────────────┤
│                                     │
│ Describe Your Legal Issue           │ ← Label
│ ┌─────────────────────────────────┐│
│ │ Describe your legal issue in... ││ ← Textarea (250px)
│ │                                  ││
│ │                                  ││
│ └─────────────────────────────────┘│
│ 15 / 20 characters minimum          │ ← Counter
│                                     │
│ ▼ Tips for best results             │ ← Accordion
│                                     │
│                   [Submit] → | 🔄   │ ← Button
│                                     │
│ 🔒 Your information is private      │ ← Privacy text
│ ⏱️  Takes about 2-3 minutes          │ ← Time estimate
└─────────────────────────────────────┘
```

### **File Locations** [Source: architecture/source-tree.md]
- Route: `app/intake/page.tsx` (new file - server component)
- Component: `components/intake/IntakePage.tsx` (new file - client component)
- Helper: `lib/auth/check-ai-access.ts` (from Story 11.3)
- Tests:
  - `tests/intake/intake-page.test.tsx` (new file)
  - `tests/intake/intake-route.test.tsx` (new file)

### **Access Control Flow** (from Story 11.3)
```typescript
// app/intake/page.tsx
import { requireAuth } from '@/lib/auth/server-auth';
import { checkAIAccess } from '@/lib/auth/check-ai-access';
import { redirect } from 'next/navigation';
import { IntakePage } from '@/components/intake/IntakePage';
export default async function Intake() {
  // Authenticate
  const user = await requireAuth();
  
  // Check AI access (user opt-in)
  const access = await checkAIAccess(user.uid);
  
  if (!access.allowed) {
    redirect('/settings?message=enable_ai');
  }

  return <IntakePage user={user} />;
}
```

### **Component Pattern**
```typescript
// components/intake/IntakePage.tsx
'use client';

import { useState } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Textarea } from '@/components/ui/textarea';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from '@/components/ui/accordion';
import { Loader2 } from 'lucide-react';
import { toast } from 'sonner';

export function IntakePage({ user }: IntakePageProps) {
  const [text, setText] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);

  const isValid = text.trim().length >= 20;
  const charCount = text.length;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!isValid || isSubmitting) return;

    setIsSubmitting(true);
    
    try {
      // TODO Story 12.2: Integrate with /api/ai/intake
      console.log('Submitting:', text);
      
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      toast.success('Analyzing your situation...');
      
      // TODO Story 12.3: Navigate to results
    } catch (error) {
      toast.error('Failed to submit. Please try again.');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="container max-w-3xl mx-auto py-8 px-4">
      <Card>
        <CardHeader>
          <div className="flex items-center gap-2">
            <CardTitle className="text-2xl">🧠 AI-Assisted Intake</CardTitle>
            <Badge variant="secondary">Experimental Beta</Badge>
          </div>
          <CardDescription>
            Describe your legal issue in plain language and we'll help you understand your options.
          </CardDescription>
        </CardHeader>
        
        <CardContent className="space-y-6">
          {/* Disclaimer */}
          <Alert>
            <AlertDescription>
              ⚠️ AI features provide educational guidance only, not legal advice.{' '}
              <a 
                href="/docs/06_Compliance.md" 
                target="_blank" 
                rel="noopener noreferrer"
                className="underline hover:text-primary"
              >
                Learn More →
              </a>
            </AlertDescription>
          </Alert>

          {/* Form */}
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="space-y-2">
              <label htmlFor="problem-text" className="text-sm font-medium">
                Describe Your Legal Issue
              </label>
              <Textarea
                id="problem-text"
                value={text}
                onChange={(e) => setText(e.target.value)}
                placeholder="Describe your legal issue in your own words. For example: 'My landlord won't fix the broken heater...' or 'I was injured at work and...' Be as specific as you can about what happened and when."
                className="min-h-[250px] text-base"
                disabled={isSubmitting}
                aria-describedby="char-count tips"
                autoFocus
              />
              <p 
                id="char-count" 
                className={`text-sm ${isValid ? 'text-primary' : 'text-muted-foreground'}`}
              >
                {charCount} / 20 characters minimum
              </p>
            </div>

            {/* Tips Accordion */}
            <Accordion type="single" collapsible>
              <AccordionItem value="tips" id="tips">
                <AccordionTrigger className="text-sm">
                  💡 Tips for best results
                </AccordionTrigger>
                <AccordionContent className="text-sm text-muted-foreground space-y-2">
                  <ul className="list-disc pl-5 space-y-1">
                    <li>Include when the issue started</li>
                    <li>Mention any important dates or deadlines</li>
                    <li>Describe what you've tried so far</li>
                    <li>Include names of people or organizations involved</li>
                  </ul>
                </AccordionContent>
              </AccordionItem>
            </Accordion>

            {/* Submit Button */}
            <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
              <div className="text-xs text-muted-foreground space-y-1">
                <p>🔒 Your information is private and secure</p>
                <p>⏱️  This will take about 2-3 minutes</p>
              </div>
              
              <Button
                type="submit"
                disabled={!isValid || isSubmitting}
                className="w-full sm:w-auto"
                aria-label="Submit description for AI analysis"
              >
                {isSubmitting ? (
                  <>
                    <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                    Analyzing...
                  </>
                ) : (
                  'Submit'
                )}
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

### **Character Counter Logic**
```typescript
// Minimum length: 20 characters (from IntakeRequestSchema)
const MIN_LENGTH = 20;
const isValid = text.trim().length >= MIN_LENGTH;

// Visual feedback
const counterColor = isValid ? 'text-primary' : 'text-muted-foreground';
const counterText = `${text.length} / ${MIN_LENGTH} characters minimum`;
```

### **Accessibility Requirements**
- Page title (H1) clear and descriptive
- Textarea properly labeled
- Helper text associated with aria-describedby
- Disclaimer has role="alert" for screen reader announcement
- Loading state announced with aria-live
- Focus management: Textarea focused on page load
- All interactive elements reachable via keyboard
- Touch targets ≥ 44x44px on mobile

### **Testing Strategy**
```typescript
// tests/intake/intake-page.test.tsx
describe('IntakePage', () => {
  it('renders disclaimer and form', () => {
    render(<IntakePage user={mockUser} />);
    expect(screen.getByText(/AI features provide educational guidance/)).toBeInTheDocument();
    expect(screen.getByLabelText('Describe Your Legal Issue')).toBeInTheDocument();
  });

  it('disables submit until minimum length', () => {
    render(<IntakePage user={mockUser} />);
    const textarea = screen.getByRole('textbox');
    const submit = screen.getByRole('button', { name: /Submit/ });
    
    expect(submit).toBeDisabled();
    
    fireEvent.change(textarea, { target: { value: 'Short text under 20 chars' } });
    expect(submit).toBeEnabled();
  });

  it('shows loading state during submission', async () => {
    render(<IntakePage user={mockUser} />);
    const textarea = screen.getByRole('textbox');
    const submit = screen.getByRole('button', { name: /Submit/ });
    
    fireEvent.change(textarea, { target: { value: 'A problem description over 20 characters long' } });
    fireEvent.click(submit);
    
    expect(screen.getByText('Analyzing...')).toBeInTheDocument();
    expect(textarea).toBeDisabled();
  });
});
```

### **Technical Constraints**
- TypeScript strict mode - no `any` types
- User opt-in required for access
- Server component for access control, client component for interactivity
- Minimum 20 characters (from IntakeRequestSchema)
- shadcn/ui components for consistency
- Mobile-first responsive design
- WCAG 2.1 AA accessibility compliance

### **Integration Points**
- Story 11.3: Uses checkAIAccess helper for access control
- Story 12.2: Will integrate with /api/ai/intake endpoint
- Story 12.3: Will pass text to summary/confirmation screen
- Authentication: Uses requireAuth

### **Out of Scope for Story 12.1**
- API integration with /api/ai/intake (Story 12.2)
- Displaying AI results (Story 12.3)
- Editing summary (Story 12.4)
- Saving to Firestore (Story 12.4)
- Analytics/logging (Story 12.5)
- File uploads (Future Phase 3)
- Voice-to-text (Future Phase 3)
- Multi-turn conversation (Future Phase 2)

### **Performance Requirements** (from Epic 12 PRD)
- Page load ≤ 1.5s on 3G mobile
- Textarea responsive to typing (no input lag)
- Submit button state updates immediately
- No unnecessary re-renders

### **UX Copy Guidelines**
- Empathetic, non-intimidating tone
- Eighth-grade reading level
- Action-oriented ("Describe" not "Enter")
- Educational, not advisory
- Privacy-conscious messaging

## Testing

- Use Vitest + React Testing Library per `CLAUDE.md`.
- Test access control (authentication, AI opt-in).
- Test form validation (character count, submit disabled).
- Test loading states and disabled inputs during submission.
- Accessibility: jest-axe for zero violations, keyboard walkthrough.
- Responsive: Test at multiple breakpoints.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-11 | 0.1 | Initial draft created from Epic 12 PRD | SM Agent (Bob) |
