# Story 15.1: Import Parser & Fixtures

## Status
Ready for Review

## Story
**As a** FairForm demo presenter,  
**I want** the Marion County eviction notice asset parsed into typed case data,  
**so that** the demo can auto-create the eviction case immediately after an upload.

## Acceptance Criteria

1. A Marion County eviction notice JSON fixture exists containing the structured case fields (`caseType`, `court`, `hearingDate`, `noticeDate`, parties, address) plus glossary metadata required by the demo. Case numbers follow Indiana Uniform Case Numbering System format (49-K01-YYMM-EV-NNNNN).
2. `parseDemoNotice(fileName)` reads the matching fixture, validates the schema, and returns a typed success result; unknown filenames or malformed data return a typed error without throwing.
3. Vitest unit tests cover the happy path, an unsupported filename, and malformed JSON scenarios (syntax errors, missing required fields, invalid field types); fixtures expose timeline/glossary metadata used by downstream import consumers.

## Tasks / Subtasks

- [x] Task 1: Define typed notice payload contracts (AC: 1, 2)
  - [x] Describe notice result type covering case payload, timeline seeds, glossary keys
  - [x] **Document field mapping between notice JSON and Case schema (caseNumber → case metadata, hearingDate → step due dates)**
  - [x] Align result shape with `Case` and `CaseStep` fields used in demo scenarios
  - [x] Export types from `lib/demo/types.ts` or inline in `importNotice.ts`
  - [x] Export discriminated union for success vs error results
- [x] Task 2: Create Marion County eviction fixture (AC: 1)
  - [x] **Create `lib/demo/imports/eviction.notice.json` fixture file**
  - [x] Author fixture with values mirroring current eviction scenario (case number, hearing date, parties, address)
  - [x] **Include glossary term IDs matching eviction scenario (e.g., 'eviction-notice', 'answer', 'default-judgment')**
  - [x] Add timeline and reminder metadata placeholders for downstream stories
- [x] Task 3: Implement `parseDemoNotice` (AC: 2)
  - [x] **Create parser utility at `lib/demo/importNotice.ts`**
  - [x] Load fixture assets from `lib/demo/imports/` directory based on filename
  - [x] Validate schema before returning data
  - [x] **Add simulated delay using demoConfig.timing.scanDelay (1500ms)**
  - [x] Map parsed data into typed result structure
  - [x] Return typed error for unknown filename or invalid payload
- [x] Task 4: Add Vitest coverage (AC: 3)
  - [x] Test happy path fixture parsing returns structured data
  - [x] Test unsupported filename returns typed error without throwing
  - [x] **Test malformed JSON (syntax error), missing required fields, and invalid field types**
  - [x] Snapshot result structure for regression safety
- [x] Task 5: Document demo repository reset contract (AC: 1, 2, 3)
  - [x] Record expected repository interaction for downstream stories in story Dev Notes
  - [x] Identify follow-up tasks for scenario merge utility (link to Story 15.2)

## Dev Notes

### Previous Story Insights
- No completed Epic 15 stories exist yet; treat this story as the starting point for the case import flow.

### Data Models
- Demo repositories mirror the production `Case` and `CaseStep` schemas; ensure fixture fields align with those structures (`caseType`, `jurisdiction`, parties, due dates). [Source: docs/architecture/data-model.md:11]
- **Critical Field Mapping**: Notice JSON fields must map to Case schema - caseNumber maps to case metadata, hearingDate maps to step due dates, parties map to case participants. [Source: lib/demo/scenarios/eviction.ts:13-16]
- **Glossary Integration**: Eviction scenario uses glossaryTerms object with IDs like 'eviction-notice', 'answer', 'default-judgment'; steps have glossaryKeys arrays for downstream enrichment. [Source: lib/demo/scenarios/eviction.ts:25-35]

### Marion County Case Data Standards
- Use Indiana Uniform Case Numbering System (Admin Rule 8): [County]-[Court]-[YYMM]-[Type]-[Sequence]
- Marion County code: 49
- Center Township Small Claims Court code: K01
- Eviction case type: EV
- Example: 49K01-2510-EV-001234 [Source: research/Marion_County_Civil_Data_Access_Research.md:139-145]

### Timeline Calculations
- 10-day notice period for non-payment evictions
- 5-day response period after service
- 2-3 week hearing scheduling typical
- Calculate step due dates based on these periods [Source: research/Claude_Marion_County_Civil_Deep_Research.md:83-99]

### API Specifications
- No specific API endpoints are invoked in this story; repository integration occurs in later stories. No specific guidance found in architecture docs.

### Component Specifications
- UI components are not part of this story’s scope. No specific guidance found in architecture docs.

### File Locations
- Demo scenarios and repositories live under `lib/demo/**`; place fixtures and parser utilities alongside existing demo data modules. [Source: docs/architecture/DEMO-ARCHITECTURE-ROBUST.md:31]
- Tests should reside under `tests/` mirroring source paths (e.g., `tests/lib/demo/importNotice.test.ts`). [Source: docs/architecture/source-tree.md:37]

### Technical Constraints
- Maintain TypeScript strict typing for parser utilities and result unions. [Source: docs/architecture/tech-stack.md:6]
- Follow repository separation—keep parsing logic in `lib/demo` utilities rather than UI components. [Source: docs/architecture/coding-standards.md:7]
- Implement resilient states by returning structured errors instead of throwing, supporting graceful demo degradation. [Source: docs/architecture/DEMO-ARCHITECTURE-ROBUST.md:7]
- **Simulated Processing Delay**: Use demoConfig.timing.scanDelay (1500ms) to mimic OCR processing time, aligning with demo architecture timing patterns. [Source: docs/architecture/DEMO-ARCHITECTURE-ROBUST.md:45]

### Project Structure Notes
- Ensure new files follow the established `lib/demo` module organization; no structural conflicts identified.

#### Testing
- Use Vitest with React Testing Library utilities where needed; place specs alongside mirror path under `tests/`. [Source: docs/architecture/tech-stack.md:10]
- Maintain coverage expectations for repository-adjacent utilities (≥80%) and include error-path assertions. [Source: docs/architecture/coding-standards.md:38]

### Demo Repository Reset Contract

**Repository Interaction for Downstream Stories:**

The `parseDemoNotice` function provides structured data that downstream stories (particularly Story 15.2 - Scenario Merge Utility) will consume to create demo cases. The expected repository interaction pattern is:

1. **Input**: `ParsedNoticeResult` from `parseDemoNotice(fileName)`
2. **Case Creation**: Use `result.case` fields to populate `Case` schema
3. **Step Generation**: Use `result.timeline` dates to calculate `CaseStep` due dates
4. **Glossary Integration**: Use `result.glossaryKeys` to enrich steps with glossary terms
5. **Repository Storage**: Store via `demoRepos.cases.create()` and `demoRepos.steps.create()`

**Key Integration Points:**
- `result.case.caseNumber` → `Case.caseNumber`
- `result.case.jurisdiction` → `Case.jurisdiction` 
- `result.timeline.responseDueDate` → `CaseStep.dueDate` for "File Answer" step
- `result.timeline.hearingDate` → `CaseStep.dueDate` for "Attend Court Hearing" step
- `result.glossaryKeys` → Used to populate `CaseStep.glossaryKeys` arrays

**Follow-up Tasks for Story 15.2:**
- Implement scenario merge utility that consumes `ParsedNoticeResult`
- Create case and step records from parsed notice data
- Integrate with existing eviction scenario template
- Handle repository reset/cleanup for demo state management

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story draft for parser and fixtures work | Bob (Scrum Master) |
| 2025-10-16 | 1.1 | Applied PO review refinements: added field mapping details, glossary integration contract, test specificity, and processing delay context | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
Claude 3.5 Sonnet (via Cursor)

### Debug Log References
- Created `lib/demo/types.ts` with typed notice payload contracts
- Updated `lib/demo/imports/eviction.notice.json` to match demo user name
- Implemented `lib/demo/importNotice.ts` with parseDemoNotice function
- Added comprehensive test coverage in `tests/lib/demo/importNotice.test.ts`

### Completion Notes List
- **Task 1**: Defined comprehensive type contracts for Marion County eviction notices including MarionCountyEvictionNotice, ParsedNoticeResult, and discriminated union ParseNoticeResult
- **Task 2**: Verified and updated existing eviction fixture to align with demo user (Alex Rodriguez) and Indiana case numbering format
- **Task 3**: Implemented parseDemoNotice with schema validation, error handling, and simulated OCR delay using demoConfig.timing.scanDelay
- **Task 4**: Added comprehensive Vitest test coverage including happy path, error scenarios, schema validation, and snapshot tests
- **Task 5**: Documented repository reset contract and integration points for downstream stories

### File List
- `lib/demo/types.ts` - New typed contracts and field mapping documentation
- `lib/demo/importNotice.ts` - New parser utility with validation and error handling
- `lib/demo/imports/eviction.notice.json` - Updated defendant name to match demo user
- `tests/lib/demo/importNotice.test.ts` - New comprehensive test suite

## QA Results
_To be populated by QA agent after implementation review_
