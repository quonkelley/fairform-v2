# Story 13.3: Context Builder with Fingerprinting

## Status
Draft

## Story
**As a** FairForm developer,
**I want** a context builder that aggregates case, user, and session data into structured AI prompts with fingerprinting for caching,
**so that** the AI Copilot receives relevant context efficiently while maintaining performance.

## Acceptance Criteria

1. Context builder aggregates data from cases, users, and caseSteps collections
2. Uses allowlist approach - only includes approved fields, never raw PII text
3. Generates structured context JSON with fingerprint hash for caching
4. Supports conversation summarization for older message history
5. Integrates with glossary system for legal term definitions
6. Handles demo mode with sample/sandbox data
7. Context size optimization keeps prompts under token limits
8. Unit tests cover all context building scenarios

## Tasks / Subtasks

- [ ] Task 1: Create context builder module (AC: 1, 2)
  - [ ] Create `lib/ai/contextBuilder.ts`
  - [ ] Define ALLOWLISTED_CASE_FIELDS constant with approved fields
  - [ ] Define ALLOWLISTED_USER_FIELDS constant
  - [ ] Implement buildContext function accepting userId, caseId?, sessionId?
  - [ ] Import required repos: casesRepo, usersRepo, stepsRepo, aiSessionsRepo

- [ ] Task 2: Implement allowlist filtering (AC: 2)
  - [ ] Create filterCaseData function to extract only allowlisted fields
  - [ ] Create filterUserData function for user preferences
  - [ ] Create filterStepData function for current step context
  - [ ] Never include free-text narratives or raw user input
  - [ ] Log filtered data for debugging (hash only, not raw content)

- [ ] Task 3: Implement context fingerprinting (AC: 3)
  - [ ] Create generateContextFingerprint function
  - [ ] Use crypto.createHash('sha256') for fingerprinting
  - [ ] Include caseType, jurisdiction, currentStepOrder, userPrefs in hash
  - [ ] Return fingerprint as hex string
  - [ ] Cache fingerprint with context data

- [ ] Task 4: Implement conversation summarization (AC: 4)
  - [ ] Create summarizeConversation function
  - [ ] Process last 10 messages if available
  - [ ] Generate concise summary of conversation topics
  - [ ] Limit summary to 200 characters
  - [ ] Include summary in context JSON

- [ ] Task 5: Integrate glossary system (AC: 5)
  - [ ] Import glossary data from Epic 7 implementation
  - [ ] Create extractGlossaryTerms function
  - [ ] Identify legal terms in case context
  - [ ] Include short definitions in context JSON
  - [ ] Limit to 5 most relevant terms

- [ ] Task 6: Implement demo mode support (AC: 6)
  - [ ] Create getDemoContext function
  - [ ] Return sample case data for demo sessions
  - [ ] Use consistent demo data across sessions
  - [ ] Ensure demo context is clearly marked

- [ ] Task 7: Optimize context size (AC: 7)
  - [ ] Implement context size estimation
  - [ ] Limit total context to ~2000 tokens
  - [ ] Prioritize recent/current information
  - [ ] Truncate older context if needed
  - [ ] Add context size to debug logs

- [ ] Task 8: Create comprehensive tests (AC: 8)
  - [ ] Test allowlist filtering with various data
  - [ ] Test fingerprint generation and caching
  - [ ] Test conversation summarization
  - [ ] Test demo mode context
  - [ ] Test context size optimization
  - [ ] Mock all repository dependencies

## Dev Notes

### Architecture Context
[Source: docs/epic-13-unified-architecture-specification.md]

The context builder is critical for performance - it transforms raw Firestore data into structured, optimized context for AI prompts. The **allowlist approach** ensures no PII leakage while **fingerprinting** enables efficient caching.

**Key Design Decisions:**
- Allowlist-only approach (no raw text inclusion)
- SHA-256 fingerprinting for cache keys
- Token-aware size optimization
- Conversation summarization for history
- Demo mode with consistent sample data

### Allowlisted Fields

**Case Data (ALLOWLISTED_CASE_FIELDS):**
```typescript
const ALLOWLISTED_CASE_FIELDS = [
  'caseType',           // 'eviction', 'small_claims', etc.
  'jurisdiction',       // Court location
  'status',            // 'active', 'completed'
  'currentStepOrder',   // Current step number
  'progressPct',       // Completion percentage
  'createdAt',         // Case creation date
  'updatedAt'          // Last modification
];
```

**User Data (ALLOWLISTED_USER_FIELDS):**
```typescript
const ALLOWLISTED_USER_FIELDS = [
  'aiParticipation',    // Boolean preference
  'timeZone',          // User timezone
  'tone',              // 'formal', 'friendly', 'helpful'
  'complexity'         // 'simple', 'detailed'
];
```

**NEVER Include:**
- Free-text fields (narrative, description, notes)
- Personal identifiers (names, addresses, phone)
- Raw user input from forms
- Sensitive case details

### Context Structure

```typescript
interface AIPromptContext {
  user: {
    id: string;
    timeZone?: string;
    preferences?: UserPreferences;
  };
  case?: {
    id: string;
    caseType?: string;
    jurisdiction?: string;
    currentStepOrder?: number;
    progressPct?: number;
    status?: string;
  };
  conversation?: {
    summary: string;      // Last 10 messages summary
    messageCount: number;
  };
  glossary?: Array<{
    term: string;
    definition: string;
  }>;
  summary: string;        // Concise narrative from allowlisted fields
  fingerprint: string;    // SHA-256 hash for caching
  tokenEstimate: number;  // Estimated token count
}
```

### Fingerprinting Implementation

```typescript
import crypto from 'crypto';

function generateContextFingerprint(context: PartialContext): string {
  const fingerprintData = {
    caseType: context.case?.caseType,
    jurisdiction: context.case?.jurisdiction,
    currentStepOrder: context.case?.currentStepOrder,
    userPrefs: context.user?.preferences,
    timestamp: Math.floor(Date.now() / (5 * 60 * 1000)) // 5-minute buckets
  };
  
  return crypto
    .createHash('sha256')
    .update(JSON.stringify(fingerprintData))
    .digest('hex');
}
```

### Conversation Summarization

```typescript
async function summarizeConversation(sessionId: string): Promise<string> {
  const messages = await aiSessionsRepo.listMessages(sessionId, { limit: 10 });
  
  if (messages.items.length === 0) return '';
  
  const topics = messages.items
    .filter(m => m.author === 'user')
    .map(m => m.content.substring(0, 50))
    .join(', ');
    
  return topics.length > 200 
    ? topics.substring(0, 197) + '...'
    : topics;
}
```

### Demo Mode Context

```typescript
function getDemoContext(): AIPromptContext {
  return {
    user: {
      id: 'demo-user-123',
      timeZone: 'America/Los_Angeles',
      preferences: {
        aiParticipation: true,
        tone: 'friendly',
        complexity: 'simple'
      }
    },
    case: {
      id: 'demo-case-456',
      caseType: 'small_claims',
      jurisdiction: 'Los Angeles County',
      currentStepOrder: 2,
      progressPct: 40,
      status: 'active'
    },
    summary: 'Demo case: Small claims tenant dispute in Los Angeles County',
    fingerprint: 'demo-fingerprint-123',
    tokenEstimate: 150
  };
}
```

### Source Tree
```
lib/ai/
├── contextBuilder.ts      # NEW: Main context building logic
├── types.ts              # EXISTING: From Story 13.1
└── schemas.ts            # EXISTING: From Story 13.2

lib/db/
├── aiSessionsRepo.ts     # EXISTING: From Story 13.1
├── casesRepo.ts          # EXISTING: Reference for data access
├── stepsRepo.ts          # EXISTING: Reference for step data
└── usersRepo.ts          # EXISTING: Reference for user data
```

### Glossary Integration
[Source: Epic 7 implementation]

```typescript
// Import glossary data from Epic 7
import { legalTerms } from '@/lib/glossary/terms';

function extractGlossaryTerms(context: CaseContext): GlossaryTerm[] {
  const relevantTerms = legalTerms.filter(term => 
    context.caseType?.toLowerCase().includes(term.category) ||
    context.jurisdiction?.toLowerCase().includes(term.jurisdiction)
  );
  
  return relevantTerms
    .slice(0, 5)  // Limit to 5 terms
    .map(term => ({
      term: term.name,
      definition: term.definition.substring(0, 100) // Keep short
    }));
}
```

### Performance Optimization

**Token Estimation:**
```typescript
function estimateTokenCount(context: AIPromptContext): number {
  // Rough estimation: 1 token ≈ 4 characters
  const text = JSON.stringify(context);
  return Math.ceil(text.length / 4);
}

function optimizeContextSize(context: AIPromptContext): AIPromptContext {
  const maxTokens = 2000;
  let currentTokens = estimateTokenCount(context);
  
  // Truncate conversation summary if too large
  if (currentTokens > maxTokens && context.conversation) {
    const reduction = currentTokens - maxTokens + 100; // Buffer
    const newSummaryLength = Math.max(50, context.conversation.summary.length - reduction);
    context.conversation.summary = context.conversation.summary.substring(0, newSummaryLength);
  }
  
  return context;
}
```

### Testing

**Test Location:** `lib/ai/contextBuilder.test.ts`

**Test Coverage:**
- Allowlist filtering with various data structures
- Fingerprint generation consistency
- Demo mode context generation
- Context size optimization
- Glossary term extraction
- Conversation summarization
- Error handling for missing data

**Example Test:**
```typescript
describe('contextBuilder', () => {
  describe('buildContext', () => {
    it('filters case data according to allowlist', async () => {
      const mockCase = {
        id: 'case-123',
        caseType: 'small_claims',
        jurisdiction: 'LA County',
        narrative: 'This should be filtered out', // Should not appear
        // ... other fields
      };
      
      const context = await buildContext('user-123', 'case-123');
      expect(context.case?.caseType).toBe('small_claims');
      expect(context.summary).not.toContain('This should be filtered out');
    });
    
    it('generates consistent fingerprints', async () => {
      const context1 = await buildContext('user-123', 'case-123');
      const context2 = await buildContext('user-123', 'case-123');
      
      expect(context1.fingerprint).toBe(context2.fingerprint);
    });
  });
});
```

### Dependencies
- crypto (Node.js built-in)
- aiSessionsRepo from Story 13.1
- casesRepo, usersRepo, stepsRepo (existing)
- Glossary system from Epic 7

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
