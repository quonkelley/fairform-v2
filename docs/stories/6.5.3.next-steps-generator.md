# Story 6.5.3: Next Steps Generator & Panel

## Status: Draft

## Story

As a **FairForm user**,
I want **actionable next steps displayed in a dedicated panel**,
So that **I can clearly see what specific actions I need to take next in my case**.

## Context Source

- Source Document: Case Detail Realignment Plan
- Enhancement Type: Next steps generation and display panel
- Existing System Impact: Adds right-column panel with actionable guidance while preserving existing timeline

## Acceptance Criteria

### Functional Requirements

1. **Next Steps Generator**: Create rule-based system for generating actionable next steps
2. **Next Steps Panel**: Build `NextStepsCard` component for right column display
3. **Case Type Integration**: Generate steps based on case type and current progress
4. **Actionable Tasks**: Display 2-3 specific, actionable tasks per case step

### Technical Requirements

5. **Rule-Based Logic**: Deterministic suggestions without AI dependency
6. **State Integration**: Next steps update when case progress changes
7. **Component Architecture**: Reusable `NextStepsCard` component with proper props

### Quality Requirements

8. **Testing**: Unit tests for next steps generation logic
9. **Accessibility**: Panel meets WCAG 2.1 AA standards
10. **Performance**: Next steps generation ≤ 100ms

## Tasks / Subtasks

- [ ] **Task 1**: Create next steps generation system
  - [ ] Create `lib/nextSteps/generate.ts` file
  - [ ] Implement rule-based next steps logic
  - [ ] Add case type and step-specific suggestions
  - [ ] Create next steps data structures

- [ ] **Task 2**: Build NextStepsCard component
  - [ ] Create `components/case-detail/NextStepsCard.tsx`
  - [ ] Implement responsive card layout
  - [ ] Add proper accessibility attributes
  - [ ] Style with design system components

- [ ] **Task 3**: Integrate with case progress state
  - [ ] Connect next steps to case progress updates
  - [ ] Add React Query integration for state management
  - [ ] Implement real-time updates when steps complete
  - [ ] Add loading and error states

- [ ] **Task 4**: Add comprehensive testing
  - [ ] Unit tests for next steps generation
  - [ ] Component tests for NextStepsCard
  - [ ] Integration tests with case state
  - [ ] Accessibility tests for panel

## Dev Notes

### Previous Story Context

This story builds on Stories 6.5.1 and 6.5.2:
- Case type enum and status adapter foundation
- Template system with Small Claims journey
- Repository pattern with progress calculation

### Technical Implementation

**Next Steps Generation:**
```typescript
// lib/nextSteps/generate.ts
export interface NextStep {
  id: string;
  title: string;
  description: string;
  actionType: 'form' | 'document' | 'review' | 'submit' | 'wait' | 'meeting' | 'communication';
  estimatedTime?: number;
  priority: 'high' | 'medium' | 'low';
}

export function generateNextSteps(
  caseType: CaseType,
  currentStep: number,
  completedSteps: number[]
): NextStep[] {
  const rules = getRulesForCaseType(caseType);
  return rules
    .filter(rule => rule.appliesToStep(currentStep))
    .map(rule => rule.generateSteps())
    .flat()
    .slice(0, 3); // Limit to 3 actionable steps
}
```

**Next Steps Rules (Small Claims Examples):**
- **Step 1 (File Claim)**: "Download court form", "Gather supporting documents", "Review filing requirements"
- **Step 2 (Serve Defendant)**: "Obtain defendant's address", "Choose service method", "Complete service affidavit"
- **Step 3 (Prepare Hearing)**: "Organize evidence", "Practice presentation", "Review court procedures"

**NextStepsCard Component:**
```typescript
// components/case-detail/NextStepsCard.tsx
interface NextStepsCardProps {
  caseId: string;
  caseType: CaseType;
  currentStep: number;
}

export function NextStepsCard({ caseId, caseType, currentStep }: NextStepsCardProps) {
  const { data: nextSteps, isLoading } = useNextSteps(caseId, caseType, currentStep);
  
  return (
    <Card className="h-fit">
      <CardHeader>
        <CardTitle>Your Next Steps</CardTitle>
        <CardDescription>
          Here's what you need to do next for your {caseType.replace('_', ' ')} case
        </CardDescription>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <Spinner label="Loading next steps" />
        ) : (
          <ul className="space-y-3">
            {nextSteps?.map((step) => (
              <NextStepItem key={step.id} step={step} />
            ))}
          </ul>
        )}
      </CardContent>
    </Card>
  );
}
```

### File Locations

**New Files:**
- `lib/nextSteps/generate.ts` - Next steps generation logic
- `lib/nextSteps/rules.ts` - Case type specific rules
- `components/case-detail/NextStepsCard.tsx` - Next steps panel component
- `components/case-detail/NextStepItem.tsx` - Individual step item component
- `lib/hooks/useNextSteps.ts` - React Query hook for next steps
- `tests/lib/nextSteps/generate.test.ts` - Generation tests
- `tests/components/case-detail/NextStepsCard.test.tsx` - Component tests

**Modified Files:**
- `lib/hooks/index.ts` - Export new hook

### Design System Integration

- Uses shadcn/ui Card components for consistent styling
- Follows established spacing and typography patterns
- Integrates with existing color scheme and accessibility standards

### Repository Pattern

- Next steps generation is pure logic (no database access)
- Uses existing case data via React Query hooks
- Maintains separation of concerns

### React Query Hook Pattern

**New Hook:**
```typescript
// lib/hooks/useNextSteps.ts
export function useNextSteps(caseId: string, caseType: CaseType, currentStep: number) {
  return useQuery({
    queryKey: ['nextSteps', caseId, caseType, currentStep],
    queryFn: () => generateNextSteps(caseType, currentStep),
    enabled: !!caseId && !!caseType,
  });
}
```

### Accessibility Requirements

- Panel has proper ARIA labels and descriptions
- Next steps are announced to screen readers
- Keyboard navigation works within the panel
- Color contrast meets WCAG 2.1 AA standards

### Testing Requirements

**Unit Tests:**
- Next steps generation logic for each case type
- Rule application and filtering
- Edge cases (no steps, completed case, etc.)

**Component Tests:**
- NextStepsCard rendering and interactions
- Loading and error states
- Accessibility attributes and keyboard navigation

**Integration Tests:**
- Hook integration with React Query
- State updates when case progress changes
- Performance with multiple case types

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- Next steps generation logic implementation
- NextStepsCard component development
- React Query hook integration

### Completion Notes List
- Rule-based next steps generation system implemented
- NextStepsCard component created with accessibility support
- React Query hook for next steps state management
- Small Claims next steps rules defined and tested

### File List
**New Files:**
- `lib/nextSteps/generate.ts` - Next steps generation logic
- `lib/nextSteps/rules.ts` - Case type specific rules
- `components/case-detail/NextStepsCard.tsx` - Next steps panel component
- `components/case-detail/NextStepItem.tsx` - Individual step item component
- `lib/hooks/useNextSteps.ts` - React Query hook for next steps
- `tests/lib/nextSteps/generate.test.ts` - Generation tests
- `tests/components/case-detail/NextStepsCard.test.tsx` - Component tests

**Modified Files:**
- `lib/hooks/index.ts` - Export new hook

### Change Log
**2025-10-10**: Initial story creation for Epic 6.5 next steps generator
- Implemented rule-based next steps generation system
- Created NextStepsCard component with accessibility support
- Added React Query hook for next steps state management

## Testing

### Test Strategy
- Unit tests for next steps generation logic
- Component tests for NextStepsCard and NextStepItem
- Integration tests with React Query and case state
- Accessibility tests for panel navigation

### Test Coverage Targets
- Next steps generation: 100% line coverage
- NextStepsCard component: 100% line coverage
- React Query hook: 100% line coverage

### Accessibility Testing
- ARIA labels and descriptions validation
- Keyboard navigation testing
- Screen reader announcement testing
- Color contrast verification

### Performance Testing
- Next steps generation benchmarks (≤ 100ms)
- Component rendering performance
- State update efficiency

## QA Results

*To be completed after implementation*

---

**Story Owner:** SM (Bob)  
**Created:** October 10, 2025  
**Epic:** 6.5 Case Detail V2 Enhancement  
**Dependencies:** Stories 6.5.1 and 6.5.2 complete
