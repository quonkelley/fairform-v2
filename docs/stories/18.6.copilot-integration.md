# Story 18.6: AI Copilot & Form Filler Integration

## Status
Planned

## Story
**As a** developer,
**I want** seamless integration between Epic 13 (AI Copilot) and Epic 18 (Form Filler),
**so that** users have a unified experience from conversation to form completion.

## Acceptance Criteria

1. ChatPanel can switch between chat mode and form mode without losing context
2. FormSession component can be embedded within ChatPanel
3. Form suggestions detected from Copilot messages trigger FormSession
4. Form completion returns to chat with success message
5. Case context flows from Copilot ‚Üí Form (pre-filling)
6. Form metadata flows from Form ‚Üí Copilot (completion tracking)
7. Demo mode works for complete flow (chat ‚Üí form ‚Üí download)
8. TypeScript types are shared between Epic 13 and Epic 18

## Tasks / Subtasks

- [ ] Task 1: Extend ChatPanel to support form mode (AC: 1, 2)
  - [ ] Add `mode` state: `'chat' | 'form'`
  - [ ] Add `activeFormId` state
  - [ ] Render FormSession when mode is 'form'
  - [ ] Render ChatThread when mode is 'chat'
  - [ ] Preserve scroll position and message history during mode switch

- [ ] Task 2: Create form suggestion detection (AC: 3)
  - [ ] Extend `Message` type to include `formSuggestion?: FormSuggestion`
  - [ ] Parse Copilot responses for form suggestions
  - [ ] Show "Start Form" button when suggestion detected
  - [ ] Auto-start form in demo mode

- [ ] Task 3: Implement form session lifecycle (AC: 4)
  - [ ] Pass `onComplete` callback to FormSession
  - [ ] Return to chat mode on completion
  - [ ] Send success message to Copilot
  - [ ] Pass `onCancel` callback to return to chat

- [ ] Task 4: Connect case context for pre-filling (AC: 5)
  - [ ] Load case data in ChatPanel using `caseId`
  - [ ] Pass case data to FormSession as prop
  - [ ] Use existing `prefillFromCase` from Story 18.3
  - [ ] Load conversation context from `contextStorage`

- [ ] Task 5: Track form completion in chat (AC: 6)
  - [ ] Send form completion event to Copilot API
  - [ ] Include form metadata (formId, downloadUrl)
  - [ ] Add form link to case dashboard
  - [ ] Update AI session with form completion

- [ ] Task 6: Create shared TypeScript types (AC: 8)
  - [ ] Create `lib/forms/types.ts` for form-specific types
  - [ ] Export `FormSuggestion` interface
  - [ ] Export `FormTemplate`, `FormField`, `FormData` interfaces
  - [ ] Import in both Epic 13 and Epic 18 files

- [ ] Task 7: Add demo mode orchestration (AC: 7)
  - [ ] Detect demo mode from config
  - [ ] Auto-trigger form suggestion in demo script
  - [ ] Pass demo flag to FormSession
  - [ ] Coordinate timing between chat and form

- [ ] Task 8: Create integration tests (AC: all)
  - [ ] Test chat ‚Üí form mode switch
  - [ ] Test form completion ‚Üí chat return
  - [ ] Test context pre-filling
  - [ ] Test demo mode complete flow
  - [ ] Test error handling (form cancellation)

## Dev Notes

### Architecture Context
This story bridges Epic 13 and Epic 18, ensuring they work together as one unified experience.

**Key Principle:** The form filler is not a separate feature - it's an extension of the conversation.

### ChatPanel Mode Management

```typescript
// components/ai-copilot/ChatPanel.tsx

type PanelMode = 'chat' | 'form';

export const ChatPanel: React.FC<ChatPanelProps> = ({ ... }) => {
  const [mode, setMode] = useState<PanelMode>('chat');
  const [activeFormId, setActiveFormId] = useState<string | null>(null);
  const [formContext, setFormContext] = useState<FormContext | null>(null);

  // Detect form suggestions in messages
  useEffect(() => {
    const lastMessage = messages[messages.length - 1];

    if (lastMessage?.formSuggestion && lastMessage.author === 'assistant') {
      // Copilot suggested a form
      setFormContext({
        formId: lastMessage.formSuggestion.formId,
        reason: lastMessage.formSuggestion.reason,
        caseId,
        caseData: loadedCaseData
      });

      // In demo mode, auto-start
      if (demoConfig.enabled) {
        handleStartForm(lastMessage.formSuggestion.formId);
      }
    }
  }, [messages]);

  const handleStartForm = (formId: string) => {
    setActiveFormId(formId);
    setMode('form');
  };

  const handleFormComplete = async (formData: FormData, downloadUrl: string) => {
    // Send completion message to chat
    await sendMessage(`[System: Form completed] ${formContext?.formId}`);

    // Return to chat mode
    setMode('chat');
    setActiveFormId(null);

    // Copilot will respond with congratulations
  };

  const handleFormCancel = () => {
    setMode('chat');
    setActiveFormId(null);
  };

  return (
    <div className="chat-panel">
      {mode === 'chat' ? (
        <>
          <ChatThread messages={messages} />
          {formContext && (
            <FormSuggestionCard
              suggestion={formContext}
              onStart={() => handleStartForm(formContext.formId)}
              onDismiss={() => setFormContext(null)}
            />
          )}
        </>
      ) : (
        <FormSession
          formId={activeFormId!}
          caseId={caseId}
          caseData={formContext?.caseData}
          onComplete={handleFormComplete}
          onCancel={handleFormCancel}
          demo={demoConfig.enabled}
        />
      )}
    </div>
  );
};
```

### Form Suggestion Type

```typescript
// lib/forms/types.ts

export interface FormSuggestion {
  formId: string;
  reason: string;
  confidence?: number;
}

// Extend Message type in Epic 13
export interface Message {
  id: string;
  author: 'user' | 'assistant';
  content: string;
  timestamp: number;
  formSuggestion?: FormSuggestion; // NEW: Form suggestion metadata
  meta?: MessageMeta;
}
```

### Copilot Response Format

```typescript
// app/api/ai/copilot/chat/route.ts

// Add to system prompt:
const formDetectionPrompt = `
FORM SUGGESTIONS:
When you determine the user needs to complete a court form, suggest it clearly.

Mention these keywords to trigger form detection:
- "file an appearance" ‚Üí marion-appearance
- "request continuance" ‚Üí marion-continuance

Format your response like:
"You'll need to file an Appearance form. I can help you fill it out now - it only takes a few minutes. Would you like to get started?"

Include metadata in your response (will be parsed by client):
FORM_SUGGESTION: formId=marion-appearance, reason=Court appearance required
`;

// Parse form suggestions from response
function parseFormSuggestion(content: string): FormSuggestion | null {
  const match = content.match(/FORM_SUGGESTION: formId=([^,]+), reason=(.+)/);
  if (match) {
    return {
      formId: match[1].trim(),
      reason: match[2].trim()
    };
  }
  return null;
}

// In SSE handler, add formSuggestion to message
const formSuggestion = parseFormSuggestion(fullResponse);
if (formSuggestion) {
  await appendMessage(session.id, {
    author: "assistant",
    content: fullResponse.replace(/FORM_SUGGESTION:.*/, '').trim(),
    meta: {
      ...metaForStorage,
      formSuggestion // Store in metadata
    }
  });
}
```

### Context Flow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Epic 13: AI Copilot                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ User: "I need to file an appearance"                    ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ Copilot detects intent ‚Üí Suggests marion-appearance    ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ ChatPanel receives message with formSuggestion          ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ Shows "Start Form" button (or auto-starts in demo)     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
                   User clicks "Start"
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Epic 18: Form Filler                                    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ FormSession starts with:                                ‚îÇ
‚îÇ   ‚Ä¢ formId: "marion-appearance"                         ‚îÇ
‚îÇ   ‚Ä¢ caseId: from ChatPanel                              ‚îÇ
‚îÇ   ‚Ä¢ caseData: loaded from Firestore                     ‚îÇ
‚îÇ   ‚Ä¢ conversation context: from sessionStorage           ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ Pre-fill fields using prefillFromCase()                 ‚îÇ
‚îÇ   ‚Ä¢ case.caseNumber ‚Üí field "case_number"              ‚îÇ
‚îÇ   ‚Ä¢ case.hearingDate ‚Üí field "hearing_date"            ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ User completes form (or auto-advances in demo)          ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ Generate PDF, upload to Storage                         ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ Call onComplete(formData, downloadUrl)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
                   Return to chat
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Epic 13: AI Copilot (Continued)                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ FormSession calls onComplete callback                   ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ ChatPanel sends completion message to Copilot           ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ Copilot: "üéâ Great! Your Appearance form is ready.     ‚îÇ
‚îÇ          [View in Dashboard]"                           ‚îÇ
‚îÇ   ‚Üì                                                     ‚îÇ
‚îÇ User continues conversation or closes chat              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Demo Mode Coordination

```typescript
// lib/demo/demoConfig.ts

export const demoConfig = {
  enabled: process.env.DEMO_MODE === 'true',

  formFiller: {
    autoStart: true, // Auto-start form when suggested
    autoAdvanceDelay: 1500, // 1.5s per field
    skipConfirmation: true // Skip "Start Form" button
  },

  copilot: {
    scriptedResponses: true,
    formSuggestionTrigger: 'appearance' // Keyword to trigger form
  }
};

// In ChatPanel demo mode
if (demoConfig.enabled && formSuggestion) {
  // Auto-start form without user clicking
  setTimeout(() => {
    handleStartForm(formSuggestion.formId);
  }, 1000); // 1s delay for visual effect
}
```

### Form Suggestion Card Component

```typescript
// components/ai-copilot/FormSuggestionCard.tsx

interface FormSuggestionCardProps {
  suggestion: {
    formId: string;
    reason: string;
  };
  onStart: () => void;
  onDismiss: () => void;
}

export function FormSuggestionCard({ suggestion, onStart, onDismiss }: FormSuggestionCardProps) {
  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-4">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <h4 className="font-semibold text-blue-900 mb-1">
            üìã Form Needed
          </h4>
          <p className="text-sm text-blue-800 mb-3">
            {suggestion.reason}
          </p>
          <button
            onClick={onStart}
            className="btn-primary"
          >
            Start Form
          </button>
        </div>
        <button onClick={onDismiss} className="text-blue-600">
          √ó
        </button>
      </div>
    </div>
  );
}
```

### Shared Types Location

```
lib/
‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îî‚îÄ‚îÄ types.ts              # Epic 13 types (existing)
‚îú‚îÄ‚îÄ forms/
‚îÇ   ‚îî‚îÄ‚îÄ types.ts              # Epic 18 form types (NEW)
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ integration.ts        # Shared integration types (NEW)
```

```typescript
// lib/types/integration.ts

import type { FormSuggestion } from '@/lib/forms/types';
import type { Message as ChatMessage } from '@/lib/ai/types';

// Extend chat message with form suggestion
export interface MessageWithFormSuggestion extends ChatMessage {
  formSuggestion?: FormSuggestion;
}

// Context passed to FormSession
export interface FormContext {
  formId: string;
  reason: string;
  caseId?: string;
  caseData?: any; // Case type from Epic 6.5
}
```

### Error Handling

```typescript
// Handle form cancellation
const handleFormCancel = () => {
  // Send cancel message to Copilot
  sendMessage("[System: User cancelled form]");

  // Copilot responds: "No problem! Let me know if you need help with anything else."

  setMode('chat');
  setActiveFormId(null);
};

// Handle form generation failure
const handleFormError = (error: Error) => {
  // Send error message to Copilot
  sendMessage(`[System: Form generation failed - ${error.message}]`);

  // Return to chat
  setMode('chat');

  // Copilot responds with retry option
};
```

### Integration Test Example

```typescript
// tests/integration/copilot-form-flow.test.tsx

describe('Copilot ‚Üí Form Filler Integration', () => {
  it('should complete full flow from chat to form download', async () => {
    // 1. Render ChatPanel
    const { getByPlaceholderText, getByText } = render(
      <ChatPanel isOpen={true} onClose={vi.fn()} caseId="test-case" />
    );

    // 2. Send message triggering form suggestion
    const input = getByPlaceholderText('Type your message...');
    await userEvent.type(input, 'I need to file an appearance');
    await userEvent.keyboard('{Enter}');

    // 3. Wait for Copilot response with form suggestion
    await waitFor(() => {
      expect(getByText(/Start Form/i)).toBeInTheDocument();
    });

    // 4. Click "Start Form"
    await userEvent.click(getByText(/Start Form/i));

    // 5. Verify FormSession is rendered
    await waitFor(() => {
      expect(getByText(/Appearance Form/i)).toBeInTheDocument();
    });

    // 6. Complete form (in test, just click Complete button)
    await userEvent.click(getByText(/Complete/i));

    // 7. Verify return to chat with success message
    await waitFor(() => {
      expect(getByText(/form is ready/i)).toBeInTheDocument();
    });
  });
});
```

### Source Tree

```
components/ai-copilot/
‚îú‚îÄ‚îÄ ChatPanel.tsx                    # MODIFY: Add form mode
‚îú‚îÄ‚îÄ FormSuggestionCard.tsx          # NEW: Form suggestion UI
‚îî‚îÄ‚îÄ FormSession.tsx                 # EXISTS: From Story 18.3

lib/
‚îú‚îÄ‚îÄ ai/
‚îÇ   ‚îî‚îÄ‚îÄ types.ts                    # MODIFY: Add formSuggestion to Message
‚îú‚îÄ‚îÄ forms/
‚îÇ   ‚îî‚îÄ‚îÄ types.ts                    # EXISTS: From Story 18.2
‚îî‚îÄ‚îÄ types/
    ‚îî‚îÄ‚îÄ integration.ts              # NEW: Shared types

app/api/ai/copilot/chat/
‚îî‚îÄ‚îÄ route.ts                        # MODIFY: Parse form suggestions

tests/integration/
‚îî‚îÄ‚îÄ copilot-form-flow.test.tsx     # NEW: E2E integration test
```

### Dependencies
- Story 18.1 (Storage) ‚úÖ
- Story 18.2 (PDF Generation) ‚è≥
- Story 18.3 (Form Collection) ‚è≥
- Story 18.4 (Download) ‚è≥
- Story 18.5 (Demo Mode) ‚è≥
- Epic 13 Stories (AI Copilot) ‚úÖ

### Implementation Notes
- Keep mode switching smooth with transitions
- Preserve message history during mode switch
- Don't lose user input if they cancel form
- Form context should include conversation summary
- Demo mode auto-advances for investor demos

### Out of Scope (Defer)
- Multiple forms in one session ‚Üí One at a time for MVP
- Form editing after completion ‚Üí Create new form
- Form drafts ‚Üí Complete in one session
- Custom form templates ‚Üí Marion County only

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | PM |

## Dev Agent Record

### Agent Model Used
_To be filled by implementing agent_

### Debug Log References
_To be filled by implementing agent_

### Completion Notes List
_To be filled by implementing agent_

### File List
_To be filled by implementing agent_

## QA Results

### Test Results
_To be filled by QA_

### Acceptance Criteria Validation
_To be filled by QA_

### Next Steps
This story should be implemented AFTER Stories 18.2-18.5 are complete, as it ties everything together.
