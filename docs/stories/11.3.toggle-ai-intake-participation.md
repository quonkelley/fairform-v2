# Story 11.3: Toggle AI Intake Participation

## Status
Draft

## Story
**As a** registered FairForm user,
**I want** to opt in or out of AI-assisted intake features,
**so that** I have control over how my legal information is processed and can choose traditional or AI-enhanced workflows.

## Acceptance Criteria

1. AI Participation section displays toggle switch with clear label and description.
2. Toggle reflects current user's `aiParticipation` setting from Firestore (default: false/OFF).
3. User can toggle AI participation on/off, and change is saved with other settings.
4. AI disclaimer text is visible near the toggle: "AI features provide educational guidance only, not legal advice."
5. Link to full compliance documentation is provided ("Learn More" → `/docs/06_Compliance.md`).
6. When AI participation is OFF, `/intake` route is inaccessible (redirects to `/settings` with message).
7. Toggle is accessible with proper ARIA attributes and keyboard navigation.
8. Changes persist across sessions and reload correctly.

## Tasks / Subtasks

- [ ] Task 1: Add AI Participation toggle to Settings page (AC: 1, 2, 3, 7)
  - [ ] Update `components/settings/SettingsPage.tsx` to include AI Participation section
  - [ ] Replace placeholder SettingsCard with functional card
  - [ ] Add shadcn/ui Switch component for aiParticipation toggle
  - [ ] Label: "Enable AI-Assisted Intake"
  - [ ] Description: "Get help describing your legal issue with AI-powered guidance"
  - [ ] Load current value from `userSettings.aiParticipation` (default: false)
  - [ ] Update form state on toggle change
  - [ ] Include toggle value in save operation (Story 11.2 save function)
  - [ ] Add proper ARIA attributes: aria-label, aria-checked, aria-describedby

- [ ] Task 2: Add AI disclaimer and compliance link (AC: 4, 5)
  - [ ] Add disclaimer text below toggle (muted color)
  - [ ] Text: "⚠️ AI features provide educational guidance only, not legal advice."
  - [ ] Add "Learn More" link pointing to compliance docs
  - [ ] Link opens in new tab (target="_blank" rel="noopener noreferrer")
  - [ ] Link accessible with keyboard (Tab navigation)
  - [ ] Style link with underline and appropriate contrast ratio
  - [ ] Add aria-label to link: "Learn more about AI features and compliance"

- [ ] Task 3: Update UserSettings type and schema (AC: 2, 8)
  - [ ] Confirm `aiParticipation: boolean` is in UserSettings interface (already in Epic 11 PRD)
  - [ ] Add to Zod schema in `lib/validation.ts`
  - [ ] Ensure it's included in DEFAULT_SETTINGS in usersRepo
  - [ ] Default value: false (user must explicitly opt-in)
  - [ ] Update TypeScript types if needed

- [ ] Task 4: Create intake route protection (AC: 6)
  - [ ] Ensure intake page reads current user settings on load
  - [ ] If `aiParticipation === false`, redirect to `/settings`
  - [ ] Show toast message: "Please enable AI features in Settings to access AI Intake"
  - [ ] If `aiParticipation === true`, render intake page
  - [ ] Document this pattern for other AI features

- [ ] Task 6: Add visual indicators for AI features (AC: 1)
  - [ ] Add "BETA" badge next to AI Participation heading
  - [ ] Use shadcn/ui Badge component (secondary variant)
  - [ ] Badge text: "Experimental Beta"
  - [ ] Add subtle background color to AI card to distinguish it
  - [ ] Use consistent styling with other AI feature indicators

- [ ] Task 7: Create intake access helper (AC: 6)
  - [ ] Create `lib/auth/check-ai-access.ts` helper function
  - [ ] Function: `checkAIAccess(userId: string): Promise<{ allowed: boolean, reason?: string }>`
  - [ ] Checks user setting for AI participation
  - [ ] Returns structured result for clear error handling
  - [ ] Reusable for future AI features
  - [ ] Write unit tests for all scenarios

- [ ] Task 8: Update Firestore security rules (AC: 8)
  - [ ] Verify users can only update their own `aiParticipation` field
  - [ ] Rule already exists from Story 11.2 (users/{uid})
  - [ ] No additional rules needed for this field
  - [ ] Document that AI feature access is checked server-side, not in rules

- [ ] Task 9: Create comprehensive tests (AC: All)
  - [ ] Component tests for Settings page:
    - AI participation toggle renders correctly
    - Toggle reflects current setting (on/off)
    - Disclaimer text is visible
    - Learn More link is present and functional
    - BETA badge is displayed
  - [ ] Integration tests:
    - Toggle on/off and save successfully
    - Setting persists on page reload
    - Disclaimer and link accessible via keyboard
  - [ ] Route protection tests:
    - Intake route accessible when aiParticipation = true
    - Intake route redirects when aiParticipation = false
    - Correct toast message shown on redirect
    - Feature flag and user setting both checked
  - [ ] Helper function tests:
    - checkAIAccess returns correct results for all scenarios
    - User opt-in OFF → not allowed
    - User opt-in ON → allowed
  - [ ] Accessibility tests:
    - Zero jest-axe violations
    - Toggle accessible via keyboard
    - Screen reader announces state changes
    - Disclaimer and link properly associated

## Dev Notes

### **Previous Story Insights**
- Story 11.1: Settings page scaffold with placeholder AI section created
- Story 11.2: Save functionality, useUserSettings hook, usersRepo all implemented
- UserSettings interface and schema exist in `lib/validation.ts`
- React Query configured for caching and mutations
- Toast notifications working (Sonner)

### **AI Access Control Flow**
```
User navigates to /intake
       ↓
Server Component (requireAuth)
       ↓
Fetch User Settings (usersRepo)
       ↓
Check aiParticipation
   false → Redirect to /settings + toast
   true → Render Intake Page
```

### **Two-Tier Access Control**
```typescript
// User Setting (individual)
interface UserSettings {
  aiParticipation: boolean; // Controls if THIS user opted in
}

// Access granted ONLY if userSettings.aiParticipation === true
```

### **UI Layout for AI Section**
```
┌─ AI Participation Card ─────────────┐
│ Enable AI-Assisted Intake    BETA  │ ← Heading + Badge
│ [●━━━━━━━━] ON                      │ ← Switch
│ Get help describing your legal      │
│ issue with AI-powered guidance      │
│                                     │
│ ⚠️ AI features provide educational  │
│ guidance only, not legal advice.    │
│ Learn More →                        │ ← Link to compliance
└─────────────────────────────────────┘
```

### **checkAIAccess Helper Pattern**
```typescript
// lib/auth/check-ai-access.ts
import * as usersRepo from '@/lib/db/usersRepo';

export interface AIAccessResult {
  allowed: boolean;
  reason?: 'user_opted_out';
}

export async function checkAIAccess(userId: string): Promise<AIAccessResult> {
  // Check user's opt-in setting
  try {
    const settings = await usersRepo.getUserSettings(userId);
    
    if (!settings?.aiParticipation) {
      return { allowed: false, reason: 'user_opted_out' };
    }

    return { allowed: true };
  } catch (error) {
    console.error('Failed to check AI access', { userId, error });
    return { allowed: false, reason: 'user_opted_out' };
  }
}
```

### **Intake Route Protection**
```typescript
// app/intake/page.tsx
import { redirect } from 'next/navigation';
import { requireAuth } from '@/lib/auth/server-auth';
import { checkAIAccess } from '@/lib/auth/check-ai-access';
import { IntakePage } from '@/components/intake/IntakePage';

export default async function Intake() {
  const user = await requireAuth();
  
  const access = await checkAIAccess(user.uid);
  
  if (!access.allowed) {
    // Redirect to settings with message
    redirect('/settings?message=enable_ai');
  }

  return <IntakePage user={user} />;
}
```

### **Settings Page URL Parameter Handling**
```typescript
// components/settings/SettingsPage.tsx
import { useSearchParams } from 'next/navigation';

export function SettingsPage({ user }: SettingsPageProps) {
  const searchParams = useSearchParams();
  const message = searchParams.get('message');

  useEffect(() => {
    if (message === 'enable_ai') {
      toast.info('Enable AI Features', {
        description: 'Turn on AI-assisted intake to access this feature.',
      });
    }
  }, [message]);

  // ... rest of component
}
```

### **Disclaimer Content** (from Epic 11 PRD and Compliance)
```
⚠️ AI features provide educational guidance only, not legal advice.

These features use artificial intelligence to help you understand 
and navigate legal processes. Always verify important information 
with qualified legal counsel.

Learn More → [Link to /docs/06_Compliance.md]
```

### **Badge Styling**
```typescript
import { Badge } from "@/components/ui/badge";

<div className="flex items-center gap-2">
  <h2 className="text-lg font-semibold">AI Participation</h2>
  <Badge variant="secondary">Experimental Beta</Badge>
</div>
```

### **File Locations** [Source: architecture/source-tree.md]
- Update: `components/settings/SettingsPage.tsx` (add AI toggle section)
- Helper: `lib/auth/check-ai-access.ts` (new file)
- Route: `app/intake/page.tsx` (new or update existing)
- Update: `lib/validation.ts` (confirm aiParticipation in schema)
- Tests:
  - `tests/auth/check-ai-access.test.ts` (new file)
  - `tests/settings/SettingsPage.test.tsx` (update with AI toggle)
  - `tests/intake/intake-route.test.tsx` (new file for route protection)

### **Accessibility Requirements**
- Switch has aria-label: "Enable AI-assisted intake features"
- Switch has aria-checked: "true" or "false"
- Disclaimer has aria-live="polite" for dynamic content
- Learn More link has aria-label: "Learn more about AI features and compliance"
- BETA badge has role="status" and aria-label: "Experimental beta feature"
- Keyboard navigation: Tab through switch → link → save button

### **Testing Strategy**
```typescript
// tests/auth/check-ai-access.test.ts
describe('checkAIAccess', () => {
  it('denies access when user has not opted in', async () => {
    vi.spyOn(usersRepo, 'getUserSettings').mockResolvedValue({
      ...mockSettings,
      aiParticipation: false,
    });
    const result = await checkAIAccess('user-123');
    expect(result).toEqual({ allowed: false, reason: 'user_opted_out' });
  });

  it('allows access when user has opted in', async () => {
    vi.spyOn(usersRepo, 'getUserSettings').mockResolvedValue({
      ...mockSettings,
      aiParticipation: true,
    });
    const result = await checkAIAccess('user-123');
    expect(result).toEqual({ allowed: true });
  });
});
```

### **Technical Constraints**
- TypeScript strict mode - no `any` types
- Access control driven by authenticated user setting
- Server-side protection for intake route (no client-side only)
- Follow repository pattern for Firestore access
- Use shadcn/ui components (Switch, Badge, Card)
- Accessibility: WCAG 2.1 AA compliance required

### **Integration Points**
- Story 11.2: Uses same save function and useUserSettings hook
- AI Intake Spike: Moderation and logging infrastructure
- Epic 12: AI Intake page will use checkAIAccess helper
- Firestore: aiParticipation field in users collection
- React Query: Cached with other user settings

### **Out of Scope for Story 11.3**
- AI Intake page implementation (Epic 12)
- AI moderation or prompt system (Epic 12)
- Analytics tracking for opt-in rates (future)
- Email notification on opt-in change (future)
- Admin dashboard for AI feature usage (Phase 2)
- Per-feature AI toggles (future - currently all-or-nothing)

### **Compliance Notes** (from Epic 11 PRD)
- Opt-in must be explicit (default: false)
- Disclaimer must be visible before/during opt-in
- Link to full compliance documentation required
- User can opt-out at any time
- No data collected before opt-in
- All AI interactions logged anonymously (Epic 12)

### **User Experience Flow**
```
1. User sees AI toggle (OFF by default)
2. User reads description + disclaimer
3. User clicks "Learn More" to read compliance (optional)
4. User toggles switch to ON
5. Toggle shows ON state immediately (optimistic)
6. User clicks "Save Changes" button
7. Settings saved to Firestore
8. Success toast appears
9. User can now access /intake
```

### **Error Handling**
- If save fails, toggle reverts to OFF
- Error toast explains failure
- User can retry save
- If Firestore read fails on intake route, deny access (fail closed)
- Log all access control errors for monitoring

## Testing

- Use Vitest + React Testing Library per `CLAUDE.md`.
- Test AI toggle rendering and state management.
- Test checkAIAccess helper with all scenarios (flag/opt-in combinations).
- Test intake route protection (redirects correctly).
- Test disclaimer and compliance link presence.
- Accessibility: jest-axe for zero violations, manual keyboard walkthrough.
- Integration: Full flow from toggle on → save → access intake.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-11 | 0.1 | Initial draft created from Epic 11 PRD | SM Agent (Bob) |
