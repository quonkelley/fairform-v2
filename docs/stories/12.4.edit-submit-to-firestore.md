# Story 12.4: Edit & Submit Summary to Firestore

## Status
Draft

## Story
**As a** self-represented litigant using FairForm,
**I want** to edit the AI-generated summary and save it as a case in my dashboard,
**so that** I have an accurate record of my legal matter and can track my progress.

## Acceptance Criteria

1. Edit page allows user to modify AI-generated summary, case type, and jurisdiction.
2. Form validates required fields before submission (summary min 20 chars, case type selected).
3. User can save edited case to Firestore `cases` collection.
4. Saved case includes all classification data (summary, caseType, jurisdiction, confidence, risk).
5. Success message displays after save with link to new case.
6. User is redirected to case dashboard after successful save.
7. Original AI classification is preserved in case metadata for analytics.
8. Save operation completes in ≤1 second under normal conditions.
9. Errors during save display with retry option.
10. Case includes initial step creation based on case type (integration with existing steps).

## Tasks / Subtasks

- [ ] Task 1: Create edit page route (AC: 1)
  - [ ] Create `app/intake/edit/page.tsx` as authenticated server component
  - [ ] Use `requireAuth` for authentication
  - [ ] Check AI participation enabled
  - [ ] Render IntakeEditPage client component
  - [ ] Pass user data

- [ ] Task 2: Create IntakeEditPage component (AC: 1, 2)
  - [ ] Create `components/intake/IntakeEditPage.tsx`
  - [ ] Load classification data from sessionStorage
  - [ ] Use React Hook Form for form management
  - [ ] Fields: summary (textarea), caseType (select), jurisdiction (nested inputs)
  - [ ] Pre-populate with AI-generated data
  - [ ] Track dirty state (has user made changes?)
  - [ ] Validate on blur and submit

- [ ] Task 3: Add form validation (AC: 2)
  - [ ] Summary: min 20 chars, max 1000 chars
  - [ ] Case type: required, must be non-empty string
  - [ ] Jurisdiction fields: optional, but if present must be valid strings
  - [ ] Use Zod schema for validation
  - [ ] Display validation errors inline
  - [ ] Submit button disabled if form invalid

- [ ] Task 4: Create useSaveCase hook (AC: 3, 4, 8)
  - [ ] Create `lib/hooks/useSaveCase.ts`
  - [ ] Use React Query mutation
  - [ ] Function: `saveCase(caseData: CaseInput)`
  - [ ] Calls casesRepo.createCase with AI classification metadata
  - [ ] Returns: `{ saveCase, isSaving, error, savedCase }`
  - [ ] Measure save duration (performance.now())
  - [ ] Log timing to console

- [ ] Task 5: Update casesRepo for AI intake (AC: 4, 7)
  - [ ] Update `lib/db/casesRepo.ts`
  - [ ] Modify `createCase` to accept optional AI metadata
  - [ ] AI metadata fields:
    - `aiGenerated: boolean` (true for AI intake cases)
    - `originalAISummary: string` (unedited AI summary)
    - `aiConfidence: number` (original confidence score)
    - `aiRiskLevel: string` (original risk assessment)
    - `aiClassifiedAt: Timestamp` (when AI classified)
  - [ ] Store in Firestore under case document
  - [ ] Update Case TypeScript interface

- [ ] Task 6: Create initial steps for case (AC: 10)
  - [ ] After case creation, generate initial steps based on caseType
  - [ ] Use existing step templates (from Story 6.x step data)
  - [ ] Create 3-5 initial steps in `caseSteps` collection
  - [ ] Link steps to case via caseId
  - [ ] Set appropriate order and status
  - [ ] Return case with step count

- [ ] Task 7: Implement save flow (AC: 3, 5, 6, 9)
  - [ ] On form submit, validate all fields
  - [ ] Call useSaveCase with form data
  - [ ] Show loading spinner on submit button
  - [ ] Disable form during save
  - [ ] On success:
    - Clear sessionStorage
    - Show success toast: "Case created successfully!"
    - Wait 500ms
    - Redirect to `/dashboard`
  - [ ] On error:
    - Show error alert with message
    - Keep form enabled
    - Show "Try Again" button
    - Log error to console

- [ ] Task 8: Add case title generation (AC: 4)
  - [ ] Generate case title from classification
  - [ ] Format: "{caseType} - {primaryIssue}" (truncate to 60 chars)
  - [ ] Example: "Small Claims - Landlord Heating Issue"
  - [ ] Make editable in form
  - [ ] Default if not provided: "{caseType} Case"

- [ ] Task 9: Create comprehensive tests (AC: All)
  - [ ] Component tests:
    - Form loads with pre-populated data
    - Validation works for all fields
    - Submit button disabled when invalid
    - Dirty state tracked correctly
    - Edit and save flow works
  - [ ] Hook tests (useSaveCase):
    - Successfully saves case
    - Includes AI metadata
    - Handles errors gracefully
    - Measures save duration
  - [ ] Repository tests:
    - createCase accepts AI metadata
    - Metadata stored correctly
    - Initial steps created
  - [ ] Integration tests:
    - Full flow: edit → validate → save → redirect
    - SessionStorage cleared after save
    - Success toast appears
    - Dashboard shows new case

- [ ] Task 10: Add accessibility features (AC: All)
  - [ ] Form labels for all fields
  - [ ] Error messages associated with fields (aria-describedby)
  - [ ] Required fields marked with aria-required
  - [ ] Loading state announced (aria-live)
  - [ ] Success state announced
  - [ ] Focus management after save

## Dev Notes

### **Previous Story Insights**
- Story 12.3: Results page with classification data created
- casesRepo and stepsRepo exist with CRUD operations
- Case and CaseStep interfaces defined
- React Hook Form not yet installed (need to add)
- React Query configured and working

### **Form Data Structure**
```typescript
interface CaseInput {
  title: string;              // User-provided or generated
  caseType: string;           // From AI or edited
  jurisdiction: string;       // Formatted: "county_state" or just state
  summary: string;            // AI summary or edited version
  primaryIssue: string;       // From AI classification
  
  // AI Metadata (stored but not editable)
  aiGenerated: boolean;
  originalAISummary: string;
  aiConfidence: number;
  aiRiskLevel: string;
  aiRecommendedSteps: string[];
  aiClassifiedAt: Date;
}
```

### **Updated Case Interface**
```typescript
// lib/validation.ts
interface Case {
  id: string;
  userId: string;
  title: string;
  caseType: string;
  jurisdiction: string;
  status: CaseStatus;
  notes: string | null;       // Store AI summary here
  
  // Existing fields
  progressPct?: number;
  totalSteps?: number;
  completedSteps?: number;
  createdAt: Date;
  updatedAt: Date;
  
  // New AI Metadata (optional)
  aiGenerated?: boolean;
  originalAISummary?: string;
  aiConfidence?: number;
  aiRiskLevel?: string;
  aiRecommendedSteps?: string[];
  aiClassifiedAt?: Date;
}
```

### **IntakeEditPage Component**
```typescript
// components/intake/IntakeEditPage.tsx
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { useSaveCase } from '@/lib/hooks/useSaveCase';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { toast } from 'sonner';
import { Loader2 } from 'lucide-react';

const EditCaseSchema = z.object({
  title: z.string().min(3, 'Title must be at least 3 characters').max(100),
  summary: z.string().min(20, 'Summary must be at least 20 characters').max(1000),
  caseType: z.string().min(1, 'Case type is required'),
  state: z.string().optional(),
  county: z.string().optional(),
});

type EditCaseForm = z.infer<typeof EditCaseSchema>;

export function IntakeEditPage({ user }: IntakeEditPageProps) {
  const [classification, setClassification] = useState<IntakeClassification | null>(null);
  const router = useRouter();
  const { saveCase, isSaving, error } = useSaveCase();

  const { register, handleSubmit, formState: { errors, isDirty }, setValue } = useForm<EditCaseForm>({
    resolver: zodResolver(EditCaseSchema),
  });

  useEffect(() => {
    const stored = sessionStorage.getItem('intake-result');
    if (!stored) {
      router.push('/intake');
      return;
    }

    const result = JSON.parse(stored);
    const data = result.data;
    setClassification(data);

    // Pre-populate form
    setValue('title', `${data.caseType} - ${data.primaryIssue.slice(0, 40)}`);
    setValue('summary', data.summary);
    setValue('caseType', data.caseType);
    setValue('state', data.jurisdiction.state || '');
    setValue('county', data.jurisdiction.county || '');
  }, [router, setValue]);

  const onSubmit = async (formData: EditCaseForm) => {
    if (!classification) return;

    const caseInput = {
      title: formData.title,
      caseType: formData.caseType,
      jurisdiction: formatJurisdiction(formData.state, formData.county),
      notes: formData.summary, // Store summary in notes field
      
      // AI Metadata
      aiGenerated: true,
      originalAISummary: classification.summary,
      aiConfidence: classification.confidence,
      aiRiskLevel: classification.riskLevel,
      aiRecommendedSteps: classification.recommendedNextSteps,
      aiClassifiedAt: new Date(),
    };

    try {
      const result = await saveCase({ userId: user.uid, ...caseInput });
      
      sessionStorage.removeItem('intake-result');
      toast.success('Case created successfully!');
      
      setTimeout(() => {
        router.push('/dashboard');
      }, 500);
    } catch (error) {
      console.error('Failed to save case:', error);
      toast.error('Failed to save case. Please try again.');
    }
  };

  if (!classification) {
    return <div>Loading...</div>;
  }

  return (
    <div className="container max-w-3xl mx-auto py-8 px-4">
      <Card>
        <CardHeader>
          <CardTitle>Edit Your Case Details</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
            {/* Title */}
            <div>
              <Label htmlFor="title">Case Title</Label>
              <Input
                id="title"
                {...register('title')}
                disabled={isSaving}
              />
              {errors.title && (
                <p className="text-sm text-red-600 mt-1">{errors.title.message}</p>
              )}
            </div>

            {/* Summary */}
            <div>
              <Label htmlFor="summary">Summary</Label>
              <Textarea
                id="summary"
                {...register('summary')}
                className="min-h-[150px]"
                disabled={isSaving}
              />
              {errors.summary && (
                <p className="text-sm text-red-600 mt-1">{errors.summary.message}</p>
              )}
            </div>

            {/* Case Type */}
            <div>
              <Label htmlFor="caseType">Case Type</Label>
              <Input
                id="caseType"
                {...register('caseType')}
                disabled={isSaving}
              />
              {errors.caseType && (
                <p className="text-sm text-red-600 mt-1">{errors.caseType.message}</p>
              )}
            </div>

            {/* Jurisdiction */}
            <div className="grid md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="state">State</Label>
                <Input
                  id="state"
                  {...register('state')}
                  placeholder="e.g., California"
                  disabled={isSaving}
                />
              </div>
              <div>
                <Label htmlFor="county">County</Label>
                <Input
                  id="county"
                  {...register('county')}
                  placeholder="e.g., Los Angeles"
                  disabled={isSaving}
                />
              </div>
            </div>

            {/* Error Display */}
            {error && (
              <Alert variant="destructive">
                <AlertDescription>
                  Failed to save case. Please try again.
                </AlertDescription>
              </Alert>
            )}

            {/* Buttons */}
            <div className="flex gap-4">
              <Button
                type="button"
                variant="outline"
                onClick={() => router.back()}
                disabled={isSaving}
              >
                Back
              </Button>
              <Button
                type="submit"
                disabled={isSaving || !isDirty}
                className="flex items-center gap-2"
              >
                {isSaving ? (
                  <>
                    <Loader2 className="h-4 w-4 animate-spin" />
                    Saving...
                  </>
                ) : (
                  'Save Case'
                )}
              </Button>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}

function formatJurisdiction(state?: string, county?: string): string {
  if (county && state) {
    return `${county.toLowerCase()}_${state.toLowerCase().slice(0, 2)}`;
  }
  if (state) {
    return state.toLowerCase().slice(0, 2);
  }
  return 'unknown';
}
```

### **useSaveCase Hook**
```typescript
// lib/hooks/useSaveCase.ts
import { useMutation, useQueryClient } from '@tanstack/react-query';
import * as casesRepo from '@/lib/db/casesRepo';
import type { CreateCaseInput } from '@/lib/validation';

export function useSaveCase() {
  const queryClient = useQueryClient();

  const mutation = useMutation({
    mutationFn: async (input: CreateCaseInput & { userId: string }) => {
      const startTime = performance.now();
      
      const result = await casesRepo.createCase(input);
      
      const duration = ((performance.now() - startTime) / 1000).toFixed(2);
      console.log(`Case saved in ${duration}s`);
      
      return result;
    },
    onSuccess: () => {
      // Invalidate cases query to refresh dashboard
      queryClient.invalidateQueries({ queryKey: ['cases'] });
    },
  });

  return {
    saveCase: mutation.mutateAsync,
    isSaving: mutation.isPending,
    error: mutation.error,
    savedCase: mutation.data,
  };
}
```

### **Updated casesRepo**
```typescript
// lib/db/casesRepo.ts - Add AI metadata support
export async function createCase(input: CreateCaseInput & { userId: string }): Promise<Case> {
  try {
    const db = getFirestoreDb();
    const casesRef = collection(db, 'cases');

    const caseData = {
      userId: input.userId,
      title: input.title,
      caseType: input.caseType,
      jurisdiction: input.jurisdiction,
      status: "active" satisfies CaseStatus,
      notes: input.notes ?? null,
      progressPct: 0,
      totalSteps: 0,
      completedSteps: 0,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      
      // AI Metadata (if present)
      ...(input.aiGenerated && {
        aiGenerated: input.aiGenerated,
        originalAISummary: input.originalAISummary,
        aiConfidence: input.aiConfidence,
        aiRiskLevel: input.aiRiskLevel,
        aiRecommendedSteps: input.aiRecommendedSteps,
        aiClassifiedAt: input.aiClassifiedAt,
      }),
    };

    const docRef = await addDoc(casesRef, caseData);

    // Create initial steps if AI-generated
    if (input.aiGenerated && input.aiRecommendedSteps) {
      await createInitialSteps(docRef.id, input.caseType, input.aiRecommendedSteps);
    }

    // Fetch and return created case
    const snapshot = await getDoc(docRef);
    return mapCaseDocument(snapshot);
  } catch (error) {
    console.error('Failed to create case', { input, error });
    throw new CasesRepositoryError('Unable to create case', { cause: error });
  }
}

async function createInitialSteps(
  caseId: string, 
  caseType: string, 
  recommendedSteps: string[]
): Promise<void> {
  const db = getFirestoreDb();
  const stepsRef = collection(db, 'caseSteps');
  
  // Create first 3 steps from AI recommendations
  const stepsToCreate = recommendedSteps.slice(0, 3);
  
  for (let i = 0; i < stepsToCreate.length; i++) {
    await addDoc(stepsRef, {
      caseId,
      name: stepsToCreate[i],
      order: i + 1,
      isComplete: false,
      completedAt: null,
      dueDate: null,
      createdAt: serverTimestamp(),
    });
  }
}
```

### **File Locations**
- Route: `app/intake/edit/page.tsx` (new)
- Component: `components/intake/IntakeEditPage.tsx` (new)
- Hook: `lib/hooks/useSaveCase.ts` (new)
- Update: `lib/db/casesRepo.ts` (add AI metadata support)
- Update: `lib/validation.ts` (add AI fields to Case interface)
- Tests:
  - `tests/intake/intake-edit-page.test.tsx` (new)
  - `tests/hooks/useSaveCase.test.tsx` (new)
  - `tests/lib/db/casesRepo.test.ts` (update)

### **Dependencies to Install**
```bash
npm install react-hook-form @hookform/resolvers/zod
```

### **Testing Strategy**
```typescript
describe('IntakeEditPage', () => {
  it('pre-populates form with AI data', () => {
    sessionStorage.setItem('intake-result', JSON.stringify({
      data: mockClassification,
    }));
    
    render(<IntakeEditPage user={mockUser} />);
    
    expect(screen.getByLabelText('Summary')).toHaveValue(mockClassification.summary);
    expect(screen.getByLabelText('Case Type')).toHaveValue(mockClassification.caseType);
  });

  it('validates required fields', async () => {
    render(<IntakeEditPage user={mockUser} />);
    
    const summary = screen.getByLabelText('Summary');
    fireEvent.change(summary, { target: { value: 'Too short' } });
    fireEvent.blur(summary);
    
    expect(await screen.findByText(/at least 20 characters/)).toBeInTheDocument();
  });

  it('saves case and redirects on success', async () => {
    const { router } = render(<IntakeEditPage user={mockUser} />);
    
    fireEvent.click(screen.getByText('Save Case'));
    
    await waitFor(() => {
      expect(router.push).toHaveBeenCalledWith('/dashboard');
    });
  });
});
```

### **Integration Points**
- Story 12.3: Receives data from results page
- casesRepo: Creates case with AI metadata
- stepsRepo: Creates initial steps
- Dashboard: Displays newly created case

### **Out of Scope**
- Advanced editing features
- Multiple classification attempts
- Case templates
- Bulk editing
- Version history

## Testing

- Use Vitest + React Testing Library.
- Test form validation and submission.
- Test save flow and error handling.
- Test AI metadata storage.
- Test initial step creation.
- Accessibility tests.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-11 | 0.1 | Initial draft | SM Agent (Bob) |

