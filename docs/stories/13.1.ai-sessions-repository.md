# Story 13.1: AI Sessions Repository

## Status
Draft

## Story
**As a** FairForm developer,
**I want** a dedicated repository for managing AI session data with messages in subcollections,
**so that** the AI Copilot can persist conversation history efficiently without hot-document contention.

## Acceptance Criteria

1. `aiSessionsRepo.ts` follows existing FairForm repository pattern (similar to `casesRepo.ts`)
2. Repository supports creating sessions with userId, optional caseId, and demo flag
3. Messages are stored in subcollection (`aiSessions/{sessionId}/messages/{messageId}`)
4. Repository provides methods for: createSession, appendMessage, listMessages (paginated), updateContextSnapshot
5. All repository methods include proper error handling with custom error class
6. TypeScript interfaces match the unified architecture specification
7. Repository includes session archival method for lifecycle management
8. Unit tests cover all repository methods with >80% coverage

## Tasks / Subtasks

- [ ] Task 1: Create TypeScript interfaces and types (AC: 6)
  - [ ] Create `lib/ai/types.ts` with AISession, AIMessage, ContextSnapshot, AIPromptContext interfaces
  - [ ] Export Author type ('user' | 'assistant' | 'system')
  - [ ] Ensure all interfaces match unified architecture spec exactly

- [ ] Task 2: Create aiSessionsRepo.ts with repository pattern (AC: 1, 2)
  - [ ] Create `lib/db/aiSessionsRepo.ts`
  - [ ] Add AISessionsRepositoryError class extending Error
  - [ ] Define collection constants: SESSIONS_COLLECTION = 'aiSessions', MESSAGES_SUBCOLLECTION = 'messages'
  - [ ] Import getAdminFirestore from existing firebase-admin setup

- [ ] Task 3: Implement createSession method (AC: 2)
  - [ ] Accept input: { userId, caseId?, demo?, title? }
  - [ ] Generate timestamp (Date.now())
  - [ ] Create session document with all required fields
  - [ ] Initialize contextSnapshot with empty hash and userPrefs
  - [ ] Return mapped AISession object
  - [ ] Include try/catch with AISessionsRepositoryError

- [ ] Task 4: Implement appendMessage method (AC: 3, 5)
  - [ ] Accept sessionId and message data (author, content, meta?)
  - [ ] Add message to messages subcollection
  - [ ] Update parent session's lastMessageAt and updatedAt
  - [ ] Return mapped AIMessage object
  - [ ] Handle errors with proper error messages

- [ ] Task 5: Implement listMessages with pagination (AC: 4)
  - [ ] Accept sessionId, options: { after?: number, limit?: number }
  - [ ] Default limit to 20 messages
  - [ ] Query messages subcollection ordered by createdAt desc
  - [ ] Fetch limit + 1 to check hasMore
  - [ ] Return { items: AIMessage[], hasMore: boolean }
  - [ ] Handle after parameter for pagination

- [ ] Task 6: Implement updateContextSnapshot method (AC: 4)
  - [ ] Accept sessionId and partial ContextSnapshot
  - [ ] Update session document's contextSnapshot field
  - [ ] Update updatedAt timestamp
  - [ ] Handle errors appropriately

- [ ] Task 7: Implement archiveOldSessions method (AC: 7)
  - [ ] Accept days parameter
  - [ ] Calculate cutoff timestamp (now - days * 24 * 60 * 60 * 1000)
  - [ ] Query sessions where lastMessageAt < cutoff and status == 'active'
  - [ ] Use batch update to set status = 'archived'
  - [ ] Return count of archived sessions

- [ ] Task 8: Add helper mapping functions (AC: 5)
  - [ ] Create mapSessionDocument function
  - [ ] Create mapMessageDocument function
  - [ ] Handle Firestore timestamp conversion
  - [ ] Ensure proper type safety

- [ ] Task 9: Create comprehensive unit tests (AC: 8)
  - [ ] Test createSession with various inputs
  - [ ] Test appendMessage to subcollection
  - [ ] Test listMessages pagination
  - [ ] Test updateContextSnapshot
  - [ ] Test archiveOldSessions
  - [ ] Test error handling for all methods
  - [ ] Mock Firestore admin SDK
  - [ ] Achieve >80% code coverage

## Dev Notes

### Architecture Context
[Source: docs/epic-13-unified-architecture-specification.md]

This story implements the data persistence layer for AI Copilot sessions. The architecture uses a **subcollection pattern** for messages to avoid hot-document contention and enable efficient pagination.

**Key Design Decisions:**
- Messages stored in subcollection (not array in main document)
- Timestamps use epoch milliseconds (number type)
- Context snapshots are small, structured objects with hash for caching
- Demo flag enables sandbox isolation

### Repository Pattern
[Source: lib/db/casesRepo.ts - existing pattern]

Follow the established FairForm repository pattern:
- Custom error class extending Error
- Use getAdminFirestore() for database access
- Async functions with try/catch error handling
- Document mapping functions for type safety
- Export repository functions (not class)

### Data Model Structure

**AISession Document:**
```typescript
{
  id: string;
  userId: string;        // Indexed
  caseId?: string;       // Indexed, optional
  title: string;
  status: 'active' | 'archived' | 'ended';
  createdAt: number;     // epoch ms
  updatedAt: number;
  lastMessageAt: number;
  contextSnapshot: {
    caseType?: string;
    jurisdiction?: string;
    currentStepOrder?: number;
    progressPct?: number;
    userPrefs?: object;
    hash: string;
  };
  demo: boolean;
}
```

**AIMessage Subcollection:**
```
aiSessions/{sessionId}/messages/{messageId}
{
  id: string;
  sessionId: string;
  author: 'user' | 'assistant' | 'system';
  content: string;
  meta?: {
    tokensIn?: number;
    tokensOut?: number;
    latencyMs?: number;
    blocked?: boolean;
    model?: string;
  };
  createdAt: number;
}
```

### Session Lifecycle
- Active sessions: status = 'active'
- Archive after 7 days (prod) or 24 hours (demo) of inactivity
- Delete after 90 days (prod) or 14 days (demo)
- Lifecycle managed by scheduled job (future story)

### Source Tree
```
lib/
├── ai/
│   └── types.ts          # NEW: TypeScript interfaces
├── db/
│   ├── aiSessionsRepo.ts # NEW: Repository implementation
│   ├── casesRepo.ts      # REFERENCE: Pattern to follow
│   └── stepsRepo.ts      # REFERENCE: Similar patterns
└── firebase-admin.ts     # EXISTING: Use getAdminFirestore()
```

### Testing

**Test Framework:** Vitest + React Testing Library
**Test Location:** `lib/db/aiSessionsRepo.test.ts`

**Testing Standards:**
- Mock Firestore Admin SDK using Vitest mocks
- Test all public repository functions
- Test error handling paths
- Test edge cases (empty results, pagination boundaries)
- Use describe/it blocks for organization
- Aim for >80% code coverage

**Example Test Structure:**
```typescript
import { describe, it, expect, vi } from 'vitest';
import * as repo from './aiSessionsRepo';

describe('aiSessionsRepo', () => {
  describe('createSession', () => {
    it('creates session with correct structure', async () => {
      // Test implementation
    });
  });
  
  describe('appendMessage', () => {
    it('adds message to subcollection', async () => {
      // Test implementation
    });
  });
  
  // ... more tests
});
```

### Dependencies
- firebase-admin (already installed)
- Existing firebase-admin.ts setup
- TypeScript strict mode enabled

### Implementation Notes
- Use FieldValue.serverTimestamp() is NOT used - use Date.now() for consistency
- All timestamps are epoch milliseconds (number type)
- Error messages should be descriptive for debugging
- Follow existing naming conventions from casesRepo.ts

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_

