# Story 13.38: Duplicate Case Detection

## Status
ðŸ“‹ Planned 
Urgency: (low priority for demo)
## Story
**As a** user attempting to create a case,
**I want** the system to warn me if I might be creating a duplicate,
**so that** I don't accidentally create multiple cases for the same legal issue.

## Acceptance Criteria

1. Checks for potential duplicates based on case type + case number
2. Also checks for case type + jurisdiction + similar dates
3. Shows warning modal with link to existing case(s)
4. Allows user to view existing case details before deciding
5. Provides "This is different" override option
6. Logs duplicate detection attempts for analytics
7. Warning is non-blocking (user can proceed if they want)
8. Works in real-time during case creation confirmation

## Tasks / Subtasks

- [ ] Task 1: Duplicate detection logic (AC: 1, 2)
  - [ ] Create `lib/db/duplicateDetection.ts`
  - [ ] Query Firestore for matching cases
  - [ ] Match by case number (exact)
  - [ ] Match by type + jurisdiction + date (fuzzy)
  - [ ] Return similarity score

- [ ] Task 2: Warning UI (AC: 3, 4, 7)
  - [ ] Create DuplicateWarningModal component
  - [ ] Show similar case details
  - [ ] Link to existing case
  - [ ] Non-blocking design (can dismiss)

- [ ] Task 3: User actions (AC: 5)
  - [ ] "View Existing Case" button
  - [ ] "This is Different" override button
  - [ ] "Cancel" option

- [ ] Task 4: Analytics tracking (AC: 6)
  - [ ] Log duplicate detections
  - [ ] Track user decisions (override vs cancel)
  - [ ] Measure accuracy of detection

- [ ] Task 5: Integration with case creation (AC: 8)
  - [ ] Check before creating case
  - [ ] Show warning if duplicates found
  - [ ] Allow proceed or cancel

- [ ] Task 6: Testing (AC: All)
  - [ ] Test with exact duplicates
  - [ ] Test with similar cases
  - [ ] Test with no matches
  - [ ] Test user workflows

## Dev Notes

### Duplicate Detection

```typescript
// lib/db/duplicateDetection.ts
export async function findPotentialDuplicates(
  userId: string,
  caseInfo: {
    caseType: string;
    caseNumber?: string;
    jurisdiction?: string;
    hearingDate?: string;
  }
): Promise<Array<{ caseId: string; similarity: number; reason: string }>> {
  
  const duplicates: Array<any> = [];

  // Exact match on case number (if provided)
  if (caseInfo.caseNumber) {
    const exactMatches = await db
      .collection('cases')
      .where('userId', '==', userId)
      .where('caseNumber', '==', caseInfo.caseNumber)
      .get();

    exactMatches.forEach(doc => {
      duplicates.push({
        caseId: doc.id,
        similarity: 1.0,
        reason: 'Same case number'
      });
    });
  }

  // Fuzzy match on type + jurisdiction + nearby date
  const similarCases = await db
    .collection('cases')
    .where('userId', '==', userId)
    .where('caseType', '==', caseInfo.caseType)
    .where('jurisdiction', '==', caseInfo.jurisdiction)
    .get();

  similarCases.forEach(doc => {
    const existingCase = doc.data();
    
    // Check if dates are within 30 days
    if (caseInfo.hearingDate && existingCase.hearingDate) {
      const daysDiff = Math.abs(
        new Date(caseInfo.hearingDate).getTime() -
        new Date(existingCase.hearingDate).getTime()
      ) / (1000 * 60 * 60 * 24);

      if (daysDiff <= 30) {
        duplicates.push({
          caseId: doc.id,
          similarity: 0.7,
          reason: 'Similar case type, location, and date'
        });
      }
    }
  });

  return duplicates.sort((a, b) => b.similarity - a.similarity);
}
```

### Warning Modal Component

```typescript
export function DuplicateWarningModal({
  duplicates,
  onViewCase,
  onOverride,
  onCancel
}: {
  duplicates: Array<{ caseId: string; similarity: number; reason: string; title: string }>;
  onViewCase: (caseId: string) => void;
  onOverride: () => void;
  onCancel: () => void;
}) {
  return (
    <Dialog open={true} onOpenChange={onCancel}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Possible Duplicate Case Detected</DialogTitle>
          <DialogDescription>
            We found {duplicates.length} existing case(s) that might be similar to the one you're creating.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-3">
          {duplicates.map(dup => (
            <div key={dup.caseId} className="border rounded p-3">
              <h4 className="font-medium">{dup.title}</h4>
              <p className="text-sm text-gray-600">{dup.reason}</p>
              <Button
                variant="link"
                onClick={() => onViewCase(dup.caseId)}
              >
                View this case
              </Button>
            </div>
          ))}
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onCancel}>
            Cancel
          </Button>
          <Button onClick={onOverride}>
            This is a different case
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### Integration with Case Creation

```typescript
// In caseCreation.ts or chat route
async function createCase(caseInfo, userId) {
  // Check for duplicates
  const duplicates = await findPotentialDuplicates(userId, caseInfo);

  if (duplicates.length > 0) {
    // Return duplicates to show warning
    return {
      status: 'duplicate_warning',
      duplicates: duplicates,
      proceedToken: generateToken() // Use this to proceed if user overrides
    };
  }

  // No duplicates, proceed with creation
  return createNewCase(caseInfo, userId);
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Product Team |

