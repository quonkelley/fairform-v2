# Story 10.3: LocalStorage Persistence & Progress Tracking

## Status: Draft

## Story

As a **FairForm user working through my checklist**,
I want **my checklist progress to be saved automatically and persist across sessions**,
So that **I can close the app and return later without losing my preparation progress**.

## Context Source

- Source Document: Epic 10 PRD (Day-in-Court Checklist)
- Enhancement Type: State persistence and progress tracking
- Existing System Impact: Adds localStorage persistence without backend dependencies

## Acceptance Criteria

### Functional Requirements

1. **Progress Persistence**: Save checklist item completion status to localStorage
2. **Case-Specific Storage**: Store progress keyed by case ID to support multiple cases
3. **Automatic Sync**: Persist changes immediately when items are checked/unchecked
4. **Progress Recovery**: Load saved progress when checklist page opens
5. **Progress Calculation**: Calculate and display completion percentage

### Technical Requirements

6. **Custom Hook**: Create `useChecklistProgress` hook for state management
7. **Storage Key Format**: Use consistent format for localStorage keys
8. **Error Handling**: Gracefully handle localStorage quota limits and errors
9. **Type Safety**: Properly typed interfaces for stored data

### Quality Requirements

10. **Reliability**: LocalStorage operations must not throw errors
11. **Performance**: Storage operations ≤ 50ms
12. **Testing**: Unit tests for storage logic and edge cases

## Tasks / Subtasks

- [ ] **Task 1**: Create useChecklistProgress custom hook
  - [ ] Define hook interface and return types
  - [ ] Implement localStorage read/write operations
  - [ ] Add state management for completed items
  - [ ] Handle case ID scoping

- [ ] **Task 2**: Implement progress persistence logic
  - [ ] Create localStorage key format
  - [ ] Implement save operation with error handling
  - [ ] Implement load operation with fallback
  - [ ] Add quota limit handling

- [ ] **Task 3**: Add progress calculation
  - [ ] Calculate completion percentage
  - [ ] Track completed vs total items
  - [ ] Update progress in real-time
  - [ ] Expose progress stats to components

- [ ] **Task 4**: Integrate with checklist components
  - [ ] Connect hook to ChecklistPage
  - [ ] Wire up checkbox toggle handlers
  - [ ] Add progress display to page header
  - [ ] Update components to use persisted state

- [ ] **Task 5**: Add comprehensive testing
  - [ ] Unit tests for localStorage operations
  - [ ] Hook tests with React Testing Library
  - [ ] Error handling tests
  - [ ] Edge case tests (quota limits, invalid data)

## Dev Notes

### Previous Story Context

This story builds on:
- Story 10.1: Checklist page scaffold
- Story 10.2: Checklist templates and components

### Technical Implementation

**useChecklistProgress Hook:**
```typescript
// lib/hooks/useChecklistProgress.ts
import { useState, useEffect, useCallback } from 'react';

interface ChecklistProgress {
  caseId: string;
  completedItems: string[];
  lastUpdated: string;
}

interface UseChecklistProgressReturn {
  completedItems: Set<string>;
  toggleItem: (itemId: string) => void;
  resetProgress: () => void;
  progressPercentage: number;
  completedCount: number;
  totalCount: number;
  isLoading: boolean;
}

const STORAGE_KEY_PREFIX = 'fairform_checklist_';

export function useChecklistProgress(
  caseId: string,
  totalItems: number
): UseChecklistProgressReturn {
  const [completedItems, setCompletedItems] = useState<Set<string>>(new Set());
  const [isLoading, setIsLoading] = useState(true);

  // Load progress from localStorage on mount
  useEffect(() => {
    try {
      const storageKey = `${STORAGE_KEY_PREFIX}${caseId}`;
      const stored = localStorage.getItem(storageKey);
      
      if (stored) {
        const progress: ChecklistProgress = JSON.parse(stored);
        setCompletedItems(new Set(progress.completedItems));
      }
    } catch (error) {
      console.error('Failed to load checklist progress:', error);
      // Continue with empty state - non-critical error
    } finally {
      setIsLoading(false);
    }
  }, [caseId]);

  // Save progress to localStorage whenever it changes
  useEffect(() => {
    if (isLoading) return; // Don't save during initial load

    try {
      const storageKey = `${STORAGE_KEY_PREFIX}${caseId}`;
      const progress: ChecklistProgress = {
        caseId,
        completedItems: Array.from(completedItems),
        lastUpdated: new Date().toISOString()
      };
      
      localStorage.setItem(storageKey, JSON.stringify(progress));
    } catch (error) {
      console.error('Failed to save checklist progress:', error);
      
      // Handle quota exceeded error
      if (error instanceof DOMException && error.name === 'QuotaExceededError') {
        console.warn('LocalStorage quota exceeded. Progress may not be saved.');
        // Could show user notification here
      }
    }
  }, [caseId, completedItems, isLoading]);

  // Toggle item completion
  const toggleItem = useCallback((itemId: string) => {
    setCompletedItems(prev => {
      const newSet = new Set(prev);
      if (newSet.has(itemId)) {
        newSet.delete(itemId);
      } else {
        newSet.add(itemId);
      }
      return newSet;
    });
  }, []);

  // Reset all progress
  const resetProgress = useCallback(() => {
    setCompletedItems(new Set());
    try {
      const storageKey = `${STORAGE_KEY_PREFIX}${caseId}`;
      localStorage.removeItem(storageKey);
    } catch (error) {
      console.error('Failed to reset checklist progress:', error);
    }
  }, [caseId]);

  // Calculate progress stats
  const completedCount = completedItems.size;
  const progressPercentage = totalItems > 0 
    ? Math.round((completedCount / totalItems) * 100) 
    : 0;

  return {
    completedItems,
    toggleItem,
    resetProgress,
    progressPercentage,
    completedCount,
    totalCount: totalItems,
    isLoading
  };
}
```

**Integration with ChecklistPage:**
```typescript
// app/cases/[id]/checklist/page.tsx
export default function ChecklistPage({ params }: ChecklistPageProps) {
  const caseId = params.id;
  const { data: caseData } = useCaseDetails(caseId);
  
  // Get checklist template based on case type
  const template = caseData 
    ? checklistTemplates[caseData.caseType]
    : null;
  
  // Calculate total items
  const totalItems = template?.categories.reduce(
    (sum, cat) => sum + cat.items.length, 
    0
  ) || 0;
  
  // Use checklist progress hook
  const {
    completedItems,
    toggleItem,
    resetProgress,
    progressPercentage,
    completedCount,
    totalCount,
    isLoading
  } = useChecklistProgress(caseId, totalItems);

  if (isLoading || !template) {
    return <Spinner label="Loading checklist" />;
  }

  return (
    <ProtectedRoute>
      <div className="mx-auto flex min-h-screen w-full max-w-4xl flex-col gap-8 px-6 py-8">
        {/* Header with progress */}
        <div className="space-y-4">
          <h1 className="text-3xl font-bold">Day-in-Court Checklist</h1>
          
          {/* Progress indicator */}
          <div className="space-y-2">
            <div className="flex items-center justify-between text-sm">
              <span className="font-medium">Your Progress</span>
              <span className="text-muted-foreground">
                {completedCount} of {totalCount} completed ({progressPercentage}%)
              </span>
            </div>
            <Progress value={progressPercentage} className="w-full" />
          </div>
        </div>

        {/* Checklist categories */}
        <div className="space-y-8">
          {template.categories.map((category) => (
            <ChecklistCategory
              key={category.id}
              category={category}
              completedItems={completedItems}
              onToggleItem={toggleItem}
            />
          ))}
        </div>

        {/* Reset button (next story) */}
      </div>
    </ProtectedRoute>
  );
}
```

**Storage Key Format:**
```
fairform_checklist_{caseId}
```

**Stored Data Structure:**
```typescript
{
  "caseId": "abc123",
  "completedItems": ["item-1", "item-2", "item-3"],
  "lastUpdated": "2025-10-10T12:00:00.000Z"
}
```

### File Locations

**New Files:**
- `lib/hooks/useChecklistProgress.ts` - Progress persistence hook
- `tests/lib/hooks/useChecklistProgress.test.ts` - Hook tests

**Modified Files:**
- `app/cases/[id]/checklist/page.tsx` - Integrate progress hook
- `lib/hooks/index.ts` - Export new hook

### Design System Integration

- Uses shadcn/ui Progress component for visual feedback
- Follows established spacing and typography patterns
- Maintains consistent color scheme for progress indicators

### Accessibility Requirements

- Progress percentage announced to screen readers
- Completed item count communicated clearly
- Storage errors don't break user experience
- Loading states properly announced

### Testing Requirements

**Unit Tests:**
- localStorage read/write operations
- Progress calculation logic
- Error handling for quota limits
- Invalid data recovery

**Hook Tests:**
- Hook initialization and state management
- Toggle item functionality
- Reset progress behavior
- Storage persistence verification

**Integration Tests:**
- Full user flow (check items, refresh, verify persistence)
- Multiple case support (switching between cases)
- Error recovery scenarios

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- useChecklistProgress hook implementation
- localStorage persistence logic
- Progress calculation and state management

### Completion Notes List
- Custom hook created for checklist progress management
- localStorage persistence with error handling
- Progress calculation and display integration
- Case-specific storage scoping implemented

### File List
**New Files:**
- `lib/hooks/useChecklistProgress.ts` - Progress persistence hook
- `tests/lib/hooks/useChecklistProgress.test.ts` - Hook tests

**Modified Files:**
- `app/cases/[id]/checklist/page.tsx` - Integrate progress hook
- `lib/hooks/index.ts` - Export new hook

### Change Log
**2025-10-10**: Initial story creation for Epic 10 localStorage persistence
- Created useChecklistProgress hook with localStorage integration
- Implemented progress calculation and tracking
- Added error handling for storage quota limits

## Testing

### Test Strategy
- Unit tests for hook logic and localStorage operations
- Integration tests for full persistence flow
- Error handling tests for quota limits
- Edge case tests for invalid data

### Test Coverage Targets
- useChecklistProgress hook: 100% line coverage
- localStorage operations: 100% error path coverage
- Progress calculation: 100% edge case coverage

### Accessibility Testing
- Progress updates announced to screen readers
- Loading states properly communicated
- Storage errors don't break accessibility

### Performance Testing
- Storage operations benchmarks (≤ 50ms)
- State update performance
- Memory usage validation

## QA Results

*To be completed after implementation*

---

**Story Owner:** SM (Bob)  
**Created:** October 10, 2025  
**Epic:** 10 Day-in-Court Checklist  
**Estimated Effort:** 1 day  
**Dependencies:** Stories 10.1 and 10.2 complete
