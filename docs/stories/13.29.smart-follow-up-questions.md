# Story 13.29: Smart Follow-Up Questions

## Status
ðŸ“‹ Planned

## Story
**As a** user creating a case through AI Copilot,
**I want** the AI to proactively ask for missing information,
**so that** I don't have to guess what details are needed and the conversation flows naturally.

## Acceptance Criteria

1. AI proactively asks for jurisdiction after case type is identified
2. AI asks case-type-specific questions (e.g., hearing date for evictions)
3. AI never repeats questions for already-collected information
4. Questions feel natural in the conversation flow (not robotic)
5. AI prioritizes critical missing information first
6. Follow-up questions adapt based on user's responses
7. AI explains why the information is needed
8. Works across all supported case types
9. **[Research] AI asks clarifying questions when input is ambiguous** (never guesses)
10. **[Research] AI explains reasoning for each question** (builds trust)

## Tasks / Subtasks

- [ ] Task 1: Create follow-up question generator (AC: 1, 2, 5, 8)
  - [ ] Create `lib/ai/followUpGenerator.ts`
  - [ ] Implement `getNextQuestion()` function
  - [ ] Define question templates for each case type
  - [ ] Prioritize questions by importance
  - [ ] Add explanations for why info is needed

- [ ] Task 2: Integrate with system prompt (AC: 4, 7)
  - [ ] Update `buildSystemPrompt()` in chat route
  - [ ] Add follow-up question context to AI
  - [ ] Ensure questions are conversational
  - [ ] Include reasoning in prompts

- [ ] Task 3: Implement duplicate prevention (AC: 3)
  - [ ] Track which questions have been asked
  - [ ] Check `collectedInfo` before suggesting questions
  - [ ] Store asked questions in session context

- [ ] Task 4: Add adaptive questioning logic (AC: 6)
  - [ ] Adjust follow-ups based on responses
  - [ ] Skip irrelevant questions based on context
  - [ ] Handle edge cases (user doesn't know answer)

- [ ] Task 5: Add disambiguation protocol (AC: 9) **[Research-Based]**
  - [ ] Detect ambiguous user inputs
  - [ ] Generate clarifying questions
  - [ ] Never assume or guess when unclear
  - [ ] Examples: multiple cases named "Smith", unclear dates

- [ ] Task 6: Testing (AC: All)
  - [ ] Test with full conversation flows
  - [ ] Test question priority logic
  - [ ] Test duplicate prevention
  - [ ] Test across case types
  - [ ] **Test ambiguous input scenarios** (AC: 9)
  - [ ] **Test reasoning explanations** (AC: 10)

## Dev Notes

### Research-Based Best Practices
**Source:** Building Legal AI Chatbot (Section 7.2 - Handling Ambiguity)

**Key Principle:** *"When the AI detects ambiguity, its default behavior should be to ask a clarifying question instead of making assumptions."*

**Disambiguation Protocol:**
1. **Detect Ambiguity:** User says "my case" but has 2 active cases
2. **Generate Specific Question:** "I found two cases: your eviction case #12345 and small claims case #67890. Which one?"
3. **Never Guess:** Even with high confidence, ask when unclear
4. **Provide Context:** Include relevant details in the clarifying question

### Follow-Up Question Logic

```typescript
// lib/ai/followUpGenerator.ts
export function getNextQuestion(
  collectedInfo: Partial<MinimumCaseInfo>,
  askedQuestions: Set<string>
): {
  question: string;
  reason: string;
  key: string;
} | null {
  
  // Jurisdiction is most important after case type
  if (collectedInfo.caseType && !collectedInfo.jurisdiction &&
      !askedQuestions.has('jurisdiction')) {
    return {
      question: "What city or county is your case in? This helps me understand which court has jurisdiction.",
      reason: "Location determines which court handles your case and what local rules apply.",
      key: 'jurisdiction'
    };
  }

  // Eviction-specific questions
  if (collectedInfo.caseType === 'eviction') {
    if (!collectedInfo.hearingDate && !askedQuestions.has('hearingDate')) {
      return {
        question: "Do you have a court hearing date listed on your notice? If so, when is it?",
        reason: "The hearing date determines how much time we have to help you prepare.",
        key: 'hearingDate'
      };
    }

    if (!collectedInfo.caseNumber && !askedQuestions.has('caseNumber')) {
      return {
        question: "Is there a case number on your eviction notice? It usually starts with letters and numbers.",
        reason: "The case number helps us track your specific case in the court system.",
        key: 'caseNumber'
      };
    }
  }

  // Small claims specific
  if (collectedInfo.caseType === 'small_claims') {
    if (!askedQuestions.has('amount')) {
      return {
        question: "What is the amount involved in your small claims matter?",
        reason: "The amount determines if your case qualifies for small claims court.",
        key: 'amount'
      };
    }
  }

  return null; // No more follow-ups needed
}
```

### Disambiguation Implementation Example

```typescript
// lib/ai/disambiguationDetector.ts
export function detectAmbiguity(
  userMessage: string,
  sessionContext: {
    activeCases?: Array<{ id: string; type: string; caseNumber?: string }>;
    collectedInfo: Partial<MinimumCaseInfo>;
  }
): {
  isAmbiguous: boolean;
  clarifyingQuestion?: string;
  reason?: string;
} {
  const lowerMessage = userMessage.toLowerCase();

  // Detect ambiguous case reference
  if (lowerMessage.includes('my case') || lowerMessage.includes('the case')) {
    if (sessionContext.activeCases && sessionContext.activeCases.length > 1) {
      return {
        isAmbiguous: true,
        clarifyingQuestion: `I found ${sessionContext.activeCases.length} cases: ${
          sessionContext.activeCases
            .map((c, i) => `(${i + 1}) ${c.type} case ${c.caseNumber ? `#${c.caseNumber}` : ''}`)
            .join(', ')
        }. Which one are you referring to?`,
        reason: 'Multiple active cases'
      };
    }
  }

  // Detect ambiguous date reference
  if (lowerMessage.match(/tomorrow|next week|soon|later/)) {
    return {
      isAmbiguous: true,
      clarifyingQuestion: `When you say "${userMessage}", do you mean your hearing date, the date you received a notice, or something else?`,
      reason: 'Unclear date context'
    };
  }

  // Detect ambiguous person reference
  if (lowerMessage.match(/he|she|they|them|him|her/) && !sessionContext.collectedInfo.caseType) {
    return {
      isAmbiguous: true,
      clarifyingQuestion: `I want to make sure I understand correctly. Who are you referring to?`,
      reason: 'Unclear pronoun reference'
    };
  }

  return { isAmbiguous: false };
}
```

### System Prompt Enhancement

```typescript
function buildSystemPrompt(appStateContext?: string): string {
  const basePrompt = `...existing prompt...

Follow-Up Question Guidelines (Research-Based):
- When you notice missing critical information, ask for it naturally
- ALWAYS explain why you're asking: "I need to know [X] because [reason]"
- If input is ambiguous or unclear, NEVER guess - ask a specific clarifying question
- Examples of ambiguity requiring clarification:
  * User mentions "my case" but has multiple active cases â†’ ask which one
  * User says vague date like "soon" â†’ ask for specific date or context
  * User refers to "them" without context â†’ ask who they mean
- If the user doesn't know something, acknowledge it gracefully: "That's okay, we can add that later"
- Don't ask the same question twice - check what's already collected
- Prioritize: jurisdiction â†’ case number/hearing date â†’ other details

${appStateContext}`;

  return basePrompt;
}
```

### Integration with Smart Follow-Ups

When implementing, combine disambiguation with follow-up logic:

```typescript
// In chat route
const ambiguityCheck = detectAmbiguity(userMessage, {
  activeCases: userActiveCases,
  collectedInfo: session.contextSnapshot.collectedInfo
});

if (ambiguityCheck.isAmbiguous) {
  // Add disambiguation instruction to system prompt
  appStateContext += `\n[disambiguation_needed]\nquestion="${ambiguityCheck.clarifyingQuestion}"\nreason="${ambiguityCheck.reason}"`;
}
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation | Product Team |
| 2025-10-16 | 1.1 | Added research-based disambiguation protocol & reasoning explanations (AC 9-10) | Product Team |

