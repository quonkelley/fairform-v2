# Story 13.18: Demo Environment Configuration

## Status
Draft

## Story
**As a** FairForm product manager,
**I want** a separate demo environment with isolated data and relaxed constraints,
**so that** we can safely demonstrate the AI Copilot to stakeholders without affecting production data or incurring compliance risks.

## Acceptance Criteria

1. Separate Firebase project configured for demo environment
2. Demo mode can be activated via URL parameter or environment variable
3. Demo sessions use pre-seeded sample data (cases, users, conversations)
4. Demo data is automatically cleaned up after 24 hours
5. Demo mode displays clear visual indicator in UI
6. Demo environment has separate API keys and configuration
7. Production database blocks demo session creation
8. Documentation includes demo setup and usage instructions

## Tasks / Subtasks

- [ ] Task 1: Create demo Firebase project (AC: 1, 6)
  - [ ] Create new Firebase project (`fairform-demo`)
  - [ ] Configure Firebase Authentication
  - [ ] Set up Firestore database
  - [ ] Deploy security rules for demo
  - [ ] Configure API keys and credentials

- [ ] Task 2: Implement demo mode detection (AC: 2)
  - [ ] Add demo mode URL parameter support
  - [ ] Add demo environment variable
  - [ ] Create demo context provider
  - [ ] Detect and persist demo mode state
  - [ ] Add demo mode to session metadata

- [ ] Task 3: Create sample data seeds (AC: 3)
  - [ ] Create sample user profiles
  - [ ] Create sample cases (eviction, small claims, etc.)
  - [ ] Create sample AI conversations
  - [ ] Create sample case steps and progress
  - [ ] Add data seeding scripts

- [ ] Task 4: Implement data cleanup (AC: 4)
  - [ ] Create cleanup Cloud Function/Cron job
  - [ ] Delete sessions older than 24 hours
  - [ ] Reset sample cases to initial state
  - [ ] Log cleanup operations
  - [ ] Schedule daily cleanup runs

- [ ] Task 5: Add demo UI indicators (AC: 5)
  - [ ] Create demo banner component
  - [ ] Add demo badge to navigation
  - [ ] Style demo mode with distinct colors
  - [ ] Add "Exit Demo" button
  - [ ] Show demo disclaimer on entry

- [ ] Task 6: Configure demo-specific settings (AC: 6)
  - [ ] Create `.env.demo` configuration
  - [ ] Set up demo OpenAI API keys
  - [ ] Configure demo Firebase credentials
  - [ ] Add demo-specific feature flags
  - [ ] Document configuration variables

- [ ] Task 7: Enforce demo isolation (AC: 7)
  - [ ] Update Firestore rules to block demo in prod
  - [ ] Add environment checks in API routes
  - [ ] Validate demo flag consistency
  - [ ] Prevent cross-environment data leaks
  - [ ] Add CI checks for demo isolation

- [ ] Task 8: Create documentation (AC: 8)
  - [ ] Write demo setup guide
  - [ ] Document demo mode activation
  - [ ] Add sample data descriptions
  - [ ] Create demo testing checklist
  - [ ] Add troubleshooting guide

## Dev Notes

### Architecture Context
[Source: docs/epic-13-unified-architecture-specification.md, Section 4.1]

Demo mode requires **complete isolation** from production - separate Firebase project, data, and configuration. This ensures stakeholder demos are safe, repeatable, and don't impact real users or data.

**Key Design Decisions:**
- Separate Firebase project (not just namespace)
- URL parameter activation (`?demo=true`)
- 24-hour auto-cleanup for demo data
- Visual indicators throughout UI
- Firestore rules block demo in production

### Demo Environment Setup

**Firebase Projects:**
```bash
# Production
Project ID: fairform-prod
API Key: AIza...prod

# Demo
Project ID: fairform-demo
API Key: AIza...demo
```

**Environment Configuration:**
```bash
# .env.local (production)
NEXT_PUBLIC_FIREBASE_PROJECT_ID=fairform-prod
NEXT_PUBLIC_FIREBASE_API_KEY=AIza...prod
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=fairform-prod.firebaseapp.com
# ... other prod config

FIREBASE_ADMIN_PROJECT_ID=fairform-prod
FIREBASE_ADMIN_PRIVATE_KEY=...
FIREBASE_ADMIN_CLIENT_EMAIL=...

# .env.demo (demo environment)
NEXT_PUBLIC_FIREBASE_PROJECT_ID=fairform-demo
NEXT_PUBLIC_FIREBASE_API_KEY=AIza...demo
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=fairform-demo.firebaseapp.com
# ... other demo config

FIREBASE_ADMIN_PROJECT_ID=fairform-demo
FIREBASE_ADMIN_PRIVATE_KEY=...
FIREBASE_ADMIN_CLIENT_EMAIL=...

DEMO_MODE=true
DEMO_CLEANUP_HOURS=24
```

### Demo Mode Detection

**Demo Context Provider:**
```typescript
// lib/demo/demoContext.tsx

import { createContext, useContext, useEffect, useState } from 'react';
import { useSearchParams } from 'next/navigation';

interface DemoContextValue {
  isDemoMode: boolean;
  enableDemoMode: () => void;
  disableDemoMode: () => void;
}

const DemoContext = createContext<DemoContextValue>({
  isDemoMode: false,
  enableDemoMode: () => {},
  disableDemoMode: () => {}
});

export function DemoProvider({ children }: { children: React.ReactNode }) {
  const searchParams = useSearchParams();
  const [isDemoMode, setIsDemoMode] = useState(false);

  useEffect(() => {
    // Check URL parameter
    const demoParam = searchParams.get('demo');
    if (demoParam === 'true') {
      setIsDemoMode(true);
      localStorage.setItem('fairform_demo_mode', 'true');
    }

    // Check localStorage
    const storedDemo = localStorage.getItem('fairform_demo_mode');
    if (storedDemo === 'true') {
      setIsDemoMode(true);
    }

    // Check environment variable
    if (process.env.NEXT_PUBLIC_DEMO_MODE === 'true') {
      setIsDemoMode(true);
    }
  }, [searchParams]);

  const enableDemoMode = () => {
    setIsDemoMode(true);
    localStorage.setItem('fairform_demo_mode', 'true');
    window.location.href = '/?demo=true';
  };

  const disableDemoMode = () => {
    setIsDemoMode(false);
    localStorage.removeItem('fairform_demo_mode');
    window.location.href = '/';
  };

  return (
    <DemoContext.Provider value={{ isDemoMode, enableDemoMode, disableDemoMode }}>
      {children}
    </DemoContext.Provider>
  );
}

export function useDemoMode() {
  return useContext(DemoContext);
}
```

### Sample Data Seeds

**Demo Data Script:**
```typescript
// scripts/seed-demo-data.ts

import { getAdminFirestore } from '@/lib/firebase-admin';

export interface DemoUser {
  id: string;
  email: string;
  displayName: string;
  createdAt: number;
}

export interface DemoCase {
  id: string;
  userId: string;
  caseType: string;
  jurisdiction: string;
  title: string;
  currentStep: number;
  progressPct: number;
  status: 'active' | 'completed';
}

export const DEMO_USERS: DemoUser[] = [
  {
    id: 'demo-user-1',
    email: 'demo@fairform.com',
    displayName: 'Demo User',
    createdAt: Date.now()
  }
];

export const DEMO_CASES: DemoCase[] = [
  {
    id: 'demo-case-eviction',
    userId: 'demo-user-1',
    caseType: 'eviction',
    jurisdiction: 'CA',
    title: 'Eviction Defense - Sample Case',
    currentStep: 3,
    progressPct: 45,
    status: 'active'
  },
  {
    id: 'demo-case-small-claims',
    userId: 'demo-user-1',
    caseType: 'small_claims',
    jurisdiction: 'CA',
    title: 'Small Claims - Security Deposit Dispute',
    currentStep: 1,
    progressPct: 15,
    status: 'active'
  }
];

export const DEMO_CONVERSATIONS = [
  {
    sessionId: 'demo-session-1',
    userId: 'demo-user-1',
    caseId: 'demo-case-eviction',
    messages: [
      {
        author: 'system',
        content: DISCLAIMERS.demo.content,
        meta: { disclaimer: true }
      },
      {
        author: 'user',
        content: 'What are the steps to respond to an eviction notice in California?'
      },
      {
        author: 'assistant',
        content: `Great question! In California, responding to an eviction notice involves several important steps:\n\n1. **Read the Notice Carefully** - Identify the type of notice and deadline\n2. **File Your Answer** - Respond within 5 days to a 3-day notice\n3. **Gather Evidence** - Collect rent receipts, communication records, photos\n4. **Attend Court Hearing** - Present your case to the judge\n\nYour current case is at step 3: "Gather Evidence and Documentation". Would you like help with this step?`
      }
    ]
  }
];

export async function seedDemoData(): Promise<void> {
  const db = getAdminFirestore();

  console.log('Seeding demo users...');
  for (const user of DEMO_USERS) {
    await db.collection('users').doc(user.id).set(user);
  }

  console.log('Seeding demo cases...');
  for (const caseData of DEMO_CASES) {
    await db.collection('cases').doc(caseData.id).set(caseData);
  }

  console.log('Seeding demo conversations...');
  for (const conv of DEMO_CONVERSATIONS) {
    // Create session
    await db.collection('aiSessions').doc(conv.sessionId).set({
      userId: conv.userId,
      caseId: conv.caseId,
      title: 'Demo Conversation',
      status: 'active',
      createdAt: Date.now(),
      updatedAt: Date.now(),
      lastMessageAt: Date.now(),
      contextSnapshot: { hash: 'demo' },
      demo: true
    });

    // Add messages
    for (let i = 0; i < conv.messages.length; i++) {
      await db
        .collection('aiSessions')
        .doc(conv.sessionId)
        .collection('messages')
        .add({
          ...conv.messages[i],
          sessionId: conv.sessionId,
          createdAt: Date.now() + i * 1000
        });
    }
  }

  console.log('Demo data seeded successfully!');
}

// Run if executed directly
if (require.main === module) {
  seedDemoData()
    .then(() => process.exit(0))
    .catch((error) => {
      console.error('Error seeding demo data:', error);
      process.exit(1);
    });
}
```

### Data Cleanup System

**Cleanup Cloud Function:**
```typescript
// functions/src/cleanupDemoData.ts

import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

export const cleanupDemoData = functions.pubsub
  .schedule('0 2 * * *') // Daily at 2 AM UTC
  .timeZone('UTC')
  .onRun(async (context) => {
    const db = admin.firestore();
    const cutoffTime = Date.now() - (24 * 60 * 60 * 1000); // 24 hours ago

    console.log('Starting demo data cleanup...');

    try {
      // Delete old demo sessions
      const sessionsSnapshot = await db
        .collection('aiSessions')
        .where('demo', '==', true)
        .where('createdAt', '<', cutoffTime)
        .get();

      console.log(`Found ${sessionsSnapshot.size} demo sessions to delete`);

      const batch = db.batch();
      let batchCount = 0;

      for (const sessionDoc of sessionsSnapshot.docs) {
        // Delete messages subcollection
        const messagesSnapshot = await sessionDoc.ref
          .collection('messages')
          .get();

        messagesSnapshot.docs.forEach((messageDoc) => {
          batch.delete(messageDoc.ref);
          batchCount++;
        });

        // Delete session document
        batch.delete(sessionDoc.ref);
        batchCount++;

        // Commit batch if reaching limit
        if (batchCount >= 450) {
          await batch.commit();
          batchCount = 0;
        }
      }

      // Commit remaining operations
      if (batchCount > 0) {
        await batch.commit();
      }

      console.log(`Cleanup completed: deleted ${sessionsSnapshot.size} sessions`);

      return {
        success: true,
        sessionsDeleted: sessionsSnapshot.size
      };

    } catch (error) {
      console.error('Cleanup error:', error);
      throw error;
    }
  });
```

**Vercel Cron Alternative:**
```typescript
// app/api/cron/cleanup-demo/route.ts

import { NextResponse } from 'next/server';
import { getAdminFirestore } from '@/lib/firebase-admin';

export const runtime = 'edge';
export const maxDuration = 300; // 5 minutes

export async function GET(request: Request) {
  // Verify cron secret
  const authHeader = request.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const db = getAdminFirestore();
  const cutoffTime = Date.now() - (24 * 60 * 60 * 1000);

  try {
    const sessionsSnapshot = await db
      .collection('aiSessions')
      .where('demo', '==', true)
      .where('createdAt', '<', cutoffTime)
      .limit(100) // Process in batches
      .get();

    let deletedCount = 0;

    for (const sessionDoc of sessionsSnapshot.docs) {
      // Delete messages
      const messagesSnapshot = await sessionDoc.ref
        .collection('messages')
        .get();

      for (const msgDoc of messagesSnapshot.docs) {
        await msgDoc.ref.delete();
      }

      // Delete session
      await sessionDoc.ref.delete();
      deletedCount++;
    }

    return NextResponse.json({
      success: true,
      sessionsDeleted: deletedCount,
      timestamp: new Date().toISOString()
    });

  } catch (error) {
    console.error('Cleanup error:', error);
    return NextResponse.json(
      { error: 'Cleanup failed', message: String(error) },
      { status: 500 }
    );
  }
}
```

### Demo UI Components

**Demo Banner:**
```typescript
// components/demo/demo-banner.tsx

import { Info, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { useDemoMode } from '@/lib/demo/demoContext';

export function DemoBanner() {
  const { isDemoMode, disableDemoMode } = useDemoMode();

  if (!isDemoMode) return null;

  return (
    <Alert className="fixed top-0 left-0 right-0 z-50 rounded-none border-0 border-b-2 border-blue-500 bg-blue-50">
      <Info className="h-4 w-4 text-blue-600" />
      <AlertDescription className="flex items-center justify-between">
        <span className="text-sm font-medium text-blue-900">
          Demo Mode - You're viewing sample data. Changes won't be saved.
        </span>
        <Button
          variant="ghost"
          size="sm"
          onClick={disableDemoMode}
          className="text-blue-700 hover:text-blue-900"
        >
          Exit Demo <X className="ml-1 h-3 w-3" />
        </Button>
      </AlertDescription>
    </Alert>
  );
}
```

**Demo Badge:**
```typescript
// components/demo/demo-badge.tsx

export function DemoBadge() {
  return (
    <div className="inline-flex items-center rounded-full bg-blue-100 px-2.5 py-0.5 text-xs font-semibold text-blue-800">
      DEMO
    </div>
  );
}
```

### Testing

**Test Location:** `lib/demo/demoMode.test.ts`

**Test Suite:**
```typescript
describe('Demo Mode', () => {
  it('activates demo mode from URL parameter', () => {
    const searchParams = new URLSearchParams('demo=true');
    // Test demo context activation
  });

  it('persists demo mode in localStorage', () => {
    // Enable demo mode
    // Check localStorage
    expect(localStorage.getItem('fairform_demo_mode')).toBe('true');
  });

  it('seeds demo data correctly', async () => {
    await seedDemoData();
    // Verify users, cases, sessions created
  });

  it('cleans up old demo sessions', async () => {
    // Create old demo session
    // Run cleanup
    // Verify deletion
  });
});
```

### Source Tree
```
lib/demo/
├── demoContext.tsx        # NEW: Demo mode context provider
└── demoConfig.ts          # NEW: Demo configuration

components/demo/
├── demo-banner.tsx        # NEW: Demo mode banner
└── demo-badge.tsx         # NEW: Demo badge component

scripts/
├── seed-demo-data.ts      # NEW: Demo data seeding
└── cleanup-demo-data.ts   # NEW: Demo cleanup script

app/api/cron/
└── cleanup-demo/
    └── route.ts           # NEW: Cleanup cron endpoint

.env.demo                  # NEW: Demo environment config

firestore.demo.rules       # NEW: Demo security rules (from Story 13.14)

tests/
└── lib/demo/
    └── demoMode.test.ts   # NEW: Demo mode tests
```

### Deployment Commands

**Deploy Demo Environment:**
```bash
# Build with demo config
npm run build:demo

# Deploy to Vercel (demo)
vercel --env=demo

# Seed demo data
npm run seed:demo

# Deploy Firestore rules
firebase deploy --only firestore:rules --project fairform-demo
```

**Vercel Configuration:**
```json
{
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/next"
    }
  ],
  "env": {
    "NEXT_PUBLIC_DEMO_MODE": "true"
  },
  "crons": [
    {
      "path": "/api/cron/cleanup-demo",
      "schedule": "0 2 * * *"
    }
  ]
}
```

### Performance Considerations
- Demo Firebase project has separate quotas
- Limit demo data size to minimize costs
- Cache demo data for faster loading
- Monitor demo usage and cleanup frequency

### Dependencies
- Separate Firebase project
- Vercel cron jobs or Cloud Functions
- Existing authentication and database infrastructure

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent*

### Debug Log References
_To be populated by dev agent*

### Completion Notes List
_To be populated by dev agent*

### File List
_To be populated by dev agent*

## QA Results
_To be populated by QA agent*
