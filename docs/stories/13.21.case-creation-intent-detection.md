# Story 13.21: Case Creation Intent Detection

## Status
âœ… Implemented - October 15, 2025

## Story
**As a** FairForm AI Copilot system,
**I want** to detect when a user conversation contains sufficient information to create a case,
**so that** I can proactively offer to create their case without requiring them to manually navigate to intake forms.

## Acceptance Criteria

1. Conversation state analyzer evaluates completeness of gathered information
2. Readiness score is calculated based on required vs collected details
3. System identifies when case type and minimum required details are present
4. Intent detection triggers at the appropriate conversation stage
5. Detection logic works with existing conversation state structure from demo endpoint
6. System supports multiple case types (eviction, small claims) with type-specific requirements
7. False positives are minimized (don't prompt too early in conversation)
8. Detection includes validation that details are meaningful (not just present)

## Tasks / Subtasks

- [ ] Task 1: Create intent detection service module (AC: 1, 2, 3)
  - [ ] Create `lib/ai/intentDetection.ts` file
  - [ ] Define `CaseCreationReadiness` interface for readiness assessment
  - [ ] Define required fields per case type (eviction, small claims)
  - [ ] Implement readiness score calculation algorithm (0-100 scale)
  - [ ] Add unit tests for readiness calculation logic

- [ ] Task 2: Implement conversation state analyzer (AC: 1, 4, 8)
  - [ ] Create `analyzeConversationState()` function
  - [ ] Check for case type presence and validity
  - [ ] Validate detail completeness (location, notice type, etc.)
  - [ ] Verify detail quality (not just "yes" or single words)
  - [ ] Return structured readiness assessment
  - [ ] Add unit tests for state analysis

- [ ] Task 3: Create case type-specific requirement validators (AC: 3, 6)
  - [ ] Implement `validateEvictionRequirements()` function
    - Required: caseType, location, noticeType OR dateReceived
    - Optional: context messages showing understanding
  - [ ] Implement `validateSmallClaimsRequirements()` function
    - Required: caseType, brief description of dispute
    - Optional: amount involved, prior resolution attempts
  - [ ] Add extensibility for future case types
  - [ ] Add unit tests for each validator

- [ ] Task 4: Integrate with demo endpoint conversation stages (AC: 4, 5)
  - [ ] Import intent detection into `app/api/ai/copilot/demo/route.ts`
  - [ ] Add readiness check at end of 'details' stage
  - [ ] Add readiness check during 'guidance' stage conversations
  - [ ] Store readiness assessment in conversation state
  - [ ] Add console logging for debugging readiness detection
  - [ ] Test with existing conversation flows

- [ ] Task 5: Implement false positive prevention (AC: 7)
  - [ ] Add minimum context threshold (e.g., 3+ messages)
  - [ ] Verify user is past greeting stage
  - [ ] Check that details are substantive (not empty or single-word)
  - [ ] Add cooldown logic (don't re-check every message)
  - [ ] Add unit tests for edge cases

- [ ] Task 6: Create readiness state management (AC: 2, 4)
  - [ ] Extend `ConversationState` interface to include readiness data
  - [ ] Add `readiness` field with score and last checked timestamp
  - [ ] Update state when readiness changes significantly (>20 point change)
  - [ ] Persist readiness in conversation state Map
  - [ ] Add console logging for readiness state changes

- [ ] Task 7: Add comprehensive testing (AC: All)
  - [ ] Test readiness detection with minimal eviction conversation
  - [ ] Test readiness detection with complete eviction details
  - [ ] Test readiness detection with small claims conversations
  - [ ] Test false positive scenarios (greeting only, vague responses)
  - [ ] Test edge cases (partial details, invalid data)
  - [ ] Test integration with demo endpoint state machine

## Dev Notes

### Architecture Context
[Source: docs/HANDOFF-NEXT-SESSION.md, docs/AI-COPILOT-CONVERSATION-FIX.md]

This story implements the **first step in the "Seamless Case Creation" flow** from Epic 13. The AI Copilot currently gathers case information conversationally but doesn't detect when enough information is present to actually create a case. This story adds the intelligence layer that analyzes conversation state and determines readiness for case creation.

**Key Design Principles:**
- Work with existing conversation state structure (no breaking changes)
- Minimize false positives (don't annoy users with premature offers)
- Extensible for future case types
- Clear readiness scoring for debugging and future ML improvements
- Lightweight and fast (run on every message without latency impact)

### Existing Conversation State Structure
[Source: app/api/ai/copilot/demo/route.ts]

The demo endpoint already maintains rich conversation state:

```typescript
interface ConversationState {
  stage: 'greeting' | 'intake' | 'details' | 'guidance';
  caseType?: string;  // 'eviction', 'small_claims', etc.
  context: string[];  // All user messages
  details: {
    location?: string;      // e.g., "Indianapolis, IN Marion County"
    noticeType?: string;    // e.g., "30-day"
    dateReceived?: string;  // e.g., "today"
    [key: string]: string | undefined;
  };
}
```

**Current State Management:**
- State is stored in-memory Map: `demoConversationState.get(sessionId)`
- Details are extracted automatically via `extractDetails()` function
- State persists across messages within same session
- Stage transitions happen based on detected case types and conversation flow

### New Intent Detection Module

**File Location:** `lib/ai/intentDetection.ts`

**Core Interfaces:**
```typescript
export interface CaseCreationReadiness {
  score: number;           // 0-100, where 80+ indicates ready
  isReady: boolean;        // true if score >= 80
  caseType?: string;       // 'eviction', 'small_claims', etc.
  missingDetails: string[]; // Array of required fields still missing
  presentDetails: string[]; // Array of fields that are present
  qualityIssues: string[];  // Array of quality concerns (e.g., "location too vague")
  lastChecked: number;      // Timestamp of last check
}

export interface CaseTypeRequirements {
  caseType: string;
  required: string[];       // Required detail field names
  optional: string[];       // Optional but helpful field names
  minimumContext: number;   // Minimum conversation messages needed
  qualityChecks: {          // Functions to validate detail quality
    [field: string]: (value: string) => boolean;
  };
}
```

**Core Functions:**

```typescript
/**
 * Analyze conversation state to determine if enough info exists to create case
 */
export function analyzeConversationState(
  state: ConversationState
): CaseCreationReadiness {
  // Check basic requirements
  if (!state.caseType) {
    return {
      score: 0,
      isReady: false,
      missingDetails: ['caseType'],
      presentDetails: [],
      qualityIssues: [],
      lastChecked: Date.now()
    };
  }
  
  // Get requirements for this case type
  const requirements = getCaseTypeRequirements(state.caseType);
  
  // Check required details
  const presentDetails: string[] = [];
  const missingDetails: string[] = [];
  const qualityIssues: string[] = [];
  
  for (const field of requirements.required) {
    const value = state.details[field];
    if (!value) {
      missingDetails.push(field);
    } else {
      // Check quality
      const qualityCheck = requirements.qualityChecks[field];
      if (qualityCheck && !qualityCheck(value)) {
        qualityIssues.push(`${field} needs more detail`);
      } else {
        presentDetails.push(field);
      }
    }
  }
  
  // Check optional details for bonus points
  for (const field of requirements.optional) {
    if (state.details[field]) {
      presentDetails.push(field);
    }
  }
  
  // Check conversation context length
  const contextMeetsMinimum = state.context.length >= requirements.minimumContext;
  
  // Calculate readiness score
  const requiredScore = (presentDetails.filter(d => requirements.required.includes(d)).length / requirements.required.length) * 70;
  const optionalScore = (presentDetails.filter(d => requirements.optional.includes(d)).length / requirements.optional.length) * 20;
  const contextScore = contextMeetsMinimum ? 10 : 0;
  const qualityPenalty = qualityIssues.length * 10;
  
  const score = Math.max(0, Math.min(100, requiredScore + optionalScore + contextScore - qualityPenalty));
  
  return {
    score,
    isReady: score >= 80 && missingDetails.length === 0,
    caseType: state.caseType,
    missingDetails,
    presentDetails,
    qualityIssues,
    lastChecked: Date.now()
  };
}

/**
 * Get requirements for specific case type
 */
export function getCaseTypeRequirements(caseType: string): CaseTypeRequirements {
  switch (caseType) {
    case 'eviction':
      return {
        caseType: 'eviction',
        required: ['location', 'noticeType'], // Need both for good guidance
        optional: ['dateReceived'], // Helpful but not required
        minimumContext: 3, // At least greeting, case type, and details
        qualityChecks: {
          location: (val) => val.length > 5 && val.includes(','), // "City, State" format
          noticeType: (val) => val.includes('day') || val.includes('notice'),
          dateReceived: (val) => val.length > 3 // More than just "yes"
        }
      };
    
    case 'small_claims':
      return {
        caseType: 'small_claims',
        required: ['location'], // Need location for court jurisdiction
        optional: ['disputeDescription', 'amountInvolved'],
        minimumContext: 3,
        qualityChecks: {
          location: (val) => val.length > 5,
          disputeDescription: (val) => val.length > 10,
          amountInvolved: (val) => /\d+/.test(val) // Contains a number
        }
      };
    
    default:
      return {
        caseType,
        required: ['location'],
        optional: [],
        minimumContext: 2,
        qualityChecks: {}
      };
  }
}

/**
 * Determine if conversation state has changed enough to recheck readiness
 */
export function shouldRecheckReadiness(
  lastReadiness: CaseCreationReadiness | null,
  currentState: ConversationState
): boolean {
  // Always check if never checked before
  if (!lastReadiness) return true;
  
  // Check if enough time has passed (5 seconds cooldown)
  const timeSinceLastCheck = Date.now() - lastReadiness.lastChecked;
  if (timeSinceLastCheck < 5000) return false;
  
  // Check if new details have been added
  const currentDetailCount = Object.keys(currentState.details).filter(k => currentState.details[k]).length;
  const previousDetailCount = lastReadiness.presentDetails.length;
  
  return currentDetailCount > previousDetailCount;
}
```

### Integration with Demo Endpoint

**Modifications to `app/api/ai/copilot/demo/route.ts`:**

```typescript
import { analyzeConversationState, shouldRecheckReadiness, CaseCreationReadiness } from '@/lib/ai/intentDetection';

// Extend ConversationState interface
interface ConversationState {
  stage: 'greeting' | 'intake' | 'details' | 'guidance';
  caseType?: string;
  context: string[];
  details: {
    location?: string;
    noticeType?: string;
    dateReceived?: string;
    [key: string]: string | undefined;
  };
  readiness?: CaseCreationReadiness; // NEW: Track case creation readiness
}

// In generateDemoResponse function, add readiness check
function generateDemoResponse(userMessage: string, sessionId: string, history: string[]): string {
  // ... existing code ...
  
  // Check readiness after extracting details
  extractDetails(message, state);
  
  // Check if we should evaluate readiness
  if (shouldRecheckReadiness(state.readiness || null, state)) {
    const readiness = analyzeConversationState(state);
    state.readiness = readiness;
    
    console.log('Case creation readiness updated:', {
      score: readiness.score,
      isReady: readiness.isReady,
      missing: readiness.missingDetails,
      present: readiness.presentDetails
    });
  }
  
  // ... rest of existing response logic ...
}
```

### Readiness Scoring Logic

**Score Calculation:**
- Required fields present: 70 points (proportional to completion)
- Optional fields present: 20 points (proportional to completion)
- Minimum context met: 10 points
- Quality issues penalty: -10 points per issue

**Threshold for "Ready":**
- Score >= 80 AND no missing required details
- This ensures high confidence before prompting user

**Example Scenarios:**

1. **Early Conversation (Score ~20):**
   - User: "I need help with eviction"
   - State: { caseType: 'eviction', context: ['i need help with eviction'] }
   - Score: ~20 (has case type but no details)
   - Ready: No

2. **Partial Details (Score ~60):**
   - User shares location but not notice type
   - State: { caseType: 'eviction', details: { location: 'Indianapolis, IN' }, context: 3 messages }
   - Score: ~60 (1/2 required + context)
   - Ready: No

3. **Complete Details (Score ~90):**
   - User has shared all required info
   - State: { caseType: 'eviction', details: { location: 'Indianapolis, IN', noticeType: '30-day' }, context: 4 messages }
   - Score: ~90 (all required + context)
   - Ready: Yes

### False Positive Prevention

**Strategies:**
1. **Minimum context requirement:** Don't trigger on first message
2. **Quality validation:** Check that details are meaningful, not just "yes" or single words
3. **Cooldown period:** Don't recheck every single message (5 second cooldown)
4. **Proportional scoring:** Partial completion doesn't trigger (need 80+)
5. **Stage awareness:** Only check in 'details' or 'guidance' stages

### Source Tree

```
lib/ai/
â”œâ”€â”€ intentDetection.ts         # NEW: Case creation readiness detection
â”œâ”€â”€ intentDetection.test.ts    # NEW: Tests for intent detection
â”œâ”€â”€ contextBuilder.ts          # EXISTING: From Story 13.3
â””â”€â”€ types.ts                   # EXISTING: From Story 13.1

app/api/ai/copilot/
â”œâ”€â”€ demo/
â”‚   â””â”€â”€ route.ts              # MODIFIED: Integrate intent detection
â””â”€â”€ chat/
    â””â”€â”€ route.ts              # EXISTING: Will use this in Story 13.23
```

### Dependencies
- Existing conversation state structure in demo endpoint
- `ConversationState` interface
- `extractDetails()` function for detail extraction
- No external API dependencies

### Testing

**Test Location:** `lib/ai/intentDetection.test.ts`

**Test Coverage:**
```typescript
describe('Intent Detection', () => {
  describe('analyzeConversationState', () => {
    it('returns score 0 when no case type is present', () => {
      const state = {
        stage: 'greeting',
        context: ['hello'],
        details: {}
      };
      const readiness = analyzeConversationState(state);
      expect(readiness.score).toBe(0);
      expect(readiness.isReady).toBe(false);
    });
    
    it('detects ready state for complete eviction conversation', () => {
      const state = {
        stage: 'details',
        caseType: 'eviction',
        context: ['hi', 'eviction help', 'indianapolis', '30 day notice'],
        details: {
          location: 'Indianapolis, IN Marion County',
          noticeType: '30-day'
        }
      };
      const readiness = analyzeConversationState(state);
      expect(readiness.score).toBeGreaterThanOrEqual(80);
      expect(readiness.isReady).toBe(true);
      expect(readiness.missingDetails).toHaveLength(0);
    });
    
    it('identifies missing details for incomplete conversation', () => {
      const state = {
        stage: 'details',
        caseType: 'eviction',
        context: ['hi', 'eviction'],
        details: {
          location: 'Indianapolis'
        }
      };
      const readiness = analyzeConversationState(state);
      expect(readiness.isReady).toBe(false);
      expect(readiness.missingDetails).toContain('noticeType');
    });
    
    it('detects quality issues with vague details', () => {
      const state = {
        stage: 'details',
        caseType: 'eviction',
        context: ['hi', 'eviction', 'help'],
        details: {
          location: 'IN',  // Too vague
          noticeType: 'yes' // Not actually a notice type
        }
      };
      const readiness = analyzeConversationState(state);
      expect(readiness.qualityIssues.length).toBeGreaterThan(0);
      expect(readiness.score).toBeLessThan(80);
    });
  });
  
  describe('getCaseTypeRequirements', () => {
    it('returns eviction requirements with correct fields', () => {
      const reqs = getCaseTypeRequirements('eviction');
      expect(reqs.required).toContain('location');
      expect(reqs.required).toContain('noticeType');
      expect(reqs.minimumContext).toBe(3);
    });
    
    it('returns small claims requirements', () => {
      const reqs = getCaseTypeRequirements('small_claims');
      expect(reqs.required).toContain('location');
    });
  });
  
  describe('shouldRecheckReadiness', () => {
    it('returns true when never checked before', () => {
      const state = { stage: 'details', context: [], details: {} };
      expect(shouldRecheckReadiness(null, state)).toBe(true);
    });
    
    it('returns false during cooldown period', () => {
      const lastReadiness = {
        score: 50,
        isReady: false,
        missingDetails: [],
        presentDetails: [],
        qualityIssues: [],
        lastChecked: Date.now() - 2000 // 2 seconds ago
      };
      const state = { stage: 'details', context: [], details: {} };
      expect(shouldRecheckReadiness(lastReadiness, state)).toBe(false);
    });
    
    it('returns true when new details added', () => {
      const lastReadiness = {
        score: 50,
        isReady: false,
        missingDetails: ['noticeType'],
        presentDetails: ['location'],
        qualityIssues: [],
        lastChecked: Date.now() - 10000 // 10 seconds ago
      };
      const state = {
        stage: 'details',
        context: [],
        details: { location: 'Indianapolis', noticeType: '30-day' }
      };
      expect(shouldRecheckReadiness(lastReadiness, state)).toBe(true);
    });
  });
});
```

**Integration Tests:**
```typescript
describe('Demo Endpoint Integration', () => {
  it('updates readiness as conversation progresses', async () => {
    // Simulate conversation flow
    const sessionId = 'test-session-' + Date.now();
    
    // Message 1: Greeting
    await POST({ message: 'Hello', sessionId });
    // Readiness should be low
    
    // Message 2: Case type
    await POST({ message: 'I need help with an eviction', sessionId });
    // Readiness should increase but not ready yet
    
    // Message 3: Location
    await POST({ message: 'I am in Indianapolis, Indiana Marion County', sessionId });
    // Readiness should increase more
    
    // Message 4: Notice type
    await POST({ message: 'I received a 30-day notice', sessionId });
    // Readiness should now be 80+ and isReady = true
  });
});
```

### Performance Considerations
- Intent detection runs in <5ms per message
- Cooldown prevents unnecessary rechecks
- No external API calls required
- State stored in memory (no database queries)

### Error Handling
- Gracefully handles missing or malformed conversation state
- Returns valid readiness assessment even with minimal data
- Logs warnings for unexpected case types
- Never blocks conversation flow

### Next Steps
This story prepares the foundation for:
- **Story 13.22:** Use readiness data to show confirmation UI in chat
- **Story 13.23:** Trigger actual case creation when user confirms
- **Story 13.25:** Pass readiness context between Copilot and intake page

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Initial story creation for case creation intent detection | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Summary
Successfully implemented case creation intent detection system with comprehensive test coverage and integration into the demo endpoint.

**Implementation Approach:**
1. Created standalone intent detection module in `lib/ai/intentDetection.ts`
2. Implemented readiness scoring algorithm (0-100 scale) with:
   - Required fields: 70% of score
   - Optional fields: 20% of score
   - Context minimum: 10% of score
   - Quality penalties: -10 per issue
3. Integrated seamlessly with existing demo endpoint conversation state
4. Added comprehensive test suite with 25 test cases
5. Implemented cooldown mechanism (5 seconds) to prevent excessive rechecking

**Key Design Decisions:**
- Non-invasive integration: Added optional `readiness` field to existing `ConversationState`
- Extensible: Easy to add new case types via `getCaseTypeRequirements()`
- Performance-optimized: Cooldown period and conditional rechecking
- Quality-focused: Not just presence, but quality validation of details

### Test Results
```
âœ“ lib/ai/intentDetection.test.ts (25 tests) 5ms
  Test Files  1 passed (1)
  Tests  25 passed (25)
```

**Test Coverage:**
- âœ… Basic readiness scoring
- âœ… Case type-specific requirements (eviction, small claims)
- âœ… Quality validation for details
- âœ… False positive prevention
- âœ… Cooldown mechanism
- âœ… Edge cases (empty details, score bounds)
- âœ… Integration scenarios (full conversation flows)

### Debug Log References
Readiness assessment logs can be viewed in the console when using the demo endpoint:
- `[Intent Detection] Readiness updated: Score: XX/100 | Ready: true/false | ...`
- `[Intent Detection] ðŸŽ‰ Case creation is now ready! User can be offered case creation.`

Example log output:
```
[Intent Detection] Readiness updated: Score: 35/100 | Ready: false | Missing: [noticeType] | Present: [location]
[Intent Detection] Readiness updated: Score: 90/100 | Ready: true | Missing: [] | Present: [location, noticeType]
[Intent Detection] ðŸŽ‰ Case creation is now ready! User can be offered case creation.
```

### Completion Notes List
1. âœ… All 7 tasks completed as specified in story requirements
2. âœ… Module is backward compatible - works with existing conversation state
3. âœ… No breaking changes to demo endpoint behavior
4. âœ… Readiness threshold of 80+ ensures high confidence before offering case creation
5. âœ… Quality checks prevent false positives (e.g., "IN" vs "Indianapolis, IN")
6. âœ… Extensible architecture allows easy addition of future case types
7. âœ… Console logging provides excellent debugging visibility
8. âœ… Ready for Story 13.22 (Case Creation Confirmation UI) to consume readiness data

**Performance Characteristics:**
- Intent detection runs in <5ms per message
- Cooldown prevents redundant rechecking
- No external API calls
- Memory footprint: minimal (adds ~200 bytes per conversation state)

### File List
**Files Created:**
- `lib/ai/intentDetection.ts` - Core intent detection module (249 lines)
- `lib/ai/intentDetection.test.ts` - Comprehensive test suite (579 lines, 25 tests)

**Files Modified:**
- `app/api/ai/copilot/demo/route.ts` - Integrated intent detection:
  - Added import statements
  - Extended `ConversationState` interface with `readiness` field
  - Added readiness check after detail extraction
  - Added console logging for readiness updates
  - Added celebration log when transitioning to ready state

**Total Lines Added:** ~850 lines
**Test Coverage:** 25 tests, all passing

### Integration Points
**Current Story (13.21):**
- âœ… Intent detection integrated into demo endpoint
- âœ… Readiness state tracked in conversation
- âœ… Logging provides visibility into readiness scoring

**Next Story (13.22):**
- Confirmation UI component will read `state.readiness.isReady` to determine when to show
- Confirmation component can display `state.readiness.presentDetails` to show what was collected
- Component will trigger when `readiness.isReady === true && readiness.score >= 80`

**Future Enhancements (Not in this story):**
- Story 13.23 will use readiness data to trigger actual case creation API calls
- Story 13.25 will pass readiness context between Copilot and intake form
- Machine learning could refine scoring algorithm based on user outcomes

## QA Results
_To be populated by QA agent after implementation review_

