# Story 13.27: Visual Progress Indicator

## Status
ðŸ“‹ Planned

## Story
**As a** user creating a case through AI Copilot,
**I want** to see what information has been collected and what's still needed,
**so that** I know my progress and what questions to expect.

## Acceptance Criteria

1. Progress checklist displays 3 required items (Case Type, Location, Case #/Date)
2. Each item shows visual state: âœ“ (collected), â—‹ (needed)
3. Checklist updates in real-time as information is extracted from conversation
4. Checklist collapses or minimizes when all requirements are met
5. Visual design matches FairForm design system
6. Works on both mobile and desktop
7. Accessible (screen reader compatible, keyboard navigable)
8. Shows confidence level for low-confidence extractions

## Tasks / Subtasks

- [ ] Task 1: Create ProgressIndicator component (AC: 1, 2, 5)
  - [ ] Create `components/ai-copilot/ProgressIndicator.tsx`
  - [ ] Define props interface (collectedInfo, requiredFields)
  - [ ] Implement checklist UI with checkmark states
  - [ ] Add Tailwind styling matching design system
  - [ ] Add collapse/expand animation
  - [ ] Add unit tests for component

- [ ] Task 2: Integrate with conversation state (AC: 3, 4)
  - [ ] Connect to `conversationStage` and `collectedInfo` from hook
  - [ ] Update component when extraction happens
  - [ ] Auto-collapse when all items collected
  - [ ] Add smooth transitions between states
  - [ ] Test with different case types

- [ ] Task 3: Add confidence indicators (AC: 8)
  - [ ] Show amber icon for <70% confidence fields
  - [ ] Add tooltip explaining confidence level
  - [ ] Allow click to edit low-confidence items
  - [ ] Test with various confidence levels

- [ ] Task 4: Accessibility implementation (AC: 7)
  - [ ] Add ARIA labels to all elements
  - [ ] Ensure keyboard navigation works
  - [ ] Test with screen readers (VoiceOver, NVDA)
  - [ ] Add focus styles
  - [ ] Add live region announcements for updates

- [ ] Task 5: Responsive design (AC: 6)
  - [ ] Test on mobile devices (320px-480px)
  - [ ] Test on tablets (768px-1024px)
  - [ ] Test on desktop (1280px+)
  - [ ] Adjust sizing and spacing for each breakpoint

- [ ] Task 6: Integration testing (AC: All)
  - [ ] Test with real conversation flows
  - [ ] Test with partial data collection
  - [ ] Test with complete data collection
  - [ ] Test collapse/expand behavior
  - [ ] Test visual updates in real-time

## Dev Notes

### Architecture Context
[Source: docs/EPIC-13-PROGRESS.md Phase 4]

This story adds visual feedback to the case creation flow established in Stories 13.21-13.26. Users currently don't have visibility into what information the AI has collected or what's still needed, leading to confusion and drop-offs.

**Key Design Principles:**
- Always visible during information gathering phase
- Non-intrusive (doesn't block conversation)
- Updates feel instant (<100ms after extraction)
- Celebrates progress (subtle animation on checkmark)
- Clear indication of completion

### Existing Conversation State
[Source: lib/ai/conversationStages.ts, lib/ai/types.ts]

```typescript
interface MinimumCaseInfo {
  caseType?: string;
  jurisdiction?: string;
  caseNumber?: string;
  hearingDate?: string;
}

interface ContextSnapshot {
  conversationStage?: ConversationStage;
  collectedInfo?: MinimumCaseInfo;
  caseType?: CaseType;
  jurisdiction?: string;
  // ...
}
```

### Component Design

**File Location:** `components/ai-copilot/ProgressIndicator.tsx`

```typescript
import { CheckCircle2, Circle, AlertCircle } from 'lucide-react';
import { cn } from '@/lib/utils';
import type { MinimumCaseInfo } from '@/lib/ai/types';

interface ProgressIndicatorProps {
  collectedInfo: Partial<MinimumCaseInfo>;
  isVisible: boolean;
  confidence?: {
    caseType?: number;
    jurisdiction?: number;
    caseNumber?: number;
    hearingDate?: number;
  };
}

export function ProgressIndicator({
  collectedInfo,
  isVisible,
  confidence = {}
}: ProgressIndicatorProps) {
  if (!isVisible) return null;

  const items = [
    {
      label: 'Case Type',
      value: collectedInfo.caseType,
      confidence: confidence.caseType,
      key: 'caseType'
    },
    {
      label: 'Location',
      value: collectedInfo.jurisdiction,
      confidence: confidence.jurisdiction,
      key: 'jurisdiction'
    },
    {
      label: 'Case # or Hearing Date',
      value: collectedInfo.caseNumber || collectedInfo.hearingDate,
      confidence: confidence.caseNumber || confidence.hearingDate,
      key: 'identifier'
    }
  ];

  const completedCount = items.filter(item => item.value).length;
  const allComplete = completedCount === items.length;

  return (
    <div
      className={cn(
        "bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 transition-all",
        allComplete && "opacity-75 scale-95"
      )}
      role="status"
      aria-live="polite"
      aria-label={`Case information: ${completedCount} of ${items.length} items collected`}
    >
      <div className="flex items-center justify-between mb-2">
        <h4 className="font-medium text-sm text-blue-900">
          Case Information
        </h4>
        <span className="text-xs text-blue-600">
          {completedCount}/{items.length}
        </span>
      </div>

      <div className="space-y-1">
        {items.map((item) => {
          const isCollected = Boolean(item.value);
          const hasLowConfidence = item.confidence && item.confidence < 0.7;

          return (
            <div
              key={item.key}
              className={cn(
                "flex items-center gap-2 text-sm transition-colors",
                isCollected && "text-green-700",
                !isCollected && "text-gray-500"
              )}
            >
              {isCollected ? (
                hasLowConfidence ? (
                  <AlertCircle className="h-4 w-4 text-amber-500" />
                ) : (
                  <CheckCircle2 className="h-4 w-4" />
                )
              ) : (
                <Circle className="h-4 w-4" />
              )}

              <span className="flex-1">
                {item.label}
              </span>

              {isCollected && item.value && (
                <span className="text-xs text-gray-600">
                  {typeof item.value === 'string' && item.value.length > 20
                    ? `${item.value.substring(0, 20)}...`
                    : item.value}
                </span>
              )}

              {hasLowConfidence && (
                <button
                  className="text-xs text-blue-600 hover:underline"
                  onClick={() => {/* Edit handler */}}
                >
                  Edit
                </button>
              )}
            </div>
          );
        })}
      </div>

      {allComplete && (
        <div className="mt-2 pt-2 border-t border-blue-200 text-xs text-green-700">
          âœ“ All required information collected
        </div>
      )}
    </div>
  );
}
```

### Integration with ChatPanel

**Modifications to `components/ai-copilot/ChatPanel.tsx`:**

```typescript
import { ProgressIndicator } from './ProgressIndicator';
import { useAICopilot } from '@/lib/hooks/useAICopilot';

export function ChatPanel({ isOpen, onClose, sessionId, caseId }: ChatPanelProps) {
  const {
    messages,
    // ... other state
    conversationStage,
    collectedInfo,
    confidence
  } = useAICopilot(sessionId, caseId);

  // Show progress indicator during gathering stages
  const showProgress =
    conversationStage === 'GATHER_MIN' ||
    conversationStage === 'GREET';

  return (
    <div className="chat-panel">
      {/* Header */}

      <div className="messages-container">
        {/* Show progress at top of messages */}
        {showProgress && (
          <ProgressIndicator
            collectedInfo={collectedInfo}
            isVisible={true}
            confidence={confidence}
          />
        )}

        {/* Messages */}
        {messages.map((msg) => (
          <MessageBubble key={msg.id} message={msg} />
        ))}
      </div>

      {/* Input */}
    </div>
  );
}
```

### Confidence Data Structure

Currently, the conversation stages module doesn't return confidence scores. This story will add that capability:

```typescript
// lib/ai/conversationStages.ts - Enhancement
export interface ExtractionResult {
  info: Partial<MinimumCaseInfo>;
  confidence: {
    caseType?: number;      // 0.0-1.0
    jurisdiction?: number;   // 0.0-1.0
    caseNumber?: number;    // 0.0-1.0
    hearingDate?: number;   // 0.0-1.0
  };
}

// When using GPT function calling (Story 13.31), confidence scores will be more accurate
// For now, regex extractions assume 1.0 confidence
```

### Accessibility Requirements

- **ARIA Labels:** All icons and interactive elements labeled
- **Live Regions:** Updates announced to screen readers
- **Keyboard Navigation:** Tab between edit buttons, Enter to activate
- **Focus Management:** Clear focus indicators
- **Screen Reader Testing:** Test with VoiceOver (Mac) and NVDA (Windows)

### Visual Design Tokens

```typescript
// colors
bg: 'bg-blue-50'
border: 'border-blue-200'
text-primary: 'text-blue-900'
text-secondary: 'text-blue-600'
complete: 'text-green-700'
warning: 'text-amber-500'
incomplete: 'text-gray-500'

// spacing
padding: 'p-3'
gap: 'gap-2'
margin: 'mb-4'

// transitions
transition: 'transition-all duration-200'
```

### Performance Considerations

- Component re-renders only when `collectedInfo` changes
- Smooth animations use CSS transitions (not JS)
- No heavy computations in render
- Memoize expensive formatting operations

### Testing Strategy

**Unit Tests:**
```typescript
describe('ProgressIndicator', () => {
  it('shows all items as incomplete initially', () => {
    render(<ProgressIndicator collectedInfo={{}} isVisible={true} />);
    expect(screen.getAllByRole('img', { name: /not collected/i })).toHaveLength(3);
  });

  it('updates when case type is collected', () => {
    const { rerender } = render(
      <ProgressIndicator collectedInfo={{}} isVisible={true} />
    );

    rerender(
      <ProgressIndicator
        collectedInfo={{ caseType: 'eviction' }}
        isVisible={true}
      />
    );

    expect(screen.getByText(/case type/i).closest('div')).toHaveClass('text-green-700');
  });

  it('shows confidence warning for low-confidence items', () => {
    render(
      <ProgressIndicator
        collectedInfo={{ caseType: 'eviction' }}
        confidence={{ caseType: 0.6 }}
        isVisible={true}
      />
    );

    expect(screen.getByRole('button', { name: /edit/i })).toBeInTheDocument();
  });

  it('is hidden when isVisible is false', () => {
    const { container } = render(
      <ProgressIndicator collectedInfo={{}} isVisible={false} />
    );

    expect(container).toBeEmptyDOMElement();
  });
});
```

**Integration Tests:**
```typescript
describe('ChatPanel with ProgressIndicator', () => {
  it('shows progress indicator during gathering stage', () => {
    render(<ChatPanel isOpen={true} conversationStage="GATHER_MIN" />);
    expect(screen.getByRole('status', { name: /case information/i })).toBeInTheDocument();
  });

  it('updates progress as conversation progresses', async () => {
    const { user } = setup(<ChatPanel isOpen={true} />);

    // Send message with case type
    await user.type(screen.getByRole('textbox'), 'I need help with an eviction');
    await user.click(screen.getByRole('button', { name: /send/i }));

    // Progress should update
    await waitFor(() => {
      expect(screen.getByText(/case type/i).closest('div')).toHaveClass('text-green-700');
    });
  });
});
```

### Dependencies

- Existing conversation stage system (13.21-13.26)
- `MinimumCaseInfo` type from lib/ai/types.ts
- Lucide icons package (already installed)
- Tailwind CSS (already configured)

### Future Enhancements (Not in this story)

- Story 13.31 will provide real confidence scores from GPT functions
- Story 13.32 will add inline editing capability
- Animated progress bar showing overall completion percentage
- Sound effects on completion (optional, user preference)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-16 | 1.0 | Initial story creation for visual progress indicator | Product Team |

## Dev Agent Record
_To be populated during implementation_

## QA Results
_To be populated by QA agent after implementation review_

