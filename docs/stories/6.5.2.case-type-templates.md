# Story 6.5.2: Case Type Templates & Journey Generation

## Status: Draft

## Story

As a **FairForm user**,
I want **case-type-specific journey templates and automated step generation**,
So that **different types of legal cases can have tailored step sequences and guidance**.

## Context Source

- Source Document: Case Detail Realignment Plan
- Enhancement Type: Template system and journey generation
- Existing System Impact: Adds template-based step generation while preserving current Small Claims workflow

## Acceptance Criteria

### Functional Requirements

1. **Template Registry**: Create case type template registry with Small Claims implementation
2. **Journey Generation**: Implement `generateCaseJourney()` function for step materialization
3. **Small Claims Template**: Define complete 5-step Small Claims journey template
4. **Template Extensibility**: Registry structure ready for additional case types (Employment, Housing, etc.)

### Technical Requirements

5. **Template Structure**: Consistent template format with title, description, stepType, instructions, estimatedTime
6. **Step Generation**: Generate steps from templates and persist to Firestore
7. **Repository Integration**: Templates integrate with existing repository pattern

### Quality Requirements

8. **Testing**: Unit tests for template registry and journey generation
9. **Documentation**: Template format documentation and usage examples
10. **Performance**: Template loading and step generation ≤ 150ms

## Tasks / Subtasks

- [ ] **Task 1**: Create case type template registry structure
  - [ ] Create `lib/journeys/templates/index.ts` file
  - [ ] Define `CaseType` enum and template interface
  - [ ] Create template registry structure
  - [ ] Add TypeScript types for templates

- [ ] **Task 2**: Implement Small Claims journey template
  - [ ] Define 5-step Small Claims template
  - [ ] Map current Small Claims workflow to template format
  - [ ] Include step types, descriptions, and instructions
  - [ ] Add estimated time for each step

- [ ] **Task 3**: Create journey generation system
  - [ ] Implement `generateCaseJourney()` function
  - [ ] Add step materialization logic
  - [ ] Create template-to-step mapping
  - [ ] Add step ordering and linking logic

- [ ] **Task 4**: Integrate with repository pattern
  - [ ] Update `casesRepo.ts` with template-based step creation
  - [ ] Add `createCaseFromTemplate()` method
  - [ ] Integrate with existing step creation workflow
  - [ ] Maintain backward compatibility

- [ ] **Task 5**: Add comprehensive testing
  - [ ] Unit tests for template registry
  - [ ] Journey generation tests
  - [ ] Integration tests with repository
  - [ ] Template validation tests

## Dev Notes

### Previous Story Context

This story builds on Story 6.5.1:
- Case type enum and status adapter foundation
- Enhanced data model with case type support
- Repository pattern with progress calculation

### Technical Implementation

**Template Registry Structure:**
```typescript
// lib/journeys/templates/index.ts
export interface JourneyTemplate {
  title: string;
  description: string;
  stepType: 'form' | 'document' | 'review' | 'submit' | 'wait' | 'meeting' | 'communication';
  instructions: string[];
  estimatedTime?: number; // in minutes
}

export const templates: Record<CaseType, JourneyTemplate[]> = {
  small_claims: [
    {
      title: "File Your Claim",
      description: "Complete and file your small claims court form",
      stepType: "form",
      instructions: [
        "Download the small claims court form",
        "Fill out all required information",
        "Review for accuracy and completeness"
      ],
      estimatedTime: 30
    },
    // ... 4 more steps
  ],
  // Future case types...
};
```

**Journey Generation:**
```typescript
// lib/journeys/generate.ts
export async function generateCaseJourney(
  caseId: string, 
  caseType: CaseType, 
  currentStep?: number
): Promise<CaseStep[]> {
  const template = templates[caseType];
  const steps = template.map((stepTemplate, index) => ({
    // Map template to CaseStep format
    // Generate step IDs, set completion status
    // Link to previous/next steps
  }));
  
  // Persist to Firestore via repository
  return await stepsRepo.createSteps(caseId, steps);
}
```

**Small Claims Template (Current 5-Step Set):**
1. **File Your Claim** - Complete and file court form
2. **Serve the Defendant** - Deliver legal notice to defendant
3. **Prepare for Hearing** - Gather evidence and prepare arguments
4. **Attend Court Hearing** - Present case to judge
5. **Collect Judgment** - Follow up on court decision

### File Locations

**New Files:**
- `lib/journeys/templates/index.ts` - Template registry
- `lib/journeys/generate.ts` - Journey generation logic
- `tests/lib/journeys/templates.test.ts` - Template tests
- `tests/lib/journeys/generate.test.ts` - Generation tests

**Modified Files:**
- `lib/db/casesRepo.ts` - Template integration
- `lib/db/stepsRepo.ts` - Step creation from templates

### Design System Integration

- Templates use consistent step type categorization
- Instructions follow established content patterns
- Estimated times align with user experience expectations

### Repository Pattern

- Templates integrate with existing repository pattern
- Journey generation uses repository methods for persistence
- Maintains separation between template logic and data access

### React Query Hook Pattern

- Existing `useCaseSteps` hook continues to work
- Template-based steps appear in existing timeline
- No breaking changes to current hook interfaces

### Accessibility Requirements

- Template instructions support screen reader navigation
- Step types provide semantic meaning for assistive technology
- Estimated times help users plan their workflow

### Testing Requirements

**Unit Tests:**
- Template registry structure validation
- Journey generation logic
- Step mapping and linking
- Template format validation

**Integration Tests:**
- Repository integration
- Template-to-step conversion
- Database persistence
- Error handling scenarios

**Performance Tests:**
- Template loading speed
- Journey generation performance
- Database operation efficiency

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- Template registry implementation
- Journey generation logic
- Repository integration testing

### Completion Notes List
- Case type template registry created with Small Claims implementation
- Journey generation system implemented with repository integration
- Small Claims 5-step template mapped from current workflow
- Template structure ready for additional case types

### File List
**New Files:**
- `lib/journeys/templates/index.ts` - Template registry
- `lib/journeys/generate.ts` - Journey generation logic
- `tests/lib/journeys/templates.test.ts` - Template tests
- `tests/lib/journeys/generate.test.ts` - Generation tests

**Modified Files:**
- `lib/db/casesRepo.ts` - Template integration
- `lib/db/stepsRepo.ts` - Step creation from templates

### Change Log
**2025-10-10**: Initial story creation for Epic 6.5 template system
- Created case type template registry with Small Claims implementation
- Implemented journey generation system with repository integration
- Mapped current Small Claims workflow to template format

## Testing

### Test Strategy
- Unit tests for template registry and journey generation
- Integration tests with repository pattern
- Template validation and error handling
- Performance tests for generation speed

### Test Coverage Targets
- Template registry: 100% line coverage
- Journey generation: 100% line coverage
- Repository integration: 100% path coverage

### Accessibility Testing
- Template instructions accessibility validation
- Step type semantic meaning verification
- Screen reader navigation testing

### Performance Testing
- Template loading benchmarks (≤ 150ms)
- Journey generation performance
- Database operation efficiency

## QA Results

*To be completed after implementation*

---

**Story Owner:** SM (Bob)  
**Created:** October 10, 2025  
**Epic:** 6.5 Case Detail V2 Enhancement  
**Dependencies:** Story 6.5.1 complete
