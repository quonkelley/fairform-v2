# Story 6.5.2: Case Type Templates & Journey Generation

## Status: Ready for Review

## Story

As a **FairForm user**,
I want **case-type-specific journey templates and automated step generation**,
So that **different types of legal cases can have tailored step sequences and guidance**.

## Context Source

- Source Document: Case Detail Realignment Plan
- Enhancement Type: Template system and journey generation
- Existing System Impact: Adds template-based step generation while preserving current Small Claims workflow

## Acceptance Criteria

### Functional Requirements

1. **Template Registry**: Create case type template registry with Small Claims implementation
2. **Journey Generation**: Implement `generateCaseJourney()` function for step materialization
3. **Small Claims Template**: Define complete 5-step Small Claims journey template
4. **Template Extensibility**: Registry structure ready for additional case types (Employment, Housing, etc.)

### Technical Requirements

5. **Template Structure**: Consistent template format with title, description, stepType, instructions, estimatedTime
6. **Step Generation**: Generate steps from templates and persist to Firestore
7. **Repository Integration**: Templates integrate with existing repository pattern

### Quality Requirements

8. **Testing**: Unit tests for template registry and journey generation
9. **Documentation**: Template format documentation and usage examples
10. **Performance**: Template loading and step generation ≤ 150ms

## Tasks / Subtasks

- [x] **Task 1**: Create case type template registry structure
  - [x] Create `lib/journeys/templates/index.ts` file
  - [x] Define `CaseType` enum and template interface
  - [x] Create template registry structure
  - [x] Add TypeScript types for templates

- [x] **Task 2**: Implement Small Claims journey template
  - [x] Define 5-step Small Claims template
  - [x] Map current Small Claims workflow to template format
  - [x] Include step types, descriptions, and instructions
  - [x] Add estimated time for each step

- [x] **Task 3**: Create journey generation system
  - [x] Implement `generateCaseJourney()` function
  - [x] Add step materialization logic
  - [x] Create template-to-step mapping
  - [x] Add step ordering and linking logic

- [x] **Task 4**: Integrate with repository pattern
  - [x] Update `casesRepo.ts` with template-based step creation
  - [x] Add `createCaseWithJourney()` method
  - [x] Integrate with existing step creation workflow
  - [x] Maintain backward compatibility

- [x] **Task 5**: Add comprehensive testing
  - [x] Unit tests for template registry
  - [x] Journey generation tests
  - [x] Integration tests with repository
  - [x] Template validation tests

## Dev Notes

### Previous Story Context

This story builds on Story 6.5.1:
- Case type enum and status adapter foundation
- Enhanced data model with case type support
- Repository pattern with progress calculation

### Technical Implementation

**Template Registry Structure:**
```typescript
// lib/journeys/templates/index.ts
export interface JourneyTemplate {
  title: string;
  description: string;
  stepType: 'form' | 'document' | 'review' | 'submit' | 'wait' | 'meeting' | 'communication';
  instructions: string[];
  estimatedTime?: number; // in minutes
}

export const templates: Record<CaseType, JourneyTemplate[]> = {
  small_claims: [
    {
      title: "File Your Claim",
      description: "Complete and file your small claims court form",
      stepType: "form",
      instructions: [
        "Download the small claims court form",
        "Fill out all required information",
        "Review for accuracy and completeness"
      ],
      estimatedTime: 30
    },
    // ... 4 more steps
  ],
  // Future case types...
};
```

**Journey Generation:**
```typescript
// lib/journeys/generate.ts
export async function generateCaseJourney(
  caseId: string, 
  caseType: CaseType, 
  currentStep?: number
): Promise<CaseStep[]> {
  const template = templates[caseType];
  const steps = template.map((stepTemplate, index) => ({
    // Map template to CaseStep format
    // Generate step IDs, set completion status
    // Link to previous/next steps
  }));
  
  // Persist to Firestore via repository
  return await stepsRepo.createSteps(caseId, steps);
}
```

**Small Claims Template (Current 5-Step Set):**
1. **File Your Claim** - Complete and file court form
2. **Serve the Defendant** - Deliver legal notice to defendant
3. **Prepare for Hearing** - Gather evidence and prepare arguments
4. **Attend Court Hearing** - Present case to judge
5. **Collect Judgment** - Follow up on court decision

### File Locations

**New Files:**
- `lib/journeys/templates/index.ts` - Template registry
- `lib/journeys/generate.ts` - Journey generation logic
- `tests/lib/journeys/templates.test.ts` - Template tests
- `tests/lib/journeys/generate.test.ts` - Generation tests

**Modified Files:**
- `lib/db/casesRepo.ts` - Template integration
- `lib/db/stepsRepo.ts` - Step creation from templates

### Design System Integration

- Templates use consistent step type categorization
- Instructions follow established content patterns
- Estimated times align with user experience expectations

### Repository Pattern

- Templates integrate with existing repository pattern
- Journey generation uses repository methods for persistence
- Maintains separation between template logic and data access

### React Query Hook Pattern

- Existing `useCaseSteps` hook continues to work
- Template-based steps appear in existing timeline
- No breaking changes to current hook interfaces

### Accessibility Requirements

- Template instructions support screen reader navigation
- Step types provide semantic meaning for assistive technology
- Estimated times help users plan their workflow

### Testing Requirements

**Unit Tests:**
- Template registry structure validation
- Journey generation logic
- Step mapping and linking
- Template format validation

**Integration Tests:**
- Repository integration
- Template-to-step conversion
- Database persistence
- Error handling scenarios

**Performance Tests:**
- Template loading speed
- Journey generation performance
- Database operation efficiency

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References
- Template registry implementation completed at `lib/journeys/templates/index.ts`
- Journey generation logic completed at `lib/journeys/generate.ts`
- Repository integration via `createCaseWithJourney()` method
- 41 comprehensive tests passing (23 template + 18 generation tests)
- TypeScript type checking passes with zero errors

### Completion Notes List
- ✅ Template registry created with `JourneyTemplate` interface and 7 step types
- ✅ Small Claims 5-step template implemented with safe legal language
- ✅ All steps include disclaimers ("This is general information, not legal advice")
- ✅ Journey generation system generates steps from templates with proper ordering
- ✅ `createCaseWithJourney()` method integrates template-based case creation
- ✅ 23 template tests validating structure, content, and safety
- ✅ 18 generation tests including mocked step creation and error handling
- ✅ All 85 tests passing (68 Epic 6 + 17 adapter tests from 6.5.1)
- ✅ Backward compatibility maintained - repository pattern preserved

### File List
**New Files:**
- `lib/journeys/templates/index.ts` - Template registry (150 lines, 7 case types)
- `lib/journeys/generate.ts` - Journey generation logic (95 lines)
- `tests/lib/journeys/templates.test.ts` - 23 template tests (250 lines)
- `tests/lib/journeys/generate.test.ts` - 18 generation tests (280 lines)

**Modified Files:**
- `lib/db/casesRepo.ts` - Added `createCaseWithJourney()` method and template imports

### Change Log
**2025-10-13**: Story 6.5.2 implementation completed
- Created template registry with `JourneyTemplate` interface
  - 7 step types: form, document, review, submit, wait, meeting, communication
  - Small Claims template with 5 steps, all with disclaimers and safe language
  - Helper functions: `getTemplate()`, `hasTemplate()`, `getAvailableCaseTypes()`
- Implemented journey generation system
  - `generateCaseJourney()` - Creates steps from template and persists to Firestore
  - `getTemplateStepCount()` - Returns step count for case type
  - `getTemplateStepDetails()` - Returns template details without creating steps
  - Error handling via `JourneyGenerationError`
- Integrated with repository pattern
  - `createCaseWithJourney()` in `casesRepo.ts` creates case + generates journey
  - Automatically calculates progress after journey generation
- Added 41 comprehensive tests
  - Template structure validation, content safety checks
  - Journey generation with mocked step creation
  - Error handling and edge cases

## Testing

### Test Strategy
- Unit tests for template registry and journey generation
- Integration tests with repository pattern
- Template validation and error handling
- Performance tests for generation speed

### Test Coverage Targets
- Template registry: 100% line coverage
- Journey generation: 100% line coverage
- Repository integration: 100% path coverage

### Accessibility Testing
- Template instructions accessibility validation
- Step type semantic meaning verification
- Screen reader navigation testing

### Performance Testing
- Template loading benchmarks (≤ 150ms)
- Journey generation performance
- Database operation efficiency

## QA Results

*To be completed after implementation*

---

**Story Owner:** SM (Bob)  
**Created:** October 10, 2025  
**Epic:** 6.5 Case Detail V2 Enhancement  
**Dependencies:** Story 6.5.1 complete
