# Story 13.23: Connect Copilot to Intake API

## Status
‚úÖ Complete

## Story
**As a** FairForm user,
**I want** my case to be created automatically after I confirm in the AI Copilot,
**so that** I can immediately start working on my legal matter without additional forms or steps.

## Acceptance Criteria

1. When user confirms case creation in Copilot, system calls `/api/cases` endpoint
2. Conversation state details are mapped to proper `CreateCaseInput` format
3. Case creation includes: title (generated from case type), caseType, jurisdiction (from location), notes (conversation summary)
4. System handles authentication properly (gets Firebase ID token)
5. On success, case ID is stored in conversation state and session metadata
6. On success, user receives confirmation message with case details and link
7. On failure, user receives clear error message with option to retry
8. Success message includes "View your case" link to `/cases/[caseId]`
9. Demo mode creates cases in demo Firebase project (not production)
10. After successful case creation, conversation stage transitions to 'case_created'
11. Session metadata is updated with `caseId` for future reference
12. Journey steps are automatically generated for the case (existing behavior)

## Tasks / Subtasks

- [ ] Task 1: Create case creation service for Copilot (AC: 1, 2, 3, 4)
  - [ ] Create `lib/ai/caseCreation.ts` module
  - [ ] Implement `mapConversationToCase()` function
  - [ ] Generate case title from case type and details
  - [ ] Extract jurisdiction from location string
  - [ ] Generate conversation summary for notes
  - [ ] Add TypeScript interfaces for mapping
  - [ ] Add unit tests for mapping logic

- [ ] Task 2: Implement case creation API call logic (AC: 1, 4, 7)
  - [ ] Create `createCaseFromConversation()` function
  - [ ] Get Firebase user and ID token
  - [ ] Call `/api/cases` with proper headers
  - [ ] Handle authentication errors
  - [ ] Handle API errors with retry logic
  - [ ] Return structured result (success | error)
  - [ ] Add comprehensive error handling

- [ ] Task 3: Integrate with demo endpoint confirmed state (AC: 1, 5, 10, 11)
  - [ ] Modify demo endpoint to detect `confirmed: true` state
  - [ ] Call case creation service when confirmed
  - [ ] Update conversation state with created caseId
  - [ ] Update session metadata in Firestore (if persistent session)
  - [ ] Transition stage to 'case_created'
  - [ ] Add console logging for debugging

- [ ] Task 4: Generate success message with case link (AC: 6, 8)
  - [ ] Create success message template
  - [ ] Include case title and type
  - [ ] Add "View your case" link: `/cases/[caseId]`
  - [ ] Mention that journey steps have been created
  - [ ] Keep message conversational and encouraging
  - [ ] Make link clickable in chat interface

- [ ] Task 5: Generate error messages for failure scenarios (AC: 7)
  - [ ] Handle authentication errors ("Please sign in to create your case")
  - [ ] Handle network errors ("Connection issue, please try again")
  - [ ] Handle API errors ("Unable to create case right now")
  - [ ] Include retry option in error messages
  - [ ] Add "Contact support" fallback option
  - [ ] Log errors for debugging

- [ ] Task 6: Add demo mode support (AC: 9)
  - [ ] Detect demo mode vs authenticated mode
  - [ ] In demo mode, show realistic success message
  - [ ] In demo mode, don't actually create case in Firestore
  - [ ] Provide demo caseId for testing purposes
  - [ ] Add disclaimer: "Demo mode - case not saved"
  - [ ] Test demo flow end-to-end

- [ ] Task 7: Handle case creation in main chat endpoint (AC: 1-12)
  - [ ] Add case creation logic to `/api/ai/copilot/chat` endpoint
  - [ ] Support both demo and authenticated case creation
  - [ ] Maintain conversation context after case creation
  - [ ] Allow continued conversation about the created case
  - [ ] Update session context with caseId

- [ ] Task 8: Update ChatPanel to render case links (AC: 8)
  - [ ] Detect messages containing case links
  - [ ] Render links as clickable buttons/cards
  - [ ] Style "View your case" link prominently
  - [ ] Handle link clicks (navigate to case detail)
  - [ ] Test link rendering and navigation

- [ ] Task 9: Add comprehensive testing (AC: All)
  - [ ] Test mapping conversation to case input
  - [ ] Test successful case creation flow
  - [ ] Test authentication error handling
  - [ ] Test API error handling
  - [ ] Test demo mode case creation
  - [ ] Test success message generation
  - [ ] Test error message generation
  - [ ] Test link rendering in chat
  - [ ] Integration test full flow end-to-end

## Dev Notes

### Architecture Context
[Source: docs/HANDOFF-NEXT-SESSION.md, app/api/ai/intake/route.ts, lib/hooks/useCreateCase.ts]

This story implements the **actual case creation** after user confirmation. It bridges the conversational AI Copilot experience with the existing FairForm case management system. After Stories 13.21 (intent detection) and 13.22 (confirmation UI), this story completes the loop by creating the case in Firestore and transitioning the user into the case management flow.

**Key Design Principles:**
- Reuse existing case creation API (`/api/cases`)
- Maintain conversation context after case creation
- Handle errors gracefully with clear user feedback
- Support both demo and authenticated modes
- Generate meaningful case titles and summaries

### Existing Case Creation Infrastructure
[Source: lib/db/casesRepo.ts, lib/hooks/useCreateCase.ts]

**Case Creation API:** `POST /api/cases`

**Request Format:**
```typescript
interface CreateCaseInput {
  title: string;          // e.g., "Eviction Defense - Indianapolis"
  caseType: CaseType;     // 'eviction' | 'small_claims' | ...
  jurisdiction: string;   // e.g., "Marion County, IN"
  notes?: string;         // Conversation summary
}

// Auth: Bearer token with Firebase ID token
```

**Response Format:**
```typescript
{
  caseId: string;  // Firestore document ID
}
```

**Automatic Behavior:**
- Journey steps are automatically generated based on case type
- Case status is set to "active"
- progressPct starts at 0
- totalSteps and completedSteps calculated from generated journey

**Existing Hook:** `useCreateCase` (client-side)
- We'll call the API directly from server-side (demo endpoint)
- Need to handle authentication differently on server

### New Case Creation Module

**File Location:** `lib/ai/caseCreation.ts`

```typescript
import { ConversationState } from '@/app/api/ai/copilot/demo/route';
import type { CreateCaseInput, CaseType } from '@/lib/validation';

export interface CaseCreationResult {
  success: boolean;
  caseId?: string;
  error?: {
    code: string;
    message: string;
    retryable: boolean;
  };
}

/**
 * Map conversation state to case creation input
 */
export function mapConversationToCase(
  state: ConversationState,
  userId: string
): CreateCaseInput & { userId: string } {
  // Generate meaningful case title
  const title = generateCaseTitle(state.caseType, state.details);
  
  // Extract jurisdiction from location
  const jurisdiction = extractJurisdiction(state.details.location);
  
  // Create conversation summary for notes
  const notes = generateConversationSummary(state);
  
  return {
    userId,
    title,
    caseType: state.caseType as CaseType,
    jurisdiction,
    notes
  };
}

/**
 * Generate a meaningful case title from case type and details
 */
export function generateCaseTitle(
  caseType?: string,
  details?: Record<string, string | undefined>
): string {
  if (!caseType) {
    return 'New Legal Case';
  }
  
  // Base title on case type
  let title = '';
  switch (caseType) {
    case 'eviction':
      title = 'Eviction Defense';
      break;
    case 'small_claims':
      title = 'Small Claims Matter';
      break;
    default:
      title = `${caseType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} Case`;
  }
  
  // Add location if available
  if (details?.location) {
    // Extract city/county from full location string
    const locationParts = details.location.split(',');
    const primaryLocation = locationParts[0]?.trim() || details.location;
    title += ` - ${primaryLocation}`;
  }
  
  return title;
}

/**
 * Extract jurisdiction from location string
 * Examples:
 *   "Indianapolis, IN Marion County" -> "Marion County, IN"
 *   "Fort Wayne, Indiana" -> "Allen County, IN"
 *   "Los Angeles, CA" -> "Los Angeles County, CA"
 */
export function extractJurisdiction(location?: string): string {
  if (!location) {
    return 'Unknown Jurisdiction';
  }
  
  // Check if county is mentioned
  const countyMatch = location.match(/([A-Za-z\s]+)\s+County/i);
  if (countyMatch) {
    const county = countyMatch[1].trim();
    // Extract state
    const stateMatch = location.match(/\b(IN|Indiana|CA|California|TX|Texas|NY|New York|[A-Z]{2})\b/i);
    const state = stateMatch ? normalizeState(stateMatch[1]) : '';
    return `${county} County${state ? ', ' + state : ''}`;
  }
  
  // If no county, try to infer from city
  const cityMatch = location.match(/^([A-Za-z\s]+),/);
  if (cityMatch) {
    const city = cityMatch[1].trim();
    const stateMatch = location.match(/,\s*([A-Z]{2}|[A-Za-z\s]+)$/);
    const state = stateMatch ? normalizeState(stateMatch[1]) : '';
    
    // For well-known cities, we can infer county
    const county = inferCountyFromCity(city);
    if (county) {
      return `${county}${state ? ', ' + state : ''}`;
    }
    
    return `${city}${state ? ', ' + state : ''}`;
  }
  
  // Fallback: use location as-is
  return location;
}

/**
 * Normalize state name/abbreviation
 */
function normalizeState(state: string): string {
  const stateMap: Record<string, string> = {
    'indiana': 'IN',
    'california': 'CA',
    'texas': 'TX',
    'new york': 'NY',
    // Add more as needed
  };
  
  const normalized = state.toLowerCase().trim();
  return stateMap[normalized] || state.toUpperCase().substring(0, 2);
}

/**
 * Infer county from well-known cities
 */
function inferCountyFromCity(city: string): string | null {
  const cityCountyMap: Record<string, string> = {
    'indianapolis': 'Marion County',
    'fort wayne': 'Allen County',
    'evansville': 'Vanderburgh County',
    'los angeles': 'Los Angeles County',
    'san francisco': 'San Francisco County',
    'new york': 'New York County',
    'chicago': 'Cook County',
    // Add more as needed
  };
  
  return cityCountyMap[city.toLowerCase()] || null;
}

/**
 * Generate conversation summary for case notes
 */
export function generateConversationSummary(state: ConversationState): string {
  let summary = `Case created through AI Copilot conversation.\n\n`;
  
  // Add case type context
  if (state.caseType === 'eviction') {
    summary += `**Eviction Details:**\n`;
    if (state.details.noticeType) {
      summary += `- Notice Type: ${state.details.noticeType.replace(/-/g, ' ')}\n`;
    }
    if (state.details.dateReceived) {
      summary += `- Date Received: ${state.details.dateReceived}\n`;
    }
  } else if (state.caseType === 'small_claims') {
    summary += `**Small Claims Details:**\n`;
  }
  
  // Add location
  if (state.details.location) {
    summary += `- Location: ${state.details.location}\n`;
  }
  
  // Add any other relevant details
  Object.entries(state.details)
    .filter(([key]) => !['location', 'noticeType', 'dateReceived'].includes(key))
    .filter(([_, value]) => value)
    .forEach(([key, value]) => {
      const label = key.replace(/([A-Z])/g, ' $1').trim();
      summary += `- ${label}: ${value}\n`;
    });
  
  // Add conversation context (last few messages)
  if (state.context.length > 0) {
    summary += `\n**Initial User Concern:**\n`;
    summary += `"${state.context[0]}"\n`;
  }
  
  return summary;
}

/**
 * Create case from conversation state
 * This function is called from the server-side (API endpoint)
 */
export async function createCaseFromConversation(
  state: ConversationState,
  userId: string,
  idToken: string
): Promise<CaseCreationResult> {
  try {
    // Map conversation to case input
    const caseInput = mapConversationToCase(state, userId);
    
    // Call the cases API
    const response = await fetch(`${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/api/cases`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${idToken}`
      },
      body: JSON.stringify(caseInput)
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      
      // Determine if error is retryable
      const retryable = response.status >= 500 || response.status === 429;
      
      return {
        success: false,
        error: {
          code: response.status === 401 ? 'UNAUTHORIZED' : 'API_ERROR',
          message: errorData.message || `Failed to create case: ${response.statusText}`,
          retryable
        }
      };
    }
    
    const data = await response.json();
    
    return {
      success: true,
      caseId: data.caseId
    };
  } catch (error) {
    console.error('Case creation error:', error);
    
    return {
      success: false,
      error: {
        code: 'NETWORK_ERROR',
        message: error instanceof Error ? error.message : 'Network error occurred',
        retryable: true
      }
    };
  }
}

/**
 * Generate success message after case creation
 */
export function generateSuccessMessage(
  caseId: string,
  caseTitle: string,
  caseType: string
): string {
  let message = `üéâ **Great news! Your case has been created successfully.**\n\n`;
  
  message += `I've set up **"${caseTitle}"** for you and generated a personalized journey with step-by-step guidance.\n\n`;
  
  // Add case-specific encouragement
  if (caseType === 'eviction') {
    message += `Your eviction defense journey includes important deadlines, required documents, and court preparation steps. `;
  } else if (caseType === 'small_claims') {
    message += `Your small claims journey includes filing requirements, evidence preparation, and hearing preparation steps. `;
  }
  
  message += `\n**[View your case ‚Üí](/cases/${caseId})**\n\n`;
  
  message += `You can continue this conversation at any time, or start working through your case steps. I'm here to help!`;
  
  return message;
}

/**
 * Generate error message for failed case creation
 */
export function generateErrorMessage(error: {
  code: string;
  message: string;
  retryable: boolean;
}): string {
  let message = '';
  
  switch (error.code) {
    case 'UNAUTHORIZED':
      message = `‚ö†Ô∏è **Please sign in to create your case**\n\n`;
      message += `I can help you prepare your case information, but you'll need to be signed in to save it. `;
      message += `Please sign in and then say "create my case" to try again.`;
      break;
    
    case 'NETWORK_ERROR':
      message = `‚ö†Ô∏è **Connection issue**\n\n`;
      message += `I'm having trouble connecting right now. Please check your internet connection and say "try again" to create your case.`;
      break;
    
    case 'API_ERROR':
    default:
      if (error.retryable) {
        message = `‚ö†Ô∏è **Temporary issue**\n\n`;
        message += `I'm unable to create your case right now, but this is likely temporary. `;
        message += `Please wait a moment and say "try again" or "create my case" to retry.\n\n`;
        message += `If the problem continues, please contact support.`;
      } else {
        message = `‚ö†Ô∏è **Unable to create case**\n\n`;
        message += `${error.message}\n\n`;
        message += `Please contact support if you need assistance.`;
      }
  }
  
  return message;
}
```

### Integration with Demo Endpoint

**Modifications to `app/api/ai/copilot/demo/route.ts`:**

```typescript
import { 
  createCaseFromConversation,
  generateSuccessMessage,
  generateErrorMessage
} from '@/lib/ai/caseCreation';
import { getAuth } from 'firebase-admin/auth';

// Extend ConversationState
interface ConversationState {
  stage: 'greeting' | 'intake' | 'details' | 'guidance' | 'awaiting_confirmation' | 'case_creation' | 'case_created';
  caseType?: string;
  context: string[];
  details: { [key: string]: string | undefined };
  readiness?: CaseCreationReadiness;
  confirmationShown?: boolean;
  confirmed?: boolean;
  lastConfirmationTime?: number;
  caseId?: string;              // NEW: Store created case ID
  caseCreationAttempted?: boolean; // NEW: Track if creation was attempted
}

function generateDemoResponse(userMessage: string, sessionId: string, history: string[]): string {
  // ... existing code ...
  
  // Handle case creation stage
  if (state.stage === 'case_creation' && !state.caseId && !state.caseCreationAttempted) {
    // Mark as attempted to prevent duplicate calls
    state.caseCreationAttempted = true;
    
    // In demo mode, simulate success
    if (isDemoMode()) {
      const demoCaseId = 'demo-case-' + Date.now();
      state.caseId = demoCaseId;
      state.stage = 'case_created';
      
      const caseTitle = generateCaseTitle(state.caseType, state.details);
      const successMsg = generateSuccessMessage(demoCaseId, caseTitle, state.caseType || 'unknown');
      
      return `${successMsg}\n\n_Note: This is demo mode - your case details are not actually saved._`;
    }
    
    // In authenticated mode, create actual case
    // This would need to be handled differently since we need auth context
    // For now, show message that directs to Story 13.23 implementation
    return "Perfect! I'm creating your case now...\n\n(Story 13.23 implementation will handle actual API call for authenticated users)";
  }
  
  // ... rest of existing logic ...
}

function isDemoMode(): boolean {
  return process.env.NEXT_PUBLIC_DEMO_MODE === 'true' || 
         process.env.NODE_ENV === 'development';
}
```

### Server-Side Case Creation (For Main Chat Endpoint)

**Modifications to `app/api/ai/copilot/chat/route.ts`:**

```typescript
import { requireAuth } from '@/lib/auth/server-auth';
import {
  createCaseFromConversation,
  generateSuccessMessage,
  generateErrorMessage
} from '@/lib/ai/caseCreation';
import { getSession, updateSession } from '@/lib/db/aiSessionsRepo';

export async function POST(request: NextRequest) {
  const user = await requireAuth(request);
  const body = await request.json();
  const { message, sessionId } = body;
  
  // Load session to get conversation state
  const session = await getSession(sessionId);
  
  // Check if user just confirmed case creation
  if (session?.metadata?.confirmed && !session?.metadata?.caseId) {
    try {
      // Get user's ID token
      const idToken = request.headers.get('authorization')?.replace('Bearer ', '') || '';
      
      // Create case from conversation
      const result = await createCaseFromConversation(
        session.metadata as ConversationState,
        user.uid,
        idToken
      );
      
      if (result.success && result.caseId) {
        // Update session with case ID
        await updateSession(sessionId, {
          metadata: {
            ...session.metadata,
            caseId: result.caseId,
            stage: 'case_created'
          }
        });
        
        // Generate success message
        const caseTitle = generateCaseTitle(
          session.metadata.caseType,
          session.metadata.details
        );
        const successMsg = generateSuccessMessage(
          result.caseId,
          caseTitle,
          session.metadata.caseType || 'unknown'
        );
        
        return NextResponse.json({
          reply: successMsg,
          meta: {
            caseId: result.caseId,
            caseCreated: true
          }
        });
      } else if (result.error) {
        // Generate error message
        const errorMsg = generateErrorMessage(result.error);
        
        return NextResponse.json({
          reply: errorMsg,
          meta: {
            error: result.error
          }
        });
      }
    } catch (error) {
      console.error('Case creation failed:', error);
      return NextResponse.json({
        reply: generateErrorMessage({
          code: 'UNEXPECTED_ERROR',
          message: 'An unexpected error occurred',
          retryable: true
        }),
        meta: {
          error: 'UNEXPECTED_ERROR'
        }
      });
    }
  }
  
  // ... rest of existing chat logic ...
}
```

### ChatPanel Link Rendering

**Modifications to `components/ai-copilot/ChatPanel.tsx`:**

```typescript
import Link from 'next/link';

// Helper function to detect and render case links
function renderMessageContent(content: string) {
  // Check for case link pattern: [View your case ‚Üí](/cases/[caseId])
  const linkPattern = /\[View your case ‚Üí\]\((\/cases\/[^)]+)\)/g;
  
  if (linkPattern.test(content)) {
    // Split content and render link as button
    const parts = content.split(linkPattern);
    
    return (
      <div className="space-y-2">
        {parts.map((part, idx) => {
          // Check if this part is a case link
          if (part.startsWith('/cases/')) {
            return (
              <Link
                key={idx}
                href={part}
                className="inline-flex items-center gap-2 px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors font-medium"
              >
                View your case ‚Üí
              </Link>
            );
          }
          return <div key={idx}>{renderMarkdown(part)}</div>;
        })}
      </div>
    );
  }
  
  // Regular message rendering
  return renderMarkdown(content);
}
```

### User Experience Flows

**Flow 1: Successful Case Creation (Authenticated)**
```
1. User: "Yes, create my case"
2. AI: [Calls createCaseFromConversation]
3. AI: [API returns caseId: "abc123"]
4. AI: "üéâ Great news! Your case has been created...
       [View your case ‚Üí](/cases/abc123)"
5. User clicks link ‚Üí navigates to case detail page
```

**Flow 2: Successful Case Creation (Demo Mode)**
```
1. User: "Yes, create my case"
2. AI: [Generates demo caseId]
3. AI: "üéâ Great news! Your case has been created...
       [View your case ‚Üí](/cases/demo-case-123)
       Note: This is demo mode - not actually saved."
4. User clicks link ‚Üí navigates to demo case view
```

**Flow 3: Case Creation Failure - Not Authenticated**
```
1. User: "Yes, create my case"
2. AI: [Detects no auth]
3. AI: "‚ö†Ô∏è Please sign in to create your case...
       I can help you prepare, but you need to be signed in to save it."
4. User signs in
5. User: "create my case"
6. [Retries successfully]
```

**Flow 4: Case Creation Failure - Network Error**
```
1. User: "Yes, create my case"
2. AI: [Network error]
3. AI: "‚ö†Ô∏è Connection issue...
       Please check internet and say 'try again'"
4. User: "try again"
5. [Retries case creation]
```

### Source Tree

```
lib/ai/
‚îú‚îÄ‚îÄ caseCreation.ts            # NEW: Case creation logic
‚îú‚îÄ‚îÄ caseCreation.test.ts       # NEW: Tests
‚îú‚îÄ‚îÄ intentDetection.ts         # EXISTING: From Story 13.21
‚îú‚îÄ‚îÄ confirmationMessages.ts    # EXISTING: From Story 13.22
‚îî‚îÄ‚îÄ responseParser.ts          # EXISTING: From Story 13.22

app/api/ai/copilot/
‚îú‚îÄ‚îÄ demo/
‚îÇ   ‚îî‚îÄ‚îÄ route.ts              # MODIFIED: Handle demo case creation
‚îî‚îÄ‚îÄ chat/
    ‚îî‚îÄ‚îÄ route.ts              # MODIFIED: Handle authenticated case creation

components/ai-copilot/
‚îî‚îÄ‚îÄ ChatPanel.tsx             # MODIFIED: Render case links as buttons
```

### Testing

**Test Location:** `lib/ai/caseCreation.test.ts`

**Test Coverage:**
```typescript
describe('caseCreation', () => {
  describe('mapConversationToCase', () => {
    it('maps eviction conversation to case input', () => {
      const state = {
        stage: 'case_creation',
        caseType: 'eviction',
        context: [],
        details: {
          location: 'Indianapolis, IN Marion County',
          noticeType: '30-day'
        }
      };
      
      const result = mapConversationToCase(state, 'user123');
      
      expect(result.title).toBe('Eviction Defense - Indianapolis');
      expect(result.caseType).toBe('eviction');
      expect(result.jurisdiction).toBe('Marion County, IN');
      expect(result.notes).toContain('30-day');
    });
  });
  
  describe('generateCaseTitle', () => {
    it('generates eviction title with location', () => {
      const title = generateCaseTitle('eviction', { location: 'Fort Wayne, IN' });
      expect(title).toBe('Eviction Defense - Fort Wayne');
    });
    
    it('generates title without location', () => {
      const title = generateCaseTitle('small_claims', {});
      expect(title).toBe('Small Claims Matter');
    });
  });
  
  describe('extractJurisdiction', () => {
    it('extracts county from full location', () => {
      const jurisdiction = extractJurisdiction('Indianapolis, IN Marion County');
      expect(jurisdiction).toBe('Marion County, IN');
    });
    
    it('infers county from city', () => {
      const jurisdiction = extractJurisdiction('Indianapolis, IN');
      expect(jurisdiction).toBe('Marion County, IN');
    });
    
    it('handles unknown locations', () => {
      const jurisdiction = extractJurisdiction('Some City, XX');
      expect(jurisdiction).toBeTruthy();
    });
  });
  
  describe('generateConversationSummary', () => {
    it('includes case type and details in summary', () => {
      const state = {
        stage: 'case_creation',
        caseType: 'eviction',
        context: ['I received an eviction notice'],
        details: {
          location: 'Indianapolis',
          noticeType: '30-day'
        }
      };
      
      const summary = generateConversationSummary(state);
      
      expect(summary).toContain('Eviction Details');
      expect(summary).toContain('30-day');
      expect(summary).toContain('Indianapolis');
      expect(summary).toContain('I received an eviction notice');
    });
  });
  
  describe('generateSuccessMessage', () => {
    it('includes case link and encouragement', () => {
      const message = generateSuccessMessage(
        'case123',
        'Eviction Defense - Indianapolis',
        'eviction'
      );
      
      expect(message).toContain('/cases/case123');
      expect(message).toContain('created successfully');
      expect(message).toContain('eviction defense journey');
    });
  });
  
  describe('generateErrorMessage', () => {
    it('generates auth error message', () => {
      const message = generateErrorMessage({
        code: 'UNAUTHORIZED',
        message: 'Not authenticated',
        retryable: false
      });
      
      expect(message).toContain('sign in');
      expect(message).toContain('create my case');
    });
    
    it('generates retryable error message', () => {
      const message = generateErrorMessage({
        code: 'NETWORK_ERROR',
        message: 'Connection failed',
        retryable: true
      });
      
      expect(message).toContain('try again');
      expect(message).toContain('Connection issue');
    });
  });
});
```

### Dependencies
- Story 13.21 (Intent Detection) - provides readiness data
- Story 13.22 (Confirmation UI) - provides confirmed state
- Existing `/api/cases` endpoint
- Firebase Authentication
- casesRepo for case creation
- Journey generation system (automatic)

### Performance Considerations
- Case creation is asynchronous (typically <1 second)
- Show loading state during API call
- Cache case ID in conversation state
- Journey generation happens automatically (may take 1-2 seconds)

### Security Considerations
- Always verify authentication before case creation
- Use secure Firebase ID tokens
- Validate all input data before API call
- Don't expose sensitive case data in error messages
- Log all case creation attempts for audit

### Error Recovery
- Provide clear retry instructions for transient errors
- Maintain conversation state across retries
- Don't lose user data on failure
- Offer support contact for persistent failures

### Next Steps
This story enables:
- **Story 13.24:** Update /intake page to reference Copilot as primary method
- **Story 13.25:** Pass case context between Copilot and case detail page
- **Future:** Allow case editing through Copilot conversation

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-14 | 1.0 | Initial story creation for connecting Copilot to intake API | Sarah (Product Owner) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent during implementation_

### Debug Log References
_To be populated by dev agent during implementation_

### Completion Notes List
_To be populated by dev agent during implementation_

### File List
_To be populated by dev agent during implementation_

## QA Results
_To be populated by QA agent after implementation review_

