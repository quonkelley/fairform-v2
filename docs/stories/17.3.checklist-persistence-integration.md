# Story 17.3: Checklist State Persistence & Integration

## Status
ðŸ“‹ Ready for Development

## Story
**As a** user preparing for my hearing,
**I want** my checklist progress to be saved automatically and integrated with my reminders and documents,
**so that** I can check off items over time and have everything I need in one place.

## Acceptance Criteria

1. Checking/unchecking checklist items persists to Firestore immediately
2. Checklist state loads correctly when opening modal
3. State updates in real-time across browser sessions
4. Optimistic UI updates provide instant feedback
5. Error states handled gracefully with retry option
6. Reminder badges show correctly when reminderId matches
7. Documents section shows all completed forms for the case
8. Documents have working download links
9. Special celebration animation triggers when step marked complete
10. Playwright test covers full flow from open â†’ check items â†’ mark complete â†’ verify persistence

## Tasks / Subtasks

- [ ] Task 1: Add stepsRepo methods for checklist updates (AC: 1, 2)
  - [ ] Add `updateHearingChecklist(stepId: string, checklist: HearingChecklistItem[]): Promise<Result<void>>` to lib/db/stepsRepo.ts
  - [ ] Implement Firestore update logic
  - [ ] Add error handling and validation
  - [ ] Return Result type (success/failure)
  - [ ] Add unit tests for new methods

- [ ] Task 2: Create useHearingChecklist hook (AC: 1, 2, 3, 4)
  - [ ] Create lib/hooks/useHearingChecklist.ts
  - [ ] Use React Query for state management
  - [ ] Implement optimistic updates on toggle
  - [ ] Handle loading and error states
  - [ ] Debounce writes to Firestore (300ms)
  - [ ] Provide `toggleItem(id: string)` mutation

- [ ] Task 3: Wire up HearingChecklist to persistence (AC: 1, 4)
  - [ ] Import useHearingChecklist in HearingStepModal
  - [ ] Pass stepId to hook
  - [ ] Connect checklist items to hook state
  - [ ] Handle onChange with optimistic update
  - [ ] Show loading skeleton on initial load
  - [ ] Test checkbox interactions persist

- [ ] Task 4: Implement error handling and recovery (AC: 5)
  - [ ] Show toast notification on save error
  - [ ] Add retry button in error state
  - [ ] Revert optimistic update on failure
  - [ ] Log errors for debugging
  - [ ] Test error scenarios (network failure, auth error)

- [ ] Task 5: Integrate reminder badges (AC: 6)
  - [ ] Query reminders for current case in HearingStepModal
  - [ ] Match checklist item reminderId to reminder.id
  - [ ] Show "Reminder Set" badge if match found
  - [ ] Show reminder status (sent/pending)
  - [ ] Add tooltip with reminder details
  - [ ] Test with various reminder states

- [ ] Task 6: Integrate documents section (AC: 7, 8)
  - [ ] Use useCompletedForms hook in HearingStepModal
  - [ ] Create DocumentsList component
  - [ ] Display form names, types, and creation dates
  - [ ] Add download button for each document
  - [ ] Add "Download All" button (ZIP)
  - [ ] Handle empty state (no documents)
  - [ ] Test document download flow

- [ ] Task 7: Create special completion celebration (AC: 9)
  - [ ] Create HearingCompletionCelebration component
  - [ ] Trigger when step.isComplete changes to true
  - [ ] Show confetti animation
  - [ ] Display congratulatory message
  - [ ] Add personalized message based on case type
  - [ ] Auto-dismiss after 5 seconds
  - [ ] Respect prefers-reduced-motion

- [ ] Task 8: Update useCompleteStep for hearings (AC: 9)
  - [ ] Check if step is hearing type
  - [ ] Trigger special celebration instead of standard
  - [ ] Track completion in analytics
  - [ ] Test completion flow

- [ ] Task 9: Write hook tests (AC: 10)
  - [ ] Create tests/lib/hooks/useHearingChecklist.test.ts
  - [ ] Test initial load
  - [ ] Test toggle item
  - [ ] Test optimistic updates
  - [ ] Test error handling
  - [ ] Test debouncing
  - [ ] Mock Firestore and React Query

- [ ] Task 10: Write integration tests (AC: 10)
  - [ ] Create tests/components/hearing/integration.test.ts
  - [ ] Test full flow: load â†’ toggle â†’ persist
  - [ ] Test reminder badge display
  - [ ] Test document list
  - [ ] Test celebration trigger
  - [ ] Mock all external dependencies

- [ ] Task 11: Write Playwright E2E test (AC: 10)
  - [ ] Create e2e/hearing-step-flow.spec.ts
  - [ ] Set up test case with hearing step
  - [ ] Navigate to case detail page
  - [ ] Click hearing step
  - [ ] Verify modal opens
  - [ ] Check checklist items
  - [ ] Mark step complete
  - [ ] Verify celebration shows
  - [ ] Reload page and verify persistence
  - [ ] Run test in CI

- [ ] Task 12: Performance optimization
  - [ ] Measure modal open time (<200ms)
  - [ ] Measure checklist toggle time (<100ms)
  - [ ] Add React.memo to HearingChecklistItem
  - [ ] Optimize re-renders
  - [ ] Profile with React DevTools

## Technical Notes

### stepsRepo Method

```typescript
// lib/db/stepsRepo.ts

export async function updateHearingChecklist(
  stepId: string,
  checklist: HearingChecklistItem[]
): Promise<Result<void>> {
  try {
    const stepRef = doc(db, 'caseSteps', stepId);

    // Validate checklist items
    const validated = z.array(HearingChecklistItemSchema).parse(checklist);

    await updateDoc(stepRef, {
      hearingChecklist: validated,
      updatedAt: serverTimestamp()
    });

    return { success: true, data: undefined };
  } catch (error) {
    console.error('Failed to update hearing checklist:', error);
    return {
      success: false,
      error: 'Failed to save checklist. Please try again.'
    };
  }
}
```

### useHearingChecklist Hook

```typescript
// lib/hooks/useHearingChecklist.ts

import { useMutation, useQueryClient } from '@tanstack/react-query';
import { useDebouncedCallback } from 'use-debounce';
import { updateHearingChecklist } from '@/lib/db/stepsRepo';
import type { HearingChecklistItem } from '@/lib/validation';

export function useHearingChecklist(stepId: string, initialChecklist: HearingChecklistItem[]) {
  const queryClient = useQueryClient();

  const mutation = useMutation({
    mutationFn: (checklist: HearingChecklistItem[]) =>
      updateHearingChecklist(stepId, checklist),
    onMutate: async (newChecklist) => {
      // Cancel outgoing refetches
      await queryClient.cancelQueries({ queryKey: ['steps', stepId] });

      // Snapshot previous value
      const previous = queryClient.getQueryData(['steps', stepId]);

      // Optimistically update
      queryClient.setQueryData(['steps', stepId], (old: any) => ({
        ...old,
        hearingChecklist: newChecklist
      }));

      return { previous };
    },
    onError: (err, newChecklist, context) => {
      // Revert on error
      queryClient.setQueryData(['steps', stepId], context?.previous);
      toast.error('Failed to save checklist');
    },
    onSettled: () => {
      // Refetch after error or success
      queryClient.invalidateQueries({ queryKey: ['steps', stepId] });
    }
  });

  // Debounce updates to reduce Firestore writes
  const debouncedUpdate = useDebouncedCallback(
    (checklist: HearingChecklistItem[]) => {
      mutation.mutate(checklist);
    },
    300
  );

  const toggleItem = (id: string) => {
    const updated = initialChecklist.map(item =>
      item.id === id ? { ...item, completed: !item.completed } : item
    );
    debouncedUpdate(updated);
  };

  return {
    toggleItem,
    isUpdating: mutation.isPending,
    error: mutation.error
  };
}
```

### HearingCompletionCelebration Component

```typescript
// components/case-journey/hearing/HearingCompletionCelebration.tsx

import confetti from 'canvas-confetti';
import { useEffect } from 'react';

export function HearingCompletionCelebration({
  isVisible,
  caseType,
  onComplete
}: {
  isVisible: boolean;
  caseType: string;
  onComplete: () => void;
}) {
  useEffect(() => {
    if (!isVisible) return;

    // Check for reduced motion preference
    const prefersReducedMotion = window.matchMedia(
      '(prefers-reduced-motion: reduce)'
    ).matches;

    if (!prefersReducedMotion) {
      // Trigger confetti
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
    }

    // Auto-dismiss after 5 seconds
    const timer = setTimeout(onComplete, 5000);
    return () => clearTimeout(timer);
  }, [isVisible, onComplete]);

  if (!isVisible) return null;

  const messages = {
    small_claims: "Great job! You're ready for your small claims hearing.",
    eviction: "You're prepared! Stay calm and confident in court.",
    default: "Excellent preparation! You've got this."
  };

  const message = messages[caseType as keyof typeof messages] || messages.default;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
      <div className="bg-card p-8 rounded-2xl shadow-xl max-w-md text-center space-y-4">
        <div className="text-6xl">ðŸŽ‰</div>
        <h2 className="text-2xl font-bold text-foreground">
          You're All Set!
        </h2>
        <p className="text-muted-foreground">
          {message}
        </p>
      </div>
    </div>
  );
}
```

### Documents Section Integration

```typescript
// In HearingStepModal

const { data: completedForms, isLoading } = useCompletedForms(step.caseId);

// ...

<section>
  <h3 className="text-lg font-semibold mb-4">Documents to Bring</h3>

  {isLoading ? (
    <Spinner label="Loading documents" />
  ) : completedForms && completedForms.length > 0 ? (
    <>
      <div className="space-y-2">
        {completedForms.map(form => (
          <div key={form.id} className="flex items-center justify-between p-3 border rounded-lg">
            <div className="flex items-center gap-3">
              <FileText className="h-5 w-5 text-primary" />
              <div>
                <p className="font-medium text-sm">{form.formName}</p>
                <p className="text-xs text-muted-foreground">
                  {new Date(form.createdAt).toLocaleDateString()}
                </p>
              </div>
            </div>
            <Button variant="ghost" size="sm" asChild>
              <a href={form.downloadUrl} download>
                Download
              </a>
            </Button>
          </div>
        ))}
      </div>
      <Button className="w-full mt-4" variant="outline">
        Download All (ZIP)
      </Button>
    </>
  ) : (
    <p className="text-sm text-muted-foreground">
      No documents available yet. Complete the form steps to generate documents.
    </p>
  )}
</section>
```

## Validation Checklist

- [ ] Checklist items persist to Firestore
- [ ] Optimistic updates work correctly
- [ ] Error handling tested
- [ ] Reminder badges display correctly
- [ ] Documents section works
- [ ] Download links functional
- [ ] Celebration animation triggers
- [ ] All tests pass (unit + integration + E2E)
- [ ] Performance metrics met (<200ms open, <100ms toggle)
- [ ] TypeScript type-check passes
- [ ] ESLint passes

## Dependencies

- Story 17.1 (hearing step type) - MUST BE COMPLETE
- Story 17.2 (modal UI) - MUST BE COMPLETE
- lib/db/stepsRepo.ts
- lib/hooks/useCompletedForms.ts
- lib/hooks/useCompleteStep.ts
- Firestore database
- React Query

## Estimated Effort
3 days

## Dev Agent Record

### Implementation Summary
_To be filled during development_

### Files Created
_To be filled during development_

### Quality Checks
_To be filled during development_

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-17 | 1.0 | Initial story creation | SM |
