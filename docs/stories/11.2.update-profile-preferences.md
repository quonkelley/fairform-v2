# Story 11.2: Update Profile Preferences

## Status
Draft

## Story
**As a** registered FairForm user,
**I want** to update my time zone and notification preferences,
**so that** I can customize my experience and receive reminders at appropriate times.

## Acceptance Criteria

1. User can select their time zone from a dropdown with common US time zones.
2. User can toggle email notification preferences (on/off).
3. User can toggle SMS notification preferences (on/off) with "coming soon" indicator.
4. Changes are saved to Firestore `users` collection when "Save Changes" button is clicked.
5. Success feedback is displayed after successful save ("✅ Settings Saved" toast).
6. Error feedback is displayed if save fails ("❌ Failed to save settings" toast).
7. Form fields are disabled during save operation (loading state).
8. Settings persist and reload correctly on page refresh.
9. Save action completes in ≤300ms under normal conditions.

## Tasks / Subtasks

- [ ] Task 1: Add time zone selector (AC: 1)
  - [ ] Use shadcn/ui Select component
  - [ ] Create `lib/constants/timezones.ts` with US time zones array
  - [ ] Time zones: Pacific, Mountain, Arizona, Central, Eastern, Alaska, Hawaii
  - [ ] Display format: "Pacific Time (PT)" → value: "America/Los_Angeles"
  - [ ] Pre-select current timezone from user settings (default: "America/Los_Angeles")
  - [ ] Update local state on change
  - [ ] Add label "Time Zone" with proper htmlFor

- [ ] Task 2: Add notification toggles (AC: 2, 3)
  - [ ] Use shadcn/ui Switch component for toggles
  - [ ] Email notifications toggle (functional)
  - [ ] SMS notifications toggle (disabled with "Coming Soon" badge)
  - [ ] Add descriptive labels with Switch Label component
  - [ ] Email: "Receive email reminders for upcoming deadlines"
  - [ ] SMS: "Receive text message reminders (Coming Soon)"
  - [ ] Update local state on toggle change
  - [ ] Use proper ARIA attributes (aria-label, aria-checked)

- [ ] Task 3: Create useUserSettings hook (AC: 4, 8)
  - [ ] Create `lib/hooks/useUserSettings.ts`
  - [ ] Use React Query for data fetching and caching
  - [ ] Query key: `['userSettings', userId]`
  - [ ] Fetch function: Read from Firestore `users/{uid}` document
  - [ ] Mutation function: Update Firestore `users/{uid}` with new settings
  - [ ] Handle missing user document (create with defaults)
  - [ ] Return: `{ settings, isLoading, updateSettings, isUpdating }`
  - [ ] Include error handling with Result pattern

- [ ] Task 4: Create usersRepo for Firestore operations (AC: 4, 8)
  - [ ] Create `lib/db/usersRepo.ts`
  - [ ] Function: `getUserSettings(userId: string): Promise<UserSettings | null>`
  - [ ] Function: `updateUserSettings(userId: string, settings: Partial<UserSettings>): Promise<UserSettings>`
  - [ ] Use repository pattern (no direct Firestore in hooks)
  - [ ] Update `updatedAt` timestamp on every save
  - [ ] Handle Firestore errors with UsersRepositoryError class
  - [ ] Write unit tests for both functions

- [ ] Task 5: Implement save functionality (AC: 4, 5, 6, 7, 9)
  - [ ] Add "Save Changes" button at bottom of form
  - [ ] Use shadcn/ui Button component (primary variant)
  - [ ] Button disabled if no changes made (compare with original values)
  - [ ] Button shows loading spinner while saving (Button loading prop)
  - [ ] Disable all form fields during save (isUpdating state)
  - [ ] On successful save:
    - Show success toast: "✅ Settings Saved"
    - Invalidate React Query cache to refetch
    - Reset dirty state
  - [ ] On error:
    - Show error toast: "❌ Failed to save settings. Please try again."
    - Re-enable form fields
    - Log error to console
  - [ ] Measure save time in dev (console.time/timeEnd)

- [ ] Task 6: Add toast notification system (AC: 5, 6)
  - [ ] Install/configure toast library (sonner or shadcn/ui toast)
  - [ ] Create `components/ui/toast.tsx` and `components/ui/use-toast.ts` if using shadcn
  - [ ] Configure toast provider in root layout
  - [ ] Success toast: green checkmark, 3s duration
  - [ ] Error toast: red X, 5s duration, dismissible
  - [ ] Toast accessible (role="status", aria-live="polite")

- [ ] Task 7: Implement form state management (AC: 7, 8)
  - [ ] Use React useState for form fields (timeZone, emailNotifications, smsNotifications)
  - [ ] Track "dirty" state (has user made changes?)
  - [ ] Compare current values with original loaded values
  - [ ] "Save Changes" button disabled if not dirty
  - [ ] Reset dirty state after successful save
  - [ ] Handle page refresh - reload from Firestore (useUserSettings)

- [ ] Task 8: Add TypeScript types and validation (AC: All)
  - [ ] Update `lib/validation.ts` with UserSettings interface
  - [ ] Create Zod schema for UserSettings
  - [ ] Validate on save (timeZone is valid IANA string)
  - [ ] Ensure strict TypeScript compliance (no `any`)
  - [ ] Export types for use in components and hooks

- [ ] Task 9: Update Firestore security rules
  - [ ] Add rule: Users can only read/write their own settings document
  - [ ] Rule: `allow read, write: if request.auth.uid == userId;`
  - [ ] Document in `firestore.rules`
  - [ ] Test with Firebase emulator (future enhancement)

- [ ] Task 10: Create comprehensive tests (AC: All)
  - [ ] Hook tests (useUserSettings):
    - Fetches settings on mount
    - Updates settings successfully
    - Handles errors gracefully
    - Caches results with React Query
  - [ ] Repository tests (usersRepo):
    - getUserSettings returns null for missing user
    - getUserSettings returns settings for existing user
    - updateUserSettings creates document if missing
    - updateUserSettings updates existing document
    - Error handling (Firestore failures)
  - [ ] Component tests:
    - Time zone selector renders and updates
    - Notification toggles work correctly
    - Save button disabled when no changes
    - Save button shows loading state
    - Toast appears on save success/failure
    - Form fields disabled during save
  - [ ] Integration tests:
    - Full save flow end-to-end
    - Settings persist on page refresh
    - Error recovery after failed save
  - [ ] Performance tests:
    - Save completes in ≤300ms (mock Firestore)
  - [ ] Accessibility tests:
    - Zero jest-axe violations
    - All form controls labeled
    - Toast messages accessible

## Dev Notes

### **Previous Story Insights**
- Story 11.1: Settings page scaffold created with placeholder sections
- SettingsCard component exists and is reusable
- AppHeader navigation includes Settings link
- Authentication and route protection working
- shadcn/ui components installed (Card, Label, Select, Switch, Button)

### **Firestore Schema** (from Epic 11 PRD)
```typescript
// Collection: users/{uid}
interface UserSettings {
  uid: string;
  email: string;
  timeZone: string; // IANA timezone string
  notifications: {
    email: boolean;
    sms: boolean; // Placeholder for Sprint 4
  };
  aiParticipation: boolean; // Story 11.3
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// Default values for new users
const DEFAULT_SETTINGS: Partial<UserSettings> = {
  timeZone: 'America/Los_Angeles',
  notifications: {
    email: true,
    sms: false,
  },
  aiParticipation: false,
};
```

### **Time Zones List**
```typescript
// lib/constants/timezones.ts
export const US_TIMEZONES = [
  { label: 'Pacific Time (PT)', value: 'America/Los_Angeles' },
  { label: 'Mountain Time (MT)', value: 'America/Denver' },
  { label: 'Mountain Time - Arizona (MST)', value: 'America/Phoenix' },
  { label: 'Central Time (CT)', value: 'America/Chicago' },
  { label: 'Eastern Time (ET)', value: 'America/New_York' },
  { label: 'Alaska Time (AKT)', value: 'America/Anchorage' },
  { label: 'Hawaii-Aleutian Time (HST)', value: 'Pacific/Honolulu' },
] as const;
```

### **useUserSettings Hook Pattern**
```typescript
// lib/hooks/useUserSettings.ts
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import * as usersRepo from '@/lib/db/usersRepo';

export function useUserSettings(userId: string) {
  const queryClient = useQueryClient();

  const { data: settings, isLoading } = useQuery({
    queryKey: ['userSettings', userId],
    queryFn: () => usersRepo.getUserSettings(userId),
    staleTime: 1000 * 60 * 5, // 5 minutes
  });

  const { mutate: updateSettings, isPending: isUpdating } = useMutation({
    mutationFn: (updates: Partial<UserSettings>) => 
      usersRepo.updateUserSettings(userId, updates),
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['userSettings', userId] });
    },
  });

  return { settings, isLoading, updateSettings, isUpdating };
}
```

### **Repository Pattern** (from coding-standards.md)
```typescript
// lib/db/usersRepo.ts
import { doc, getDoc, setDoc, updateDoc, serverTimestamp } from 'firebase/firestore';
import { getFirestoreDb } from '@/lib/firebase';
import type { UserSettings } from '@/lib/validation';

export class UsersRepositoryError extends Error {
  constructor(message: string, options?: { cause?: unknown }) {
    super(message, options);
    this.name = 'UsersRepositoryError';
  }
}

export async function getUserSettings(userId: string): Promise<UserSettings | null> {
  try {
    const db = getFirestoreDb();
    const userRef = doc(db, 'users', userId);
    const snapshot = await getDoc(userRef);
    
    if (!snapshot.exists()) {
      return null;
    }
    
    return mapUserSettingsDocument(snapshot);
  } catch (error) {
    console.error('Failed to get user settings', { userId, error });
    throw new UsersRepositoryError('Unable to load settings', { cause: error });
  }
}

export async function updateUserSettings(
  userId: string,
  updates: Partial<UserSettings>
): Promise<UserSettings> {
  try {
    const db = getFirestoreDb();
    const userRef = doc(db, 'users', userId);
    
    // Check if document exists
    const snapshot = await getDoc(userRef);
    
    if (!snapshot.exists()) {
      // Create new document with defaults
      await setDoc(userRef, {
        uid: userId,
        ...DEFAULT_SETTINGS,
        ...updates,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      });
    } else {
      // Update existing document
      await updateDoc(userRef, {
        ...updates,
        updatedAt: serverTimestamp(),
      });
    }
    
    // Fetch and return updated document
    const updatedSnapshot = await getDoc(userRef);
    return mapUserSettingsDocument(updatedSnapshot);
  } catch (error) {
    console.error('Failed to update user settings', { userId, error });
    throw new UsersRepositoryError('Unable to save settings', { cause: error });
  }
}
```

### **Form UI Layout**
```
┌─ Notifications Card ────────────────┐
│ Email Notifications                 │
│ [●━━━━━━━━] ON                      │ ← Switch
│ Receive email reminders for         │
│ upcoming deadlines                  │
│                                     │
│ SMS Notifications (Coming Soon)     │
│ [━━━━━━━━○] OFF                     │ ← Switch (disabled)
│ Text message reminders will be      │
│ available in the next release       │
└─────────────────────────────────────┘

┌─ Profile Card ──────────────────────┐
│ Time Zone                           │
│ [Pacific Time (PT)        ▼]        │ ← Select
│ Used for deadline reminders         │
└─────────────────────────────────────┘

[Save Changes] ← Button (primary)
```

### **File Locations** [Source: architecture/source-tree.md]
- Hook: `lib/hooks/useUserSettings.ts` (new file)
- Repository: `lib/db/usersRepo.ts` (new file)
- Constants: `lib/constants/timezones.ts` (new file)
- Update: `components/settings/SettingsPage.tsx` (add form controls)
- Update: `lib/validation.ts` (add UserSettings type and schema)
- Security rules: `firestore.rules` (add users collection rule)
- Tests:
  - `tests/hooks/useUserSettings.test.tsx` (new file)
  - `tests/lib/db/usersRepo.test.ts` (new file)
  - `tests/settings/SettingsPage.test.tsx` (update with new functionality)

### **Toast Library Setup**
Using shadcn/ui Sonner toast:
```bash
npx shadcn-ui@latest add sonner
```

Then in root layout:
```typescript
import { Toaster } from "@/components/ui/sonner";

export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        {children}
        <Toaster />
      </body>
    </html>
  );
}
```

Usage in component:
```typescript
import { toast } from "sonner";

// Success
toast.success("Settings Saved", {
  description: "Your preferences have been updated.",
});

// Error
toast.error("Failed to save settings", {
  description: "Please try again or contact support.",
});
```

### **Performance Requirements** (from Epic 11 PRD)
- Save action ≤ 300ms response time
- Page load ≤ 1.2s on 3G mobile
- Optimistic updates: Show success immediately, roll back on error
- Cache settings with React Query (5-minute stale time)

### **Accessibility Requirements**
- All form controls have associated labels
- Switch components use aria-checked
- Select has aria-label
- Disabled fields have aria-disabled
- Toast has role="status" and aria-live="polite"
- Error messages associated with fields via aria-describedby

### **Testing Strategy**
```typescript
// tests/hooks/useUserSettings.test.tsx
describe('useUserSettings', () => {
  it('fetches user settings on mount', async () => {
    const { result } = renderHook(() => useUserSettings('user-123'));
    
    await waitFor(() => {
      expect(result.current.settings).toEqual(mockSettings);
    });
  });

  it('updates settings successfully', async () => {
    const { result } = renderHook(() => useUserSettings('user-123'));
    
    act(() => {
      result.current.updateSettings({ timeZone: 'America/Chicago' });
    });
    
    await waitFor(() => {
      expect(result.current.settings.timeZone).toBe('America/Chicago');
    });
  });
});
```

### **Technical Constraints**
- TypeScript strict mode - no `any` types
- Follow repository pattern (no direct Firestore in components/hooks)
- Use React Query for data fetching and mutations
- shadcn/ui components for consistency
- Toast notifications for user feedback
- Performance: Save operation ≤300ms
- Firestore security rules must be updated

### **Integration Points**
- Story 11.1: Uses SettingsCard component and page structure
- Story 11.3: Will add aiParticipation field to same form
- Firebase Auth: Uses userId from authenticated user
- React Query: Caches settings data, invalidates on update
- Firestore: Reads/writes to `users/{uid}` collection

### **Out of Scope for Story 11.2**
- AI participation toggle (Story 11.3)
- Email address editing (managed by Firebase Auth)
- Password reset (managed by Firebase Auth)
- SMS notification implementation (Sprint 4)
- Multiple notification channels (Sprint 4+)
- Profile image upload (future enhancement)

### **Error Handling**
- Firestore read failure: Show error toast, allow retry
- Firestore write failure: Show error toast, don't update UI state
- Network timeout: Show specific "Network error" message
- Invalid data: Validate before save, show validation errors
- Concurrent updates: Last write wins (acceptable for MVP)

## Testing

- Use Vitest + React Testing Library per `CLAUDE.md`.
- Test useUserSettings hook with React Query wrapper.
- Test usersRepo functions with mocked Firestore.
- Test form functionality: select, toggles, save button states.
- Test toast notifications appear correctly.
- Accessibility: jest-axe for zero violations.
- Performance: Verify save completes in ≤300ms (mocked).
- Integration: Full flow from load → edit → save → verify.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-11 | 0.1 | Initial draft created from Epic 11 PRD | SM Agent (Bob) |

