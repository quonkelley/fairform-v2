# Story 12.3: Display AI Summary & Confirmation

## Status
Draft

## Story
**As a** self-represented litigant using FairForm,
**I want** to review the AI-generated summary and classification of my legal issue,
**so that** I can verify the information is accurate before proceeding to create my case.

## Acceptance Criteria

1. Results page displays AI-generated summary in clear, readable format.
2. Case type classification is prominently displayed with visual indicator.
3. Jurisdiction information (state, county, court level) is shown if detected.
4. Confidence level is displayed with visual representation (percentage or indicator).
5. Risk level is shown with appropriate color coding (low=green, medium=yellow, high=red).
6. Recommended next steps are displayed as an actionable list.
7. AI disclaimers from response are prominently displayed.
8. "Edit Summary" button allows user to modify information (Story 12.4).
9. "Confirm & Create Case" button proceeds to save (Story 12.4).
10. User can go back to intake form to start over.
11. Page meets WCAG 2.1 AA accessibility standards (zero jest-axe violations).

## Tasks / Subtasks

- [ ] Task 1: Create intake results page route (AC: 1)
  - [ ] Create `app/intake/results/page.tsx` as authenticated server component
  - [ ] Use `requireAuth` for authentication
  - [ ] Check AI participation (redirect if disabled)
  - [ ] Render IntakeResultsPage client component
  - [ ] Pass user data to component

- [ ] Task 2: Create IntakeResultsPage component (AC: 1, 2, 3, 4, 5)
  - [ ] Create `components/intake/IntakeResultsPage.tsx`
  - [ ] Retrieve classification data from sessionStorage (from Story 12.2)
  - [ ] Handle missing data (redirect back to /intake)
  - [ ] Use shadcn/ui Card components for layout
  - [ ] Display page title: "Review Your Case Summary"
  - [ ] Show BETA badge
  - [ ] Add main disclaimer Alert at top

- [ ] Task 3: Display case classification (AC: 2)
  - [ ] Create prominent case type display section
  - [ ] Large heading with case type (e.g., "Small Claims Case")
  - [ ] Add case type icon/badge
  - [ ] Use primary color for emphasis
  - [ ] Format: "{caseType} Case" or "{caseType} Matter"
  - [ ] Make it the visual focal point of the page

- [ ] Task 4: Display jurisdiction information (AC: 3)
  - [ ] Create jurisdiction Card section
  - [ ] Show state if detected: "State: California"
  - [ ] Show county if detected: "County: Los Angeles"
  - [ ] Show court level if detected: "Court Level: Small Claims"
  - [ ] Handle missing jurisdiction gracefully: "Jurisdiction: Not specified"
  - [ ] Use descriptive labels and proper formatting
  - [ ] Add map pin icon (MapPin from lucide-react)

- [ ] Task 5: Display AI summary (AC: 1)
  - [ ] Create summary Card section
  - [ ] Label: "AI-Generated Summary"
  - [ ] Display summary text with proper line breaks
  - [ ] Use readable typography (line-height 1.6, max-width 65ch)
  - [ ] Highlight primary issue in bold or different color
  - [ ] Make text selectable for copy/paste

- [ ] Task 6: Display confidence and risk indicators (AC: 4, 5)
  - [ ] Create indicators Card section
  - [ ] Confidence Level:
    - Display as percentage: "85% Confident"
    - Visual: Progress bar or badge
    - Color: green if >80%, yellow if 60-80%, red if <60%
  - [ ] Risk Level:
    - Display with icon and color
    - Low: Green shield, "Low Risk"
    - Medium: Yellow alert, "Medium Risk"
    - High: Red warning, "High Risk - Seek Immediate Help"
  - [ ] Use appropriate icons (Shield, AlertTriangle, AlertCircle)

- [ ] Task 7: Display recommended next steps (AC: 6)
  - [ ] Create next steps Card section
  - [ ] Label: "Recommended Next Steps"
  - [ ] Display as numbered list
  - [ ] Each step on separate line with proper spacing
  - [ ] Use actionable language
  - [ ] Make list accessible (ordered list semantics)

- [ ] Task 8: Display AI disclaimers (AC: 7)
  - [ ] Create disclaimers section at bottom
  - [ ] Use Alert component (warning or info variant)
  - [ ] Display each disclaimer from API response
  - [ ] Include standard disclaimer if not in response:
    - "This AI-generated summary is for educational purposes only and does not constitute legal advice."
  - [ ] Make disclaimers visually distinct
  - [ ] Ensure they're read by screen readers

- [ ] Task 9: Add action buttons (AC: 8, 9, 10)
  - [ ] Create button row at bottom
  - [ ] "Start Over" button (secondary, outline):
    - Clears sessionStorage
    - Navigates back to /intake
    - Confirmation dialog: "Are you sure? Your current analysis will be lost."
  - [ ] "Edit Summary" button (secondary):
    - Navigates to /intake/edit (Story 12.4)
    - Passes current data
  - [ ] "Confirm & Create Case" button (primary):
    - Navigates to save flow (Story 12.4)
    - Most prominent button
  - [ ] Responsive: Stack vertically on mobile, horizontal on desktop

- [ ] Task 10: Handle edge cases (AC: 1)
  - [ ] No data in sessionStorage: Redirect to /intake with message
  - [ ] Invalid data structure: Show error, redirect to /intake
  - [ ] Missing required fields: Show warning, allow edit
  - [ ] Very high risk: Emphasize urgency, suggest professional help
  - [ ] Low confidence (<60%): Show warning, suggest starting over

- [ ] Task 11: Implement accessibility features (AC: 11)
  - [ ] Page title (H1): "Review Your Case Summary"
  - [ ] Section headings (H2) for each card
  - [ ] Proper heading hierarchy
  - [ ] All indicators have text alternatives
  - [ ] Icons have aria-label or aria-hidden
  - [ ] Alert role for disclaimers
  - [ ] Focus management: Focus H1 on page load
  - [ ] Keyboard navigation: Tab through all interactive elements

- [ ] Task 12: Add responsive design (AC: 11)
  - [ ] Mobile (< 768px):
    - Single column layout
    - Cards full-width
    - Stack buttons vertically
    - Reduce padding
  - [ ] Desktop (≥ 768px):
    - Max-width 900px container
    - Grid layout for indicators (confidence + risk side-by-side)
    - Horizontal button layout
  - [ ] Test at 360px, 768px, 1024px breakpoints

- [ ] Task 13: Create comprehensive tests (AC: All)
  - [ ] Component tests:
    - Renders classification data correctly
    - Displays all sections (summary, jurisdiction, steps, etc.)
    - Handles missing jurisdiction gracefully
    - Shows appropriate risk level colors
    - Confidence indicator displays correctly
    - Disclaimers are present
  - [ ] Navigation tests:
    - Start Over clears data and redirects
    - Edit Summary navigates with data
    - Confirm navigates to save flow
  - [ ] Edge case tests:
    - Missing sessionStorage data redirects
    - Low confidence shows warning
    - High risk emphasizes urgency
  - [ ] Accessibility tests:
    - Zero jest-axe violations
    - Proper heading structure
    - All interactive elements labeled
    - Icons have text alternatives

## Dev Notes

### **Previous Story Insights**
- Story 12.1: IntakePage with text input created
- Story 12.2: useAIIntake hook implemented, data stored in sessionStorage
- Classification data structure defined in IntakeClassificationSchema
- shadcn/ui components installed (Card, Alert, Badge, Progress, Button)

### **Classification Data Structure** (from API)
```typescript
interface IntakeClassification {
  summary: string;           // AI-generated narrative summary
  primaryIssue: string;      // Main legal issue identified
  caseType: string;          // "Small Claims", "Eviction", "Family", etc.
  jurisdiction: {
    state?: string;          // "California"
    county?: string;         // "Los Angeles"
    courtLevel?: string;     // "Small Claims Court"
  };
  confidence: number;        // 0-1 (0.85 = 85%)
  riskLevel: "low" | "medium" | "high";
  recommendedNextSteps: string[];  // Array of action items
  disclaimers: string[];     // Legal disclaimers
}
```

### **Page Layout**
```
┌─────────────────────────────────────┐
│ 🧠 Review Your Case Summary  [BETA] │ ← H1
├─────────────────────────────────────┤
│ ⚠️  Important: This AI-generated... │ ← Disclaimer Alert
├─────────────────────────────────────┤
│                                     │
│ ╔═══════════════════════════════╗ │
│ ║ 📋 Small Claims Case          ║ │ ← Case Type (prominent)
│ ╚═══════════════════════════════╝ │
│                                     │
│ ┌─ Summary ─────────────────────┐ │
│ │ You reported an issue with... │ │
│ │ regarding your landlord not   │ │
│ │ fixing a broken heater...     │ │
│ └───────────────────────────────┘ │
│                                     │
│ ┌─ Location & Jurisdiction ─────┐ │
│ │ 📍 State: California           │ │
│ │    County: Los Angeles         │ │
│ │    Court: Small Claims Court   │ │
│ └───────────────────────────────┘ │
│                                     │
│ ┌─ Confidence ─┐ ┌─ Risk Level ──┐│
│ │ ███████░ 85% │ │ 🟢 Low Risk   ││
│ └──────────────┘ └───────────────┘│
│                                     │
│ ┌─ Recommended Next Steps ───────┐│
│ │ 1. Document all communication  │ │
│ │ 2. Check your lease agreement  │ │
│ │ 3. File a complaint with...    │ │
│ └───────────────────────────────┘ │
│                                     │
│ ⚠️  AI-generated disclaimers...    │
│                                     │
│ [Start Over]  [Edit] [Confirm ✓]  │
└─────────────────────────────────────┘
```

### **Component Structure**
```typescript
// components/intake/IntakeResultsPage.tsx
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { AlertCircle, AlertTriangle, CheckCircle, MapPin, Shield } from 'lucide-react';
import type { IntakeClassification } from '@/lib/ai/schemas';

export function IntakeResultsPage({ user }: IntakeResultsPageProps) {
  const [classification, setClassification] = useState<IntakeClassification | null>(null);
  const router = useRouter();

  useEffect(() => {
    // Retrieve stored classification data
    const stored = sessionStorage.getItem('intake-result');
    
    if (!stored) {
      router.push('/intake?message=no_data');
      return;
    }

    try {
      const result = JSON.parse(stored);
      setClassification(result.data);
    } catch (error) {
      console.error('Failed to parse intake result:', error);
      router.push('/intake?message=invalid_data');
    }
  }, [router]);

  if (!classification) {
    return <div>Loading...</div>;
  }

  const confidencePct = Math.round(classification.confidence * 100);
  const isLowConfidence = classification.confidence < 0.6;

  const getRiskColor = (risk: string) => {
    switch (risk) {
      case 'low': return 'text-green-600';
      case 'medium': return 'text-yellow-600';
      case 'high': return 'text-red-600';
      default: return 'text-gray-600';
    }
  };

  const getRiskIcon = (risk: string) => {
    switch (risk) {
      case 'low': return <Shield className="h-5 w-5" />;
      case 'medium': return <AlertTriangle className="h-5 w-5" />;
      case 'high': return <AlertCircle className="h-5 w-5" />;
      default: return null;
    }
  };

  const handleStartOver = () => {
    if (confirm('Are you sure? Your current analysis will be lost.')) {
      sessionStorage.removeItem('intake-result');
      router.push('/intake');
    }
  };

  const handleEdit = () => {
    router.push('/intake/edit');
  };

  const handleConfirm = () => {
    router.push('/intake/save');
  };

  return (
    <div className="container max-w-4xl mx-auto py-8 px-4">
      {/* Header */}
      <div className="flex items-center gap-2 mb-6">
        <h1 className="text-3xl font-bold">Review Your Case Summary</h1>
        <Badge variant="secondary">Experimental Beta</Badge>
      </div>

      {/* Main Disclaimer */}
      <Alert className="mb-6">
        <AlertCircle className="h-4 w-4" />
        <AlertDescription>
          This AI-generated summary is for educational purposes only and does not constitute legal advice. 
          Review carefully and consult with an attorney for legal guidance.
        </AlertDescription>
      </Alert>

      {/* Low Confidence Warning */}
      {isLowConfidence && (
        <Alert variant="destructive" className="mb-6">
          <AlertTriangle className="h-4 w-4" />
          <AlertDescription>
            We're not very confident about this classification ({confidencePct}%). 
            You may want to provide more details or consult directly with a legal professional.
          </AlertDescription>
        </Alert>
      )}

      <div className="space-y-6">
        {/* Case Type - Prominent Display */}
        <Card className="border-2 border-primary bg-primary/5">
          <CardHeader className="text-center">
            <CardTitle className="text-2xl text-primary">
              📋 {classification.caseType}
            </CardTitle>
            <CardDescription>
              Primary Issue: {classification.primaryIssue}
            </CardDescription>
          </CardHeader>
        </Card>

        {/* Summary */}
        <Card>
          <CardHeader>
            <CardTitle>AI-Generated Summary</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="leading-relaxed max-w-prose">
              {classification.summary}
            </p>
          </CardContent>
        </Card>

        {/* Jurisdiction */}
        {(classification.jurisdiction.state || classification.jurisdiction.county || classification.jurisdiction.courtLevel) && (
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <MapPin className="h-5 w-5" />
                Location & Jurisdiction
              </CardTitle>
            </CardHeader>
            <CardContent className="space-y-2">
              {classification.jurisdiction.state && (
                <p><strong>State:</strong> {classification.jurisdiction.state}</p>
              )}
              {classification.jurisdiction.county && (
                <p><strong>County:</strong> {classification.jurisdiction.county}</p>
              )}
              {classification.jurisdiction.courtLevel && (
                <p><strong>Court Level:</strong> {classification.jurisdiction.courtLevel}</p>
              )}
            </CardContent>
          </Card>
        )}

        {/* Confidence and Risk */}
        <div className="grid md:grid-cols-2 gap-6">
          {/* Confidence */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Confidence Level</CardTitle>
            </CardHeader>
            <CardContent className="space-y-2">
              <Progress value={confidencePct} className="h-3" />
              <p className="text-2xl font-bold">{confidencePct}%</p>
            </CardContent>
          </Card>

          {/* Risk Level */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Risk Assessment</CardTitle>
            </CardHeader>
            <CardContent>
              <div className={`flex items-center gap-2 text-xl font-bold ${getRiskColor(classification.riskLevel)}`}>
                {getRiskIcon(classification.riskLevel)}
                <span className="capitalize">{classification.riskLevel} Risk</span>
              </div>
              {classification.riskLevel === 'high' && (
                <p className="text-sm text-red-600 mt-2">
                  This situation may require immediate professional legal assistance.
                </p>
              )}
            </CardContent>
          </Card>
        </div>

        {/* Recommended Next Steps */}
        {classification.recommendedNextSteps.length > 0 && (
          <Card>
            <CardHeader>
              <CardTitle>Recommended Next Steps</CardTitle>
            </CardHeader>
            <CardContent>
              <ol className="list-decimal pl-5 space-y-2">
                {classification.recommendedNextSteps.map((step, index) => (
                  <li key={index} className="leading-relaxed">{step}</li>
                ))}
              </ol>
            </CardContent>
          </Card>
        )}

        {/* AI Disclaimers */}
        {classification.disclaimers.length > 0 && (
          <Alert variant="default">
            <AlertDescription className="space-y-2">
              {classification.disclaimers.map((disclaimer, index) => (
                <p key={index}>{disclaimer}</p>
              ))}
            </AlertDescription>
          </Alert>
        )}

        {/* Action Buttons */}
        <div className="flex flex-col sm:flex-row gap-4 justify-between pt-4">
          <Button variant="outline" onClick={handleStartOver}>
            Start Over
          </Button>
          
          <div className="flex flex-col sm:flex-row gap-4">
            <Button variant="secondary" onClick={handleEdit}>
              Edit Summary
            </Button>
            <Button onClick={handleConfirm} className="flex items-center gap-2">
              <CheckCircle className="h-4 w-4" />
              Confirm & Create Case
            </Button>
          </div>
        </div>
      </div>
    </div>
  );
}
```

### **File Locations** [Source: architecture/source-tree.md]
- Route: `app/intake/results/page.tsx` (new file)
- Component: `components/intake/IntakeResultsPage.tsx` (new file)
- Tests:
  - `tests/intake/intake-results-page.test.tsx` (new file)
  - `tests/intake/intake-results-route.test.tsx` (new file)

### **Confidence Level Visualization**
```typescript
// Color coding for confidence
const getConfidenceColor = (confidence: number) => {
  if (confidence >= 0.8) return 'text-green-600';
  if (confidence >= 0.6) return 'text-yellow-600';
  return 'text-red-600';
};

// Progress bar color (via CSS class)
<Progress 
  value={confidencePct} 
  className={cn(
    "h-3",
    confidence >= 0.8 && "bg-green-100",
    confidence >= 0.6 && confidence < 0.8 && "bg-yellow-100",
    confidence < 0.6 && "bg-red-100"
  )}
/>
```

### **Risk Level Display**
```typescript
interface RiskDisplay {
  color: string;
  icon: React.ReactNode;
  message?: string;
}

const RISK_DISPLAYS: Record<string, RiskDisplay> = {
  low: {
    color: 'text-green-600',
    icon: <Shield className="h-5 w-5" />,
  },
  medium: {
    color: 'text-yellow-600',
    icon: <AlertTriangle className="h-5 w-5" />,
  },
  high: {
    color: 'text-red-600',
    icon: <AlertCircle className="h-5 w-5" />,
    message: 'This situation may require immediate professional legal assistance.',
  },
};
```

### **Testing Strategy**
```typescript
// tests/intake/intake-results-page.test.tsx
describe('IntakeResultsPage', () => {
  beforeEach(() => {
    sessionStorage.setItem('intake-result', JSON.stringify({
      data: mockClassification,
    }));
  });

  it('displays classification summary', () => {
    render(<IntakeResultsPage user={mockUser} />);
    
    expect(screen.getByText('Small Claims')).toBeInTheDocument();
    expect(screen.getByText(/You reported an issue/)).toBeInTheDocument();
  });

  it('shows confidence level with correct color', () => {
    render(<IntakeResultsPage user={mockUser} />);
    
    const confidence = screen.getByText('85%');
    expect(confidence).toBeInTheDocument();
    expect(confidence).toHaveClass('text-green-600');
  });

  it('displays risk level with appropriate icon', () => {
    render(<IntakeResultsPage user={mockUser} />);
    
    expect(screen.getByText('Low Risk')).toBeInTheDocument();
    expect(screen.getByRole('img', { name: /shield/i })).toBeInTheDocument();
  });

  it('handles missing sessionStorage data', () => {
    sessionStorage.clear();
    const router = useRouter();
    
    render(<IntakeResultsPage user={mockUser} />);
    
    expect(router.push).toHaveBeenCalledWith('/intake?message=no_data');
  });

  it('shows warning for low confidence', () => {
    const lowConfidenceData = {
      ...mockClassification,
      confidence: 0.5,
    };
    
    sessionStorage.setItem('intake-result', JSON.stringify({ data: lowConfidenceData }));
    
    render(<IntakeResultsPage user={mockUser} />);
    
    expect(screen.getByText(/not very confident/i)).toBeInTheDocument();
  });
});
```

### **Accessibility Requirements**
- Proper heading hierarchy (H1 → H2)
- All icons have aria-label or aria-hidden
- Progress bars have aria-valuenow, aria-valuemin, aria-valuemax
- Risk indicators have semantic meaning (not color alone)
- Disclaimers have role="alert"
- Buttons have descriptive labels
- Focus management on page load

### **Technical Constraints**
- TypeScript strict mode - no `any` types
- Data from sessionStorage (validated)
- Redirect if data missing or invalid
- shadcn/ui components for consistency
- Mobile-first responsive design
- WCAG 2.1 AA accessibility compliance

### **Integration Points**
- Story 12.2: Receives classification data via sessionStorage
- Story 12.4: "Edit Summary" and "Confirm" buttons navigate to edit/save flows
- IntakeClassificationSchema: Validates data structure

### **Out of Scope for Story 12.3**
- Editing functionality (Story 12.4)
- Saving to Firestore (Story 12.4)
- Share/export results (future)
- Print summary (future)
- Comparison with other cases (future)
- Historical classification data (future)

## Testing

- Use Vitest + React Testing Library per `CLAUDE.md`.
- Test data loading from sessionStorage.
- Test display of all classification fields.
- Test confidence and risk visualizations.
- Test edge cases (missing data, low confidence, high risk).
- Accessibility: jest-axe for zero violations, keyboard navigation.
- Responsive: Test at multiple breakpoints.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-11 | 0.1 | Initial draft created from Epic 12 PRD | SM Agent (Bob) |

