# Story 12.2: API Integration & Classification

## Status
Draft

## Story
**As a** self-represented litigant using FairForm,
**I want** my problem description to be analyzed by AI and classified into a case type,
**so that** I can understand what kind of legal matter I'm dealing with and what steps to take.

## Acceptance Criteria

1. Form submission calls `/api/ai/intake` endpoint with user's text.
2. Loading state displays progress indicator and prevents duplicate submissions.
3. API response is validated against `IntakeClassificationSchema`.
4. Successful classification navigates to results screen (Story 12.3).
5. Content moderation blocks inappropriate text with clear error message.
6. API errors display user-friendly error messages (not technical details).
7. User can retry after errors without losing their text.
8. API call completes in ≤3 seconds under normal conditions.
9. All errors are logged to console for debugging.

## Tasks / Subtasks

- [ ] Task 1: Create useAIIntake hook (AC: 1, 2, 3, 4, 9)
  - [ ] Create `lib/hooks/useAIIntake.ts`
  - [ ] Use React Query mutation for API call
  - [ ] Function: `submitIntake(text: string, userTimezone?: string)`
  - [ ] POST to `/api/ai/intake` with IntakeRequest body
  - [ ] Handle response parsing and validation
  - [ ] Return: `{ classify, isLoading, error, data, reset }`
  - [ ] On success: Store classification data in state
  - [ ] On error: Store error details for display
  - [ ] Log all API calls and responses to console

- [ ] Task 2: Integrate hook into IntakePage (AC: 1, 2, 7)
  - [ ] Update `components/intake/IntakePage.tsx`
  - [ ] Import and use useAIIntake hook
  - [ ] Replace placeholder submission with actual API call
  - [ ] Pass user's text to classify function
  - [ ] Include userTimezone from browser (Intl.DateTimeFormat)
  - [ ] Preserve text in state during/after submission
  - [ ] Don't clear textarea on error (allow retry)

- [ ] Task 3: Implement enhanced loading states (AC: 2, 8)
  - [ ] Show multi-stage loading indicator:
    - Stage 1: "Checking content..." (moderation)
    - Stage 2: "Analyzing your situation..." (AI processing)
    - Stage 3: "Preparing results..." (schema validation)
  - [ ] Display estimated time remaining (countdown from 3s)
  - [ ] Disable all form controls during submission
  - [ ] Prevent duplicate submissions (disable submit button)
  - [ ] Show cancel button (optional - cancel request)

- [ ] Task 4: Handle moderation blocks (AC: 5)
  - [ ] Detect ContentBlocked error from API
  - [ ] Display user-friendly message in Alert component
  - [ ] Message: "We're unable to process this request. Please review your description and remove any inappropriate content."
  - [ ] Don't show technical moderation details to user
  - [ ] Log moderation details to console for debugging
  - [ ] Keep textarea value so user can edit
  - [ ] Show "Try Again" button

- [ ] Task 5: Handle API errors (AC: 6, 7, 9)
  - [ ] Map API error types to user messages:
    - `ValidationError`: "Please provide more detail about your situation (at least 20 characters)."
    - `ConfigurationError`: "The AI service is temporarily unavailable. Please try again later."
    - `UpstreamError`: "We're having trouble connecting to the AI service. Please try again."
    - `SchemaMismatch`: "We received an unexpected response. Please try again."
    - `ModerationFailure`: "Content check failed. Please try again."
    - `ServerError`: "Something went wrong. Please try again or contact support."
  - [ ] Display errors in Alert component (destructive variant)
  - [ ] Include "Try Again" button in error state
  - [ ] Log full error details to console
  - [ ] Track error count (after 3 failures, show support link)

- [ ] Task 6: Add success transition (AC: 4)
  - [ ] On successful classification, show brief success message
  - [ ] Message: "✅ Analysis complete!"
  - [ ] Wait 500ms for user to see success
  - [ ] Navigate to results page with classification data
  - [ ] Pass data via React state or URL params
  - [ ] Store in sessionStorage as backup

- [ ] Task 7: Implement retry functionality (AC: 7)
  - [ ] Add "Try Again" button in error state
  - [ ] Button clears error state and re-enables form
  - [ ] Preserves user's text in textarea
  - [ ] Resets loading stages
  - [ ] Focuses textarea after reset
  - [ ] Track retry attempts

- [ ] Task 8: Add performance monitoring (AC: 8, 9)
  - [ ] Use performance.now() to measure API call duration
  - [ ] Log timing to console: "AI Intake completed in 2.3s"
  - [ ] If > 3s, log warning
  - [ ] Track and log individual stages if possible
  - [ ] Consider adding user-facing "This is taking longer than usual..." after 5s

- [ ] Task 9: Create comprehensive tests (AC: All)
  - [ ] Hook tests (useAIIntake):
    - Successfully calls API and returns data
    - Handles validation errors
    - Handles moderation blocks
    - Handles API errors
    - Supports retry after error
    - Includes timezone in request
  - [ ] Integration tests:
    - Full submission flow with mock API
    - Loading states display correctly
    - Success navigates to results
    - Error displays with retry option
    - Text preserved on error
  - [ ] Error handling tests:
    - Each error type displays correct message
    - Console logs contain debug info
    - Retry clears error state
  - [ ] Performance tests:
    - API call timing logged
    - Timeout after reasonable duration

## Dev Notes

### **Previous Story Insights**
- Story 12.1: IntakePage component with textarea and validation created
- `/api/ai/intake` endpoint fully implemented with moderation, GPT-4o-mini, schema validation
- IntakeRequestSchema and IntakeClassificationSchema defined
- Toast notifications (Sonner) configured
- React Query installed and configured

### **API Endpoint** (Already Implemented)
```typescript
// POST /api/ai/intake
// Request:
{
  text: string;          // User's problem description (min 20 chars)
  userTimezone?: string; // Optional IANA timezone
}

// Success Response (200):
{
  data: {
    summary: string;
    primaryIssue: string;
    caseType: string;
    jurisdiction: {
      state?: string;
      county?: string;
      courtLevel?: string;
    };
    confidence: number;        // 0-1
    riskLevel: "low" | "medium" | "high";
    recommendedNextSteps: string[];
    disclaimers: string[];
  };
  moderation: {
    verdict: "pass" | "review" | "block";
    flaggedCategories: string[];
  };
  requiresReview: boolean;
}

// Error Responses:
// 400 - ValidationError, ContentBlocked
// 500 - ConfigurationError, ServerError
// 502 - UpstreamError, SchemaMismatch, ModerationFailure
```

### **useAIIntake Hook Pattern**
```typescript
// lib/hooks/useAIIntake.ts
import { useMutation } from '@tanstack/react-query';
import type { IntakeRequest, IntakeClassification } from '@/lib/ai/schemas';

interface AIIntakeResponse {
  data: IntakeClassification;
  moderation: {
    verdict: 'pass' | 'review' | 'block';
    flaggedCategories: string[];
  };
  requiresReview: boolean;
}

export function useAIIntake() {
  const mutation = useMutation({
    mutationFn: async (request: IntakeRequest) => {
      const startTime = performance.now();
      
      const response = await fetch('/api/ai/intake', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(request),
      });

      const duration = ((performance.now() - startTime) / 1000).toFixed(2);
      console.log(`AI Intake completed in ${duration}s`);

      if (!response.ok) {
        const error = await response.json();
        console.error('AI Intake error:', error);
        throw new AIIntakeError(error.error, error.message, response.status);
      }

      const result: AIIntakeResponse = await response.json();
      console.log('AI Intake success:', result);
      
      return result;
    },
  });

  return {
    classify: mutation.mutate,
    classifyAsync: mutation.mutateAsync,
    isLoading: mutation.isPending,
    error: mutation.error as AIIntakeError | null,
    data: mutation.data,
    reset: mutation.reset,
  };
}

class AIIntakeError extends Error {
  constructor(
    public code: string,
    message: string,
    public status: number
  ) {
    super(message);
    this.name = 'AIIntakeError';
  }
}
```

### **Updated IntakePage Integration**
```typescript
// components/intake/IntakePage.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAIIntake } from '@/lib/hooks/useAIIntake';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Button } from '@/components/ui/button';
import { Loader2, AlertCircle } from 'lucide-react';

export function IntakePage({ user }: IntakePageProps) {
  const [text, setText] = useState('');
  const router = useRouter();
  const { classify, isLoading, error, data, reset } = useAIIntake();

  // Get user's timezone
  const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!isValid || isLoading) return;

    classify(
      { text: text.trim(), userTimezone },
      {
        onSuccess: (result) => {
          // Store in sessionStorage for navigation
          sessionStorage.setItem('intake-result', JSON.stringify(result));
          
          // Navigate to results page
          setTimeout(() => {
            router.push('/intake/results');
          }, 500);
        },
      }
    );
  };

  const handleRetry = () => {
    reset();
    // Text is preserved, user can edit and resubmit
  };

  // Error message mapping
  const getErrorMessage = (error: AIIntakeError): string => {
    switch (error.code) {
      case 'ValidationError':
        return 'Please provide more detail about your situation (at least 20 characters).';
      case 'ContentBlocked':
        return "We're unable to process this request. Please review your description and remove any inappropriate content.";
      case 'ConfigurationError':
        return 'The AI service is temporarily unavailable. Please try again later.';
      case 'UpstreamError':
      case 'SchemaMismatch':
        return "We're having trouble connecting to the AI service. Please try again.";
      case 'ModerationFailure':
        return 'Content check failed. Please try again.';
      default:
        return 'Something went wrong. Please try again or contact support.';
    }
  };

  return (
    <form onSubmit={handleSubmit}>
      {/* Existing form content... */}

      {/* Error Display */}
      {error && (
        <Alert variant="destructive">
          <AlertCircle className="h-4 w-4" />
          <AlertDescription>
            {getErrorMessage(error)}
          </AlertDescription>
          <Button 
            variant="outline" 
            size="sm" 
            onClick={handleRetry}
            className="mt-2"
          >
            Try Again
          </Button>
        </Alert>
      )}

      {/* Loading Stages */}
      {isLoading && (
        <div className="space-y-2 text-center">
          <Loader2 className="h-8 w-8 animate-spin mx-auto text-primary" />
          <p className="text-sm text-muted-foreground">
            Analyzing your situation...
          </p>
          <p className="text-xs text-muted-foreground">
            This typically takes 2-3 seconds
          </p>
        </div>
      )}

      {/* Submit Button */}
      <Button
        type="submit"
        disabled={!isValid || isLoading}
      >
        {isLoading ? 'Analyzing...' : 'Submit'}
      </Button>
    </form>
  );
}
```

### **Multi-Stage Loading Indicator** (Optional Enhancement)
```typescript
const [loadingStage, setLoadingStage] = useState<'moderation' | 'analysis' | 'validation' | null>(null);

// Simulate stages (actual stages determined by API timing)
useEffect(() => {
  if (isLoading) {
    setLoadingStage('moderation');
    setTimeout(() => setLoadingStage('analysis'), 500);
    setTimeout(() => setLoadingStage('validation'), 2000);
  } else {
    setLoadingStage(null);
  }
}, [isLoading]);

const getStageMessage = () => {
  switch (loadingStage) {
    case 'moderation': return 'Checking content...';
    case 'analysis': return 'Analyzing your situation...';
    case 'validation': return 'Preparing results...';
    default: return 'Processing...';
  }
};
```

### **File Locations** [Source: architecture/source-tree.md]
- Hook: `lib/hooks/useAIIntake.ts` (new file)
- Update: `components/intake/IntakePage.tsx` (integrate hook)
- API: `app/api/ai/intake/route.ts` (already exists from Spike)
- Tests:
  - `tests/hooks/useAIIntake.test.tsx` (new file)
  - `tests/intake/intake-page.test.tsx` (update with API integration)
  - `tests/api/ai-intake.test.ts` (already exists from Spike)

### **Error Handling Flow**
```
User submits text
       ↓
useAIIntake hook
       ↓
POST /api/ai/intake
       ↓
     Error?
    ↙     ↘
  Yes      No
   ↓        ↓
Map error  Success
to message   ↓
   ↓      Navigate to
Display    results page
Alert      (Story 12.3)
   ↓
Show retry
button
```

### **Performance Monitoring**
```typescript
// Log API timing
const startTime = performance.now();
await fetch('/api/ai/intake', ...);
const duration = performance.now() - startTime;

console.log(`AI Intake: ${duration}ms`);

if (duration > 3000) {
  console.warn('AI Intake exceeded 3s target:', duration);
}

// Optional: Show "taking longer..." message after 5s
const timeoutId = setTimeout(() => {
  if (isLoading) {
    toast.info('This is taking longer than usual. Please wait...');
  }
}, 5000);
```

### **SessionStorage Pattern** (for navigation)
```typescript
// Store result for next page
sessionStorage.setItem('intake-result', JSON.stringify(result));

// Retrieve on results page (Story 12.3)
const storedResult = sessionStorage.getItem('intake-result');
const result = storedResult ? JSON.parse(storedResult) : null;

// Clear after use
sessionStorage.removeItem('intake-result');
```

### **Testing Strategy**
```typescript
// tests/hooks/useAIIntake.test.tsx
describe('useAIIntake', () => {
  it('successfully submits and returns classification', async () => {
    const { result } = renderHook(() => useAIIntake());
    
    act(() => {
      result.current.classify({ text: 'My landlord evicted me unfairly' });
    });

    await waitFor(() => {
      expect(result.current.data).toBeDefined();
      expect(result.current.data?.data.caseType).toBe('Eviction');
    });
  });

  it('handles ContentBlocked error', async () => {
    global.fetch = vi.fn().mockResolvedValue({
      ok: false,
      status: 400,
      json: async () => ({ 
        error: 'ContentBlocked', 
        message: 'Content blocked by moderation' 
      }),
    });

    const { result } = renderHook(() => useAIIntake());
    
    act(() => {
      result.current.classify({ text: 'inappropriate content' });
    });

    await waitFor(() => {
      expect(result.current.error?.code).toBe('ContentBlocked');
    });
  });

  it('includes timezone in request', async () => {
    const fetchSpy = vi.spyOn(global, 'fetch');
    const { result } = renderHook(() => useAIIntake());
    
    act(() => {
      result.current.classify({ 
        text: 'My landlord evicted me', 
        userTimezone: 'America/Los_Angeles' 
      });
    });

    await waitFor(() => {
      expect(fetchSpy).toHaveBeenCalledWith(
        '/api/ai/intake',
        expect.objectContaining({
          body: expect.stringContaining('America/Los_Angeles'),
        })
      );
    });
  });
});
```

### **Accessibility Requirements**
- Loading state announced with aria-live="polite"
- Error alerts have role="alert" for immediate announcement
- Retry button accessible via keyboard
- Screen reader announces stage changes
- Loading spinner has aria-label="Analyzing your situation"

### **Technical Constraints**
- TypeScript strict mode - no `any` types
- Use React Query for mutation management
- API response must match IntakeClassificationSchema
- Error messages user-friendly (no technical jargon)
- Performance target: ≤3s API response time
- Log all API calls and errors to console

### **Integration Points**
- Story 12.1: Uses IntakePage component and form structure
- Story 12.3: Navigates to results page with classification data
- API Spike: Uses existing /api/ai/intake endpoint
- React Query: Manages mutation state and caching

### **Out of Scope for Story 12.2**
- Displaying AI results (Story 12.3)
- Editing results (Story 12.4)
- Saving to Firestore (Story 12.4)
- Analytics dashboard (Story 12.5)
- Cancel/abort request functionality (future enhancement)
- Retry with exponential backoff (future enhancement)
- Offline support (future enhancement)

### **User Experience Flow**
```
1. User submits text (≥20 chars)
2. Submit button shows loading spinner
3. API request sent with text + timezone
4. Loading message: "Analyzing your situation..."
5. Response received (2-3s)
   ↓
Success: Navigate to results page
   or
Error: Display error message + retry button
```

## Testing

- Use Vitest + React Testing Library per `CLAUDE.md`.
- Mock fetch for API calls in tests.
- Test useAIIntake hook with all error scenarios.
- Test loading states and disabled controls.
- Test error messages and retry functionality.
- Test navigation to results on success.
- Performance: Verify timing logged to console.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-11 | 0.1 | Initial draft created from Epic 12 PRD | SM Agent (Bob) |

