# Story 12.5: Admin Logs & Analytics View

## Status
Draft

## Story
**As an** administrator of FairForm,
**I want** to view anonymized AI intake logs and analytics,
**so that** I can monitor classification accuracy, identify issues, and improve the AI system over time.

## Acceptance Criteria

1. Admin page accessible at `/admin/ai-intake` (protected, admin-only route).
2. Page displays list of recent AI intake classifications (last 100).
3. Each log entry shows: timestamp, case type, confidence, risk level, moderation verdict.
4. User-identifying information (userId, text) is hashed/anonymized in display.
5. Summary statistics displayed: total classifications, average confidence, accuracy rate.
6. Filtering by date range, case type, confidence level, and moderation verdict.
7. Ability to export logs as CSV for external analysis.
8. Page loads in â‰¤2 seconds with pagination for performance.
9. Admin access controlled via Firestore security rules and server-side check.
10. Page meets WCAG 2.1 AA accessibility standards.

## Tasks / Subtasks

- [ ] Task 1: Create admin intake logs route (AC: 1, 9)
  - [ ] Create `app/admin/ai-intake/page.tsx` as authenticated server component
  - [ ] Use `requireAuth` for authentication
  - [ ] Check if user has admin role (new: `isAdmin` check)
  - [ ] If not admin, return 403 Forbidden
  - [ ] Render AdminAIIntakePage client component

- [ ] Task 2: Add admin role to user schema (AC: 9)
  - [ ] Update UserSettings interface to include `isAdmin?: boolean`
  - [ ] Update Firestore security rules for admin access
  - [ ] Rule: Only admins can read `aiIntakeLogs` collection
  - [ ] Manually set admin flag for initial admin user (via Firestore Console)
  - [ ] Document admin role assignment process

- [ ] Task 3: Create aiIntakeLogsRepo (AC: 2, 3, 4)
  - [ ] Create `lib/db/aiIntakeLogsRepo.ts`
  - [ ] Function: `listRecentLogs(limit = 100): Promise<AIIntakeLog[]>`
  - [ ] Function: `getLogsByDateRange(start, end): Promise<AIIntakeLog[]>`
  - [ ] Function: `getStatistics(): Promise<IntakeStatistics>`
  - [ ] Fetch from `aiIntakeLogs` Firestore collection
  - [ ] Map documents to AIIntakeLog interface
  - [ ] Handle pagination with Firestore query cursors

- [ ] Task 4: Define AIIntakeLog interface (AC: 3, 4)
  - [ ] Create interface in `lib/validation.ts`
  - [ ] Fields:
    - `id: string`
    - `userIdHash: string` (hashed userId)
    - `caseType: string`
    - `confidence: number`
    - `riskLevel: string`
    - `moderationVerdict: string`
    - `classifiedAt: Date`
    - `processingTime: number` (ms)
  - [ ] NO raw user text or PII
  - [ ] Create Zod schema for validation

- [ ] Task 5: Create AdminAIIntakePage component (AC: 2, 3, 5, 6)
  - [ ] Create `components/admin/AdminAIIntakePage.tsx`
  - [ ] Use React Query to fetch logs with `useAIIntakeLogs` hook
  - [ ] Display logs in shadcn/ui Table component
  - [ ] Columns: Timestamp, Case Type, Confidence, Risk, Moderation
  - [ ] Color-code risk levels (green/yellow/red)
  - [ ] Display confidence as percentage with bar
  - [ ] Show summary statistics at top (total, avg confidence, etc.)
  - [ ] Add loading skeleton while fetching

- [ ] Task 6: Implement filtering (AC: 6)
  - [ ] Add filter controls above table
  - [ ] Date range picker (from/to dates)
  - [ ] Case type dropdown (all case types + "All")
  - [ ] Confidence range slider (0-100%)
  - [ ] Moderation verdict select (pass/review/block/all)
  - [ ] Apply filters client-side to loaded data
  - [ ] Show count of filtered results

- [ ] Task 7: Add summary statistics (AC: 5)
  - [ ] Create statistics Card at top of page
  - [ ] Metrics:
    - Total classifications
    - Average confidence score
    - Distribution by case type (bar chart or table)
    - Moderation block rate
    - Average processing time
  - [ ] Use simple visualizations (Progress bars, badges)
  - [ ] Update stats when filters applied

- [ ] Task 8: Implement CSV export (AC: 7)
  - [ ] Add "Export to CSV" button
  - [ ] Generate CSV from filtered log data
  - [ ] Include all visible columns
  - [ ] Filename: `ai-intake-logs-{date}.csv`
  - [ ] Use browser download (no server endpoint needed)
  - [ ] Show toast on successful export

- [ ] Task 9: Add pagination (AC: 8)
  - [ ] Load logs in pages of 50
  - [ ] Add "Load More" button at bottom
  - [ ] Track current page/cursor
  - [ ] Disable button when all loaded
  - [ ] Show "Showing X of Y" count
  - [ ] Use Firestore query cursors for efficient paging

- [ ] Task 10: Create comprehensive tests (AC: All)
  - [ ] Route protection tests:
    - Non-admin users get 403
    - Admin users can access
  - [ ] Repository tests:
    - Fetches logs correctly
    - Respects date range filters
    - Calculates statistics accurately
  - [ ] Component tests:
    - Displays logs in table
    - Filters work correctly
    - Export generates CSV
    - Pagination loads more
  - [ ] Accessibility tests:
    - Table accessible
    - Filters keyboard navigable
    - Zero violations

## Dev Notes

### **Previous Story Insights**
- Story 12.2: AI Intake API logs to `aiIntakeLogs` collection (from `lib/ai/logs.ts`)
- Firestore collections and security rules established
- Admin functionality is new - need to add role system
- shadcn/ui Table component available

### **AIIntakeLog Structure** (from lib/ai/logs.ts)
```typescript
// Firestore collection: aiIntakeLogs
interface AIIntakeLog {
  id: string;
  userIdHash: string;        // Hashed userId (SHA-256)
  caseType: string;
  primaryIssue: string;      // Anonymized
  confidence: number;
  riskLevel: "low" | "medium" | "high";
  moderationVerdict: "pass" | "review" | "block";
  moderationFlags: string[]; // Categories flagged
  classifiedAt: Date;
  processingTime?: number;   // Optional: API response time in ms
}
```

### **Admin Role System**
```typescript
// Update lib/validation.ts - UserSettings interface
interface UserSettings {
  // ... existing fields
  isAdmin?: boolean;  // NEW: Admin flag
}

// Server-side admin check
export async function requireAdmin(request: NextRequest) {
  const user = await requireAuth(request);
  
  const settings = await usersRepo.getUserSettings(user.uid);
  
  if (!settings?.isAdmin) {
    throw new Error('Forbidden: Admin access required');
  }
  
  return { ...user, isAdmin: true };
}
```

### **Firestore Security Rules Update**
```javascript
// firestore.rules - Add admin collection access
match /aiIntakeLogs/{logId} {
  allow read: if request.auth != null && 
    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
  allow write: if false; // Logs written by server only
}
```

### **aiIntakeLogsRepo**
```typescript
// lib/db/aiIntakeLogsRepo.ts
import { collection, query, orderBy, limit, getDocs, where, Timestamp } from 'firebase/firestore';
import { getFirestoreDb } from '@/lib/firebase';
import type { AIIntakeLog } from '@/lib/validation';

export class AIIntakeLogsRepositoryError extends Error {
  constructor(message: string, options?: { cause?: unknown }) {
    super(message, options);
    this.name = 'AIIntakeLogsRepositoryError';
  }
}

export async function listRecentLogs(limitCount = 100): Promise<AIIntakeLog[]> {
  try {
    const db = getFirestoreDb();
    const logsQuery = query(
      collection(db, 'aiIntakeLogs'),
      orderBy('classifiedAt', 'desc'),
      limit(limitCount)
    );

    const snapshot = await getDocs(logsQuery);
    return snapshot.docs.map(mapLogDocument);
  } catch (error) {
    console.error('Failed to list AI intake logs', error);
    throw new AIIntakeLogsRepositoryError('Unable to load logs', { cause: error });
  }
}

export async function getLogsByDateRange(
  startDate: Date,
  endDate: Date
): Promise<AIIntakeLog[]> {
  try {
    const db = getFirestoreDb();
    const logsQuery = query(
      collection(db, 'aiIntakeLogs'),
      where('classifiedAt', '>=', Timestamp.fromDate(startDate)),
      where('classifiedAt', '<=', Timestamp.fromDate(endDate)),
      orderBy('classifiedAt', 'desc')
    );

    const snapshot = await getDocs(logsQuery);
    return snapshot.docs.map(mapLogDocument);
  } catch (error) {
    console.error('Failed to get logs by date range', error);
    throw new AIIntakeLogsRepositoryError('Unable to load logs', { cause: error });
  }
}

export interface IntakeStatistics {
  totalClassifications: number;
  averageConfidence: number;
  caseTypeDistribution: Record<string, number>;
  moderationBlockRate: number;
  averageProcessingTime?: number;
}

export async function getStatistics(): Promise<IntakeStatistics> {
  const logs = await listRecentLogs(1000); // Last 1000 for stats
  
  const total = logs.length;
  const avgConfidence = logs.reduce((sum, log) => sum + log.confidence, 0) / total;
  
  const caseTypes: Record<string, number> = {};
  let blockedCount = 0;
  let totalProcessingTime = 0;
  let processingTimeCount = 0;
  
  logs.forEach(log => {
    caseTypes[log.caseType] = (caseTypes[log.caseType] || 0) + 1;
    if (log.moderationVerdict === 'block') blockedCount++;
    if (log.processingTime) {
      totalProcessingTime += log.processingTime;
      processingTimeCount++;
    }
  });
  
  return {
    totalClassifications: total,
    averageConfidence: Math.round(avgConfidence * 100) / 100,
    caseTypeDistribution: caseTypes,
    moderationBlockRate: blockedCount / total,
    averageProcessingTime: processingTimeCount > 0 
      ? Math.round(totalProcessingTime / processingTimeCount)
      : undefined,
  };
}

function mapLogDocument(doc: DocumentSnapshot): AIIntakeLog {
  const data = doc.data();
  return {
    id: doc.id,
    userIdHash: data.userIdHash,
    caseType: data.caseType,
    primaryIssue: data.primaryIssue,
    confidence: data.confidence,
    riskLevel: data.riskLevel,
    moderationVerdict: data.moderationVerdict,
    moderationFlags: data.moderationFlags || [],
    classifiedAt: data.classifiedAt.toDate(),
    processingTime: data.processingTime,
  };
}
```

### **AdminAIIntakePage Component**
```typescript
// components/admin/AdminAIIntakePage.tsx
'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import * as aiIntakeLogsRepo from '@/lib/db/aiIntakeLogsRepo';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Progress } from '@/components/ui/progress';
import { Download } from 'lucide-react';
import { toast } from 'sonner';

export function AdminAIIntakePage() {
  const { data: logs, isLoading } = useQuery({
    queryKey: ['aiIntakeLogs'],
    queryFn: () => aiIntakeLogsRepo.listRecentLogs(100),
  });

  const { data: stats } = useQuery({
    queryKey: ['aiIntakeStats'],
    queryFn: () => aiIntakeLogsRepo.getStatistics(),
  });

  const handleExport = () => {
    if (!logs) return;
    
    const csv = generateCSV(logs);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-intake-logs-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    
    toast.success('Logs exported successfully');
  };

  return (
    <div className="container mx-auto py-8 px-4">
      <h1 className="text-3xl font-bold mb-6">AI Intake Analytics</h1>

      {/* Statistics */}
      {stats && (
        <div className="grid md:grid-cols-4 gap-4 mb-6">
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm">Total Classifications</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold">{stats.totalClassifications}</p>
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm">Avg Confidence</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold">{(stats.averageConfidence * 100).toFixed(1)}%</p>
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm">Block Rate</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold">{(stats.moderationBlockRate * 100).toFixed(1)}%</p>
            </CardContent>
          </Card>
          
          <Card>
            <CardHeader className="pb-2">
              <CardTitle className="text-sm">Avg Processing</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-2xl font-bold">{stats.averageProcessingTime || 'N/A'}ms</p>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Export Button */}
      <div className="mb-4 flex justify-end">
        <Button onClick={handleExport} variant="outline">
          <Download className="mr-2 h-4 w-4" />
          Export CSV
        </Button>
      </div>

      {/* Logs Table */}
      <Card>
        <CardHeader>
          <CardTitle>Recent Classifications</CardTitle>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Timestamp</TableHead>
                <TableHead>Case Type</TableHead>
                <TableHead>Confidence</TableHead>
                <TableHead>Risk</TableHead>
                <TableHead>Moderation</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {logs?.map((log) => (
                <TableRow key={log.id}>
                  <TableCell>{new Date(log.classifiedAt).toLocaleString()}</TableCell>
                  <TableCell>{log.caseType}</TableCell>
                  <TableCell>
                    <div className="flex items-center gap-2">
                      <Progress value={log.confidence * 100} className="w-16 h-2" />
                      <span className="text-sm">{Math.round(log.confidence * 100)}%</span>
                    </div>
                  </TableCell>
                  <TableCell>
                    <Badge variant={getRiskVariant(log.riskLevel)}>
                      {log.riskLevel}
                    </Badge>
                  </TableCell>
                  <TableCell>
                    <Badge variant={getModerationVariant(log.moderationVerdict)}>
                      {log.moderationVerdict}
                    </Badge>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </CardContent>
      </Card>
    </div>
  );
}

function getRiskVariant(risk: string) {
  switch (risk) {
    case 'low': return 'default';
    case 'medium': return 'secondary';
    case 'high': return 'destructive';
    default: return 'outline';
  }
}

function getModerationVariant(verdict: string) {
  switch (verdict) {
    case 'pass': return 'default';
    case 'review': return 'secondary';
    case 'block': return 'destructive';
    default: return 'outline';
  }
}

function generateCSV(logs: AIIntakeLog[]): string {
  const headers = ['Timestamp', 'Case Type', 'Confidence', 'Risk Level', 'Moderation Verdict'];
  const rows = logs.map(log => [
    new Date(log.classifiedAt).toISOString(),
    log.caseType,
    log.confidence.toString(),
    log.riskLevel,
    log.moderationVerdict,
  ]);
  
  return [headers, ...rows].map(row => row.join(',')).join('\n');
}
```

### **File Locations**
- Route: `app/admin/ai-intake/page.tsx` (new)
- Component: `components/admin/AdminAIIntakePage.tsx` (new)
- Repository: `lib/db/aiIntakeLogsRepo.ts` (new)
- Helper: `lib/auth/require-admin.ts` (new)
- Update: `lib/validation.ts` (add AIIntakeLog interface, isAdmin field)
- Update: `firestore.rules` (add admin access rules)
- Tests:
  - `tests/admin/admin-ai-intake.test.tsx` (new)
  - `tests/lib/db/aiIntakeLogsRepo.test.ts` (new)
  - `tests/auth/require-admin.test.ts` (new)

### **Admin Setup Process**
1. Deploy app with updated user schema
2. Manually set `isAdmin: true` in Firestore Console for admin user
3. Deploy updated security rules
4. Admin can now access `/admin/ai-intake`

### **CSV Export Format**
```csv
Timestamp,Case Type,Confidence,Risk Level,Moderation Verdict
2025-10-11T14:30:00.000Z,Small Claims,0.85,low,pass
2025-10-11T14:25:00.000Z,Eviction,0.72,medium,pass
...
```

### **Performance Considerations**
- Limit initial load to 100 logs
- Use Firestore query cursors for pagination
- Cache statistics with React Query (5-min stale time)
- Client-side filtering to avoid re-fetching
- Lazy load additional data on scroll/click

### **Security Considerations**
- Admin-only route protection (server-side)
- Firestore security rules enforce admin read access
- No PII displayed (userId hashed, no raw text)
- Audit log for admin access (future enhancement)

### **Testing Strategy**
```typescript
describe('AdminAIIntakePage', () => {
  it('displays logs in table', async () => {
    render(<AdminAIIntakePage />);
    
    await waitFor(() => {
      expect(screen.getByText('Small Claims')).toBeInTheDocument();
    });
  });

  it('exports logs as CSV', () => {
    const createElementSpy = vi.spyOn(document, 'createElement');
    render(<AdminAIIntakePage />);
    
    fireEvent.click(screen.getByText('Export CSV'));
    
    expect(createElementSpy).toHaveBeenCalledWith('a');
  });

  it('shows statistics cards', async () => {
    render(<AdminAIIntakePage />);
    
    await waitFor(() => {
      expect(screen.getByText('Total Classifications')).toBeInTheDocument();
      expect(screen.getByText('Avg Confidence')).toBeInTheDocument();
    });
  });
});
```

### **Integration Points**
- lib/ai/logs.ts: Reads logs written by API
- Admin role system: Requires new isAdmin flag
- Firestore security rules: Enforces admin access

### **Out of Scope**
- Manual classification correction
- A/B testing framework
- Machine learning retraining
- Real-time monitoring dashboard
- Detailed error analysis

## Testing

- Use Vitest + React Testing Library.
- Test admin access control.
- Test log display and filtering.
- Test CSV export functionality.
- Test statistics calculations.
- Accessibility tests.

## Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-10-11 | 0.1 | Initial draft | SM Agent (Bob) |

