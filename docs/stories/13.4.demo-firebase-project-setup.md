# Story 13.4: Demo Firebase Project Setup

## Status
Draft

## Story
**As a** FairForm demo presenter,
**I want** a completely isolated Firebase project for demo sessions,
**so that** demo data never mixes with production data and demos can run safely without authentication.

## Acceptance Criteria

1. Separate Firebase project created for demo environment
2. Demo project configured with Firestore and Authentication
3. Environment variables updated to support demo/production switching
4. Demo-specific Firestore security rules implemented
5. Sample data seeding scripts for demo cases and users
6. Demo mode detection in application code
7. CI/CD pipeline configured to deploy demo project
8. Documentation for demo setup and maintenance

## Tasks / Subtasks

- [ ] Task 1: Create demo Firebase project (AC: 1)
  - [ ] Create new Firebase project: 'fairform-demo' or similar
  - [ ] Enable Firestore Database
  - [ ] Enable Authentication (Anonymous auth for demo)
  - [ ] Generate service account key for demo project
  - [ ] Document project ID and configuration

- [ ] Task 2: Configure demo environment variables (AC: 3)
  - [ ] Create `.env.demo` file with demo Firebase config
  - [ ] Add demo-specific environment variables
  - [ ] Update `.env.example` to include demo variables
  - [ ] Document required demo environment variables

- [ ] Task 3: Implement demo mode detection (AC: 6)
  - [ ] Create `lib/config/demo.ts` for demo mode utilities
  - [ ] Add `isDemoMode()` function to detect demo environment
  - [ ] Add `getDemoFirebaseConfig()` function
  - [ ] Update Firebase initialization to use demo config when needed

- [ ] Task 4: Create demo Firestore security rules (AC: 4)
  - [ ] Create `firestore.demo.rules` file
  - [ ] Allow anonymous read/write for demo collections
  - [ ] Block access to production data patterns
  - [ ] Include rules for aiSessions and messages collections
  - [ ] Test rules with Firebase emulator

- [ ] Task 5: Create sample data seeding scripts (AC: 5)
  - [ ] Create `scripts/seed-demo-data.ts`
  - [ ] Seed demo users with anonymous authentication
  - [ ] Seed sample cases (eviction, small claims, family law)
  - [ ] Seed sample case steps and progress
  - [ ] Create demo AI sessions with conversation history

- [ ] Task 6: Update Firebase initialization (AC: 6)
  - [ ] Modify `lib/firebase.ts` to support demo mode
  - [ ] Create separate Firebase app instance for demo
  - [ ] Update `lib/firebase-admin.ts` for server-side demo support
  - [ ] Ensure proper cleanup and error handling

- [ ] Task 7: Configure CI/CD for demo deployment (AC: 7)
  - [ ] Update GitHub Actions workflow for demo deployment
  - [ ] Add demo environment secrets to repository
  - [ ] Configure separate deployment pipeline for demo
  - [ ] Add demo health check endpoint

- [ ] Task 8: Create demo setup documentation (AC: 8)
  - [ ] Document demo Firebase project setup process
  - [ ] Create demo data seeding instructions
  - [ ] Document environment variable configuration
  - [ ] Create demo deployment checklist

## Dev Notes

### Architecture Context
[Source: docs/epic-13-unified-architecture-specification.md]

Demo isolation is **critical for safety** - it prevents any possibility of demo data contaminating production. The architecture uses a **separate Firebase project** with completely isolated data and authentication.

**Key Design Decisions:**
- Separate Firebase project (not just namespace)
- Anonymous authentication for demos
- Sample data seeding for consistent demos
- Environment-based configuration switching
- Complete data isolation from production

### Demo Firebase Configuration

**Project Setup:**
```bash
# Create demo Firebase project
firebase projects:create fairform-demo --display-name "FairForm Demo"

# Enable required services
firebase use fairform-demo
firebase firestore:indexes --project fairform-demo
```

**Environment Variables:**
```bash
# .env.demo
NEXT_PUBLIC_FIREBASE_PROJECT_ID=fairform-demo
NEXT_PUBLIC_FIREBASE_API_KEY=demo-api-key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=fairform-demo.firebaseapp.com
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=fairform-demo.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=demo-sender-id
NEXT_PUBLIC_FIREBASE_APP_ID=demo-app-id

# Server-side (for API routes)
FIREBASE_DEMO_PROJECT_ID=fairform-demo
FIREBASE_DEMO_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
FIREBASE_DEMO_CLIENT_EMAIL=demo-service@fairform-demo.iam.gserviceaccount.com

# Demo mode detection
DEMO_MODE=true
DEMO_TOKEN=demo-secret-token-123
```

### Demo Mode Detection

**Client-side detection:**
```typescript
// lib/config/demo.ts
export function isDemoMode(): boolean {
  return process.env.NODE_ENV === 'development' && 
         process.env.NEXT_PUBLIC_DEMO_MODE === 'true';
}

export function getFirebaseConfig() {
  if (isDemoMode()) {
    return {
      projectId: process.env.NEXT_PUBLIC_FIREBASE_DEMO_PROJECT_ID,
      apiKey: process.env.NEXT_PUBLIC_FIREBASE_DEMO_API_KEY,
      authDomain: process.env.NEXT_PUBLIC_FIREBASE_DEMO_AUTH_DOMAIN,
      storageBucket: process.env.NEXT_PUBLIC_FIREBASE_DEMO_STORAGE_BUCKET,
      messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_DEMO_MESSAGING_SENDER_ID,
      appId: process.env.NEXT_PUBLIC_FIREBASE_DEMO_APP_ID
    };
  }
  
  return {
    projectId: process.env.NEXT_PUBLIC_FIREBASE_PROJECT_ID,
    apiKey: process.env.NEXT_PUBLIC_FIREBASE_API_KEY,
    authDomain: process.env.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN,
    storageBucket: process.env.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET,
    messagingSenderId: process.env.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID,
    appId: process.env.NEXT_PUBLIC_FIREBASE_APP_ID
  };
}
```

**Server-side detection:**
```typescript
// lib/firebase-admin.ts
import { initializeApp, getApps, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

function getFirebaseAdminConfig() {
  if (process.env.DEMO_MODE === 'true') {
    return {
      credential: cert({
        projectId: process.env.FIREBASE_DEMO_PROJECT_ID,
        privateKey: process.env.FIREBASE_DEMO_PRIVATE_KEY?.replace(/\\n/g, '\n'),
        clientEmail: process.env.FIREBASE_DEMO_CLIENT_EMAIL
      }),
      projectId: process.env.FIREBASE_DEMO_PROJECT_ID
    };
  }
  
  return {
    credential: cert({
      projectId: process.env.FIREBASE_PROJECT_ID,
      privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, '\n'),
      clientEmail: process.env.FIREBASE_CLIENT_EMAIL
    }),
    projectId: process.env.FIREBASE_PROJECT_ID
  };
}

export function getAdminFirestore() {
  const apps = getApps();
  const app = apps.length > 0 ? apps[0] : initializeApp(getFirebaseAdminConfig());
  return getFirestore(app);
}
```

### Demo Firestore Security Rules

```javascript
// firestore.demo.rules
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow anonymous access for demo
    function isAnonymous() {
      return request.auth != null && request.auth.token.firebase.sign_in_provider == 'anonymous';
    }
    
    // Demo sessions - open access
    match /aiSessions/{sessionId} {
      allow read, write: if isAnonymous();
      
      match /messages/{messageId} {
        allow read, write: if isAnonymous();
      }
    }
    
    // Demo cases - open access
    match /cases/{caseId} {
      allow read, write: if isAnonymous();
      
      match /steps/{stepId} {
        allow read, write: if isAnonymous();
      }
    }
    
    // Demo users - open access
    match /users/{userId} {
      allow read, write: if isAnonymous();
    }
    
    // Block access to any non-demo collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

### Sample Data Seeding

**Demo users:**
```typescript
// scripts/seed-demo-data.ts
const demoUsers = [
  {
    uid: 'demo-user-1',
    email: 'demo1@fairform.com',
    displayName: 'Demo User 1',
    preferences: {
      aiParticipation: true,
      timeZone: 'America/Los_Angeles',
      tone: 'friendly',
      complexity: 'simple'
    }
  },
  // ... more demo users
];
```

**Demo cases:**
```typescript
const demoCases = [
  {
    id: 'demo-case-1',
    userId: 'demo-user-1',
    caseType: 'eviction',
    jurisdiction: 'Los Angeles County',
    status: 'active',
    currentStepOrder: 2,
    progressPct: 40,
    createdAt: Date.now() - (7 * 24 * 60 * 60 * 1000), // 7 days ago
    updatedAt: Date.now()
  },
  {
    id: 'demo-case-2',
    userId: 'demo-user-1',
    caseType: 'small_claims',
    jurisdiction: 'Orange County',
    status: 'active',
    currentStepOrder: 1,
    progressPct: 20,
    createdAt: Date.now() - (3 * 24 * 60 * 60 * 1000), // 3 days ago
    updatedAt: Date.now()
  }
  // ... more demo cases
];
```

**Demo AI sessions:**
```typescript
const demoAISessions = [
  {
    id: 'demo-session-1',
    userId: 'demo-user-1',
    caseId: 'demo-case-1',
    title: 'Eviction Case - Tenant Rights',
    status: 'active',
    createdAt: Date.now() - (2 * 24 * 60 * 60 * 1000),
    lastMessageAt: Date.now() - (1 * 60 * 60 * 1000), // 1 hour ago
    contextSnapshot: {
      caseType: 'eviction',
      jurisdiction: 'Los Angeles County',
      currentStepOrder: 2,
      progressPct: 40,
      hash: 'demo-hash-1'
    },
    demo: true
  }
  // ... more demo sessions
];
```

### Source Tree
```
lib/
├── config/
│   └── demo.ts           # NEW: Demo mode utilities
├── firebase.ts           # MODIFIED: Support demo config
├── firebase-admin.ts     # MODIFIED: Support demo admin
└── db/
    └── aiSessionsRepo.ts # EXISTING: Works with demo Firestore

scripts/
└── seed-demo-data.ts     # NEW: Demo data seeding

firestore.demo.rules      # NEW: Demo security rules
.env.demo                 # NEW: Demo environment variables
```

### CI/CD Configuration

**GitHub Actions demo deployment:**
```yaml
# .github/workflows/deploy-demo.yml
name: Deploy Demo
on:
  push:
    branches: [demo]
    
jobs:
  deploy-demo:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Deploy to Vercel (Demo)
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_DEMO_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_DEMO_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_DEMO_PROJECT_ID }}
          vercel-args: '--env NEXT_PUBLIC_DEMO_MODE=true'
```

### Testing

**Test Location:** `lib/config/demo.test.ts`

**Test Coverage:**
- Demo mode detection logic
- Firebase configuration switching
- Demo environment variable handling
- Error handling for missing demo config

**Example Test:**
```typescript
describe('demo config', () => {
  beforeEach(() => {
    process.env.NODE_ENV = 'development';
  });
  
  it('detects demo mode correctly', () => {
    process.env.NEXT_PUBLIC_DEMO_MODE = 'true';
    expect(isDemoMode()).toBe(true);
    
    process.env.NEXT_PUBLIC_DEMO_MODE = 'false';
    expect(isDemoMode()).toBe(false);
  });
  
  it('returns demo Firebase config in demo mode', () => {
    process.env.NEXT_PUBLIC_DEMO_MODE = 'true';
    process.env.NEXT_PUBLIC_FIREBASE_DEMO_PROJECT_ID = 'demo-project';
    
    const config = getFirebaseConfig();
    expect(config.projectId).toBe('demo-project');
  });
});
```

### Documentation

**Demo Setup Guide:**
```markdown
# Demo Environment Setup

## 1. Create Demo Firebase Project
- Go to Firebase Console
- Create new project: "fairform-demo"
- Enable Firestore and Authentication (Anonymous)

## 2. Configure Environment Variables
- Copy `.env.demo` to `.env.local`
- Update Firebase project credentials
- Set `DEMO_MODE=true`

## 3. Seed Demo Data
```bash
npm run seed:demo
```

## 4. Deploy Demo
```bash
npm run deploy:demo
```
```

### Dependencies
- firebase-admin (existing)
- Firebase CLI for project setup
- Vercel CLI for demo deployment

### Security Considerations
- Demo project completely isolated from production
- Anonymous authentication only
- No real user data in demo
- Regular demo data refresh/cleanup

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-13 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
