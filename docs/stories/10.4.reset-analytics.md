# Story 10.4: Reset Functionality & Analytics Events

## Status: Draft

## Story

As a **FairForm user who wants to start fresh**,
I want **the ability to reset my checklist progress with confirmation**,
So that **I can clear my preparation status and track my progress properly for a rescheduled hearing**.

## Context Source

- Source Document: Epic 10 PRD (Day-in-Court Checklist)
- Enhancement Type: Reset functionality and analytics tracking
- Existing System Impact: Adds reset feature and tracking without backend dependencies

## Acceptance Criteria

### Functional Requirements

1. **Reset Button**: Add "Reset Checklist" button at bottom of page
2. **Confirmation Modal**: Show confirmation dialog before resetting progress
3. **Clear Progress**: Reset all completed items and clear localStorage
4. **Visual Feedback**: Provide clear feedback when reset is complete
5. **Analytics Events**: Track checklist interactions for product insights

### Technical Requirements

6. **Modal Component**: Use shadcn/ui Dialog for confirmation
7. **Reset Handler**: Implement safe reset with error handling
8. **Event Tracking**: Add PostHog events for key user actions
9. **Non-Blocking**: Analytics failures don't break user experience

### Quality Requirements

10. **Accessibility**: Reset button and modal meet WCAG 2.1 AA standards
11. **User Protection**: Confirmation prevents accidental data loss
12. **Testing**: Unit tests for reset logic and analytics

## Tasks / Subtasks

- [ ] **Task 1**: Create reset confirmation dialog
  - [ ] Build ResetChecklistDialog component
  - [ ] Add confirmation message and buttons
  - [ ] Implement modal trigger and state
  - [ ] Add proper accessibility attributes

- [ ] **Task 2**: Implement reset functionality
  - [ ] Wire up reset handler from useChecklistProgress hook
  - [ ] Add visual feedback for successful reset
  - [ ] Handle reset errors gracefully
  - [ ] Update UI to reflect cleared state

- [ ] **Task 3**: Add analytics event tracking
  - [ ] Integrate PostHog for event tracking
  - [ ] Add checklist_viewed event
  - [ ] Add checklist_item_completed event
  - [ ] Add checklist_item_uncompleted event
  - [ ] Add checklist_reset event
  - [ ] Add checklist_completed (100%) event

- [ ] **Task 4**: Style reset button and feedback
  - [ ] Add reset button to page footer
  - [ ] Style button appropriately (destructive variant)
  - [ ] Add success toast/alert after reset
  - [ ] Maintain consistent design system

- [ ] **Task 5**: Add comprehensive testing
  - [ ] Component tests for reset dialog
  - [ ] Integration tests for reset flow
  - [ ] Analytics event tests (mocked)
  - [ ] Accessibility tests for modal

## Dev Notes

### Previous Story Context

This story builds on:
- Story 10.1: Checklist page scaffold
- Story 10.2: Checklist templates and components
- Story 10.3: LocalStorage persistence and progress tracking

### Technical Implementation

**ResetChecklistDialog Component:**
```typescript
// components/checklist/reset-checklist-dialog.tsx
import { useState } from 'react';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import { Button } from '@/components/ui/button';
import { RotateCcw } from 'lucide-react';

interface ResetChecklistDialogProps {
  onReset: () => void;
  isDisabled?: boolean;
}

export function ResetChecklistDialog({ 
  onReset, 
  isDisabled 
}: ResetChecklistDialogProps) {
  const [open, setOpen] = useState(false);

  const handleConfirm = () => {
    onReset();
    setOpen(false);
  };

  return (
    <AlertDialog open={open} onOpenChange={setOpen}>
      <AlertDialogTrigger asChild>
        <Button
          variant="destructive"
          size="sm"
          disabled={isDisabled}
          className="gap-2"
        >
          <RotateCcw className="h-4 w-4" />
          Reset Checklist
        </Button>
      </AlertDialogTrigger>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Reset Checklist Progress?</AlertDialogTitle>
          <AlertDialogDescription>
            This will clear all your completed items and reset your progress to 0%.
            This action cannot be undone.
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel>Cancel</AlertDialogCancel>
          <AlertDialogAction onClick={handleConfirm} className="bg-destructive text-destructive-foreground">
            Reset Progress
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  );
}
```

**Analytics Integration:**
```typescript
// lib/analytics/checklist-events.ts
import posthog from 'posthog-js';

export const checklistEvents = {
  viewed: (caseId: string, caseType: string) => {
    posthog.capture('checklist_viewed', {
      case_id: caseId,
      case_type: caseType,
      timestamp: new Date().toISOString()
    });
  },

  itemCompleted: (caseId: string, itemId: string, progressPct: number) => {
    posthog.capture('checklist_item_completed', {
      case_id: caseId,
      item_id: itemId,
      progress_percentage: progressPct,
      timestamp: new Date().toISOString()
    });
  },

  itemUncompleted: (caseId: string, itemId: string, progressPct: number) => {
    posthog.capture('checklist_item_uncompleted', {
      case_id: caseId,
      item_id: itemId,
      progress_percentage: progressPct,
      timestamp: new Date().toISOString()
    });
  },

  checklistCompleted: (caseId: string, caseType: string, timeToComplete: number) => {
    posthog.capture('checklist_completed', {
      case_id: caseId,
      case_type: caseType,
      time_to_complete_ms: timeToComplete,
      timestamp: new Date().toISOString()
    });
  },

  reset: (caseId: string, itemsCleared: number) => {
    posthog.capture('checklist_reset', {
      case_id: caseId,
      items_cleared: itemsCleared,
      timestamp: new Date().toISOString()
    });
  }
};
```

**Integration with ChecklistPage:**
```typescript
// app/cases/[id]/checklist/page.tsx
import { checklistEvents } from '@/lib/analytics/checklist-events';
import { ResetChecklistDialog } from '@/components/checklist/reset-checklist-dialog';
import { useToast } from '@/components/ui/use-toast';

export default function ChecklistPage({ params }: ChecklistPageProps) {
  const caseId = params.id;
  const { data: caseData } = useCaseDetails(caseId);
  const { toast } = useToast();
  
  const {
    completedItems,
    toggleItem,
    resetProgress,
    progressPercentage,
    completedCount,
    totalCount
  } = useChecklistProgress(caseId, totalItems);

  // Track page view
  useEffect(() => {
    if (caseData) {
      checklistEvents.viewed(caseId, caseData.caseType);
    }
  }, [caseId, caseData]);

  // Track 100% completion
  useEffect(() => {
    if (progressPercentage === 100 && caseData) {
      checklistEvents.checklistCompleted(caseId, caseData.caseType, 0);
    }
  }, [progressPercentage, caseId, caseData]);

  // Enhanced toggle with analytics
  const handleToggleItem = (itemId: string) => {
    const wasCompleted = completedItems.has(itemId);
    toggleItem(itemId);
    
    // Track the change
    const newProgress = wasCompleted 
      ? Math.round(((completedCount - 1) / totalCount) * 100)
      : Math.round(((completedCount + 1) / totalCount) * 100);
    
    if (wasCompleted) {
      checklistEvents.itemUncompleted(caseId, itemId, newProgress);
    } else {
      checklistEvents.itemCompleted(caseId, itemId, newProgress);
    }
  };

  // Enhanced reset with analytics and feedback
  const handleReset = () => {
    const itemsCleared = completedCount;
    resetProgress();
    checklistEvents.reset(caseId, itemsCleared);
    
    toast({
      title: 'Checklist Reset',
      description: 'Your progress has been cleared successfully.',
      variant: 'default'
    });
  };

  return (
    <ProtectedRoute>
      <div className="mx-auto flex min-h-screen w-full max-w-4xl flex-col gap-8 px-6 py-8">
        {/* ... existing content ... */}

        {/* Checklist categories */}
        <div className="space-y-8">
          {template.categories.map((category) => (
            <ChecklistCategory
              key={category.id}
              category={category}
              completedItems={completedItems}
              onToggleItem={handleToggleItem} // Use enhanced handler
            />
          ))}
        </div>

        {/* Footer with reset button */}
        <footer className="mt-8 flex items-center justify-between border-t border-border pt-6">
          <p className="text-sm text-muted-foreground">
            Your progress is saved automatically
          </p>
          <ResetChecklistDialog
            onReset={handleReset}
            isDisabled={completedCount === 0}
          />
        </footer>
      </div>
    </ProtectedRoute>
  );
}
```

### File Locations

**New Files:**
- `components/checklist/reset-checklist-dialog.tsx` - Reset confirmation dialog
- `lib/analytics/checklist-events.ts` - Analytics event helpers
- `tests/components/checklist/reset-checklist-dialog.test.tsx` - Dialog tests
- `tests/lib/analytics/checklist-events.test.ts` - Analytics tests

**Modified Files:**
- `app/cases/[id]/checklist/page.tsx` - Add reset button and analytics
- `lib/hooks/useChecklistProgress.ts` - Expose reset function

### Design System Integration

- Uses shadcn/ui AlertDialog for confirmation
- Uses shadcn/ui Toast for success feedback
- Follows destructive button variant for reset action
- Maintains consistent spacing and layout

### Accessibility Requirements

- Reset button has proper ARIA label
- Confirmation modal has proper heading structure
- Modal is keyboard navigable
- Screen readers announce reset confirmation
- Toast notifications announced to screen readers

### Testing Requirements

**Unit Tests:**
- Reset dialog component behavior
- Analytics event payload structure
- Reset handler with error cases

**Component Tests:**
- Dialog open/close interactions
- Confirmation flow
- Reset button disabled state

**Integration Tests:**
- Full reset flow with localStorage
- Analytics event firing
- Toast notification display
- State updates after reset

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4

### Debug Log References
- Reset dialog implementation
- Analytics integration
- Toast notification system

### Completion Notes List
- Reset confirmation dialog created with accessibility
- Analytics events integrated for product insights
- Toast feedback implemented for user confirmation
- Reset button properly disabled when no items completed

### File List
**New Files:**
- `components/checklist/reset-checklist-dialog.tsx` - Reset confirmation dialog
- `lib/analytics/checklist-events.ts` - Analytics event helpers
- `tests/components/checklist/reset-checklist-dialog.test.tsx` - Dialog tests
- `tests/lib/analytics/checklist-events.test.ts` - Analytics tests

**Modified Files:**
- `app/cases/[id]/checklist/page.tsx` - Add reset button and analytics
- `lib/hooks/useChecklistProgress.ts` - Expose reset function

### Change Log
**2025-10-10**: Initial story creation for Epic 10 reset and analytics
- Created reset confirmation dialog with user protection
- Integrated PostHog analytics for checklist interactions
- Added toast feedback for successful reset

## Testing

### Test Strategy
- Unit tests for dialog component and analytics helpers
- Integration tests for reset flow and event tracking
- Accessibility tests for modal and button
- Analytics mocking for reliable tests

### Test Coverage Targets
- Reset dialog: 100% line coverage
- Analytics events: 100% line coverage
- Integration flow: 100% path coverage

### Accessibility Testing
- Modal keyboard navigation
- Screen reader announcements
- Focus management in dialog
- Button disabled state communication

### Performance Testing
- Dialog open/close performance
- Analytics event batching
- Toast notification timing

## QA Results

*To be completed after implementation*

---

**Story Owner:** SM (Bob)  
**Created:** October 10, 2025  
**Epic:** 10 Day-in-Court Checklist  
**Estimated Effort:** 0.75 day  
**Dependencies:** Story 10.3 complete
